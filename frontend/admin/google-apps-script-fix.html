<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Apps Script 403 錯誤修復指南</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 抑制 Tailwind CSS 生產環境警告
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                mode: 'jit'
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .code-block { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">🔧 Google Apps Script 403 錯誤修復指南</h1>
            <p class="text-lg text-stone-600">解決 "403 Forbidden" 權限問題的完整指南</p>
        </header>

        <!-- 錯誤診斷 -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">🔍 錯誤診斷</h2>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="font-bold text-red-800 mb-2">當前錯誤：</h3>
                <div class="code-block text-sm text-red-700">
                    GET https://script.googleusercontent.com/macros/echo?user_content_key=... 403 (Forbidden)
                </div>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="font-bold text-yellow-800 mb-3">可能原因：</h3>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li>Google Apps Script 部署設定不正確</li>
                    <li>權限設定需要更新</li>
                    <li>部署 URL 已過期或無效</li>
                    <li>執行身分設定有問題</li>
                </ul>
            </div>
        </div>

        <!-- 修復步驟 -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">🔧 修復步驟</h2>
            
            <div class="space-y-6">
                <!-- 步驟 1 -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-bold text-lg mb-3">步驟 1：檢查 Apps Script 專案</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>前往 <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">Google Apps Script</a></li>
                        <li>找到你的知音計畫專案</li>
                        <li>確認專案可以正常開啟</li>
                    </ol>
                </div>

                <!-- 步驟 2 -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-bold text-lg mb-3">步驟 2：重新部署服務</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>在 Apps Script 專案中，點擊 <strong>"部署"</strong> → <strong>"管理部署"</strong></li>
                        <li>刪除舊的部署（如果有）</li>
                        <li>點擊 <strong>"建立部署"</strong></li>
                        <li>設定類型為 <strong>"網路應用程式"</strong></li>
                        <li><strong>重要</strong>：執行身分選擇 <strong>"我"</strong></li>
                        <li><strong>重要</strong>：存取權限選擇 <strong>"任何人"</strong></li>
                        <li>點擊 <strong>"部署"</strong></li>
                    </ol>
                    
                    <div class="bg-green-50 p-3 rounded mt-3">
                        <p class="text-sm text-green-800"><strong>注意：</strong> 部署後會獲得新的 URL，需要更新前端代碼中的 APPS_SCRIPT_URL</p>
                    </div>
                </div>

                <!-- 步驟 3 -->
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-bold text-lg mb-3">步驟 3：授權應用程式</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>部署完成後，系統會要求授權</li>
                        <li>點擊 <strong>"授權存取"</strong></li>
                        <li>選擇你的 Google 帳戶</li>
                        <li>閱讀權限要求，點擊 <strong>"允許"</strong></li>
                        <li>如果看到 "此應用程式未經驗證" 警告：
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                <li>點擊 <strong>"進階"</strong></li>
                                <li>點擊 <strong>"前往 [專案名稱] (不安全)"</strong></li>
                                <li>點擊 <strong>"允許"</strong></li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <!-- 步驟 4 -->
                <div class="border-l-4 border-amber-500 pl-4">
                    <h3 class="font-bold text-lg mb-3">步驟 4：測試部署</h3>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                        <li>複製新的部署 URL</li>
                        <li>在瀏覽器中直接測試：<code class="bg-gray-100 px-2 py-1 rounded">新URL + ?action=test</code></li>
                        <li>應該會看到 JSON 回應而不是 403 錯誤</li>
                    </ol>
                </div>

                <!-- 步驟 5 -->
                <div class="border-l-4 border-red-500 pl-4">
                    <h3 class="font-bold text-lg mb-3">步驟 5：更新前端代碼</h3>
                    <p class="text-sm mb-3">將新的 URL 更新到以下檔案中的 <code class="bg-gray-100 px-2 py-1 rounded">APPS_SCRIPT_URL</code>：</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><code>frontend/admin/admin-dashboard-real.html</code></li>
                        <li><code>frontend/admin/manual-booking.html</code></li>
                        <li><code>frontend/admin/payouts-diagnostic.html</code></li>
                        <li><code>frontend/admin/commission-audit.html</code></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 常見問題 -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">❓ 常見問題與解決</h2>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-2">Q: 仍然出現 403 錯誤怎麼辦？</h3>
                    <p class="text-sm">A: 1) 確認執行身分是 "我"，不是 "存取網路應用程式的使用者" 2) 清除瀏覽器快取後重試 3) 等待 5-10 分鐘讓 Google 系統更新</p>
                </div>

                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-2">Q: 如何確認 Apps Script 正在運行？</h3>
                    <p class="text-sm">A: 在 Apps Script 編輯器中查看 "執行" 記錄，應該會看到成功的 API 調用記錄</p>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-bold mb-2">Q: 權限警告是否安全？</h3>
                    <p class="text-sm">A: 是的，這是因為這是你自己的應用程式，Google 無法驗證。點擊 "進階" → "前往應用程式" 是安全的</p>
                </div>
            </div>
        </div>

        <!-- 檢查清單 -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">✅ 修復檢查清單</h2>
            
            <div class="space-y-3">
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">重新部署 Apps Script 應用程式</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">設定執行身分為 "我"</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">設定存取權限為 "任何人"</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">完成應用程式授權</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">測試新的部署 URL</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">更新前端代碼中的 APPS_SCRIPT_URL</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-green-600">
                    <span class="text-sm">清除瀏覽器快取並重新測試</span>
                </label>
            </div>

            <div class="mt-6 p-4 bg-green-50 rounded-lg">
                <p class="text-sm text-green-800">
                    <strong>完成所有步驟後</strong>，返回管理後台重新載入數據，403 錯誤應該已解決！
                </p>
            </div>
        </div>
    </div>
</body>
</html>