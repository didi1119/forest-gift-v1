<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« - å¿«é€ŸåŠŸèƒ½æ¼”ç¤º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="feature-flags.js"></script>
    <style>
        body {
            font-family: 'system-ui', sans-serif;
            background-color: #FDFBF8;
            color: #5C544B;
        }
        .demo-card {
            background-color: #FFFFFF;
            border: 1px solid #EAE6E1;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .status-ok { color: #10B981; }
        .status-pending { color: #F59E0B; }
        .test-btn {
            background: #2E4B36;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            margin: 0.25rem;
        }
        .test-btn:hover {
            background: #1F3528;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-green-800 mb-6 text-center">éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« - ç³»çµ±åŠŸèƒ½æ¼”ç¤º</h1>
        
        <!-- 1. subid è¿½è¹¤æ¸¬è©¦ -->
        <div class="demo-card">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š subid è¿½è¹¤ç³»çµ±</h2>
            <p class="mb-3">ç•¶å‰ URL: <code id="current-url" class="bg-gray-100 px-2 py-1 rounded">loading...</code></p>
            <p class="mb-3">æª¢æ¸¬åˆ°çš„ subid: <span id="detected-subid" class="font-bold status-pending">æª¢æ¸¬ä¸­...</span></p>
            <p class="mb-3">localStorage ä¸­çš„ subid: <span id="stored-subid" class="font-bold">loading...</span></p>
            
            <div class="mt-4">
                <button class="test-btn" onclick="testSubidTracking('test123')">æ¸¬è©¦ subid: test123</button>
                <button class="test-btn" onclick="testSubidTracking('ambassador456')">æ¸¬è©¦ subid: ambassador456</button>
                <button class="test-btn" onclick="clearSubid()">æ¸…é™¤ subid</button>
            </div>
        </div>

        <!-- 2. Feature Flags æ¸¬è©¦ -->
        <div class="demo-card">
            <h2 class="text-xl font-semibold mb-4">ğŸš© Feature Flags ç³»çµ±</h2>
            <div id="feature-flags-status" class="mb-4">
                <p>è¼‰å…¥ä¸­...</p>
            </div>
            
            <div class="mt-4">
                <button class="test-btn" onclick="testFeatureFlag('EXTRA_FEATURE_1')">åˆ‡æ›ç¯€æ—¥æ¨¡å¼</button>
                <button class="test-btn" onclick="testFeatureFlag('ENHANCED_TRACKING')">åˆ‡æ›å¢å¼·è¿½è¹¤</button>
                <button class="test-btn" onclick="showAllFlags()">é¡¯ç¤ºæ‰€æœ‰æ——æ¨™</button>
                <button class="test-btn" onclick="resetAllFlags()">é‡è¨­æ‰€æœ‰æ——æ¨™</button>
            </div>
        </div>

        <!-- 3. localStorage è³‡æ–™æ¸¬è©¦ -->
        <div class="demo-card">
            <h2 class="text-xl font-semibold mb-4">ğŸ’¾ æœ¬åœ°å„²å­˜æ¸¬è©¦</h2>
            <div id="storage-info"></div>
            
            <div class="mt-4">
                <button class="test-btn" onclick="testLocalStorage()">æ¸¬è©¦è³‡æ–™å„²å­˜</button>
                <button class="test-btn" onclick="viewStoredData()">æŸ¥çœ‹å„²å­˜è³‡æ–™</button>
                <button class="test-btn" onclick="clearStoredData()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

        <!-- 4. äº‹ä»¶è¿½è¹¤æ¨¡æ“¬ -->
        <div class="demo-card">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ˆ äº‹ä»¶è¿½è¹¤æ¨¡æ“¬</h2>
            <p class="mb-3">è¿½è¹¤æ—¥èªŒï¼š</p>
            <div id="tracking-log" class="bg-gray-50 p-3 rounded min-h-[100px] font-mono text-sm max-h-40 overflow-y-auto"></div>
            
            <div class="mt-4">
                <button class="test-btn" onclick="simulateEvent('card_draw', {card: 'éå»'})">æ¨¡æ“¬æŠ½å¡äº‹ä»¶</button>
                <button class="test-btn" onclick="simulateEvent('playlist_play', {playlist: 'healing'})">æ¨¡æ“¬éŸ³æ¨‚æ’­æ”¾</button>
                <button class="test-btn" onclick="simulateEvent('journal_submit', {day: 1, word_count: 150})">æ¨¡æ“¬é€±è¨˜æäº¤</button>
                <button class="test-btn" onclick="clearTrackingLog()">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>

        <!-- 5. ç³»çµ±æª¢æŸ¥çµæœ -->
        <div class="demo-card">
            <h2 class="text-xl font-semibold mb-4">âœ… ç³»çµ±å®Œæ•´æ€§æª¢æŸ¥</h2>
            <div id="system-status">
                <p class="status-pending">åŸ·è¡Œæª¢æŸ¥ä¸­...</p>
            </div>
            <button class="test-btn" onclick="runSystemCheck()">é‡æ–°æª¢æŸ¥</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æª¢æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            updateUrlDisplay();
            updateSubidDisplay();
            updateFeatureFlagsDisplay();
            runSystemCheck();
            
            // ç›£è½ feature flag è®Šæ›´äº‹ä»¶
            document.addEventListener('featureFlagChanged', function(event) {
                logTracking(`Feature Flag è®Šæ›´: ${event.detail.flagName} = ${event.detail.enabled}`);
                updateFeatureFlagsDisplay();
            });
        });

        // subid è¿½è¹¤åŠŸèƒ½
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function getSubid() {
            let subid = getUrlParameter('subid') || getUrlParameter('pid');
            if (!subid) {
                subid = localStorage.getItem('forest_subid');
            }
            if (subid) {
                localStorage.setItem('forest_subid', subid);
            }
            return subid;
        }

        function updateUrlDisplay() {
            document.getElementById('current-url').textContent = window.location.href;
        }

        function updateSubidDisplay() {
            const subid = getSubid();
            const detectedEl = document.getElementById('detected-subid');
            const storedEl = document.getElementById('stored-subid');
            
            if (subid) {
                detectedEl.textContent = subid;
                detectedEl.className = 'font-bold status-ok';
                storedEl.textContent = localStorage.getItem('forest_subid') || 'ç„¡';
            } else {
                detectedEl.textContent = 'æœªæª¢æ¸¬åˆ°';
                detectedEl.className = 'font-bold status-pending';
                storedEl.textContent = localStorage.getItem('forest_subid') || 'ç„¡';
            }
        }

        function testSubidTracking(testSubid) {
            // æ¨¡æ“¬ URL åƒæ•¸
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('subid', testSubid);
            window.history.replaceState({}, '', newUrl);
            
            updateUrlDisplay();
            updateSubidDisplay();
            logTracking(`æ¸¬è©¦ subid: ${testSubid}`);
        }

        function clearSubid() {
            localStorage.removeItem('forest_subid');
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.delete('subid');
            newUrl.searchParams.delete('pid');
            window.history.replaceState({}, '', newUrl);
            
            updateUrlDisplay();
            updateSubidDisplay();
            logTracking('å·²æ¸…é™¤ subid');
        }

        // Feature Flags æ¸¬è©¦
        function updateFeatureFlagsDisplay() {
            if (typeof window.featureFlags === 'undefined') {
                document.getElementById('feature-flags-status').innerHTML = 
                    '<p class="status-pending">Feature Flags ç³»çµ±æœªè¼‰å…¥</p>';
                return;
            }

            const flags = window.featureFlags.getAllFlags();
            let html = '<table class="w-full text-sm"><tr><th class="text-left">æ——æ¨™</th><th class="text-left">ç‹€æ…‹</th></tr>';
            
            for (const [name, enabled] of Object.entries(flags)) {
                const status = enabled ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨';
                const statusClass = enabled ? 'status-ok' : 'status-pending';
                html += `<tr><td class="py-1">${name}</td><td class="py-1 ${statusClass}">${status}</td></tr>`;
            }
            html += '</table>';
            
            document.getElementById('feature-flags-status').innerHTML = html;
        }

        function testFeatureFlag(flagName) {
            if (typeof window.featureFlags !== 'undefined') {
                const result = window.featureFlags.toggle(flagName);
                logTracking(`${flagName} å·²${result ? 'å•Ÿç”¨' : 'åœç”¨'}`);
            }
        }

        function showAllFlags() {
            if (typeof window.debugFeatureFlags !== 'undefined') {
                console.log('æ‰€æœ‰ Feature Flags:', window.debugFeatureFlags.list());
                logTracking('å·²åœ¨ console é¡¯ç¤ºæ‰€æœ‰æ——æ¨™');
            }
        }

        function resetAllFlags() {
            if (typeof window.featureFlags !== 'undefined') {
                window.featureFlags.reset();
                logTracking('æ‰€æœ‰æ——æ¨™å·²é‡è¨­ç‚ºé è¨­å€¼');
            }
        }

        // localStorage æ¸¬è©¦
        function testLocalStorage() {
            const testData = {
                test_key: 'test_value',
                timestamp: new Date().toISOString(),
                random: Math.random()
            };
            
            localStorage.setItem('forest_test_data', JSON.stringify(testData));
            logTracking('æ¸¬è©¦è³‡æ–™å·²å„²å­˜åˆ° localStorage');
            viewStoredData();
        }

        function viewStoredData() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('forest_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }
            
            const info = document.getElementById('storage-info');
            if (Object.keys(allData).length === 0) {
                info.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„å„²å­˜è³‡æ–™</p>';
            } else {
                let html = '<h4 class="font-medium mb-2">å„²å­˜çš„è³‡æ–™ï¼š</h4><ul class="text-sm">';
                for (const [key, value] of Object.entries(allData)) {
                    const shortValue = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    html += `<li><strong>${key}:</strong> ${shortValue}</li>`;
                }
                html += '</ul>';
                info.innerHTML = html;
            }
        }

        function clearStoredData() {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('forest_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            logTracking(`å·²æ¸…é™¤ ${keysToRemove.length} é …å„²å­˜è³‡æ–™`);
            viewStoredData();
            updateSubidDisplay();
            updateFeatureFlagsDisplay();
        }

        // äº‹ä»¶è¿½è¹¤æ¨¡æ“¬
        function simulateEvent(eventType, data = {}) {
            const subid = getSubid();
            const eventData = {
                subid: subid || 'no-subid',
                timestamp: new Date().toISOString(),
                ...data
            };
            
            // æ¨¡æ“¬ GA4 è¿½è¹¤ï¼ˆå¯¦éš›æœƒå‘¼å« gtagï¼‰
            console.log(`GA4 Event: ${eventType}`, eventData);
            logTracking(`äº‹ä»¶: ${eventType} | è³‡æ–™: ${JSON.stringify(eventData)}`);
        }

        function logTracking(message) {
            const log = document.getElementById('tracking-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        function clearTrackingLog() {
            document.getElementById('tracking-log').innerHTML = '';
        }

        // ç³»çµ±å®Œæ•´æ€§æª¢æŸ¥
        function runSystemCheck() {
            const checks = [
                {
                    name: 'Feature Flags ç³»çµ±',
                    test: () => typeof window.featureFlags !== 'undefined' && typeof window.debugFeatureFlags !== 'undefined',
                    description: 'æª¢æŸ¥ Feature Flags é¡åˆ¥å’Œé–‹ç™¼å·¥å…·æ˜¯å¦è¼‰å…¥'
                },
                {
                    name: 'localStorage æ”¯æ´',
                    test: () => typeof Storage !== 'undefined',
                    description: 'æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ localStorage'
                },
                {
                    name: 'subid è¿½è¹¤åŠŸèƒ½',
                    test: () => typeof getSubid === 'function' && typeof getUrlParameter === 'function',
                    description: 'æª¢æŸ¥ subid è¿½è¹¤ç›¸é—œå‡½å¼æ˜¯å¦æ­£å¸¸'
                },
                {
                    name: 'URL API æ”¯æ´',
                    test: () => typeof URL !== 'undefined' && typeof URLSearchParams !== 'undefined',
                    description: 'æª¢æŸ¥ URL è™•ç† API æ˜¯å¦å¯ç”¨'
                },
                {
                    name: 'JSON è™•ç†',
                    test: () => {
                        try {
                            JSON.parse('{"test": true}');
                            JSON.stringify({test: true});
                            return true;
                        } catch {
                            return false;
                        }
                    },
                    description: 'æª¢æŸ¥ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–åŠŸèƒ½'
                }
            ];

            let html = '<h4 class="font-medium mb-3">æª¢æŸ¥çµæœï¼š</h4><div class="space-y-2">';
            let allPassed = true;

            checks.forEach(check => {
                const passed = check.test();
                allPassed = allPassed && passed;
                const status = passed ? 'âœ…' : 'âŒ';
                const statusClass = passed ? 'status-ok' : 'text-red-600';
                html += `<div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span>${check.name}</span>
                    <span class="${statusClass}">${status}</span>
                </div>`;
            });

            html += '</div>';
            html += `<div class="mt-4 p-3 rounded ${allPassed ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}">
                <strong>${allPassed ? 'âœ… æ‰€æœ‰æª¢æŸ¥é€šé' : 'âŒ éƒ¨åˆ†æª¢æŸ¥å¤±æ•—'}</strong>
            </div>`;

            document.getElementById('system-status').innerHTML = html;
        }
    </script>
</body>
</html>