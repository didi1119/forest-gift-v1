<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payouts è¡¨æ ¼è¨ºæ–·å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .json-output { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; font-family: 'Courier New', monospace; white-space: pre-wrap; }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">ğŸ”§ Payouts è¡¨æ ¼è¨ºæ–·å·¥å…·</h1>
            <p class="text-lg text-stone-600">æª¢æŸ¥å’Œä¿®å¾©çµç®—è¨˜éŒ„è¡¨æ ¼çš„è³‡æ–™çµæ§‹å•é¡Œ</p>
        </header>

        <!-- è¨ºæ–·çµæœå€åŸŸ -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ğŸ“‹ è¨ºæ–·çµæœ</h2>
            
            <div class="space-y-4 mb-6">
                <button onclick="runDiagnosis()" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    ğŸ” é–‹å§‹è¨ºæ–·
                </button>
                
                <button onclick="repairPayouts()" id="repairButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-300 disabled:bg-gray-400" disabled>
                    ğŸ”§ ä¿®å¾©è¡¨æ ¼
                </button>
            </div>

            <div id="diagnosisResult" class="hidden">
                <h3 class="text-lg font-semibold text-stone-800 mb-4">è¨ºæ–·å ±å‘Š</h3>
                <div id="diagnosisOutput" class="json-output text-sm"></div>
            </div>
        </div>

        <!-- ä¿®å¾©çµæœå€åŸŸ -->
        <div id="repairResultSection" class="brand-card p-8 hidden">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ğŸ› ï¸ ä¿®å¾©çµæœ</h2>
            <div id="repairResult" class="json-output text-sm"></div>
        </div>

        <!-- èªªæ˜å€åŸŸ -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">â„¹ï¸ ä½¿ç”¨èªªæ˜</h2>
            <div class="space-y-4 text-stone-700">
                <p><strong>å•é¡ŒèƒŒæ™¯ï¼š</strong> çµç®—ç®¡ç†é¡¯ç¤ºè³‡æ–™ä¸æ­£ç¢ºï¼Œç„¡æ³•å–æ¶ˆçµç®—ï¼Œä¸»è¦æ˜¯å› ç‚º Google Sheets çš„æ¬„ä½çµæ§‹èˆ‡ç¨‹å¼ç¢¼é æœŸä¸åŒ¹é…ã€‚</p>
                
                <div>
                    <strong>é æœŸçš„è¡¨æ ¼çµæ§‹ï¼š</strong>
                    <ul class="list-disc list-inside mt-2 ml-4 space-y-1 text-sm">
                        <li>Column A: IDï¼ˆå”¯ä¸€è­˜åˆ¥ç¢¼ï¼‰</li>
                        <li>Column B: partner_codeï¼ˆå¤§ä½¿ä»£ç¢¼ï¼‰</li>
                        <li>Column C: payout_typeï¼ˆçµç®—é¡å‹ï¼šCASH/ACCOMMODATIONï¼‰</li>
                        <li>Column D: amountï¼ˆé‡‘é¡ï¼‰</li>
                        <li>Column E: related_booking_idsï¼ˆç›¸é—œè¨‚æˆ¿IDï¼‰</li>
                        <li>Column F: payout_methodï¼ˆçµç®—æ–¹å¼ï¼‰</li>
                        <li>Column G: payout_statusï¼ˆçµç®—ç‹€æ…‹ï¼‰</li>
                        <li>å…¶ä»–æ¬„ä½ï¼šæ—¥æœŸã€å‚™è¨»ç­‰</li>
                    </ul>
                </div>
                
                <p><strong>ä½¿ç”¨æ­¥é©Ÿï¼š</strong></p>
                <ol class="list-decimal list-inside ml-4 space-y-1">
                    <li>é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€æª¢æŸ¥ç•¶å‰è¡¨æ ¼çµæ§‹</li>
                    <li>æŸ¥çœ‹è¨ºæ–·å ±å‘Šï¼Œäº†è§£å•é¡Œæ‰€åœ¨</li>
                    <li>å¦‚æœéœ€è¦ä¿®å¾©ï¼Œé»æ“Šã€Œä¿®å¾©è¡¨æ ¼ã€</li>
                    <li>ä¿®å¾©å®Œæˆå¾Œï¼Œé‡æ–°æª¢æŸ¥çµç®—ç®¡ç†åŠŸèƒ½</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„ iframe ç”¨æ–¼æ¥æ”¶è¡¨å–®å›æ‡‰ -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';

        async function runDiagnosis() {
            const button = document.querySelector('button[onclick="runDiagnosis()"]');
            const originalText = button.textContent;
            button.textContent = 'è¨ºæ–·ä¸­...';
            button.disabled = true;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=diagnose_payouts'
                });

                const result = await response.json();
                
                document.getElementById('diagnosisResult').classList.remove('hidden');
                document.getElementById('diagnosisOutput').textContent = JSON.stringify(result, null, 2);
                
                // å¦‚æœéœ€è¦ä¿®å¾©ï¼Œå•Ÿç”¨ä¿®å¾©æŒ‰éˆ•
                if (result.success && result.repair_needed) {
                    document.getElementById('repairButton').disabled = false;
                }

                showToast(result.success ? 'âœ… è¨ºæ–·å®Œæˆ' : 'âŒ è¨ºæ–·å¤±æ•—ï¼š' + result.error);

            } catch (error) {
                console.error('è¨ºæ–·éŒ¯èª¤:', error);
                document.getElementById('diagnosisOutput').textContent = 'éŒ¯èª¤: ' + error.message;
                showToast('âŒ è¨ºæ–·å¤±æ•—ï¼š' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function repairPayouts() {
            const button = document.getElementById('repairButton');
            const originalText = button.textContent;
            button.textContent = 'ä¿®å¾©ä¸­...';
            button.disabled = true;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=repair_payouts'
                });

                const result = await response.json();
                
                document.getElementById('repairResultSection').classList.remove('hidden');
                document.getElementById('repairResult').textContent = JSON.stringify(result, null, 2);
                
                showToast(result.success ? 'âœ… ä¿®å¾©å®Œæˆ' : 'âŒ ä¿®å¾©å¤±æ•—ï¼š' + result.error);

                // ä¿®å¾©å®Œæˆå¾Œï¼Œå»ºè­°é‡æ–°è¨ºæ–·
                if (result.success) {
                    setTimeout(() => {
                        if (confirm('ä¿®å¾©å®Œæˆï¼æ˜¯å¦è¦é‡æ–°è¨ºæ–·é©—è­‰çµæœï¼Ÿ')) {
                            runDiagnosis();
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('ä¿®å¾©éŒ¯èª¤:', error);
                document.getElementById('repairResult').textContent = 'éŒ¯èª¤: ' + error.message;
                showToast('âŒ ä¿®å¾©å¤±æ•—ï¼š' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            if (message.includes('âŒ')) {
                toast.className = toast.className.replace('bg-green-600', 'bg-red-600');
            }
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>