<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ºæ–·æ¸¬è©¦ - æŸ¥æ‰¾å•é¡Œæ ¹æº</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">è¨ºæ–·æ¸¬è©¦ - æŸ¥æ‰¾å•é¡Œæ ¹æº</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Google Apps Script URL</label>
                <input type="text" id="scriptUrl" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                       value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
            </div>
            
            <button onclick="runDiagnosticTest()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold">
                ğŸ” é–‹å§‹è¨ºæ–·
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">è¨ºæ–·çµæœ</h2>
            <div id="results" class="space-y-3">
                <p class="text-gray-500">é»æ“Šã€Œé–‹å§‹è¨ºæ–·ã€ä¾†åŸ·è¡Œæ¸¬è©¦...</p>
            </div>
        </div>
    </div>

    <script>
        const TEST_CODE = 'DIAG_' + Date.now();
        let testBookingId = null;
        
        async function runDiagnosticTest() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            try {
                // Step 1: å‰µå»ºæ¸¬è©¦å¤§ä½¿
                addResult('ğŸ“ Step 1: å‰µå»ºæ¸¬è©¦å¤§ä½¿ï¼ˆåˆå§‹10000é»ï¼‰', 'info');
                
                const createPartnerParams = new URLSearchParams({
                    action: 'create_partner',
                    partner_code: TEST_CODE,
                    partner_name: 'è¨ºæ–·æ¸¬è©¦å¤§ä½¿',
                    partner_level: 'LV1_INSIDER',
                    contact_phone: '0999888777',
                    contact_email: 'diag@test.com',
                    commission_preference: 'ACCOMMODATION',
                    available_points: '10000',
                    points_used: '0',
                    successful_referrals: '0',
                    bank_account: '9999888877776666'
                });
                
                const createPartnerResponse = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: createPartnerParams.toString()
                });
                
                const partnerResult = await createPartnerResponse.json();
                
                if (!partnerResult.success) {
                    addResult(`âŒ å‰µå»ºå¤§ä½¿å¤±æ•—: ${partnerResult.error}`, 'error');
                    return;
                }
                
                addResult('âœ… å¤§ä½¿å‰µå»ºæˆåŠŸ', 'success');
                
                // Step 2: å–å¾—åˆå§‹ç‹€æ…‹
                addResult('ğŸ“ Step 2: æª¢æŸ¥åˆå§‹ç‹€æ…‹', 'info');
                await delay(1000);
                
                const initialData = await getPartnerData(scriptUrl, TEST_CODE);
                if (!initialData) {
                    addResult('âŒ ç„¡æ³•å–å¾—åˆå§‹è³‡æ–™', 'error');
                    return;
                }
                
                addResult(`åˆå§‹ç‹€æ…‹:`, 'data');
                addResult(`â€¢ available_points: ${initialData.available_points}`, 'data');
                addResult(`â€¢ points_used: ${initialData.points_used}`, 'data');
                addResult(`â€¢ successful_referrals: ${initialData.successful_referrals}`, 'data');
                addResult(`â€¢ partner_level: ${initialData.partner_level || initialData.level}`, 'data');
                
                // Step 3: å‰µå»ºè¨‚æˆ¿ï¼ˆä½¿ç”¨è¡¨å–®æ–¹å¼é¿å… CORSï¼‰
                addResult('ğŸ“ Step 3: å‰µå»ºè¨‚æˆ¿ï¼ˆæ¨è–¦è¨‚æˆ¿ï¼‰', 'info');
                
                testBookingId = 'BOOK_' + Date.now();
                
                // ä½¿ç”¨ iframe å’Œè¡¨å–®æäº¤
                const iframe = document.createElement('iframe');
                iframe.name = 'submitFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = scriptUrl;
                form.target = 'submitFrame';
                form.style.display = 'none';
                
                const bookingData = {
                    action: 'create_booking',
                    partner_code: TEST_CODE,
                    guest_name: 'æ¸¬è©¦æˆ¿å®¢_' + Date.now(),
                    guest_phone: '0911' + Math.floor(Math.random() * 1000000),
                    checkin_date: '2024-12-25',
                    checkout_date: '2024-12-27',
                    room_price: '5000',
                    booking_source: 'REFERRAL',
                    notes: 'è¨ºæ–·æ¸¬è©¦è¨‚æˆ¿'
                };
                
                Object.keys(bookingData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = bookingData[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
                
                // ç­‰å¾…æäº¤å®Œæˆ
                await delay(3000);
                
                // æŸ¥æ‰¾è¨‚æˆ¿
                const bookings = await getBookings(scriptUrl, TEST_CODE);
                if (bookings && bookings.length > 0) {
                    testBookingId = bookings[0].id;
                    addResult(`âœ… è¨‚æˆ¿å‰µå»ºæˆåŠŸï¼ŒID: ${testBookingId}`, 'success');
                } else {
                    addResult('âš ï¸ è¨‚æˆ¿å¯èƒ½å¤±æ•—ï¼Œç¹¼çºŒæ¸¬è©¦...', 'warning');
                }
                
                // Step 4: ç¢ºèªå…¥ä½
                addResult('ğŸ“ Step 4: ç¢ºèªå…¥ä½å®Œæˆ', 'info');
                
                if (testBookingId) {
                    const confirmForm = document.createElement('form');
                    confirmForm.method = 'POST';
                    confirmForm.action = scriptUrl;
                    confirmForm.target = 'submitFrame';
                    confirmForm.style.display = 'none';
                    
                    const confirmData = {
                        action: 'confirm_checkin_completion',
                        booking_id: testBookingId,
                        confirmed_by: 'diagnostic_test'
                    };
                    
                    Object.keys(confirmData).forEach(key => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = confirmData[key];
                        confirmForm.appendChild(input);
                    });
                    
                    document.body.appendChild(confirmForm);
                    confirmForm.submit();
                    
                    await delay(3000);
                    addResult('âœ… ç¢ºèªå…¥ä½è«‹æ±‚å·²ç™¼é€', 'success');
                }
                
                // Step 5: æª¢æŸ¥æœ€çµ‚ç‹€æ…‹
                addResult('ğŸ“ Step 5: æª¢æŸ¥æœ€çµ‚ç‹€æ…‹', 'info');
                await delay(2000);
                
                const finalData = await getPartnerData(scriptUrl, TEST_CODE);
                if (!finalData) {
                    addResult('âŒ ç„¡æ³•å–å¾—æœ€çµ‚è³‡æ–™', 'error');
                    return;
                }
                
                addResult(`æœ€çµ‚ç‹€æ…‹:`, 'data');
                addResult(`â€¢ available_points: ${finalData.available_points}`, 'data');
                addResult(`â€¢ points_used: ${finalData.points_used}`, 'data');
                addResult(`â€¢ successful_referrals: ${finalData.successful_referrals}`, 'data');
                addResult(`â€¢ total_commission_earned: ${finalData.total_commission_earned}`, 'data');
                
                // åˆ†æçµæœ
                addResult('ğŸ“Š åˆ†æçµæœ:', 'header');
                
                const pointsChange = finalData.available_points - initialData.available_points;
                const referralsChange = finalData.successful_referrals - initialData.successful_referrals;
                
                if (pointsChange > 0) {
                    addResult(`âœ… é»æ•¸å¢åŠ äº† ${pointsChange} é»ï¼ˆä½£é‡‘æ­£ç¢ºè¨ˆç®—ï¼‰`, 'success');
                } else if (pointsChange === 0) {
                    addResult(`âš ï¸ é»æ•¸æ²’æœ‰è®ŠåŒ–ï¼ˆä½£é‡‘å¯èƒ½æ²’æœ‰è¨ˆç®—ï¼‰`, 'warning');
                } else {
                    addResult(`âŒ é»æ•¸æ¸›å°‘äº† ${Math.abs(pointsChange)} é»ï¼ˆç•°å¸¸ï¼‰`, 'error');
                }
                
                if (referralsChange > 0) {
                    addResult(`âœ… æˆåŠŸæ¨è–¦æ•¸å¢åŠ äº† ${referralsChange}`, 'success');
                } else {
                    addResult(`âš ï¸ æˆåŠŸæ¨è–¦æ•¸æ²’æœ‰è®ŠåŒ–`, 'warning');
                }
                
                // é æœŸä½£é‡‘
                const expectedCommission = 1000; // LV1 ACCOMMODATION
                const expectedFirstBonus = (initialData.successful_referrals === 0) ? 1500 : 0;
                const expectedTotal = expectedCommission + expectedFirstBonus;
                
                addResult(`é æœŸä½£é‡‘: ${expectedCommission} + é¦–æ¬¡çå‹µ: ${expectedFirstBonus} = ${expectedTotal}`, 'info');
                
                if (Math.abs(pointsChange - expectedTotal) < 1) {
                    addResult('ğŸ‰ ä½£é‡‘è¨ˆç®—å®Œå…¨æ­£ç¢ºï¼', 'success');
                } else {
                    addResult(`âš ï¸ ä½£é‡‘è¨ˆç®—å¯èƒ½æœ‰èª¤å·®: å¯¦éš› ${pointsChange} vs é æœŸ ${expectedTotal}`, 'warning');
                }
                
                // æª¢æŸ¥è¨‚æˆ¿ç‹€æ…‹
                const finalBookings = await getBookings(scriptUrl, TEST_CODE);
                if (finalBookings && finalBookings.length > 0) {
                    const booking = finalBookings[0];
                    addResult('è¨‚æˆ¿ç‹€æ…‹:', 'header');
                    addResult(`â€¢ stay_status: ${booking.stay_status}`, 'data');
                    addResult(`â€¢ commission_status: ${booking.commission_status}`, 'data');
                    addResult(`â€¢ commission_amount: ${booking.commission_amount}`, 'data');
                    addResult(`â€¢ commission_type: ${booking.commission_type}`, 'data');
                }
                
            } catch (error) {
                addResult(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function getPartnerData(scriptUrl, partnerCode) {
            const response = await fetch(`${scriptUrl}?action=get_all_data`);
            const data = await response.json();
            
            if (data.success && data.data.partners) {
                return data.data.partners.find(p => p.partner_code === partnerCode);
            }
            return null;
        }
        
        async function getBookings(scriptUrl, partnerCode) {
            const response = await fetch(`${scriptUrl}?action=get_all_data`);
            const data = await response.json();
            
            if (data.success && data.data.bookings) {
                return data.data.bookings.filter(b => b.partner_code === partnerCode);
            }
            return [];
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const colors = {
                success: 'text-green-600 font-semibold',
                error: 'text-red-600 font-semibold',
                warning: 'text-yellow-600',
                info: 'text-blue-600',
                data: 'text-gray-700 ml-4',
                header: 'text-purple-600 font-bold text-lg mt-4'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || colors.info;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }
    </script>
</body>
</html>