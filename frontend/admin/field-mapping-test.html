<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬„ä½å°æ‡‰æ¸¬è©¦å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ” æ¬„ä½å°æ‡‰æ¸¬è©¦å·¥å…·</h1>
        
        <!-- æ¸¬è©¦æŒ‰éˆ• -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">æ¸¬è©¦æ§åˆ¶å°</h2>
            <div class="flex gap-4">
                <button onclick="loadPartnerData()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    è¼‰å…¥ Partners è³‡æ–™
                </button>
                <button onclick="checkFieldMapping()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    æª¢æŸ¥æ¬„ä½å°æ‡‰
                </button>
                <button onclick="clearResults()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    æ¸…é™¤çµæœ
                </button>
            </div>
        </div>
        
        <!-- çµæœé¡¯ç¤ºå€ -->
        <div id="results" class="space-y-4"></div>
    </div>
    
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        let partnersData = [];
        
        function log(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const typeClass = {
                'info': 'bg-blue-50 border-blue-200',
                'success': 'bg-green-50 border-green-200',
                'warning': 'bg-yellow-50 border-yellow-200',
                'error': 'bg-red-50 border-red-200'
            }[type];
            
            const html = `
                <div class="bg-white rounded-lg shadow p-6 border-2 ${typeClass}">
                    <h3 class="text-lg font-bold mb-2">${title}</h3>
                    <pre class="text-sm overflow-x-auto">${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
                </div>
            `;
            resultsDiv.innerHTML += html;
        }
        
        async function loadPartnerData() {
            log('è¼‰å…¥è³‡æ–™', 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥ Partners è³‡æ–™...', 'info');
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const result = await response.json();
                
                if (result.success !== false && result.data && result.data.partners) {
                    partnersData = result.data.partners;
                    log('è¼‰å…¥æˆåŠŸ', `æˆåŠŸè¼‰å…¥ ${partnersData.length} ä½å¤¥ä¼´è³‡æ–™`, 'success');
                    
                    // é¡¯ç¤ºç¬¬ä¸€ä½å¤¥ä¼´çš„è³‡æ–™çµæ§‹
                    if (partnersData.length > 0) {
                        log('ç¬¬ä¸€ä½å¤¥ä¼´è³‡æ–™ç¯„ä¾‹', partnersData[0], 'info');
                    }
                } else {
                    log('è¼‰å…¥å¤±æ•—', result.error || 'ç„¡æ³•è¼‰å…¥è³‡æ–™', 'error');
                }
            } catch (error) {
                log('è¼‰å…¥éŒ¯èª¤', error.message, 'error');
            }
        }
        
        function checkFieldMapping() {
            if (partnersData.length === 0) {
                log('éŒ¯èª¤', 'è«‹å…ˆè¼‰å…¥ Partners è³‡æ–™', 'error');
                return;
            }
            
            log('é–‹å§‹æª¢æŸ¥æ¬„ä½å°æ‡‰', 'åˆ†ææ‰€æœ‰å¤¥ä¼´çš„æ¬„ä½åç¨±...', 'info');
            
            // æ”¶é›†æ‰€æœ‰æ¬„ä½åç¨±
            const fieldStats = {};
            const fieldExamples = {};
            
            partnersData.forEach(partner => {
                Object.keys(partner).forEach(field => {
                    if (!fieldStats[field]) {
                        fieldStats[field] = 0;
                        fieldExamples[field] = [];
                    }
                    fieldStats[field]++;
                    if (fieldExamples[field].length < 3 && partner[field]) {
                        fieldExamples[field].push(partner[field]);
                    }
                });
            });
            
            // æª¢æŸ¥æ–°èˆŠæ¬„ä½å°æ‡‰
            const fieldMapping = {
                'å§“åæ¬„ä½': {
                    'partner_name (æ–°)': fieldStats['partner_name'] || 0,
                    'name (èˆŠ)': fieldStats['name'] || 0,
                    'ç¯„ä¾‹': fieldExamples['partner_name'] || fieldExamples['name']
                },
                'ç­‰ç´šæ¬„ä½': {
                    'partner_level (æ–°)': fieldStats['partner_level'] || 0,
                    'level (èˆŠ)': fieldStats['level'] || 0,
                    'ç¯„ä¾‹': fieldExamples['partner_level'] || fieldExamples['level']
                },
                'é›»è©±æ¬„ä½': {
                    'contact_phone (æ–°)': fieldStats['contact_phone'] || 0,
                    'phone (èˆŠ)': fieldStats['phone'] || 0,
                    'ç¯„ä¾‹': fieldExamples['contact_phone'] || fieldExamples['phone']
                },
                'Emailæ¬„ä½': {
                    'contact_email (æ–°)': fieldStats['contact_email'] || 0,
                    'email (èˆŠ)': fieldStats['email'] || 0,
                    'ç¯„ä¾‹': fieldExamples['contact_email'] || fieldExamples['email']
                },
                'æˆåŠŸæ¨è–¦æ•¸': {
                    'successful_referrals (æ–°)': fieldStats['successful_referrals'] || 0,
                    'total_successful_referrals (èˆŠ)': fieldStats['total_successful_referrals'] || 0,
                    'ç¯„ä¾‹': fieldExamples['successful_referrals'] || fieldExamples['total_successful_referrals']
                },
                'å¹´åº¦é€²åº¦': {
                    'yearly_referrals (æ–°)': fieldStats['yearly_referrals'] || 0,
                    'level_progress (èˆŠ)': fieldStats['level_progress'] || 0,
                    'ç¯„ä¾‹': fieldExamples['yearly_referrals'] || fieldExamples['level_progress']
                }
            };
            
            log('æ¬„ä½å°æ‡‰åˆ†æçµæœ', fieldMapping, 'warning');
            
            // æª¢æŸ¥é—œéµæ¬„ä½æ˜¯å¦å­˜åœ¨
            const criticalFields = ['partner_code', 'available_points', 'points_used', 'pending_commission'];
            const missingFields = [];
            
            criticalFields.forEach(field => {
                if (!fieldStats[field] || fieldStats[field] < partnersData.length) {
                    missingFields.push(`${field} (${fieldStats[field] || 0}/${partnersData.length})`);
                }
            });
            
            if (missingFields.length > 0) {
                log('ç¼ºå°‘é—œéµæ¬„ä½', missingFields.join(', '), 'error');
            } else {
                log('é—œéµæ¬„ä½æª¢æŸ¥', 'æ‰€æœ‰é—œéµæ¬„ä½éƒ½å­˜åœ¨', 'success');
            }
            
            // é¡¯ç¤ºæ‰€æœ‰æ¬„ä½çµ±è¨ˆ
            log('å®Œæ•´æ¬„ä½çµ±è¨ˆ', fieldStats, 'info');
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            log('æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'é»æ“Šã€Œè¼‰å…¥ Partners è³‡æ–™ã€é–‹å§‹æ¸¬è©¦', 'success');
        });
    </script>
</body>
</html>