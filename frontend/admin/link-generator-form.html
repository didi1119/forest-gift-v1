<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知音大使專屬連結生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .forest-gradient {
            background: linear-gradient(135deg, #1e3c1e 0%, #2d5a2d 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .link-display {
            word-break: break-all;
            background: #f0f9f0;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #d0e8d0;
            font-family: monospace;
            font-size: 14px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-50 min-h-screen">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="forest-gradient text-white p-8 rounded-2xl mb-8 card-shadow">
            <h1 class="text-3xl font-bold mb-2">🌲 知音大使專屬連結生成器</h1>
            <p class="text-green-100">為每位大使生成專屬的推薦連結，開啟森林旅程</p>
        </div>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl p-8 mb-6 card-shadow">
            <h2 class="text-2xl font-bold text-green-800 mb-6">📝 大使資訊</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Basic Info -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        夥伴代碼 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="例如：FOREST001" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        夥伴姓名 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="partnerName" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="例如：林小森" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email
                    </label>
                    <input type="email" id="partnerEmail" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="例如：partner@example.com">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        聯絡電話 <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="partnerPhone" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="例如：0912345678" required>
                </div>
            </div>

            <!-- Coupon Info -->
            <div class="mt-6 p-6 bg-amber-50 rounded-lg border-2 border-amber-200">
                <h3 class="text-lg font-bold text-amber-800 mb-4">🎫 專屬優惠券設定</h3>
                <p class="text-sm text-amber-700 mb-4">
                    ⚠️ 重要：請先到 LINE 官方帳號後台建立專屬優惠券，然後將連結貼在下方
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            優惠券代碼
                        </label>
                        <input type="text" id="couponCode" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：FOREST20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            LINE 優惠券連結 <span class="text-red-500">*</span>
                        </label>
                        <input type="url" id="couponUrl" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="https://lin.ee/xxxxx" required>
                    </div>
                </div>
            </div>

            <!-- Bank Info -->
            <div class="mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">🏦 銀行資訊（選填）</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">銀行名稱</label>
                        <input type="text" id="bankName" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：台灣銀行">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">銀行代碼</label>
                        <input type="text" id="bankCode" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：004">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分行名稱</label>
                        <input type="text" id="bankBranch" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：信義分行">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">戶名</label>
                        <input type="text" id="bankAccountName" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：林小森">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">帳號</label>
                        <input type="text" id="bankAccountNumber" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="例如：1234567890123">
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button onclick="generateLinks()" 
                    class="mt-8 w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:from-green-700 hover:to-emerald-700 transition duration-200 shadow-lg">
                🔗 生成專屬連結
            </button>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="bg-white rounded-2xl p-8 card-shadow hidden">
            <h2 class="text-2xl font-bold text-green-800 mb-6">✨ 生成結果</h2>
            
            <!-- Links Display -->
            <div class="space-y-4 mb-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">🏠 主頁連結（短網址）</h3>
                    <div class="link-display" id="landingLink">生成中...</div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">🎁 優惠券連結（短網址）</h3>
                    <div class="link-display" id="couponLink">生成中...</div>
                </div>
            </div>

            <!-- Share Template -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-2">📱 分享範本</h3>
                <textarea id="shareTemplate" class="w-full h-48 p-4 border border-gray-300 rounded-lg" readonly>生成中...</textarea>
                <button onclick="copyShareTemplate()" 
                        class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                    📋 複製分享文案
                </button>
            </div>

            <!-- Save Button -->
            <button onclick="saveToSheets()" 
                    class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:from-amber-600 hover:to-orange-600 transition duration-200 shadow-lg">
                💾 儲存到 Google Sheets
            </button>
            
            <div id="saveStatus" class="mt-4 text-center text-sm text-gray-600 hidden">
                正在儲存資料...
            </div>

            <!-- Tips -->
            <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                <p><strong class="text-green-800">💡 使用提示：</strong></p>
                <ul class="text-sm text-green-700 mt-2 space-y-1">
                    <li>• 短網址更美觀易記，適合分享</li>
                    <li>• 請確保優惠券連結是大使專屬的</li>
                    <li>• 儲存成功後可在管理後台查看</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden iframe for form submission -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        const GITHUB_PAGES_URL = 'https://didi1119.github.io/forest-gift-v1';
        
        let generatedData = null;

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Create short URL using TinyURL
        async function createShortUrl(originalUrl) {
            try {
                const response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(originalUrl));
                if (response.ok) {
                    const shortUrl = await response.text();
                    if (shortUrl && shortUrl.startsWith('https://tinyurl.com/')) {
                        return shortUrl;
                    }
                }
            } catch (error) {
                console.warn('短網址生成失敗:', error);
            }
            return originalUrl; // Return original URL if shortening fails
        }

        // Generate links
        async function generateLinks() {
            const partnerCode = document.getElementById('partnerCode').value.trim();
            const partnerName = document.getElementById('partnerName').value.trim();
            const partnerEmail = document.getElementById('partnerEmail').value.trim();
            const partnerPhone = document.getElementById('partnerPhone').value.trim();
            const couponCode = document.getElementById('couponCode').value.trim();
            const couponUrl = document.getElementById('couponUrl').value.trim();

            // Validation
            if (!partnerCode || !partnerName) {
                alert('請填寫夥伴代碼和姓名');
                return;
            }
            
            if (!partnerPhone) {
                alert('請填寫聯絡電話');
                return;
            }

            if (!couponUrl) {
                alert('請提供專屬優惠券連結！\n\n請到 LINE 官方帳號後台建立專屬優惠券，然後將連結貼上。');
                return;
            }

            // Show result section
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('landingLink').textContent = '生成短網址中...';
            document.getElementById('couponLink').textContent = '生成短網址中...';
            document.getElementById('shareTemplate').textContent = '生成中...';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            try {
                // Generate tracking URLs (include coupon_url in landing page URL)
                const landingUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=landing&coupon_url=${encodeURIComponent(couponUrl)}`;
                const trackedCouponUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=coupon&target=${encodeURIComponent(couponUrl)}`;

                // Generate short URLs
                const shortLandingUrl = await createShortUrl(landingUrl);
                const shortCouponUrl = await createShortUrl(trackedCouponUrl);

                // Generate share template
                const shareText = `🌲 來自靜謐森林的特別邀請

親愛的朋友，我想與你分享一個很特別的地方 —— 一片能讓心靈真正休息的森林。

這裡不只是住宿，更是一場回到內心家園的旅程。我為你準備了一份專屬的森林禮物，希望能為你的生活帶來一些不一樣的寧靜與感動。

🎁 點擊連結，開始你的森林之旅：
${shortLandingUrl}

🎫 專屬優惠券：
${shortCouponUrl}

期待你也能在這裡，找到屬於自己的那份安靜。

—— ${partnerName} 真誠推薦 ❤️`;

                // Save generated data
                generatedData = {
                    partner_code: partnerCode,
                    partner_name: partnerName,
                    contact_email: partnerEmail,
                    contact_phone: partnerPhone,
                    coupon_code: couponCode,
                    coupon_url: couponUrl, // User's custom coupon URL
                    landing_link: landingUrl,
                    coupon_link: trackedCouponUrl,
                    short_landing_link: shortLandingUrl,
                    short_coupon_link: shortCouponUrl,
                    bank_name: document.getElementById('bankName').value.trim(),
                    bank_code: document.getElementById('bankCode').value.trim(),
                    bank_branch: document.getElementById('bankBranch').value.trim(),
                    bank_account_name: document.getElementById('bankAccountName').value.trim(),
                    bank_account_number: document.getElementById('bankAccountNumber').value.trim()
                };

                // Display results
                document.getElementById('landingLink').textContent = shortLandingUrl;
                document.getElementById('couponLink').textContent = shortCouponUrl;
                document.getElementById('shareTemplate').textContent = shareText;

                showToast('✅ 連結生成成功！');

            } catch (error) {
                console.error('生成連結失敗:', error);
                showToast('❌ 生成失敗，請重試');
            }
        }

        // Copy share template
        function copyShareTemplate() {
            const shareTemplate = document.getElementById('shareTemplate');
            shareTemplate.select();
            document.execCommand('copy');
            showToast('✅ 已複製到剪貼簿');
        }

        // Save to Google Sheets
        function saveToSheets() {
            if (!generatedData) {
                alert('請先生成連結');
                return;
            }

            const button = document.querySelector('button[onclick="saveToSheets()"]');
            const originalText = button.textContent;
            button.textContent = '儲存中...';
            button.disabled = true;
            document.getElementById('saveStatus').classList.remove('hidden');
            document.getElementById('saveStatus').textContent = '正在儲存資料到 Google Sheets...';

            try {
                // Prepare complete partner data
                const partnerData = {
                    action: 'create_partner',
                    // Basic info
                    partner_code: generatedData.partner_code,
                    partner_name: generatedData.partner_name,
                    contact_email: generatedData.contact_email || '',
                    contact_phone: generatedData.contact_phone || '',
                    
                    // Level info (initial values)
                    partner_level: 'LV1_INSIDER',
                    successful_referrals: '0',
                    yearly_referrals: '0',
                    
                    // Commission info (initial values)
                    commission_preference: 'ACCOMMODATION',
                    total_commission_earned: '0',
                    total_commission_paid: '0',
                    available_points: '0',
                    points_used: '0',
                    pending_commission: '0',
                    
                    // Coupon info (IMPORTANT: User's custom coupon)
                    coupon_code: generatedData.coupon_code || '',
                    coupon_url: generatedData.coupon_url || '', // User's custom coupon URL
                    
                    // Link info
                    landing_link: generatedData.landing_link || '',
                    coupon_link: generatedData.coupon_link || '',
                    short_landing_link: generatedData.short_landing_link || '',
                    short_coupon_link: generatedData.short_coupon_link || '',
                    
                    // Bank info
                    bank_account: generatedData.bank_account_number || '',
                    bank_name: generatedData.bank_name || '',
                    bank_code: generatedData.bank_code || '',
                    bank_branch: generatedData.bank_branch || '',
                    bank_account_name: generatedData.bank_account_name || ''
                };

                // Create form for submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // Add all partner data as form fields
                Object.keys(partnerData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = partnerData[key];
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();

                // Show success after a delay
                setTimeout(() => {
                    document.body.removeChild(form);
                    button.textContent = originalText;
                    button.disabled = false;
                    document.getElementById('saveStatus').textContent = '✅ 資料已成功儲存到 Google Sheets！';
                    showToast('✅ 大使資料已儲存成功！');
                    
                    // Clear form after success
                    setTimeout(() => {
                        if (confirm('資料已儲存成功！是否清空表單以建立新的大使？')) {
                            location.reload();
                        }
                    }, 1000);
                }, 3000);

            } catch (error) {
                console.error('儲存失敗:', error);
                button.textContent = originalText;
                button.disabled = false;
                document.getElementById('saveStatus').textContent = '❌ 儲存失敗，請重試';
                showToast('❌ 儲存失敗，請重試');
            }
        }
    </script>
</body>
</html>