<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è©³ç´° Fetch è¨ºæ–·å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Apps Script Fetch è¨ºæ–·å·¥å…·</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Apps Script URL:</label>
                <input type="text" id="scriptUrl" value="https://script.google.com/macros/s/AKfycbyzaMMHbo1zesnAP4Go3Iz1R1z3702Ct4cuEJOdJpHArHpVpnCgvMIfeWx_PzRTWj8F/exec" class="w-full p-2 border rounded text-xs">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">æ¸¬è©¦æ–¹å¼:</label>
                <select id="testMethod" class="w-full p-2 border rounded">
                    <option value="GET">GET è«‹æ±‚</option>
                    <option value="POST">POST è«‹æ±‚</option>
                    <option value="FETCH_TEST">Fetch å¯ç”¨æ€§æ¸¬è©¦</option>
                    <option value="CORS_TEST">CORS é æª¢æ¸¬è©¦</option>
                </select>
            </div>
        </div>
        
        <div class="space-x-4 mb-6">
            <button onclick="testFetch()" class="bg-blue-600 text-white px-6 py-3 rounded font-semibold">
                é–‹å§‹è¨ºæ–·
            </button>
            <button onclick="clearLog()" class="bg-gray-600 text-white px-6 py-3 rounded font-semibold">
                æ¸…é™¤è¨˜éŒ„
            </button>
        </div>
        
        <div id="results" class="bg-gray-50 p-4 rounded min-h-96 font-mono text-sm overflow-auto">
            <p class="text-gray-600">æº–å‚™é–‹å§‹è¨ºæ–·...</p>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            results.innerHTML += `<div class="${colors[type] || 'text-gray-600'}"><strong>[${timestamp}]</strong> ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testFetch() {
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            const method = document.getElementById('testMethod').value;
            
            if (!scriptUrl) {
                log('è«‹è¼¸å…¥ Apps Script URL', 'error');
                return;
            }
            
            clearLog();
            log(`é–‹å§‹æ¸¬è©¦: ${method}`, 'info');
            log(`ç›®æ¨™ URL: ${scriptUrl}`, 'info');
            log(`ç€è¦½å™¨: ${navigator.userAgent}`, 'info');
            log(`ä¾†æº: ${window.location.origin}`, 'info');
            log('---', 'info');
            
            try {
                if (method === 'GET') {
                    await testGet(scriptUrl);
                } else if (method === 'POST') {
                    await testPost(scriptUrl);
                } else if (method === 'FETCH_TEST') {
                    await testFetchAvailability(scriptUrl);
                } else if (method === 'CORS_TEST') {
                    await testCors(scriptUrl);
                }
            } catch (error) {
                log(`ä¸»è¦éŒ¯èª¤: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
            }
        }
        
        async function testGet(scriptUrl) {
            log('ğŸ” æ¸¬è©¦ GET è«‹æ±‚...', 'info');
            
            try {
                const url = `${scriptUrl}?test=true&timestamp=${Date.now()}`;
                log(`GET URL: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                log(`GET ç‹€æ…‹ç¢¼: ${response.status}`, response.ok ? 'success' : 'error');
                log(`GET ç‹€æ…‹æ–‡å­—: ${response.statusText}`, 'info');
                
                // é¡¯ç¤ºå›æ‡‰ headers
                log('GET å›æ‡‰ Headers:', 'info');
                for (let [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                const responseText = await response.text();
                log(`GET å›æ‡‰å…§å®¹: ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`, 'info');
                
                if (response.ok) {
                    log('âœ… GET è«‹æ±‚æˆåŠŸ', 'success');
                } else {
                    log('âŒ GET è«‹æ±‚å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ GET è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
                log(`éŒ¯èª¤é¡å‹: ${error.name}`, 'error');
                
                if (error.message.includes('fetch')) {
                    log('ğŸ” é€™å¯èƒ½æ˜¯ç¶²è·¯é€£æ¥å•é¡Œæˆ– CORS å•é¡Œ', 'warning');
                }
            }
        }
        
        async function testPost(scriptUrl) {
            log('ğŸ” æ¸¬è©¦ POST è«‹æ±‚...', 'info');
            
            const testData = {
                action: 'create_partner',
                partner_code: 'DEBUG_TEST_' + Date.now(),
                name: 'è¨ºæ–·æ¸¬è©¦',
                email: 'debug@test.com',
                coupon_url: 'https://lin.ee/debug'
            };
            
            try {
                log(`POST è³‡æ–™: ${JSON.stringify(testData)}`, 'info');
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                log(`POST ç‹€æ…‹ç¢¼: ${response.status}`, response.ok ? 'success' : 'error');
                log(`POST ç‹€æ…‹æ–‡å­—: ${response.statusText}`, 'info');
                
                // é¡¯ç¤ºå›æ‡‰ headers
                log('POST å›æ‡‰ Headers:', 'info');
                for (let [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                const responseText = await response.text();
                log(`POST å›æ‡‰å…§å®¹: ${responseText}`, 'info');
                
                try {
                    const result = JSON.parse(responseText);
                    log(`POST è§£æçµæœ: ${JSON.stringify(result, null, 2)}`, 'info');
                    
                    if (result.success) {
                        log('âœ… POST è«‹æ±‚æˆåŠŸ', 'success');
                    } else {
                        log(`âŒ POST è«‹æ±‚å¤±æ•—: ${result.error}`, 'error');
                    }
                } catch (parseError) {
                    log(`JSON è§£æéŒ¯èª¤: ${parseError.message}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ POST è«‹æ±‚éŒ¯èª¤: ${error.message}`, 'error');
                log(`éŒ¯èª¤é¡å‹: ${error.name}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('ğŸ” é€™é€šå¸¸è¡¨ç¤º:', 'warning');
                    log('  1. CORS é æª¢è«‹æ±‚å¤±æ•—', 'warning');
                    log('  2. Apps Script éƒ¨ç½²è¨­å®šå•é¡Œ', 'warning');
                    log('  3. ç¶²è·¯é€£æ¥å•é¡Œ', 'warning');
                }
            }
        }
        
        async function testFetchAvailability(scriptUrl) {
            log('ğŸ” æ¸¬è©¦ Fetch API å¯ç”¨æ€§...', 'info');
            
            // æª¢æŸ¥ fetch æ˜¯å¦å¯ç”¨
            if (typeof fetch === 'undefined') {
                log('âŒ Fetch API ä¸å¯ç”¨', 'error');
                return;
            }
            
            log('âœ… Fetch API å¯ç”¨', 'success');
            
            // æ¸¬è©¦ç°¡å–®çš„å¤–éƒ¨è«‹æ±‚
            try {
                log('æ¸¬è©¦å° Google çš„è«‹æ±‚...', 'info');
                const testResponse = await fetch('https://www.google.com', { 
                    method: 'HEAD', 
                    mode: 'no-cors' 
                });
                log('âœ… å¤–éƒ¨ç¶²è·¯é€£æ¥æ­£å¸¸', 'success');
            } catch (error) {
                log(`âŒ å¤–éƒ¨ç¶²è·¯é€£æ¥æœ‰å•é¡Œ: ${error.message}`, 'error');
            }
            
            // æ¸¬è©¦å° Apps Script çš„åŸºæœ¬é€£æ¥
            try {
                log('æ¸¬è©¦å° Apps Script çš„åŸºæœ¬é€£æ¥...', 'info');
                const response = await fetch(scriptUrl, { 
                    method: 'HEAD', 
                    mode: 'cors' 
                });
                log(`åŸºæœ¬é€£æ¥ç‹€æ…‹: ${response.status}`, 'info');
            } catch (error) {
                log(`åŸºæœ¬é€£æ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        async function testCors(scriptUrl) {
            log('ğŸ” æ¸¬è©¦ CORS è¨­å®š...', 'info');
            
            try {
                // æ¸¬è©¦ OPTIONS è«‹æ±‚
                log('ç™¼é€ OPTIONS è«‹æ±‚...', 'info');
                const optionsResponse = await fetch(scriptUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                    }
                });
                
                log(`OPTIONS ç‹€æ…‹ç¢¼: ${optionsResponse.status}`, optionsResponse.ok ? 'success' : 'error');
                
                log('CORS Headers:', 'info');
                let hasCorHeaders = false;
                for (let [key, value] of optionsResponse.headers.entries()) {
                    if (key.toLowerCase().includes('access-control')) {
                        log(`  ${key}: ${value}`, 'success');
                        hasCorHeaders = true;
                    }
                }
                
                if (!hasCorHeaders) {
                    log('âŒ æ²’æœ‰æ‰¾åˆ° CORS headers', 'error');
                    log('é€™è¡¨ç¤º doOptions å‡½æ•¸å¯èƒ½æ²’æœ‰æ­£å¸¸å·¥ä½œ', 'warning');
                } else {
                    log('âœ… ç™¼ç¾ CORS headers', 'success');
                }
                
            } catch (error) {
                log(`âŒ CORS æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>