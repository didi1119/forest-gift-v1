# 🧪 ID 系統完整測試計畫

## 測試前準備
1. **備份現有數據**：先備份 Google Sheets 資料庫
2. **部署新版本**：將修改後的 `apps-script-commission-v2.js` 部署到 Google Apps Script
3. **開啟日誌**：在 Google Apps Script 編輯器中開啟執行記錄（Executions）

---

## 📋 測試項目清單

### 1️⃣ 測試新建記錄的 ID 生成

#### A. 測試 Bookings 表格
```javascript
// 測試步驟：
1. 開啟管理後台：admin-dashboard-real.html
2. 進入「手動訂房」頁面
3. 填寫測試資料：
   - 房客姓名：測試客戶001
   - 電話：0912345678
   - 入住日期：選擇明天
   - 退房日期：選擇後天
   - 房價：3000
4. 提交表單
5. 檢查 Google Sheets 的 Bookings 表格

✅ 預期結果：
- 新記錄的 ID 欄位（A欄）應該有數字（如：1, 2, 3...）
- 不應該是空白
- Console 應顯示：「生成新的 Booking ID: X」
```

#### B. 測試 Partners 表格
```javascript
// 測試步驟：
1. 在管理後台點擊「夥伴管理」
2. 點擊「新增大使」
3. 填寫測試資料：
   - 代碼：TEST001
   - 姓名：測試大使
   - 電話：0987654321
   - Email：test@example.com
4. 提交表單
5. 檢查 Google Sheets 的 Partners 表格

✅ 預期結果：
- 新大使記錄應該有 ID
- ID 應該是遞增的數字
```

#### C. 測試 Payouts 表格
```javascript
// 測試步驟：
1. 在訂單管理中找到一筆「待確認」的訂單
2. 點擊「確認入住完成」
3. 檢查 Google Sheets 的 Payouts 表格

✅ 預期結果：
- 如果有佣金，Payouts 表格應該新增一筆記錄
- 該記錄應該有 ID
```

---

### 2️⃣ 測試編輯功能（ID 為空的舊記錄）

```javascript
// 測試步驟：
1. 找一筆 ID 欄位為空的舊訂房記錄
2. 點擊「編輯」按鈕
3. 修改房價或備註
4. 儲存變更

✅ 預期結果：
- 應該能成功儲存（使用姓名+電話查找）
- Console 顯示：「🔍 開始用複合條件查找（姓名+電話）...」
- 不應該出現 403 錯誤
```

---

### 3️⃣ 測試邊界情況

#### A. 測試空表格
```javascript
// 測試步驟（危險！請先備份）：
1. 創建新的測試 Sheet 或清空某個不重要的表格（保留標題行）
2. 新增第一筆記錄

✅ 預期結果：
- 第一筆記錄的 ID 應該是 1
- Console 顯示：「XX 表格只有標題行，從 ID 1 開始」
```

#### B. 測試 ID 衝突
```javascript
// 測試步驟：
1. 手動在 Google Sheets 中將某筆記錄的 ID 改為 999
2. 新增一筆記錄

✅ 預期結果：
- 新記錄的 ID 應該是 1000（999+1）
- 不會覆蓋或衝突
```

---

### 4️⃣ 測試佣金計算（不重複）

```javascript
// 測試步驟：
1. 找一筆有推薦大使的訂單
2. 點擊「確認入住完成」
3. 檢查 Partners 表格中該大使的數據

✅ 預期結果：
- total_commission_earned（J欄）應該增加
- pending_commission（L欄）不應該增加（已修復重複計算）
- 只有一個欄位增加佣金
```

---

### 5️⃣ 測試各種 ID 相關功能

#### A. 住宿金使用
```javascript
// 測試步驟：
1. 在夥伴管理中找有住宿金的大使
2. 點擊「使用住宿金」
3. 輸入金額並提交

✅ 預期結果：
- AccommodationUsage 表格新增記錄且有 ID
```

#### B. 轉換現金
```javascript
// 測試步驟：
1. 找有住宿金的大使
2. 點擊「轉換現金」
3. 輸入轉換金額

✅ 預期結果：
- AccommodationUsage 表格新增記錄且有 ID
- Payouts 表格新增記錄且有 ID
```

---

## 🔍 檢查點清單

### Google Apps Script 日誌檢查
在 Apps Script 編輯器中查看執行記錄，應該看到：
- [ ] `生成 Booking ID: 當前最大 ID = X, 新 ID = Y`
- [ ] `生成 Partner ID: 當前最大 ID = X, 新 ID = Y`
- [ ] `生成 Payout ID: 當前最大 ID = X, 新 ID = Y`
- [ ] 沒有錯誤訊息

### Google Sheets 檢查
- [ ] Bookings 表格新記錄有 ID
- [ ] Partners 表格新記錄有 ID
- [ ] Payouts 表格新記錄有 ID
- [ ] AccommodationUsage 表格新記錄有 ID
- [ ] ID 都是遞增的數字

### 前端 Console 檢查
- [ ] 沒有 403 Forbidden 錯誤
- [ ] 沒有 undefined ID 錯誤
- [ ] 編輯功能正常運作

---

## 🚨 緊急回滾方案

如果測試發現嚴重問題：

1. **立即停止測試**
2. **回滾 Google Apps Script**：
   - 在 Apps Script 編輯器中
   - 點擊「部署」→「管理部署」
   - 選擇上一個版本
3. **檢查數據完整性**：
   - 確認沒有數據遺失
   - 確認業務功能正常

---

## 📊 測試記錄表

| 測試項目 | 測試時間 | 結果 | 備註 |
|---------|---------|------|------|
| 新建 Booking ID | | ⬜ 通過 / ❌ 失敗 | |
| 新建 Partner ID | | ⬜ 通過 / ❌ 失敗 | |
| 編輯舊記錄 | | ⬜ 通過 / ❌ 失敗 | |
| 確認入住佣金 | | ⬜ 通過 / ❌ 失敗 | |
| 住宿金使用 | | ⬜ 通過 / ❌ 失敗 | |
| 轉換現金 | | ⬜ 通過 / ❌ 失敗 | |
| 空表格 ID=1 | | ⬜ 通過 / ❌ 失敗 | |

---

## 💡 測試提示

1. **分階段測試**：先測試讀取功能，確認沒問題再測試寫入
2. **使用測試數據**：用明顯的測試名稱（如「測試客戶999」）方便識別
3. **記錄每一步**：截圖或記錄每個步驟的結果
4. **檢查日誌**：Google Apps Script 的日誌是最重要的診斷工具

## 🎯 測試成功標準

✅ 所有新記錄都有遞增的 ID
✅ 編輯功能正常（即使舊記錄沒有 ID）
✅ 沒有 403 錯誤
✅ 佣金不重複計算
✅ 所有表格的 ID 生成都正常

---

*測試前請確保已備份數據！*