<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½£é‡‘ç³»çµ±çœŸå¯¦æ¸¬è©¦ï¼ˆFetch APIï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">ä½£é‡‘ç³»çµ±çœŸå¯¦æ¸¬è©¦</h1>
        <p class="text-red-600 mb-8">âš ï¸ æ­¤æ¸¬è©¦æœƒå¯¦éš›å‘¼å« API ä¸¦é¡¯ç¤ºçœŸå¯¦å›æ‡‰</p>
        
        <!-- é…ç½®å€ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Google Apps Script URL
                    </label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        æ¸¬è©¦å¤¥ä¼´ä»£ç¢¼
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="TEST_REAL_001">
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦æ¡ˆä¾‹ -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- å·¦å´ï¼šåŸºæœ¬æ¸¬è©¦ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">åŸºæœ¬åŠŸèƒ½æ¸¬è©¦</h2>
                <div class="space-y-3">
                    <button onclick="testCreatePartner()" 
                            class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        1. å‰µå»ºæ¸¬è©¦å¤§ä½¿ï¼ˆ5000åˆå§‹é»æ•¸ï¼‰
                    </button>
                    
                    <button onclick="testGetPartnerInfo()" 
                            class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        2. æŸ¥è©¢å¤§ä½¿è³‡æ–™
                    </button>
                    
                    <button onclick="testCreateAndConfirmBooking()" 
                            class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        3. å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèªå…¥ä½
                    </button>
                    
                    <button onclick="testUsePoints()" 
                            class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        4. ä½¿ç”¨ä½å®¿é‡‘é»æ•¸
                    </button>
                    
                    <button onclick="testConvertPointsToCash()" 
                            class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        5. è½‰æ›é»æ•¸ç‚ºç¾é‡‘ï¼ˆ50%ï¼‰
                    </button>
                </div>
            </div>

            <!-- å³å´ï¼šé€²éšæ¸¬è©¦ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">é€²éšæ¸¬è©¦</h2>
                <div class="space-y-3">
                    <button onclick="testPointsInsufficient()" 
                            class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        æ¸¬è©¦é»æ•¸ä¸è¶³
                    </button>
                    
                    <button onclick="testCancelPayout()" 
                            class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
                        æ¸¬è©¦å–æ¶ˆçµç®—
                    </button>
                    
                    <button onclick="testDeleteBooking()" 
                            class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        æ¸¬è©¦åˆªé™¤è¨‚æˆ¿
                    </button>
                    
                    <button onclick="clearTestData()" 
                            class="w-full bg-red-700 text-white px-4 py-2 rounded hover:bg-red-800">
                        æ¸…ç†æ¸¬è©¦è³‡æ–™
                    </button>
                    
                    <button onclick="runFullTest()" 
                            class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="results" class="space-y-2 font-mono text-sm max-h-96 overflow-y-auto">
                <p class="text-gray-500">æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
            </div>
        </div>
    </div>

    <script>
        let testBookingId = null;
        let testGuestName = null;
        let testPayoutId = null;

        // ä½¿ç”¨ Fetch API ç™¼é€è«‹æ±‚
        async function callAPI(action, data) {
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            try {
                const params = new URLSearchParams({
                    action: action,
                    ...data
                });
                
                addResult(`ğŸ“¤ ç™¼é€è«‹æ±‚: ${action}`, 'info');
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addResult(`âœ… ${action} æˆåŠŸ: ${result.message || 'OK'}`, 'success');
                    if (result.data) {
                        console.log('Response data:', result.data);
                    }
                } else {
                    addResult(`âŒ ${action} å¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
                
                return result;
                
            } catch (error) {
                addResult(`âŒ API éŒ¯èª¤: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // 1. å‰µå»ºæ¸¬è©¦å¤§ä½¿
        async function testCreatePartner() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            const result = await callAPI('create_partner', {
                partner_code: partnerCode,
                partner_name: 'çœŸå¯¦æ¸¬è©¦å¤§ä½¿',
                contact_phone: '0912345678',
                contact_email: 'test@example.com',
                bank_code: '808',
                bank_account: '12345678901234',
                commission_preference: 'ACCOMMODATION',
                available_points: 5000,  // åˆå§‹é»æ•¸
                notes: 'æ¸¬è©¦ç”¨å¤§ä½¿ï¼Œåˆå§‹é»æ•¸5000'
            });
            
            if (result.success) {
                addResult(`å¤§ä½¿å‰µå»ºæˆåŠŸï¼Œä»£ç¢¼: ${partnerCode}`, 'success');
            }
        }

        // 2. æŸ¥è©¢å¤§ä½¿è³‡æ–™
        async function testGetPartnerInfo() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === partnerCode);
                    
                    if (partner) {
                        addResult(`
ğŸ“Š å¤§ä½¿ç‹€æ…‹:
â€¢ ä»£ç¢¼: ${partner.partner_code}
â€¢ ç­‰ç´š: ${partner.partner_level || 'LV1_INSIDER'}
â€¢ å¯ç”¨é»æ•¸: ${partner.available_points || 0}
â€¢ å·²ä½¿ç”¨é»æ•¸: ${partner.points_used || 0}
â€¢ å¾…æ”¯ä»˜ç¾é‡‘: ${partner.pending_commission || 0}
â€¢ ç´¯ç©ä½£é‡‘: ${partner.total_commission_earned || 0}
â€¢ æˆåŠŸæ¨è–¦: ${partner.successful_referrals || 0}
                        `, 'info');
                    } else {
                        addResult(`æ‰¾ä¸åˆ°å¤§ä½¿: ${partnerCode}`, 'error');
                    }
                } else {
                    addResult('ç„¡æ³•ç²å–è³‡æ–™', 'error');
                }
            } catch (error) {
                addResult(`æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // 3. å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèªå…¥ä½
        async function testCreateAndConfirmBooking() {
            const partnerCode = document.getElementById('partnerCode').value;
            testGuestName = `æ¸¬è©¦æˆ¿å®¢_${Date.now()}`;
            
            // å‰µå»ºè¨‚æˆ¿
            const bookingResult = await callAPI('create_booking', {
                partner_code: partnerCode,
                guest_name: testGuestName,
                guest_phone: '0987654321',
                guest_email: 'guest@test.com',
                checkin_date: '2024-12-25',
                checkout_date: '2024-12-27',
                room_price: 5000
            });
            
            if (bookingResult.success && bookingResult.booking_id) {
                testBookingId = bookingResult.booking_id;
                addResult(`è¨‚æˆ¿å‰µå»ºæˆåŠŸï¼ŒID: ${testBookingId}`, 'success');
                
                // ç­‰å¾…å¾Œç¢ºèªå…¥ä½
                setTimeout(async () => {
                    const confirmResult = await callAPI('confirm_checkin_completion', {
                        guest_name: testGuestName,
                        guest_phone: '0987654321',
                        checkin_date: '2024-12-25'
                    });
                    
                    if (confirmResult.success) {
                        addResult(`å…¥ä½ç¢ºèªæˆåŠŸï¼Œæ‡‰ç²å¾—ä½£é‡‘`, 'success');
                        // æŸ¥è©¢æ›´æ–°å¾Œçš„ç‹€æ…‹
                        setTimeout(() => testGetPartnerInfo(), 1000);
                    }
                }, 2000);
            }
        }

        // 4. ä½¿ç”¨ä½å®¿é‡‘é»æ•¸
        async function testUsePoints() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            const result = await callAPI('use_accommodation_points', {
                partner_code: partnerCode,
                deduct_amount: 1000,
                checkin_date: '2024-12-28',
                room_price: 3000,
                notes: 'æ¸¬è©¦ä½¿ç”¨1000é»'
            });
            
            if (result.success) {
                addResult(`æˆåŠŸä½¿ç”¨1000é»ï¼Œè¨‚æˆ¿ID: ${result.booking_id}`, 'success');
                setTimeout(() => testGetPartnerInfo(), 1000);
            }
        }

        // 5. è½‰æ›é»æ•¸ç‚ºç¾é‡‘
        async function testConvertPointsToCash() {
            const partnerCode = document.getElementById('partnerCode').value;
            const pointsToConvert = 2000;
            const cashAmount = pointsToConvert * 0.5;
            
            const result = await callAPI('convert_points_to_cash', {
                partner_code: partnerCode,
                points_used: pointsToConvert,
                cash_amount: cashAmount,
                exchange_rate: 0.5
            });
            
            if (result.success) {
                addResult(`æˆåŠŸè½‰æ›${pointsToConvert}é»ç‚ºNT$${cashAmount}`, 'success');
                setTimeout(() => testGetPartnerInfo(), 1000);
            }
        }

        // æ¸¬è©¦é»æ•¸ä¸è¶³
        async function testPointsInsufficient() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            const result = await callAPI('use_accommodation_points', {
                partner_code: partnerCode,
                deduct_amount: 100000,  // è¶…é¡
                checkin_date: '2024-12-30',
                room_price: 100000
            });
            
            if (!result.success) {
                addResult(`âœ… æ­£ç¢ºæ‹’çµ•è¶…é¡ä½¿ç”¨: ${result.error}`, 'warning');
            } else {
                addResult(`âŒ éŒ¯èª¤ï¼šä¸æ‡‰å…è¨±è¶…é¡ä½¿ç”¨`, 'error');
            }
        }

        // æ¸¬è©¦å–æ¶ˆçµç®—
        async function testCancelPayout() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            // å…ˆå‰µå»ºçµç®—
            const createResult = await callAPI('create_payout', {
                partner_code: partnerCode,
                payout_type: 'ACCOMMODATION',
                amount: 500,
                payout_method: 'OTHER',
                notes: 'æ¸¬è©¦çµç®—ï¼ˆå°‡è¢«å–æ¶ˆï¼‰'
            });
            
            if (createResult.success && createResult.payout_id) {
                testPayoutId = createResult.payout_id;
                addResult(`å‰µå»ºæ¸¬è©¦çµç®—ï¼ŒID: ${testPayoutId}`, 'info');
                
                // å–æ¶ˆçµç®—
                setTimeout(async () => {
                    const cancelResult = await callAPI('cancel_payout', {
                        payout_id: testPayoutId
                    });
                    
                    if (cancelResult.success) {
                        addResult(`æˆåŠŸå–æ¶ˆçµç®— #${testPayoutId}`, 'success');
                        setTimeout(() => testGetPartnerInfo(), 1000);
                    }
                }, 2000);
            }
        }

        // æ¸¬è©¦åˆªé™¤è¨‚æˆ¿
        async function testDeleteBooking() {
            if (!testGuestName) {
                addResult('è«‹å…ˆåŸ·è¡Œ"å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèªå…¥ä½"', 'error');
                return;
            }
            
            const result = await callAPI('delete_booking', {
                guest_name: testGuestName,
                guest_phone: '0987654321'
            });
            
            if (result.success) {
                addResult(`æˆåŠŸåˆªé™¤è¨‚æˆ¿ï¼Œæ‡‰æ’¤éŠ·ç›¸é—œä½£é‡‘`, 'success');
                setTimeout(() => testGetPartnerInfo(), 1000);
            }
        }

        // æ¸…ç†æ¸¬è©¦è³‡æ–™
        async function clearTestData() {
            addResult('âš ï¸ æ¸…ç†åŠŸèƒ½éœ€è¦æ‰‹å‹•åœ¨ Google Sheets ä¸­åŸ·è¡Œ', 'warning');
        }

        // åŸ·è¡Œå®Œæ•´æ¸¬è©¦
        async function runFullTest() {
            addResult('ğŸš€ é–‹å§‹å®Œæ•´æ¸¬è©¦æµç¨‹...', 'info');
            
            await testCreatePartner();
            await delay(2000);
            
            await testGetPartnerInfo();
            await delay(2000);
            
            await testCreateAndConfirmBooking();
            await delay(5000);
            
            await testUsePoints();
            await delay(2000);
            
            await testConvertPointsToCash();
            await delay(2000);
            
            await testPointsInsufficient();
            await delay(2000);
            
            await testGetPartnerInfo();
            
            addResult('âœ… å®Œæ•´æ¸¬è©¦æµç¨‹çµæŸ', 'success');
        }

        // å»¶é²å‡½æ•¸
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æ·»åŠ çµæœ
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };
            
            const resultItem = `<div class="${colors[type]}">
                <span class="text-gray-500">[${timestamp}]</span> ${message.replace(/\n/g, '<br>')}
            </div>`;
            
            if (resultsDiv.innerHTML.includes('æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                resultsDiv.innerHTML = resultItem;
            } else {
                resultsDiv.innerHTML = resultItem + resultsDiv.innerHTML;
            }
            
            // ä¿æŒæ²å‹•åœ¨æœ€æ–°è¨Šæ¯
            resultsDiv.scrollTop = 0;
        }
    </script>
</body>
</html>