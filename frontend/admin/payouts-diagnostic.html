<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payouts 表格診斷工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .json-output { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; font-family: 'Courier New', monospace; white-space: pre-wrap; }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">🔧 Payouts 表格診斷工具</h1>
            <p class="text-lg text-stone-600">檢查和修復結算記錄表格的資料結構問題</p>
        </header>

        <!-- 診斷結果區域 -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">📋 診斷結果</h2>
            
            <div class="space-y-4 mb-6">
                <button onclick="runDiagnosis()" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                    🔍 開始診斷
                </button>
                
                <button onclick="repairPayouts()" id="repairButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-300 disabled:bg-gray-400" disabled>
                    🔧 修復表格
                </button>
            </div>

            <div id="diagnosisResult" class="hidden">
                <h3 class="text-lg font-semibold text-stone-800 mb-4">診斷報告</h3>
                <div id="diagnosisOutput" class="json-output text-sm"></div>
            </div>
        </div>

        <!-- 修復結果區域 -->
        <div id="repairResultSection" class="brand-card p-8 hidden">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">🛠️ 修復結果</h2>
            <div id="repairResult" class="json-output text-sm"></div>
        </div>

        <!-- 說明區域 -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ℹ️ 使用說明</h2>
            <div class="space-y-4 text-stone-700">
                <p><strong>問題背景：</strong> 結算管理顯示資料不正確，無法取消結算，主要是因為 Google Sheets 的欄位結構與程式碼預期不匹配。</p>
                
                <div>
                    <strong>預期的表格結構：</strong>
                    <ul class="list-disc list-inside mt-2 ml-4 space-y-1 text-sm">
                        <li>Column A: ID（唯一識別碼）</li>
                        <li>Column B: partner_code（大使代碼）</li>
                        <li>Column C: payout_type（結算類型：CASH/ACCOMMODATION）</li>
                        <li>Column D: amount（金額）</li>
                        <li>Column E: related_booking_ids（相關訂房ID）</li>
                        <li>Column F: payout_method（結算方式）</li>
                        <li>Column G: payout_status（結算狀態）</li>
                        <li>其他欄位：日期、備註等</li>
                    </ul>
                </div>
                
                <p><strong>使用步驟：</strong></p>
                <ol class="list-decimal list-inside ml-4 space-y-1">
                    <li>點擊「開始診斷」檢查當前表格結構</li>
                    <li>查看診斷報告，了解問題所在</li>
                    <li>如果需要修復，點擊「修復表格」</li>
                    <li>修復完成後，重新檢查結算管理功能</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 隱藏的 iframe 用於接收表單回應 -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';

        async function runDiagnosis() {
            const button = document.querySelector('button[onclick="runDiagnosis()"]');
            const originalText = button.textContent;
            button.textContent = '診斷中...';
            button.disabled = true;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=diagnose_payouts'
                });

                const result = await response.json();
                
                document.getElementById('diagnosisResult').classList.remove('hidden');
                document.getElementById('diagnosisOutput').textContent = JSON.stringify(result, null, 2);
                
                // 如果需要修復，啟用修復按鈕
                if (result.success && result.repair_needed) {
                    document.getElementById('repairButton').disabled = false;
                }

                showToast(result.success ? '✅ 診斷完成' : '❌ 診斷失敗：' + result.error);

            } catch (error) {
                console.error('診斷錯誤:', error);
                document.getElementById('diagnosisOutput').textContent = '錯誤: ' + error.message;
                showToast('❌ 診斷失敗：' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function repairPayouts() {
            const button = document.getElementById('repairButton');
            const originalText = button.textContent;
            button.textContent = '修復中...';
            button.disabled = true;

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=repair_payouts'
                });

                const result = await response.json();
                
                document.getElementById('repairResultSection').classList.remove('hidden');
                document.getElementById('repairResult').textContent = JSON.stringify(result, null, 2);
                
                showToast(result.success ? '✅ 修復完成' : '❌ 修復失敗：' + result.error);

                // 修復完成後，建議重新診斷
                if (result.success) {
                    setTimeout(() => {
                        if (confirm('修復完成！是否要重新診斷驗證結果？')) {
                            runDiagnosis();
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('修復錯誤:', error);
                document.getElementById('repairResult').textContent = '錯誤: ' + error.message;
                showToast('❌ 修復失敗：' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            if (message.includes('❌')) {
                toast.className = toast.className.replace('bg-green-600', 'bg-red-600');
            }
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>