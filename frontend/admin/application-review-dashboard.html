<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”³è«‹å¯©æ ¸ç®¡ç†å¾Œå° - éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .status-pending { background-color: #FEF3C7; color: #D97706; }
        .status-approved { background-color: #D1FAE5; color: #059669; }
        .status-rejected { background-color: #FEE2E2; color: #DC2626; }
        .btn-primary { background-color: #2E4B36; color: white; }
        .btn-primary:hover { background-color: #1F2937; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #B91C1C; }
    </style>
</head>
<body class="antialiased min-h-screen">
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loading" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
            <p class="text-gray-600">è¼‰å…¥ç”³è«‹è³‡æ–™ä¸­...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- é é¢æ¨™é¡Œ -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold brand-accent mb-2">ç”³è«‹å¯©æ ¸ç®¡ç†å¾Œå°</h1>
            <p class="text-gray-600">éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« - å¤§ä½¿ç”³è«‹å¯©æ ¸èˆ‡ç®¡ç†ç³»çµ±</p>
            <div class="mt-4 flex flex-wrap gap-4">
                <button id="refresh-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    ğŸ”„ é‡æ–°è¼‰å…¥
                </button>
                <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    ğŸ“Š åŒ¯å‡ºè³‡æ–™
                </button>
            </div>
        </header>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="brand-card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 mr-4">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">å¾…å¯©æ ¸</p>
                        <p id="pending-count" class="text-2xl font-bold text-yellow-700">0</p>
                    </div>
                </div>
            </div>
            <div class="brand-card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 mr-4">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">å·²æ ¸å‡†</p>
                        <p id="approved-count" class="text-2xl font-bold text-green-700">0</p>
                    </div>
                </div>
            </div>
            <div class="brand-card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 mr-4">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">å·²æ‹’çµ•</p>
                        <p id="rejected-count" class="text-2xl font-bold text-red-700">0</p>
                    </div>
                </div>
            </div>
            <div class="brand-card p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 mr-4">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">ç¸½ç”³è«‹æ•¸</p>
                        <p id="total-count" class="text-2xl font-bold text-blue-700">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨ -->
        <div class="brand-card p-6 mb-8">
            <div class="flex flex-wrap items-center gap-4">
                <label class="text-sm font-medium text-gray-700">ç‹€æ…‹ç¯©é¸ï¼š</label>
                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="ALL">å…¨éƒ¨</option>
                    <option value="PENDING" selected>å¾…å¯©æ ¸</option>
                    <option value="APPROVED">å·²æ ¸å‡†</option>
                    <option value="REJECTED">å·²æ‹’çµ•</option>
                </select>
                <button id="filter-btn" class="px-4 py-2 btn-primary rounded-lg transition">
                    ğŸ” å¥—ç”¨ç¯©é¸
                </button>
                <div class="ml-auto text-sm text-gray-500" id="last-updated">
                    æœ€å¾Œæ›´æ–°ï¼šè¼‰å…¥ä¸­...
                </div>
            </div>
        </div>

        <!-- ç”³è«‹åˆ—è¡¨ -->
        <div class="brand-card p-6">
            <h2 class="text-xl font-bold brand-accent mb-6">ç”³è«‹åˆ—è¡¨</h2>
            <div id="applications-container">
                <!-- ç”³è«‹è³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </div>

    <!-- å¯©æ ¸æ¨¡æ…‹æ¡† -->
    <div id="review-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold">å¯©æ ¸ç”³è«‹</h3>
                <button id="close-review-modal" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="review-applicant-info" class="mb-6">
                    <!-- ç”³è«‹è€…è³‡è¨Šå°‡åœ¨é€™è£¡è¼‰å…¥ -->
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="review-notes" class="block text-sm font-medium text-gray-700 mb-2">å¯©æ ¸å‚™è¨»</label>
                        <textarea id="review-notes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="è¼¸å…¥å¯©æ ¸æ„è¦‹..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="reject-btn" class="px-4 py-2 btn-danger rounded-lg transition">
                            âŒ æ‹’çµ•ç”³è«‹
                        </button>
                        <button id="approve-btn" class="px-4 py-2 btn-success rounded-lg transition">
                            âœ… æ ¸å‡†ç”³è«‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€£çµç”Ÿæˆæ¨¡æ…‹æ¡† -->
    <div id="link-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold">ç”Ÿæˆå¤§ä½¿é€£çµ</h3>
                <button id="close-link-modal" class="text-gray-400 hover:text-gray-700 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div id="link-applicant-info" class="mb-6">
                    <!-- ç”³è«‹è€…è³‡è¨Šå°‡åœ¨é€™è£¡è¼‰å…¥ -->
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="partner-code" class="block text-sm font-medium text-gray-700 mb-2">å¤§ä½¿ä»£ç¢¼ *</label>
                        <input type="text" id="partner-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="ä¾‹å¦‚: FOREST001" required>
                        <p class="text-xs text-gray-500 mt-1">å»ºè­°æ ¼å¼ï¼šFOREST + æ•¸å­—ï¼Œä¾‹å¦‚ FOREST001</p>
                    </div>
                    <div>
                        <label for="coupon-url" class="block text-sm font-medium text-gray-700 mb-2">å„ªæƒ åˆ¸ç›®æ¨™ç¶²å€</label>
                        <input type="url" id="coupon-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="https://example.com/booking">
                        <p class="text-xs text-gray-500 mt-1">å¯é¸ï¼šå„ªæƒ åˆ¸é€£çµçš„æœ€çµ‚ç›®æ¨™ç¶²å€</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-link-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            å–æ¶ˆ
                        </button>
                        <button id="generate-link-btn" class="px-4 py-2 btn-primary rounded-lg transition">
                            ğŸ”— ç”Ÿæˆä¸¦è½‰ç‚ºå¤¥ä¼´
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apps Script URL è¨­å®š -->
    <script>
        // è«‹æ›´æ–°ç‚ºæ‚¨çš„ Apps Script URL
        const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE';
        
        // å…¨åŸŸè®Šæ•¸
        let currentApplications = [];
        let currentFilter = 'PENDING';
        let selectedApplication = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
            setupEventListeners();
        });

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            document.getElementById('refresh-btn').addEventListener('click', loadApplications);
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('filter-btn').addEventListener('click', applyFilter);
            document.getElementById('status-filter').addEventListener('change', applyFilter);
            
            // å¯©æ ¸æ¨¡æ…‹æ¡†
            document.getElementById('close-review-modal').addEventListener('click', closeReviewModal);
            document.getElementById('approve-btn').addEventListener('click', () => reviewApplication('APPROVED'));
            document.getElementById('reject-btn').addEventListener('click', () => reviewApplication('REJECTED'));
            
            // é€£çµç”Ÿæˆæ¨¡æ…‹æ¡†
            document.getElementById('close-link-modal').addEventListener('click', closeLinkModal);
            document.getElementById('cancel-link-btn').addEventListener('click', closeLinkModal);
            document.getElementById('generate-link-btn').addEventListener('click', generatePartnerLink);
        }

        // è¼‰å…¥ç”³è«‹è³‡æ–™
        async function loadApplications() {
            try {
                showLoading(true);
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'get_applications',
                        status_filter: currentFilter
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                if (result.success) {
                    currentApplications = result.data || [];
                    updateStatistics(result);
                    renderApplications();
                    document.getElementById('last-updated').textContent = 
                        `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleString('zh-TW')}`;
                } else {
                    throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
                }
                
            } catch (error) {
                console.error('è¼‰å…¥ç”³è«‹è³‡æ–™éŒ¯èª¤:', error);
                showError('è¼‰å…¥ç”³è«‹è³‡æ–™å¤±æ•—ï¼š' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStatistics(result) {
            const pendingCount = result.data?.filter(app => app.application_status === 'PENDING').length || 0;
            const approvedCount = result.data?.filter(app => app.application_status === 'APPROVED').length || 0;
            const rejectedCount = result.data?.filter(app => app.application_status === 'REJECTED').length || 0;
            const totalCount = result.total_count || result.data?.length || 0;

            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('approved-count').textContent = approvedCount;
            document.getElementById('rejected-count').textContent = rejectedCount;
            document.getElementById('total-count').textContent = totalCount;
        }

        // æ¸²æŸ“ç”³è«‹åˆ—è¡¨
        function renderApplications() {
            const container = document.getElementById('applications-container');
            
            if (currentApplications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg font-medium">æ²’æœ‰æ‰¾åˆ°ç”³è«‹è³‡æ–™</p>
                        <p class="text-sm">è«‹æª¢æŸ¥ç¯©é¸æ¢ä»¶æˆ–é‡æ–°è¼‰å…¥é é¢</p>
                    </div>
                `;
                return;
            }

            const applicationsHTML = currentApplications.map(app => `
                <div class="border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800">${escapeHtml(app.name || 'æœªæä¾›å§“å')}</h3>
                            <p class="text-gray-600">${escapeHtml(app.email || 'æœªæä¾›Email')}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="status-${app.application_status?.toLowerCase() || 'pending'} px-3 py-1 rounded-full text-xs font-medium">
                                ${getStatusText(app.application_status)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                        <div>
                            <span class="font-medium">LINEåç¨±ï¼š</span>
                            ${escapeHtml(app.line_name || 'æœªæä¾›')}
                        </div>
                        <div>
                            <span class="font-medium">è¯çµ¡é›»è©±ï¼š</span>
                            ${escapeHtml(app.phone || 'æœªæä¾›')}
                        </div>
                        <div class="md:col-span-2">
                            <span class="font-medium">ç”³è«‹æ™‚é–“ï¼š</span>
                            ${app.created_at ? new Date(app.created_at).toLocaleString('zh-TW') : 'æœªçŸ¥'}
                        </div>
                    </div>
                    
                    ${app.message ? `
                        <div class="mb-4">
                            <span class="font-medium text-gray-700">ç”³è«‹ç•™è¨€ï¼š</span>
                            <p class="text-gray-600 bg-gray-50 p-3 rounded-lg mt-1">${escapeHtml(app.message)}</p>
                        </div>
                    ` : ''}
                    
                    ${app.review_notes ? `
                        <div class="mb-4">
                            <span class="font-medium text-gray-700">å¯©æ ¸å‚™è¨»ï¼š</span>
                            <p class="text-gray-600 bg-blue-50 p-3 rounded-lg mt-1">${escapeHtml(app.review_notes)}</p>
                            <div class="text-xs text-gray-500 mt-1">
                                å¯©æ ¸è€…ï¼š${escapeHtml(app.reviewed_by || 'æœªçŸ¥')} | 
                                å¯©æ ¸æ™‚é–“ï¼š${app.reviewed_at ? new Date(app.reviewed_at).toLocaleString('zh-TW') : 'æœªçŸ¥'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end space-x-3">
                        ${app.application_status === 'PENDING' ? `
                            <button onclick="openReviewModal(${app.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                                ğŸ“‹ å¯©æ ¸ç”³è«‹
                            </button>
                        ` : ''}
                        
                        ${app.application_status === 'APPROVED' && !app.partner_link_sent ? `
                            <button onclick="openLinkModal(${app.id})" class="px-4 py-2 btn-success rounded-lg transition text-sm">
                                ğŸ”— ç”Ÿæˆå¤§ä½¿é€£çµ
                            </button>
                        ` : ''}
                        
                        ${app.partner_code_assigned ? `
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                å·²åˆ†é…ä»£ç¢¼ï¼š${escapeHtml(app.partner_code_assigned)}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = applicationsHTML;
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilter() {
            currentFilter = document.getElementById('status-filter').value;
            loadApplications();
        }

        // é–‹å•Ÿå¯©æ ¸æ¨¡æ…‹æ¡†
        function openReviewModal(applicationId) {
            selectedApplication = currentApplications.find(app => app.id === applicationId);
            if (!selectedApplication) return;

            document.getElementById('review-applicant-info').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">ç”³è«‹è€…è³‡è¨Š</h4>
                    <div class="space-y-2 text-sm">
                        <div><strong>å§“åï¼š</strong>${escapeHtml(selectedApplication.name || 'æœªæä¾›')}</div>
                        <div><strong>Emailï¼š</strong>${escapeHtml(selectedApplication.email || 'æœªæä¾›')}</div>
                        <div><strong>LINEï¼š</strong>${escapeHtml(selectedApplication.line_name || 'æœªæä¾›')}</div>
                        <div><strong>é›»è©±ï¼š</strong>${escapeHtml(selectedApplication.phone || 'æœªæä¾›')}</div>
                        ${selectedApplication.message ? `<div><strong>ç•™è¨€ï¼š</strong>${escapeHtml(selectedApplication.message)}</div>` : ''}
                    </div>
                </div>
            `;

            document.getElementById('review-notes').value = '';
            document.getElementById('review-modal').classList.remove('hidden');
        }

        // å¯©æ ¸ç”³è«‹
        async function reviewApplication(status) {
            if (!selectedApplication) return;

            const reviewNotes = document.getElementById('review-notes').value;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'review_application',
                        application_id: selectedApplication.id,
                        status: status,
                        review_notes: reviewNotes,
                        reviewed_by: 'admin'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`ç”³è«‹å·²${status === 'APPROVED' ? 'æ ¸å‡†' : 'æ‹’çµ•'}`);
                    closeReviewModal();
                    loadApplications(); // é‡æ–°è¼‰å…¥æ•¸æ“š
                } else {
                    throw new Error(result.error || 'æ“ä½œå¤±æ•—');
                }
                
            } catch (error) {
                console.error('å¯©æ ¸ç”³è«‹éŒ¯èª¤:', error);
                showError('å¯©æ ¸æ“ä½œå¤±æ•—ï¼š' + error.message);
            }
        }

        // é–‹å•Ÿé€£çµç”Ÿæˆæ¨¡æ…‹æ¡†
        function openLinkModal(applicationId) {
            selectedApplication = currentApplications.find(app => app.id === applicationId);
            if (!selectedApplication) return;

            document.getElementById('link-applicant-info').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">å³å°‡è½‰ç‚ºæ­£å¼å¤§ä½¿</h4>
                    <div class="space-y-2 text-sm">
                        <div><strong>å§“åï¼š</strong>${escapeHtml(selectedApplication.name || 'æœªæä¾›')}</div>
                        <div><strong>Emailï¼š</strong>${escapeHtml(selectedApplication.email || 'æœªæä¾›')}</div>
                    </div>
                </div>
            `;

            // è‡ªå‹•å»ºè­°å¤§ä½¿ä»£ç¢¼
            const suggestedCode = generateSuggestedPartnerCode(selectedApplication.name);
            document.getElementById('partner-code').value = suggestedCode;
            document.getElementById('coupon-url').value = '';
            
            document.getElementById('link-modal').classList.remove('hidden');
        }

        // ç”Ÿæˆå¤§ä½¿é€£çµ
        async function generatePartnerLink() {
            if (!selectedApplication) return;

            const partnerCode = document.getElementById('partner-code').value.trim();
            const couponUrl = document.getElementById('coupon-url').value.trim();

            if (!partnerCode) {
                showError('è«‹è¼¸å…¥å¤§ä½¿ä»£ç¢¼');
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'promote_to_partner',
                        application_id: selectedApplication.id,
                        partner_code: partnerCode,
                        coupon_url: couponUrl
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('ç”³è«‹è€…å·²æˆåŠŸè½‰ç‚ºæ­£å¼å¤§ä½¿ï¼');
                    closeLinkModal();
                    loadApplications(); // é‡æ–°è¼‰å…¥æ•¸æ“š
                    
                    // é¡¯ç¤ºç”Ÿæˆçš„é€£çµè³‡è¨Š
                    alert(`å¤§ä½¿é€£çµå·²ç”Ÿæˆï¼š\n\nè‘—é™¸é é€£çµï¼š${result.landing_link}\n${result.coupon_link ? `å„ªæƒ åˆ¸é€£çµï¼š${result.coupon_link}` : ''}`);
                } else {
                    throw new Error(result.error || 'æ“ä½œå¤±æ•—');
                }
                
            } catch (error) {
                console.error('ç”Ÿæˆå¤§ä½¿é€£çµéŒ¯èª¤:', error);
                showError('ç”Ÿæˆé€£çµå¤±æ•—ï¼š' + error.message);
            }
        }

        // ç”Ÿæˆå»ºè­°çš„å¤§ä½¿ä»£ç¢¼
        function generateSuggestedPartnerCode(name) {
            const timestamp = Date.now().toString().slice(-4);
            if (name) {
                // ç°¡åŒ–å§“åè™•ç†
                const simpleName = name.replace(/[^a-zA-Z0-9\u4e00-\u9fff]/g, '').slice(0, 4);
                return `FOREST${timestamp}`;
            }
            return `FOREST${timestamp}`;
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            if (currentApplications.length === 0) {
                showError('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const headers = ['ID', 'å§“å', 'Email', 'LINEåç¨±', 'é›»è©±', 'ç”³è«‹ç•™è¨€', 'ç‹€æ…‹', 'å¯©æ ¸å‚™è¨»', 'ç”³è«‹æ™‚é–“', 'å¯©æ ¸æ™‚é–“'];
            const csvData = currentApplications.map(app => [
                app.id || '',
                app.name || '',
                app.email || '',
                app.line_name || '',
                app.phone || '',
                app.message || '',
                getStatusText(app.application_status),
                app.review_notes || '',
                app.created_at ? new Date(app.created_at).toLocaleString('zh-TW') : '',
                app.reviewed_at ? new Date(app.reviewed_at).toLocaleString('zh-TW') : ''
            ]);

            const csv = [headers, ...csvData].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ç”³è«‹è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // è¼”åŠ©å‡½æ•¸
        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            selectedApplication = null;
        }

        function closeLinkModal() {
            document.getElementById('link-modal').classList.add('hidden');
            selectedApplication = null;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…å¯©æ ¸',
                'APPROVED': 'å·²æ ¸å‡†',
                'REJECTED': 'å·²æ‹’çµ•'
            };
            return statusMap[status] || 'æœªçŸ¥ç‹€æ…‹';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            alert('âœ… ' + message);
        }

        function showError(message) {
            alert('âŒ ' + message);
        }
    </script>
</body>
</html>