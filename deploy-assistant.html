<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apps Script 自動部署助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .code-container { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">🚀 Apps Script 自動部署助手</h1>
            <p class="text-gray-600">一鍵複製最新後端代碼，告別手動重複操作</p>
        </header>

        <!-- 狀態指示器 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800">當前狀態</h2>
                    <p id="statusText" class="text-gray-600">準備載入最新代碼...</p>
                </div>
                <div id="statusIcon" class="text-4xl">⏳</div>
            </div>
        </div>

        <!-- 快速操作區 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <button onclick="loadLatestCode()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition">
                <div class="text-2xl mb-2">📥</div>
                <div class="font-semibold">載入最新代碼</div>
            </button>
            
            <button onclick="copyToClipboard()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition" disabled id="copyBtn">
                <div class="text-2xl mb-2">📋</div>
                <div class="font-semibold">複製到剪貼板</div>
            </button>
            
            <a href="https://script.google.com/home/projects/1buMGx7T1SFnOIygylkqQURUDFsHGidXcQ-k3kx3Xmn4/edit" target="_blank" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition text-center">
                <div class="text-2xl mb-2">🔗</div>
                <div class="font-semibold">打開 Apps Script</div>
            </a>
        </div>

        <!-- 步驟指南 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">📋 三步驟快速部署</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl mb-2">1️⃣</div>
                    <div class="font-medium">載入最新代碼</div>
                    <div class="text-sm text-gray-600 mt-1">點擊「載入最新代碼」</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl mb-2">2️⃣</div>
                    <div class="font-medium">複製代碼</div>
                    <div class="text-sm text-gray-600 mt-1">點擊「複製到剪貼板」</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl mb-2">3️⃣</div>
                    <div class="font-medium">貼上部署</div>
                    <div class="text-sm text-gray-600 mt-1">在 Apps Script 中貼上並儲存</div>
                </div>
            </div>
        </div>

        <!-- 代碼預覽區 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">📄 最新後端代碼</h3>
                <div class="flex space-x-2">
                    <span id="codeLength" class="text-sm text-gray-500">0 字元</span>
                    <span id="lastUpdate" class="text-sm text-gray-500"></span>
                </div>
            </div>
            
            <div class="code-container bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm">
                <pre id="codeContent">// 點擊「載入最新代碼」來顯示內容...</pre>
            </div>
        </div>

        <!-- 常見問題 -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">❓ 常見問題</h3>
            <div class="space-y-4">
                <details class="border-l-4 border-blue-500 pl-4">
                    <summary class="font-medium cursor-pointer">如何確認部署成功？</summary>
                    <p class="text-gray-600 mt-2">在 Apps Script 中貼上代碼後，點擊「儲存」圖示，然後點擊「部署」→「管理部署」→「編輯」→「版本」→「新版本」→「部署」</p>
                </details>
                
                <details class="border-l-4 border-green-500 pl-4">
                    <summary class="font-medium cursor-pointer">部署後如何測試？</summary>
                    <p class="text-gray-600 mt-2">回到管理後台，嘗試確認入住功能。如果成功，會顯示「入住確認完成！佣金已計算。」</p>
                </details>
                
                <details class="border-l-4 border-purple-500 pl-4">
                    <summary class="font-medium cursor-pointer">為什麼要經常更新？</summary>
                    <p class="text-gray-600 mt-2">系統持續優化中，每次更新都包含錯誤修復和功能改進，確保系統穩定運行。</p>
                </details>
            </div>
        </div>
    </div>

    <script>
        let latestCode = '';
        
        async function loadLatestCode() {
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            const copyBtn = document.getElementById('copyBtn');
            const codeContent = document.getElementById('codeContent');
            const codeLength = document.getElementById('codeLength');
            const lastUpdate = document.getElementById('lastUpdate');
            
            statusText.textContent = '正在載入最新代碼...';
            statusIcon.textContent = '⏳';
            
            try {
                // 從 GitHub 載入最新代碼
                const response = await fetch('https://raw.githubusercontent.com/didi1119/forest-gift-v1/main/backend/apps-script-commission-v2.js');
                
                if (!response.ok) {
                    throw new Error('無法載入代碼');
                }
                
                latestCode = await response.text();
                
                // 更新 UI
                statusText.textContent = '✅ 最新代碼已載入，可以複製了！';
                statusIcon.textContent = '✅';
                copyBtn.disabled = false;
                copyBtn.classList.remove('opacity-50');
                
                codeContent.textContent = latestCode;
                codeLength.textContent = `${latestCode.length.toLocaleString()} 字元`;
                lastUpdate.textContent = `更新時間：${new Date().toLocaleString('zh-TW')}`;
                
            } catch (error) {
                statusText.textContent = '❌ 載入失敗：' + error.message;
                statusIcon.textContent = '❌';
                console.error('載入代碼失敗:', error);
            }
        }
        
        async function copyToClipboard() {
            if (!latestCode) {
                alert('請先載入最新代碼！');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(latestCode);
                
                // 暫時改變按鈕狀態
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<div class="text-2xl mb-2">✅</div><div class="font-semibold">已複製！</div>';
                copyBtn.classList.add('bg-green-800');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('bg-green-800');
                }, 2000);
                
                // 顯示下一步提示
                showNextStepGuide();
                
            } catch (error) {
                alert('複製失敗：' + error.message);
            }
        }
        
        function showNextStepGuide() {
            const guide = document.createElement('div');
            guide.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg max-w-sm z-50';
            guide.innerHTML = `
                <h4 class="font-bold mb-2">🎉 代碼已複製！</h4>
                <p class="text-sm mb-3">現在請：</p>
                <ol class="text-sm list-decimal list-inside space-y-1">
                    <li>點擊上方「打開 Apps Script」</li>
                    <li>選擇並刪除所有現有代碼</li>
                    <li>貼上複製的代碼 (Ctrl+V)</li>
                    <li>點擊儲存 (Ctrl+S)</li>
                    <li>重新部署</li>
                </ol>
                <button onclick="this.parentElement.remove()" class="mt-3 bg-white text-blue-600 px-3 py-1 rounded text-sm font-medium">
                    知道了
                </button>
            `;
            
            document.body.appendChild(guide);
            
            // 5秒後自動消失
            setTimeout(() => {
                if (guide.parentElement) {
                    guide.remove();
                }
            }, 15000);
        }
        
        // 頁面載入時自動載入代碼
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadLatestCode, 1000);
        });
    </script>
</body>
</html>