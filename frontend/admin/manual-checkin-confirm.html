<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¥ä½å®Œæˆç¢ºèªç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">å…¥ä½å®Œæˆç¢ºèªç³»çµ±</h1>
            <p class="text-lg text-stone-600">æ‰‹å‹•ç¢ºèªæˆ¿å®¢å…¥ä½å®Œæˆï¼Œè‡ªå‹•è¨ˆç®—ä½£é‡‘èˆ‡æ›´æ–°å¤§ä½¿ç­‰ç´š</p>
        </header>

        <!-- çµ±è¨ˆæ¦‚è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="totalPendingBookings">-</div>
                <div class="text-sm text-stone-600 mt-1">å¾…ç¢ºèªå…¥ä½</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="totalCompletedToday">-</div>
                <div class="text-sm text-stone-600 mt-1">ä»Šæ—¥å·²ç¢ºèª</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="totalCommissionToday">-</div>
                <div class="text-sm text-stone-600 mt-1">ä»Šæ—¥ç”¢ç”Ÿä½£é‡‘</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-amber-600" id="totalLevelUps">-</div>
                <div class="text-sm text-stone-600 mt-1">ç­‰ç´šæ™‰å‡æ•¸</div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨ -->
        <div class="brand-card p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">ç‹€æ…‹ç¯©é¸</label>
                    <select id="statusFilter" class="p-2 border-2 border-stone-200 rounded-lg focus:border-green-800">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="PENDING">å¾…å…¥ä½</option>
                        <option value="CHECKED_IN">å·²å…¥ä½</option>
                        <option value="COMPLETED" selected>å¯ç¢ºèªå®Œæˆ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">å¤§ä½¿ç¯©é¸</label>
                    <input type="text" id="partnerFilter" placeholder="è¼¸å…¥å¤§ä½¿ä»£ç¢¼" class="p-2 border-2 border-stone-200 rounded-lg focus:border-green-800">
                </div>
                <div class="self-end">
                    <button onclick="loadBookings()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                </div>
            </div>
        </div>

        <!-- å¾…ç¢ºèªå…¥ä½åˆ—è¡¨ -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ğŸ“‹ å¾…ç¢ºèªå…¥ä½è¨˜éŒ„</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">æˆ¿å®¢è³‡è¨Š</th>
                            <th class="text-left py-3 px-4">æ¨è–¦å¤§ä½¿</th>
                            <th class="text-left py-3 px-4">å…¥ä½æœŸé–“</th>
                            <th class="text-center py-3 px-4">æˆ¿åƒ¹</th>
                            <th class="text-center py-3 px-4">ç¾æ³ç‹€æ…‹</th>
                            <th class="text-center py-3 px-4">é è¨ˆä½£é‡‘</th>
                            <th class="text-center py-3 px-4">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable">
                        <tr>
                            <td colspan="7" class="text-center py-8 text-stone-500">
                                è¼‰å…¥ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä½£é‡‘è¨ˆç®—è¦å‰‡èªªæ˜ -->
        <div class="brand-card p-6 mt-8">
            <h3 class="font-serif text-xl font-semibold brand-accent mb-4">ğŸ’° ä½£é‡‘è¨ˆç®—è¦å‰‡</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-700 mb-2">LV1 çŸ¥éŸ³å¤§ä½¿</h4>
                    <p class="text-sm text-stone-600">1000ä½å®¿é‡‘ æˆ– 500ç¾é‡‘</p>
                    <p class="text-xs text-green-600 mt-1">èµ·å§‹ç­‰ç´š</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-700 mb-2">LV2 æ£®æ—åš®å°</h4>
                    <p class="text-sm text-stone-600">1200ä½å®¿é‡‘ æˆ– 600ç¾é‡‘</p>
                    <p class="text-xs text-blue-600 mt-1">éœ€å¹´åº¦4çµ„æˆåŠŸæ¨è–¦</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-purple-700 mb-2">LV3 ç§˜å¢ƒå®ˆè­·è€…</h4>
                    <p class="text-sm text-stone-600">1500ä½å®¿é‡‘ æˆ– 800ç¾é‡‘</p>
                    <p class="text-xs text-purple-600 mt-1">éœ€å¹´åº¦10çµ„æˆåŠŸæ¨è–¦</p>
                </div>
            </div>
            <div class="mt-4 p-4 bg-yellow-50 rounded-lg">
                <p class="text-yellow-800 font-semibold">ğŸ é¦–æ¬¡æ¨è–¦çå‹µ</p>
                <p class="text-sm text-yellow-700">æ¯ä½å¤§ä½¿çš„ç¬¬ä¸€æ¬¡æˆåŠŸæ¨è–¦é¡å¤–ç²å¾— 1500 ä½å®¿é‡‘</p>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªå½ˆçª— -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 max-w-lg w-full">
                <h3 class="text-2xl font-bold text-green-800 mb-4">âœ… ç¢ºèªå…¥ä½å®Œæˆ</h3>
                <div id="confirmDetails" class="space-y-3 text-sm text-stone-600 mb-6">
                    <!-- ç¢ºèªè©³æƒ…å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                <div class="flex space-x-4">
                    <button onclick="executeConfirmation()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700">
                        ç¢ºèªå®Œæˆå…¥ä½
                    </button>
                    <button onclick="closeConfirmModal()" class="px-6 py-3 border-2 border-stone-200 text-stone-600 rounded-lg font-semibold hover:bg-stone-50">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„ iframe ç”¨æ–¼æ¥æ”¶è¡¨å–®å›æ‡‰ -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        // è¨­å®šå€¼
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        let allBookings = [];
        let currentBookingToConfirm = null;
        
        // ä½£é‡‘ç­‰ç´šå°ç…§è¡¨
        const COMMISSION_RATES = {
            'LV1_INSIDER': { accommodation: 1000, cash: 500 },
            'LV2_GUIDE': { accommodation: 1200, cash: 600 },
            'LV3_GUARDIAN': { accommodation: 1500, cash: 800 }
        };
        
        const FIRST_REFERRAL_BONUS = 1500; // é¦–æ¬¡æ¨è–¦çå‹µ

        // è¼‰å…¥è¨‚æˆ¿è¨˜éŒ„
        async function loadBookings() {
            try {
                // ç›®å‰ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼Œå¯¦éš›ä½¿ç”¨æ™‚æœƒå¾ Google Sheets è¼‰å…¥
                loadMockBookings();
                displayBookings();
                updateStats();
                
            } catch (error) {
                console.error('è¼‰å…¥è¨‚æˆ¿è¨˜éŒ„å¤±æ•—:', error);
                showError('è¼‰å…¥å¤±æ•—');
            }
        }

        // è¼‰å…¥æ¨¡æ“¬æ•¸æ“š
        function loadMockBookings() {
            allBookings = [
                {
                    id: 1,
                    partner_code: 'WANG001',
                    partner_name: 'ç‹å°æ˜',
                    partner_level: 'LV1_INSIDER',
                    partner_progress: 0,
                    partner_first_bonus: false,
                    partner_preference: 'CASH',
                    guest_name: 'å¼µä¸‰',
                    guest_phone: '0912345678',
                    checkin_date: '2024-02-10',
                    checkout_date: '2024-02-12',
                    room_price: 5000,
                    stay_status: 'CHECKED_IN',
                    payment_status: 'PAID',
                    commission_status: 'NOT_ELIGIBLE',
                    booking_source: 'REFERRAL_LINK'
                },
                {
                    id: 2,
                    partner_code: 'CHEN002',
                    partner_name: 'é™³å°ç¾',
                    partner_level: 'LV1_INSIDER',
                    partner_progress: 1,
                    partner_first_bonus: true,
                    partner_preference: 'ACCOMMODATION',
                    guest_name: 'æå››',
                    guest_phone: '0987654321',
                    checkin_date: '2024-02-15',
                    checkout_date: '2024-02-17',
                    room_price: 4000,
                    stay_status: 'CHECKED_IN',
                    payment_status: 'PAID',
                    commission_status: 'NOT_ELIGIBLE',
                    booking_source: 'PHONE_BOOKING'
                },
                {
                    id: 3,
                    partner_code: null,
                    partner_name: null,
                    partner_level: null,
                    guest_name: 'ç‹äº”',
                    guest_phone: '0900123456',
                    checkin_date: '2024-02-20',
                    checkout_date: '2024-02-22',
                    room_price: 3500,
                    stay_status: 'PENDING',
                    payment_status: 'PAID',
                    commission_status: 'NOT_ELIGIBLE',
                    booking_source: 'MANUAL_ENTRY'
                }
            ];
        }

        // é¡¯ç¤ºè¨‚æˆ¿è¨˜éŒ„
        function displayBookings() {
            const statusFilter = document.getElementById('statusFilter').value;
            const partnerFilter = document.getElementById('partnerFilter').value.toLowerCase();
            
            let filteredBookings = allBookings.filter(booking => {
                const statusMatch = !statusFilter || booking.stay_status === statusFilter;
                const partnerMatch = !partnerFilter || 
                    (booking.partner_code && booking.partner_code.toLowerCase().includes(partnerFilter)) ||
                    (booking.partner_name && booking.partner_name.toLowerCase().includes(partnerFilter));
                
                return statusMatch && partnerMatch;
            });

            const table = document.getElementById('bookingsTable');
            
            if (filteredBookings.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-stone-500">
                            æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = filteredBookings.map(booking => {
                const canConfirm = booking.stay_status === 'CHECKED_IN' && booking.payment_status === 'PAID';
                const isCompleted = booking.stay_status === 'COMPLETED';
                const estimatedCommission = calculateEstimatedCommission(booking);
                
                return `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="py-4 px-4">
                            <div>
                                <div class="font-semibold">${booking.guest_name}</div>
                                <div class="text-sm text-stone-600">${booking.guest_phone}</div>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            ${booking.partner_code ? `
                                <div>
                                    <div class="font-medium text-green-700">${booking.partner_name}</div>
                                    <div class="text-xs text-stone-500">${booking.partner_code}</div>
                                    <div class="text-xs">
                                        <span class="px-1 py-0.5 rounded text-xs ${getLevelClass(booking.partner_level)}">
                                            ${getLevelText(booking.partner_level)}
                                        </span>
                                    </div>
                                </div>
                            ` : `
                                <span class="text-stone-400">éæ¨è–¦è¨‚æˆ¿</span>
                            `}
                        </td>
                        <td class="py-4 px-4">
                            <div class="text-sm">
                                <div>${booking.checkin_date}</div>
                                <div class="text-stone-500">~ ${booking.checkout_date}</div>
                            </div>
                        </td>
                        <td class="py-4 px-4 text-center font-semibold">
                            $${booking.room_price.toLocaleString()}
                        </td>
                        <td class="py-4 px-4 text-center">
                            <span class="px-2 py-1 rounded text-xs ${getStatusClass(booking.stay_status)}">
                                ${getStatusText(booking.stay_status)}
                            </span>
                            <div class="text-xs text-stone-500 mt-1">
                                ${booking.payment_status === 'PAID' ? 'å·²ä»˜æ¬¾' : 'æœªä»˜æ¬¾'}
                            </div>
                        </td>
                        <td class="py-4 px-4 text-center">
                            ${booking.partner_code ? `
                                <div class="font-semibold text-green-600">
                                    $${estimatedCommission.total}
                                </div>
                                <div class="text-xs text-stone-500">
                                    ${estimatedCommission.breakdown}
                                </div>
                            ` : `
                                <span class="text-stone-400">-</span>
                            `}
                        </td>
                        <td class="py-4 px-4 text-center">
                            ${canConfirm ? `
                                <button onclick="showConfirmModal(${booking.id})" 
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    âœ… ç¢ºèªå®Œæˆ
                                </button>
                            ` : isCompleted ? `
                                <span class="text-green-600 text-sm">å·²å®Œæˆ</span>
                            ` : `
                                <span class="text-stone-400 text-sm">ä¸å¯ç¢ºèª</span>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è¨ˆç®—é ä¼°ä½£é‡‘
        function calculateEstimatedCommission(booking) {
            if (!booking.partner_code) {
                return { total: 0, breakdown: 'ç„¡æ¨è–¦å¤§ä½¿' };
            }

            const level = booking.partner_level || 'LV1_INSIDER';
            const preference = booking.partner_preference || 'CASH';
            const rates = COMMISSION_RATES[level];
            
            let baseCommission = rates[preference.toLowerCase()] || rates.cash;
            let firstBonus = !booking.partner_first_bonus ? FIRST_REFERRAL_BONUS : 0;
            let total = baseCommission + firstBonus;
            
            let breakdown = `åŸºæœ¬: $${baseCommission}`;
            if (firstBonus > 0) {
                breakdown += ` + é¦–æ¨: $${firstBonus}`;
            }
            
            return { total, breakdown };
        }

        // é¡¯ç¤ºç¢ºèªå½ˆçª—
        function showConfirmModal(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            currentBookingToConfirm = booking;
            const commission = calculateEstimatedCommission(booking);
            
            const modal = document.getElementById('confirmModal');
            const details = document.getElementById('confirmDetails');
            
            details.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><strong>æˆ¿å®¢å§“åï¼š</strong>${booking.guest_name}</div>
                    <div><strong>æˆ¿å®¢é›»è©±ï¼š</strong>${booking.guest_phone}</div>
                    <div><strong>å…¥ä½æœŸé–“ï¼š</strong>${booking.checkin_date} ~ ${booking.checkout_date}</div>
                    <div><strong>æˆ¿åƒ¹ï¼š</strong>$${booking.room_price.toLocaleString()}</div>
                    ${booking.partner_code ? `
                        <div><strong>æ¨è–¦å¤§ä½¿ï¼š</strong>${booking.partner_name} (${booking.partner_code})</div>
                        <div><strong>å¤§ä½¿ç­‰ç´šï¼š</strong>${getLevelText(booking.partner_level)}</div>
                        <div><strong>ä½£é‡‘åå¥½ï¼š</strong>${booking.partner_preference === 'CASH' ? 'ç¾é‡‘' : 'ä½å®¿é‡‘'}</div>
                        <div><strong>é è¨ˆä½£é‡‘ï¼š</strong>$${commission.total} (${commission.breakdown})</div>
                    ` : ''}
                </div>
                <div class="mt-4 p-4 bg-amber-50 rounded-lg">
                    <p class="text-amber-800 font-semibold">ç¢ºèªå¾Œå°‡åŸ·è¡Œï¼š</p>
                    <ul class="text-sm text-amber-700 mt-2 list-disc list-inside">
                        <li>å°‡è¨‚æˆ¿ç‹€æ…‹æ›´æ–°ç‚ºã€Œå·²å®Œæˆã€</li>
                        ${booking.partner_code ? `
                            <li>è¨ˆç®—ä¸¦è¨˜éŒ„ä½£é‡‘ $${commission.total}</li>
                            <li>æ›´æ–°å¤§ä½¿æ¨è–¦é€²åº¦</li>
                            <li>æª¢æŸ¥æ˜¯å¦ç¬¦åˆç­‰ç´šæ™‰å‡æ¢ä»¶</li>
                        ` : ''}
                    </ul>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // é—œé–‰ç¢ºèªå½ˆçª—
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            currentBookingToConfirm = null;
        }

        // åŸ·è¡Œç¢ºèª
        async function executeConfirmation() {
            if (!currentBookingToConfirm) return;
            
            const booking = currentBookingToConfirm;
            const button = document.querySelector('#confirmModal button[onclick="executeConfirmation()"]');
            const originalText = button.textContent;
            
            button.textContent = 'è™•ç†ä¸­...';
            button.disabled = true;
            
            try {
                const commission = calculateEstimatedCommission(booking);
                
                // æº–å‚™æäº¤åˆ° Apps Script çš„æ•¸æ“š
                const confirmData = {
                    action: 'confirm_checkin_completion',
                    booking_id: booking.id,
                    partner_code: booking.partner_code,
                    commission_amount: commission.total,
                    commission_type: booking.partner_preference,
                    is_first_referral_bonus: !booking.partner_first_bonus,
                    first_referral_bonus_amount: !booking.partner_first_bonus ? FIRST_REFERRAL_BONUS : 0
                };

                // ä½¿ç”¨è¡¨å–®æäº¤æ–¹å¼ï¼ˆé¿å…CORSå•é¡Œï¼‰
                await submitFormData(confirmData);
                
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                booking.stay_status = 'COMPLETED';
                booking.commission_status = 'CALCULATED';
                
                // æ›´æ–°å¤§ä½¿é€²åº¦ï¼ˆå¦‚æœæœ‰æ¨è–¦å¤§ä½¿ï¼‰
                if (booking.partner_code) {
                    booking.partner_progress += 1;
                    booking.partner_first_bonus = true;
                    
                    // æª¢æŸ¥ç­‰ç´šæ™‰å‡
                    checkLevelUpgrade(booking);
                }
                
                showToast('âœ… å…¥ä½ç¢ºèªå®Œæˆï¼Œä½£é‡‘å·²è¨ˆç®—ä¸¦è¨˜éŒ„ï¼');
                closeConfirmModal();
                displayBookings();
                updateStats();
                
            } catch (error) {
                console.error('ç¢ºèªå¤±æ•—:', error);
                showToast('âŒ ç¢ºèªå¤±æ•—ï¼š' + error.message, 'error');
                
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // æª¢æŸ¥ç­‰ç´šæ™‰å‡
        function checkLevelUpgrade(booking) {
            const currentLevel = booking.partner_level;
            const progress = booking.partner_progress;
            
            let newLevel = currentLevel;
            
            if (currentLevel === 'LV1_INSIDER' && progress >= 4) {
                newLevel = 'LV2_GUIDE';
            } else if (currentLevel === 'LV2_GUIDE' && progress >= 10) {
                newLevel = 'LV3_GUARDIAN';
            }
            
            if (newLevel !== currentLevel) {
                booking.partner_level = newLevel;
                showToast(`ğŸ‰ ${booking.partner_name} æ™‰å‡ç‚º ${getLevelText(newLevel)}ï¼`, 'success');
            }
        }

        // æäº¤è¡¨å–®æ•¸æ“š
        function submitFormData(data) {
            return new Promise((resolve, reject) => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // æ·»åŠ æ‰€æœ‰æ•¸æ“šä½œç‚ºéš±è—è¼¸å…¥
                for (const [key, value] of Object.entries(data)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value || '';
                    form.appendChild(input);
                }

                // ç›£è½ iframe è¼‰å…¥å®Œæˆäº‹ä»¶
                const iframe = document.getElementById('hiddenFrame');
                iframe.onload = function() {
                    setTimeout(() => {
                        resolve();
                    }, 1000);
                };

                // æäº¤è¡¨å–®
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            });
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const pendingBookings = allBookings.filter(b => b.stay_status === 'CHECKED_IN' && b.payment_status === 'PAID').length;
            const completedToday = allBookings.filter(b => b.stay_status === 'COMPLETED').length;
            const totalCommission = allBookings
                .filter(b => b.stay_status === 'COMPLETED' && b.partner_code)
                .reduce((sum, b) => sum + calculateEstimatedCommission(b).total, 0);
            const levelUps = 0; // å¯¦éš›æ‡‰è©²å¾ç³»çµ±è¨˜éŒ„ä¸­è¨ˆç®—
            
            document.getElementById('totalPendingBookings').textContent = pendingBookings;
            document.getElementById('totalCompletedToday').textContent = completedToday;
            document.getElementById('totalCommissionToday').textContent = `$${totalCommission.toLocaleString()}`;
            document.getElementById('totalLevelUps').textContent = levelUps;
        }

        // è¼”åŠ©å‡½æ•¸
        function getStatusClass(status) {
            const classes = {
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'CHECKED_IN': 'bg-blue-100 text-blue-800',
                'COMPLETED': 'bg-green-100 text-green-800',
                'CANCELLED': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const texts = {
                'PENDING': 'å¾…å…¥ä½',
                'CHECKED_IN': 'å·²å…¥ä½',
                'COMPLETED': 'å·²å®Œæˆ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }

        function getLevelClass(level) {
            const classes = {
                'LV1_INSIDER': 'bg-green-100 text-green-800',
                'LV2_GUIDE': 'bg-blue-100 text-blue-800',
                'LV3_GUARDIAN': 'bg-purple-100 text-purple-800'
            };
            return classes[level] || 'bg-gray-100 text-gray-800';
        }

        function getLevelText(level) {
            const texts = {
                'LV1_INSIDER': 'LV1 çŸ¥éŸ³å¤§ä½¿',
                'LV2_GUIDE': 'LV2 æ£®æ—åš®å°',
                'LV3_GUARDIAN': 'LV3 ç§˜å¢ƒå®ˆè­·è€…'
            };
            return texts[level] || level;
        }

        function showError(message) {
            document.getElementById('bookingsTable').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-8 text-red-500">
                        ${message}
                    </td>
                </tr>
            `;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('statusFilter').addEventListener('change', displayBookings);
        document.getElementById('partnerFilter').addEventListener('input', displayBookings);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadBookings();
        });
    </script>
</body>
</html>