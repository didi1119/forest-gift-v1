<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥éŸ³è¨ˆç•« - æ•¸æ“šåˆ†æå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">çŸ¥éŸ³è¨ˆç•«æ•¸æ“šåˆ†æå„€è¡¨æ¿</h1>
            <p class="text-lg text-stone-600">æ·±åº¦æ´å¯Ÿå¤§ä½¿è¡¨ç¾èˆ‡ç”¨æˆ¶è¡Œç‚º</p>
            <div class="flex justify-center space-x-4 mt-4">
                <button onclick="refreshAllData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    ğŸ”„ é‡æ–°æ•´ç†æ•¸æ“š
                </button>
                <button onclick="exportAnalyticsReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    ğŸ“Š åŒ¯å‡ºåˆ†æå ±è¡¨
                </button>
            </div>
        </header>

        <!-- æ ¸å¿ƒæŒ‡æ¨™æ¦‚è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="totalConversionRate">-</div>
                <div class="text-sm text-stone-600 mt-1">æ•´é«”è½‰æ›ç‡</div>
                <div class="text-xs text-stone-500 mt-1">é»æ“Šâ†’å…¥ä½å®Œæˆ</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="avgCommissionPerBooking">-</div>
                <div class="text-sm text-stone-600 mt-1">å¹³å‡ä½£é‡‘</div>
                <div class="text-xs text-stone-500 mt-1">æ¯ç­†å®Œæˆè¨‚æˆ¿</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="topAmbassadorConversion">-</div>
                <div class="text-sm text-stone-600 mt-1">æœ€ä½³å¤§ä½¿è½‰æ›ç‡</div>
                <div class="text-xs text-stone-500 mt-1" id="topAmbassadorName">-</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-amber-600" id="mostPopularCard">-</div>
                <div class="text-sm text-stone-600 mt-1">æœ€å—æ­¡è¿å¡ç‰‡</div>
                <div class="text-xs text-stone-500 mt-1">ç¥è«­å¡ç‰‡ä½¿ç”¨ç‡</div>
            </div>
        </div>

        <!-- å¤§ä½¿è¡¨ç¾åˆ†æ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- å¤§ä½¿ç¸¾æ•ˆæ’è¡Œ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">å¤§ä½¿ç¸¾æ•ˆæ’è¡Œ</h2>
                <div class="chart-container">
                    <canvas id="ambassadorPerformanceChart"></canvas>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm text-stone-600 mb-2">
                        <span>æ’åºæ–¹å¼ï¼š</span>
                        <select id="performanceSort" onchange="updateAmbassadorChart()" class="text-xs border rounded px-2 py-1">
                            <option value="conversion">è½‰æ›ç‡</option>
                            <option value="clicks">é»æ“Šæ•¸</option>
                            <option value="commission">ä½£é‡‘ç¸½é¡</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- å¤§ä½¿ç­‰ç´šåˆ†ä½ˆ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">å¤§ä½¿ç­‰ç´šåˆ†ä½ˆ</h2>
                <div class="chart-container">
                    <canvas id="levelDistributionChart"></canvas>
                </div>
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded mr-2"></span>
                            LV1 çŸ¥éŸ³å¤§ä½¿
                        </span>
                        <span class="text-sm font-semibold" id="lv1Count">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded mr-2"></span>
                            LV2 æ£®æ—åš®å°
                        </span>
                        <span class="text-sm font-semibold" id="lv2Count">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm flex items-center">
                            <span class="w-3 h-3 bg-purple-500 rounded mr-2"></span>
                            LV3 ç§˜å¢ƒå®ˆè­·è€…
                        </span>
                        <span class="text-sm font-semibold" id="lv3Count">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¥è«­å¡ç‰‡ä½¿ç”¨åˆ†æ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- å¡ç‰‡ä½¿ç”¨çµ±è¨ˆ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ç¥è«­å¡ç‰‡ä½¿ç”¨çµ±è¨ˆ</h2>
                <div class="chart-container">
                    <canvas id="giftCardChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div class="text-sm text-stone-600">
                        ç¸½å¡ç‰‡äº’å‹•æ¬¡æ•¸ï¼š<span id="totalCardInteractions" class="font-semibold">-</span>
                    </div>
                </div>
            </div>

            <!-- ç†±é–€å¡ç‰‡æ’è¡Œ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ç†±é–€å¡ç‰‡æ’è¡Œ TOP 10</h2>
                <div id="popularCardsRanking" class="space-y-3">
                    <div class="text-center py-8 text-stone-500">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- æ™‚é–“è¶¨å‹¢åˆ†æ -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">æ™‚é–“è¶¨å‹¢åˆ†æ</h2>
            <div class="mb-4 flex justify-between items-center">
                <div class="flex space-x-4">
                    <button onclick="setTimeRange('7days')" id="btn-7days" class="px-3 py-1 rounded text-sm bg-green-600 text-white">
                        è¿‘7å¤©
                    </button>
                    <button onclick="setTimeRange('30days')" id="btn-30days" class="px-3 py-1 rounded text-sm bg-stone-200 text-stone-700">
                        è¿‘30å¤©
                    </button>
                    <button onclick="setTimeRange('90days')" id="btn-90days" class="px-3 py-1 rounded text-sm bg-stone-200 text-stone-700">
                        è¿‘90å¤©
                    </button>
                </div>
                <div class="text-sm text-stone-600">
                    æ•¸æ“šæ›´æ–°æ™‚é–“ï¼š<span id="lastUpdateTime">-</span>
                </div>
            </div>
            <div class="chart-container" style="height: 400px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- è½‰æ›æ¼æ–—åˆ†æ -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">è½‰æ›æ¼æ–—åˆ†æ</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="bg-blue-100 rounded-lg p-6 mb-3">
                        <div class="text-3xl font-bold text-blue-600" id="funnelClicks">-</div>
                        <div class="text-sm text-blue-700">é»æ“Šé€£çµ</div>
                    </div>
                    <div class="text-xs text-stone-500">100%</div>
                </div>
                <div class="text-center">
                    <div class="bg-green-100 rounded-lg p-6 mb-3">
                        <div class="text-3xl font-bold text-green-600" id="funnelBookings">-</div>
                        <div class="text-sm text-green-700">å®Œæˆè¨‚æˆ¿</div>
                    </div>
                    <div class="text-xs text-stone-500" id="bookingConversionRate">-%</div>
                </div>
                <div class="text-center">
                    <div class="bg-purple-100 rounded-lg p-6 mb-3">
                        <div class="text-3xl font-bold text-purple-600" id="funnelCheckedIn">-</div>
                        <div class="text-sm text-purple-700">å¯¦éš›å…¥ä½</div>
                    </div>
                    <div class="text-xs text-stone-500" id="checkinConversionRate">-%</div>
                </div>
                <div class="text-center">
                    <div class="bg-amber-100 rounded-lg p-6 mb-3">
                        <div class="text-3xl font-bold text-amber-600" id="funnelCompleted">-</div>
                        <div class="text-sm text-amber-700">å®Œæˆå…¥ä½</div>
                    </div>
                    <div class="text-xs text-stone-500" id="completionConversionRate">-%</div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°æ•¸æ“šè¡¨æ ¼ -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">è©³ç´°æ•¸æ“šåˆ†æ</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-3 px-4">å¤§ä½¿ä»£ç¢¼</th>
                            <th class="text-center py-3 px-4">ç­‰ç´š</th>
                            <th class="text-center py-3 px-4">é»æ“Šæ•¸</th>
                            <th class="text-center py-3 px-4">è¨‚æˆ¿æ•¸</th>
                            <th class="text-center py-3 px-4">å®Œæˆæ•¸</th>
                            <th class="text-center py-3 px-4">è½‰æ›ç‡</th>
                            <th class="text-center py-3 px-4">ç´¯ç©ä½£é‡‘</th>
                            <th class="text-center py-3 px-4">å¹³å‡å®¢å–®åƒ¹</th>
                        </tr>
                    </thead>
                    <tbody id="detailedAnalyticsTable">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-stone-500">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Apps Script API é…ç½®
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        // å…¨åŸŸè®Šæ•¸
        let analyticsData = {
            partners: [],
            bookings: [],
            clicks: [],
            payouts: []
        };
        
        let charts = {};
        let currentTimeRange = '7days';

        // è¼‰å…¥åˆ†ææ•¸æ“š
        async function loadAnalyticsData() {
            try {
                // ç›®å‰ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼Œå¯¦éš›éƒ¨ç½²æ™‚æœƒé€£æ¥çœŸå¯¦API
                generateMockAnalyticsData();
                
                updateMetrics();
                initializeCharts();
                updateAllCharts();
                updateDetailedTable();
                
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW');
                
            } catch (error) {
                console.error('è¼‰å…¥åˆ†ææ•¸æ“šå¤±æ•—:', error);
                showError('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // ç”Ÿæˆæ¨¡æ“¬åˆ†ææ•¸æ“š
        function generateMockAnalyticsData() {
            // æ¨¡æ“¬ç¥è«­å¡ç‰‡æ•¸æ“š
            const cardNames = [
                'é•·æ—¥ (The Longest Day)', 'æ°¸å¤œ (The Longest Night)', 'æ˜¥åˆ† (Vernal Equinox)', 
                'ç§‹åˆ† (Autumnal Equinox)', 'ä¹¾æ—± (The Drought)', 'æ´ªæ°´ (The Flood)', 
                'å¤§ç« (The Great Fire)', 'æ·±é›ª (The Deep Snow)', 'æ¿ƒéœ§ (The Thick Fog)',
                'é›·æš´ (The Thunderstorm)', 'æ™´ç©º (The Clear Sky)', 'æ˜Ÿç©º (The Starry Sky)',
                'å·¨æœ¨ (The Giant Tree)', 'æ²³æµ (The River)', 'ç€‘å¸ƒ (The Waterfall)',
                'æ´ç©´ (The Cave)', 'å‹•ç‰©é·å¾™ (The Great Migration)', 'è…æœ¨ (The Decomposing Log)',
                'èŒçµ²ç¶²çµ¡ (The Mycelial Network)', 'é³¥ç¾¤å…±èˆ (The Murmuration)'
            ];
            
            // ç”Ÿæˆæ¨¡æ“¬é»æ“Šæ•¸æ“šï¼ˆåŒ…å«å¡ç‰‡é¸æ“‡ï¼‰
            analyticsData.clicks = [];
            for (let i = 0; i < 150; i++) {
                analyticsData.clicks.push({
                    partner_code: `DEMO${String(Math.floor(Math.random() * 5) + 1).padStart(3, '0')}`,
                    timestamp: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                    gift_card_selected: cardNames[Math.floor(Math.random() * cardNames.length)] || null
                });
            }

            // ç”Ÿæˆæ¨¡æ“¬å¤¥ä¼´æ•¸æ“š
            analyticsData.partners = [
                { partner_code: 'DEMO001', name: 'ç‹å°æ˜', level: 'LV2_GUIDE', total_commission_earned: 3200, level_progress: 6 },
                { partner_code: 'DEMO002', name: 'é™³å°ç¾', level: 'LV1_INSIDER', total_commission_earned: 1500, level_progress: 2 },
                { partner_code: 'DEMO003', name: 'æ—å¤§è¯', level: 'LV3_GUARDIAN', total_commission_earned: 8500, level_progress: 15 },
                { partner_code: 'DEMO004', name: 'å¼µé›…é›¯', level: 'LV1_INSIDER', total_commission_earned: 800, level_progress: 1 },
                { partner_code: 'DEMO005', name: 'æå¿—å¼·', level: 'LV2_GUIDE', total_commission_earned: 2800, level_progress: 4 }
            ];

            // ç”Ÿæˆæ¨¡æ“¬è¨‚æˆ¿æ•¸æ“š
            analyticsData.bookings = [
                { partner_code: 'DEMO001', stay_status: 'COMPLETED', room_price: 5000, commission_amount: 600 },
                { partner_code: 'DEMO001', stay_status: 'COMPLETED', room_price: 4500, commission_amount: 600 },
                { partner_code: 'DEMO002', stay_status: 'COMPLETED', room_price: 3500, commission_amount: 500 },
                { partner_code: 'DEMO003', stay_status: 'COMPLETED', room_price: 6000, commission_amount: 800 },
                { partner_code: 'DEMO003', stay_status: 'PENDING', room_price: 5500, commission_amount: 0 },
                { partner_code: 'DEMO004', stay_status: 'COMPLETED', room_price: 4000, commission_amount: 500 },
                { partner_code: 'DEMO005', stay_status: 'CHECKED_IN', room_price: 4800, commission_amount: 0 }
            ];
        }

        // æ›´æ–°æ ¸å¿ƒæŒ‡æ¨™
        function updateMetrics() {
            // è¨ˆç®—æ•´é«”è½‰æ›ç‡
            const totalClicks = analyticsData.clicks.length;
            const completedBookings = analyticsData.bookings.filter(b => b.stay_status === 'COMPLETED').length;
            const conversionRate = totalClicks > 0 ? ((completedBookings / totalClicks) * 100).toFixed(1) : '0.0';
            
            // è¨ˆç®—å¹³å‡ä½£é‡‘
            const totalCommission = analyticsData.bookings
                .filter(b => b.stay_status === 'COMPLETED')
                .reduce((sum, b) => sum + (b.commission_amount || 0), 0);
            const avgCommission = completedBookings > 0 ? Math.round(totalCommission / completedBookings) : 0;
            
            // æ‰¾å‡ºæœ€ä½³å¤§ä½¿
            const partnerStats = calculatePartnerStats();
            const topAmbassador = partnerStats.reduce((best, current) => 
                current.conversionRate > best.conversionRate ? current : best, 
                { conversionRate: 0, name: '-' }
            );
            
            // æ‰¾å‡ºæœ€å—æ­¡è¿çš„å¡ç‰‡
            const cardStats = calculateCardStats();
            const mostPopular = cardStats.length > 0 ? cardStats[0] : { name: '-' };
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('totalConversionRate').textContent = conversionRate + '%';
            document.getElementById('avgCommissionPerBooking').textContent = '$' + avgCommission;
            document.getElementById('topAmbassadorConversion').textContent = topAmbassador.conversionRate.toFixed(1) + '%';
            document.getElementById('topAmbassadorName').textContent = topAmbassador.name;
            document.getElementById('mostPopularCard').textContent = mostPopular.name.split(' ')[0] || '-';
        }

        // è¨ˆç®—å¤¥ä¼´çµ±è¨ˆ
        function calculatePartnerStats() {
            return analyticsData.partners.map(partner => {
                const partnerClicks = analyticsData.clicks.filter(c => c.partner_code === partner.partner_code).length;
                const partnerBookings = analyticsData.bookings.filter(b => b.partner_code === partner.partner_code);
                const completedBookings = partnerBookings.filter(b => b.stay_status === 'COMPLETED').length;
                
                return {
                    ...partner,
                    clicks: partnerClicks,
                    bookings: partnerBookings.length,
                    completed: completedBookings,
                    conversionRate: partnerClicks > 0 ? (completedBookings / partnerClicks) * 100 : 0,
                    avgOrderValue: completedBookings > 0 ? 
                        partnerBookings.filter(b => b.stay_status === 'COMPLETED')
                                     .reduce((sum, b) => sum + b.room_price, 0) / completedBookings : 0
                };
            });
        }

        // è¨ˆç®—å¡ç‰‡çµ±è¨ˆ
        function calculateCardStats() {
            const cardCounts = {};
            analyticsData.clicks.forEach(click => {
                if (click.gift_card_selected) {
                    cardCounts[click.gift_card_selected] = (cardCounts[click.gift_card_selected] || 0) + 1;
                }
            });
            
            return Object.entries(cardCounts)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);
        }

        // åˆå§‹åŒ–åœ–è¡¨
        function initializeCharts() {
            // å¤§ä½¿ç¸¾æ•ˆåœ–è¡¨
            const ctx1 = document.getElementById('ambassadorPerformanceChart').getContext('2d');
            charts.ambassadorPerformance = new Chart(ctx1, {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: '#2E4B36' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // ç­‰ç´šåˆ†ä½ˆåœ–è¡¨
            const ctx2 = document.getElementById('levelDistributionChart').getContext('2d');
            charts.levelDistribution = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['LV1 çŸ¥éŸ³å¤§ä½¿', 'LV2 æ£®æ—åš®å°', 'LV3 ç§˜å¢ƒå®ˆè­·è€…'],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // ç¥è«­å¡ç‰‡åœ–è¡¨
            const ctx3 = document.getElementById('giftCardChart').getContext('2d');
            charts.giftCard = new Chart(ctx3, {
                type: 'pie',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // æ™‚é–“è¶¨å‹¢åœ–è¡¨
            const ctx4 = document.getElementById('trendChart').getContext('2d');
            charts.trend = new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'é»æ“Šæ•¸', data: [], borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                        { label: 'è¨‚æˆ¿æ•¸', data: [], borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)' },
                        { label: 'å®Œæˆæ•¸', data: [], borderColor: '#F59E0B', backgroundColor: 'rgba(245, 158, 11, 0.1)' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateAllCharts() {
            updateAmbassadorChart();
            updateLevelChart();
            updateCardChart();
            updateTrendChart();
            updateFunnelAnalysis();
        }

        // æ›´æ–°å¤§ä½¿åœ–è¡¨
        function updateAmbassadorChart() {
            const sortBy = document.getElementById('performanceSort').value;
            const partnerStats = calculatePartnerStats();
            
            let sortedStats;
            switch (sortBy) {
                case 'conversion':
                    sortedStats = partnerStats.sort((a, b) => b.conversionRate - a.conversionRate);
                    break;
                case 'clicks':
                    sortedStats = partnerStats.sort((a, b) => b.clicks - a.clicks);
                    break;
                case 'commission':
                    sortedStats = partnerStats.sort((a, b) => b.total_commission_earned - a.total_commission_earned);
                    break;
                default:
                    sortedStats = partnerStats;
            }
            
            charts.ambassadorPerformance.data.labels = sortedStats.map(p => p.partner_code);
            charts.ambassadorPerformance.data.datasets[0].data = sortedStats.map(p => {
                switch (sortBy) {
                    case 'conversion': return p.conversionRate;
                    case 'clicks': return p.clicks;
                    case 'commission': return p.total_commission_earned;
                    default: return p.conversionRate;
                }
            });
            charts.ambassadorPerformance.update();
        }

        // æ›´æ–°ç­‰ç´šåˆ†ä½ˆåœ–è¡¨
        function updateLevelChart() {
            const levelCounts = {
                'LV1_INSIDER': analyticsData.partners.filter(p => p.level === 'LV1_INSIDER').length,
                'LV2_GUIDE': analyticsData.partners.filter(p => p.level === 'LV2_GUIDE').length,
                'LV3_GUARDIAN': analyticsData.partners.filter(p => p.level === 'LV3_GUARDIAN').length
            };
            
            charts.levelDistribution.data.datasets[0].data = [
                levelCounts.LV1_INSIDER,
                levelCounts.LV2_GUIDE,
                levelCounts.LV3_GUARDIAN
            ];
            charts.levelDistribution.update();
            
            // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
            document.getElementById('lv1Count').textContent = levelCounts.LV1_INSIDER + ' äºº';
            document.getElementById('lv2Count').textContent = levelCounts.LV2_GUIDE + ' äºº';
            document.getElementById('lv3Count').textContent = levelCounts.LV3_GUARDIAN + ' äºº';
        }

        // æ›´æ–°å¡ç‰‡åœ–è¡¨
        function updateCardChart() {
            const cardStats = calculateCardStats();
            const top10Cards = cardStats.slice(0, 10);
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            charts.giftCard.data.labels = top10Cards.map(c => c.name.split(' ')[0]);
            charts.giftCard.data.datasets[0].data = top10Cards.map(c => c.count);
            charts.giftCard.data.datasets[0].backgroundColor = colors.slice(0, top10Cards.length);
            charts.giftCard.update();
            
            // æ›´æ–°ç¸½äº’å‹•æ¬¡æ•¸
            const totalInteractions = cardStats.reduce((sum, card) => sum + card.count, 0);
            document.getElementById('totalCardInteractions').textContent = totalInteractions.toLocaleString();
            
            // æ›´æ–°ç†±é–€å¡ç‰‡æ’è¡Œ
            updatePopularCardsRanking(cardStats.slice(0, 10));
        }

        // æ›´æ–°ç†±é–€å¡ç‰‡æ’è¡Œ
        function updatePopularCardsRanking(cardStats) {
            const container = document.getElementById('popularCardsRanking');
            
            if (cardStats.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-stone-500">æš«ç„¡æ•¸æ“š</div>';
                return;
            }
            
            container.innerHTML = cardStats.map((card, index) => `
                <div class="flex items-center justify-between p-3 bg-stone-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${index < 3 ? 'bg-amber-100 text-amber-800' : 'bg-stone-200 text-stone-600'} font-semibold mr-3">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium text-sm">${card.name.split(' ')[0]}</div>
                            <div class="text-xs text-stone-500">${card.name}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-green-600">${card.count}</div>
                        <div class="text-xs text-stone-500">æ¬¡ä½¿ç”¨</div>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°è¶¨å‹¢åœ–è¡¨
        function updateTrendChart() {
            // ç”Ÿæˆæ¨¡æ“¬è¶¨å‹¢æ•¸æ“š
            const days = currentTimeRange === '7days' ? 7 : currentTimeRange === '30days' ? 30 : 90;
            const labels = [];
            const clicksData = [];
            const bookingsData = [];
            const completedData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }));
                
                // æ¨¡æ“¬æ•¸æ“š
                clicksData.push(Math.floor(Math.random() * 20) + 5);
                bookingsData.push(Math.floor(Math.random() * 8) + 1);
                completedData.push(Math.floor(Math.random() * 6) + 1);
            }
            
            charts.trend.data.labels = labels;
            charts.trend.data.datasets[0].data = clicksData;
            charts.trend.data.datasets[1].data = bookingsData;
            charts.trend.data.datasets[2].data = completedData;
            charts.trend.update();
        }

        // æ›´æ–°æ¼æ–—åˆ†æ
        function updateFunnelAnalysis() {
            const totalClicks = analyticsData.clicks.length;
            const totalBookings = analyticsData.bookings.length;
            const checkedIn = analyticsData.bookings.filter(b => b.stay_status === 'CHECKED_IN' || b.stay_status === 'COMPLETED').length;
            const completed = analyticsData.bookings.filter(b => b.stay_status === 'COMPLETED').length;
            
            document.getElementById('funnelClicks').textContent = totalClicks;
            document.getElementById('funnelBookings').textContent = totalBookings;
            document.getElementById('funnelCheckedIn').textContent = checkedIn;
            document.getElementById('funnelCompleted').textContent = completed;
            
            // è¨ˆç®—è½‰æ›ç‡
            const bookingRate = totalClicks > 0 ? ((totalBookings / totalClicks) * 100).toFixed(1) : '0.0';
            const checkinRate = totalBookings > 0 ? ((checkedIn / totalBookings) * 100).toFixed(1) : '0.0';
            const completionRate = checkedIn > 0 ? ((completed / checkedIn) * 100).toFixed(1) : '0.0';
            
            document.getElementById('bookingConversionRate').textContent = bookingRate + '%';
            document.getElementById('checkinConversionRate').textContent = checkinRate + '%';
            document.getElementById('completionConversionRate').textContent = completionRate + '%';
        }

        // æ›´æ–°è©³ç´°æ•¸æ“šè¡¨æ ¼
        function updateDetailedTable() {
            const partnerStats = calculatePartnerStats();
            const table = document.getElementById('detailedAnalyticsTable');
            
            if (partnerStats.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-stone-500">æš«ç„¡æ•¸æ“š</td></tr>';
                return;
            }
            
            table.innerHTML = partnerStats.map(partner => `
                <tr class="border-b hover:bg-stone-50">
                    <td class="py-3 px-4 font-medium">${partner.partner_code}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-2 py-1 rounded text-xs ${getLevelClass(partner.level)}">
                            ${getLevelText(partner.level)}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">${partner.clicks}</td>
                    <td class="py-3 px-4 text-center">${partner.bookings}</td>
                    <td class="py-3 px-4 text-center font-semibold text-green-600">${partner.completed}</td>
                    <td class="py-3 px-4 text-center">${partner.conversionRate.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-center">$${(partner.total_commission_earned || 0).toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">$${partner.avgOrderValue.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // è¼”åŠ©å‡½æ•¸
        function getLevelClass(level) {
            const classes = {
                'LV1_INSIDER': 'bg-green-100 text-green-800',
                'LV2_GUIDE': 'bg-blue-100 text-blue-800',
                'LV3_GUARDIAN': 'bg-purple-100 text-purple-800'
            };
            return classes[level] || 'bg-gray-100 text-gray-800';
        }

        function getLevelText(level) {
            const texts = {
                'LV1_INSIDER': 'LV1',
                'LV2_GUIDE': 'LV2',
                'LV3_GUARDIAN': 'LV3'
            };
            return texts[level] || 'LV1';
        }

        function setTimeRange(range) {
            currentTimeRange = range;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('[id^="btn-"]').forEach(btn => {
                btn.className = 'px-3 py-1 rounded text-sm bg-stone-200 text-stone-700';
            });
            document.getElementById(`btn-${range}`).className = 'px-3 py-1 rounded text-sm bg-green-600 text-white';
            
            updateTrendChart();
        }

        function refreshAllData() {
            location.reload();
        }

        function exportAnalyticsReport() {
            const partnerStats = calculatePartnerStats();
            const reportData = partnerStats.map(p => ({
                'å¤§ä½¿ä»£ç¢¼': p.partner_code,
                'å§“å': p.name,
                'ç­‰ç´š': getLevelText(p.level),
                'é»æ“Šæ•¸': p.clicks,
                'è¨‚æˆ¿æ•¸': p.bookings,
                'å®Œæˆæ•¸': p.completed,
                'è½‰æ›ç‡': p.conversionRate.toFixed(1) + '%',
                'ç´¯ç©ä½£é‡‘': p.total_commission_earned,
                'å¹³å‡å®¢å–®åƒ¹': Math.round(p.avgOrderValue)
            }));
            
            downloadCSV(reportData, 'çŸ¥éŸ³è¨ˆç•«åˆ†æå ±è¡¨.csv');
        }

        function downloadCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        function showError(message) {
            alert('éŒ¯èª¤ï¼š' + message);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalyticsData();
        });
    </script>
</body>
</html>