<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診斷測試 - 查找問題根源</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">診斷測試 - 查找問題根源</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Google Apps Script URL</label>
                <input type="text" id="scriptUrl" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                       value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
            </div>
            
            <button onclick="runDiagnosticTest()" 
                    class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold">
                🔍 開始診斷
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">診斷結果</h2>
            <div id="results" class="space-y-3">
                <p class="text-gray-500">點擊「開始診斷」來執行測試...</p>
            </div>
        </div>
    </div>

    <script>
        const TEST_CODE = 'DIAG_' + Date.now();
        let testBookingId = null;
        
        async function runDiagnosticTest() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            try {
                // Step 1: 創建測試大使
                addResult('📝 Step 1: 創建測試大使（初始10000點）', 'info');
                
                const createPartnerParams = new URLSearchParams({
                    action: 'create_partner',
                    partner_code: TEST_CODE,
                    partner_name: '診斷測試大使',
                    partner_level: 'LV1_INSIDER',
                    contact_phone: '0999888777',
                    contact_email: 'diag@test.com',
                    commission_preference: 'ACCOMMODATION',
                    available_points: '10000',
                    points_used: '0',
                    successful_referrals: '0',
                    bank_account: '9999888877776666'
                });
                
                const createPartnerResponse = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: createPartnerParams.toString()
                });
                
                const partnerResult = await createPartnerResponse.json();
                
                if (!partnerResult.success) {
                    addResult(`❌ 創建大使失敗: ${partnerResult.error}`, 'error');
                    return;
                }
                
                addResult('✅ 大使創建成功', 'success');
                
                // Step 2: 取得初始狀態
                addResult('📝 Step 2: 檢查初始狀態', 'info');
                await delay(1000);
                
                const initialData = await getPartnerData(scriptUrl, TEST_CODE);
                if (!initialData) {
                    addResult('❌ 無法取得初始資料', 'error');
                    return;
                }
                
                addResult(`初始狀態:`, 'data');
                addResult(`• available_points: ${initialData.available_points}`, 'data');
                addResult(`• points_used: ${initialData.points_used}`, 'data');
                addResult(`• successful_referrals: ${initialData.successful_referrals}`, 'data');
                addResult(`• partner_level: ${initialData.partner_level || initialData.level}`, 'data');
                
                // Step 3: 創建訂房（使用表單方式避免 CORS）
                addResult('📝 Step 3: 創建訂房（推薦訂房）', 'info');
                
                testBookingId = 'BOOK_' + Date.now();
                
                // 使用 iframe 和表單提交
                const iframe = document.createElement('iframe');
                iframe.name = 'submitFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = scriptUrl;
                form.target = 'submitFrame';
                form.style.display = 'none';
                
                const bookingData = {
                    action: 'create_booking',
                    partner_code: TEST_CODE,
                    guest_name: '測試房客_' + Date.now(),
                    guest_phone: '0911' + Math.floor(Math.random() * 1000000),
                    checkin_date: '2024-12-25',
                    checkout_date: '2024-12-27',
                    room_price: '5000',
                    booking_source: 'REFERRAL',
                    notes: '診斷測試訂房'
                };
                
                Object.keys(bookingData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = bookingData[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
                
                // 等待提交完成
                await delay(3000);
                
                // 查找訂房
                const bookings = await getBookings(scriptUrl, TEST_CODE);
                if (bookings && bookings.length > 0) {
                    testBookingId = bookings[0].id;
                    addResult(`✅ 訂房創建成功，ID: ${testBookingId}`, 'success');
                } else {
                    addResult('⚠️ 訂房可能失敗，繼續測試...', 'warning');
                }
                
                // Step 4: 確認入住
                addResult('📝 Step 4: 確認入住完成', 'info');
                
                if (testBookingId) {
                    const confirmForm = document.createElement('form');
                    confirmForm.method = 'POST';
                    confirmForm.action = scriptUrl;
                    confirmForm.target = 'submitFrame';
                    confirmForm.style.display = 'none';
                    
                    const confirmData = {
                        action: 'confirm_checkin_completion',
                        booking_id: testBookingId,
                        confirmed_by: 'diagnostic_test'
                    };
                    
                    Object.keys(confirmData).forEach(key => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = confirmData[key];
                        confirmForm.appendChild(input);
                    });
                    
                    document.body.appendChild(confirmForm);
                    confirmForm.submit();
                    
                    await delay(3000);
                    addResult('✅ 確認入住請求已發送', 'success');
                }
                
                // Step 5: 檢查最終狀態
                addResult('📝 Step 5: 檢查最終狀態', 'info');
                await delay(2000);
                
                const finalData = await getPartnerData(scriptUrl, TEST_CODE);
                if (!finalData) {
                    addResult('❌ 無法取得最終資料', 'error');
                    return;
                }
                
                addResult(`最終狀態:`, 'data');
                addResult(`• available_points: ${finalData.available_points}`, 'data');
                addResult(`• points_used: ${finalData.points_used}`, 'data');
                addResult(`• successful_referrals: ${finalData.successful_referrals}`, 'data');
                addResult(`• total_commission_earned: ${finalData.total_commission_earned}`, 'data');
                
                // 分析結果
                addResult('📊 分析結果:', 'header');
                
                const pointsChange = finalData.available_points - initialData.available_points;
                const referralsChange = finalData.successful_referrals - initialData.successful_referrals;
                
                if (pointsChange > 0) {
                    addResult(`✅ 點數增加了 ${pointsChange} 點（佣金正確計算）`, 'success');
                } else if (pointsChange === 0) {
                    addResult(`⚠️ 點數沒有變化（佣金可能沒有計算）`, 'warning');
                } else {
                    addResult(`❌ 點數減少了 ${Math.abs(pointsChange)} 點（異常）`, 'error');
                }
                
                if (referralsChange > 0) {
                    addResult(`✅ 成功推薦數增加了 ${referralsChange}`, 'success');
                } else {
                    addResult(`⚠️ 成功推薦數沒有變化`, 'warning');
                }
                
                // 預期佣金
                const expectedCommission = 1000; // LV1 ACCOMMODATION
                const expectedFirstBonus = (initialData.successful_referrals === 0) ? 1500 : 0;
                const expectedTotal = expectedCommission + expectedFirstBonus;
                
                addResult(`預期佣金: ${expectedCommission} + 首次獎勵: ${expectedFirstBonus} = ${expectedTotal}`, 'info');
                
                if (Math.abs(pointsChange - expectedTotal) < 1) {
                    addResult('🎉 佣金計算完全正確！', 'success');
                } else {
                    addResult(`⚠️ 佣金計算可能有誤差: 實際 ${pointsChange} vs 預期 ${expectedTotal}`, 'warning');
                }
                
                // 檢查訂房狀態
                const finalBookings = await getBookings(scriptUrl, TEST_CODE);
                if (finalBookings && finalBookings.length > 0) {
                    const booking = finalBookings[0];
                    addResult('訂房狀態:', 'header');
                    addResult(`• stay_status: ${booking.stay_status}`, 'data');
                    addResult(`• commission_status: ${booking.commission_status}`, 'data');
                    addResult(`• commission_amount: ${booking.commission_amount}`, 'data');
                    addResult(`• commission_type: ${booking.commission_type}`, 'data');
                }
                
            } catch (error) {
                addResult(`❌ 錯誤: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function getPartnerData(scriptUrl, partnerCode) {
            const response = await fetch(`${scriptUrl}?action=get_all_data`);
            const data = await response.json();
            
            if (data.success && data.data.partners) {
                return data.data.partners.find(p => p.partner_code === partnerCode);
            }
            return null;
        }
        
        async function getBookings(scriptUrl, partnerCode) {
            const response = await fetch(`${scriptUrl}?action=get_all_data`);
            const data = await response.json();
            
            if (data.success && data.data.bookings) {
                return data.data.bookings.filter(b => b.partner_code === partnerCode);
            }
            return [];
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const colors = {
                success: 'text-green-600 font-semibold',
                error: 'text-red-600 font-semibold',
                warning: 'text-yellow-600',
                info: 'text-blue-600',
                data: 'text-gray-700 ml-4',
                header: 'text-purple-600 font-bold text-lg mt-4'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || colors.info;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }
    </script>
</body>
</html>