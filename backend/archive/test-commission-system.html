<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½£é‡‘ç³»çµ±å®Œæ•´æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ä½£é‡‘ç³»çµ±å®Œæ•´æ¸¬è©¦</h1>
        
        <!-- é…ç½®å€ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Google Apps Script URL
                    </label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        æ¸¬è©¦å¤¥ä¼´ä»£ç¢¼
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="TEST_COMMISSION_001">
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦æ¡ˆä¾‹ -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <!-- å·¦å´ï¼šé»æ•¸ç›¸é—œæ¸¬è©¦ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">é»æ•¸ç³»çµ±æ¸¬è©¦</h2>
                <div class="space-y-3">
                    <button onclick="testCreatePartnerWithPoints()" 
                            class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        1. å‰µå»ºæ¸¬è©¦å¤§ä½¿ï¼ˆå«åˆå§‹é»æ•¸ï¼‰
                    </button>
                    
                    <button onclick="testEarnPoints()" 
                            class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        2. è³ºå–ä½å®¿é‡‘é»æ•¸ï¼ˆå®Œæˆæ¨è–¦ï¼‰
                    </button>
                    
                    <button onclick="testUsePoints()" 
                            class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        3. ä½¿ç”¨ä½å®¿é‡‘é»æ•¸
                    </button>
                    
                    <button onclick="testConvertPointsToCash()" 
                            class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        4. è½‰æ›é»æ•¸ç‚ºç¾é‡‘ï¼ˆ50%åŒ¯ç‡ï¼‰
                    </button>
                    
                    <button onclick="testInsufficientPoints()" 
                            class="w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        5. æ¸¬è©¦é»æ•¸ä¸è¶³æƒ…æ³
                    </button>
                </div>
            </div>

            <!-- å³å´ï¼šå–æ¶ˆèˆ‡è² å‚µæ¸¬è©¦ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">å–æ¶ˆçµç®—æ¸¬è©¦</h2>
                <div class="space-y-3">
                    <button onclick="testCancelPayoutNormal()" 
                            class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        1. å–æ¶ˆçµç®—ï¼ˆé»æ•¸å……è¶³ï¼‰
                    </button>
                    
                    <button onclick="testCancelPayoutWithDebt()" 
                            class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                        2. å–æ¶ˆçµç®—ï¼ˆé»æ•¸ä¸è¶³ç”¢ç”Ÿè² å‚µï¼‰
                    </button>
                    
                    <button onclick="testDeleteBookingWithCommission()" 
                            class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
                        3. å–æ¶ˆå·²çµç®—è¨‚æˆ¿
                    </button>
                    
                    <button onclick="testGetPartnerStatus()" 
                            class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                        4. æŸ¥çœ‹å¤§ä½¿ç•¶å‰ç‹€æ…‹
                    </button>
                    
                    <button onclick="testFullScenario()" 
                            class="w-full bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800">
                        5. å®Œæ•´å ´æ™¯æ¸¬è©¦
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="results" class="space-y-2 font-mono text-sm">
                <p class="text-gray-500">æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„ iframe -->
    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <script>
        let testBookingId = null;
        let testPayoutId = null;

        // è¼”åŠ©å‡½æ•¸ï¼šæäº¤è¡¨å–®
        function submitForm(action, data, callback) {
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = scriptUrl;
            form.target = 'hiddenFrame';
            form.style.display = 'none';

            // æ·»åŠ  action
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = action;
            form.appendChild(actionInput);

            // æ·»åŠ å…¶ä»–æ•¸æ“š
            Object.keys(data).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data[key];
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            // æ¨¡æ“¬å›èª¿
            setTimeout(() => {
                if (callback) callback();
            }, 1500);
        }

        // æ·»åŠ çµæœ
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };
            
            const resultItem = `<div class="${colors[type]}">
                <span class="text-gray-500">[${timestamp}]</span> ${message}
            </div>`;
            
            if (resultsDiv.innerHTML.includes('æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                resultsDiv.innerHTML = resultItem;
            } else {
                resultsDiv.innerHTML = resultItem + resultsDiv.innerHTML;
            }
        }

        // æ¸¬è©¦æ¡ˆä¾‹
        function testCreatePartnerWithPoints() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            submitForm('create_partner', {
                partner_code: partnerCode,
                partner_name: 'æ¸¬è©¦å¤§ä½¿ï¼ˆä½£é‡‘ç³»çµ±ï¼‰',
                contact_phone: '0912345678',
                bank_account: '12345678901234',
                commission_preference: 'ACCOMMODATION',
                available_points: 5000,  // çµ¦äºˆåˆå§‹é»æ•¸ç”¨æ–¼æ¸¬è©¦
                notes: 'æ¸¬è©¦ç”¨å¤§ä½¿ï¼Œåˆå§‹é»æ•¸5000'
            }, () => {
                addResult(`âœ… å‰µå»ºå¤§ä½¿ ${partnerCode}ï¼Œåˆå§‹é»æ•¸ï¼š5000`, 'success');
            });
        }

        function testEarnPoints() {
            const partnerCode = document.getElementById('partnerCode').value;
            const bookingId = 'BOOK_' + Date.now();
            
            // å…ˆå‰µå»ºè¨‚æˆ¿
            submitForm('create_booking', {
                partner_code: partnerCode,
                guest_name: 'è³ºå–é»æ•¸æ¸¬è©¦_' + Date.now(),
                guest_phone: '0987654321',
                checkin_date: '2024-12-25',
                checkout_date: '2024-12-27',
                room_price: 5000
            }, () => {
                testBookingId = bookingId;
                addResult(`ğŸ“ å‰µå»ºæ¨è–¦è¨‚æˆ¿`, 'info');
                
                // ç¢ºèªå…¥ä½å®Œæˆ
                setTimeout(() => {
                    submitForm('confirm_checkin_completion', {
                        guest_name: 'è³ºå–é»æ•¸æ¸¬è©¦_' + Date.now(),
                        guest_phone: '0987654321',
                        checkin_date: '2024-12-25'
                    }, () => {
                        addResult(`âœ… ç¢ºèªå…¥ä½å®Œæˆï¼Œæ‡‰ç²å¾—ä½å®¿é‡‘é»æ•¸`, 'success');
                    });
                }, 1000);
            });
        }

        function testUsePoints() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            submitForm('use_accommodation_points', {
                partner_code: partnerCode,
                deduct_amount: 1000,
                checkin_date: '2024-12-28',
                room_price: 3000,
                notes: 'æ¸¬è©¦ä½¿ç”¨ä½å®¿é‡‘1000é»'
            }, () => {
                addResult(`âœ… ä½¿ç”¨1000é»ä½å®¿é‡‘`, 'success');
            });
        }

        function testConvertPointsToCash() {
            const partnerCode = document.getElementById('partnerCode').value;
            const pointsToConvert = 2000;
            const cashAmount = pointsToConvert * 0.5;  // 50%åŒ¯ç‡
            
            submitForm('convert_points_to_cash', {
                partner_code: partnerCode,
                points_used: pointsToConvert,
                cash_amount: cashAmount,
                exchange_rate: 0.5
            }, () => {
                addResult(`âœ… è½‰æ›${pointsToConvert}é»ç‚ºç¾é‡‘NT$${cashAmount}ï¼ˆ50%åŒ¯ç‡ï¼‰`, 'success');
            });
        }

        function testInsufficientPoints() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            submitForm('use_accommodation_points', {
                partner_code: partnerCode,
                deduct_amount: 100000,  // æ•…æ„ä½¿ç”¨è¶…é¡é»æ•¸
                checkin_date: '2024-12-30',
                room_price: 100000
            }, () => {
                addResult(`âš ï¸ æ¸¬è©¦é»æ•¸ä¸è¶³æƒ…æ³ï¼ˆæ‡‰è©²å¤±æ•—ï¼‰`, 'warning');
            });
        }

        function testCancelPayoutNormal() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            // å…ˆå‰µå»ºä¸€å€‹çµç®—
            submitForm('create_payout', {
                partner_code: partnerCode,
                payout_type: 'ACCOMMODATION',
                amount: 500,
                payout_method: 'OTHER',
                notes: 'æ¸¬è©¦çµç®—ï¼ˆå°‡è¢«å–æ¶ˆï¼‰'
            }, () => {
                addResult(`ğŸ“ å‰µå»ºæ¸¬è©¦çµç®—`, 'info');
                
                // å–æ¶ˆçµç®—
                setTimeout(() => {
                    // æ³¨æ„ï¼šéœ€è¦çŸ¥é“å¯¦éš›çš„ payout_id
                    submitForm('cancel_payout', {
                        payout_id: 'LATEST_PAYOUT'  // å¯¦éš›æ¸¬è©¦æ™‚éœ€è¦çœŸå¯¦ID
                    }, () => {
                        addResult(`âœ… å–æ¶ˆçµç®—ï¼ˆé»æ•¸å……è¶³æƒ…æ³ï¼‰`, 'success');
                    });
                }, 1500);
            });
        }

        function testCancelPayoutWithDebt() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            addResult(`ğŸ”„ æ¨¡æ“¬é»æ•¸ä¸è¶³å–æ¶ˆçµç®—...`, 'info');
            
            // å…ˆç”¨æ‰å¤§éƒ¨åˆ†é»æ•¸
            submitForm('use_accommodation_points', {
                partner_code: partnerCode,
                deduct_amount: 4000,  // ç”¨æ‰å¤§éƒ¨åˆ†é»æ•¸
                checkin_date: '2024-12-31',
                room_price: 5000
            }, () => {
                addResult(`ğŸ“ å·²æ¶ˆè€—4000é»`, 'info');
                
                // å˜—è©¦å–æ¶ˆä¸€å€‹å¤§é¡çµç®—
                setTimeout(() => {
                    submitForm('cancel_payout', {
                        payout_id: 'LARGE_PAYOUT'  // å¯¦éš›æ¸¬è©¦æ™‚éœ€è¦çœŸå¯¦ID
                    }, () => {
                        addResult(`âš ï¸ å–æ¶ˆçµç®—ï¼ˆæ‡‰ç”¢ç”Ÿè² å‚µè¨˜éŒ„ï¼‰`, 'warning');
                    });
                }, 1500);
            });
        }

        function testDeleteBookingWithCommission() {
            const partnerCode = document.getElementById('partnerCode').value;
            
            if (!testBookingId) {
                addResult(`âŒ è«‹å…ˆåŸ·è¡Œ"è³ºå–ä½å®¿é‡‘é»æ•¸"æ¸¬è©¦`, 'error');
                return;
            }
            
            submitForm('delete_booking', {
                guest_name: 'è³ºå–é»æ•¸æ¸¬è©¦_' + Date.now(),
                guest_phone: '0987654321'
            }, () => {
                addResult(`âœ… å–æ¶ˆå·²çµç®—è¨‚æˆ¿ï¼Œæ‡‰æ’¤éŠ·ç›¸é—œä½£é‡‘`, 'success');
            });
        }

        async function testGetPartnerStatus() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === partnerCode);
                    if (partner) {
                        addResult(`
ğŸ“Š å¤§ä½¿ç‹€æ…‹ï¼š
â€¢ ä»£ç¢¼ï¼š${partner.partner_code}
â€¢ ç­‰ç´šï¼š${partner.partner_level || 'LV1_INSIDER'}
â€¢ å¯ç”¨é»æ•¸ï¼š${partner.available_points || 0}
â€¢ å·²ä½¿ç”¨é»æ•¸ï¼š${partner.points_used || 0}
â€¢ å¾…æ”¯ä»˜ç¾é‡‘ï¼š${partner.pending_commission || 0}
â€¢ ç´¯ç©ä½£é‡‘ï¼š${partner.total_commission_earned || 0}
â€¢ æˆåŠŸæ¨è–¦ï¼š${partner.successful_referrals || 0}
                        `, 'info');
                    } else {
                        addResult(`æ‰¾ä¸åˆ°å¤§ä½¿ ${partnerCode}`, 'error');
                    }
                }
            } catch (error) {
                addResult(`ç²å–ç‹€æ…‹å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        function testFullScenario() {
            addResult(`ğŸš€ é–‹å§‹å®Œæ•´å ´æ™¯æ¸¬è©¦...`, 'info');
            
            // åŸ·è¡Œä¸€ç³»åˆ—æ¸¬è©¦
            setTimeout(() => testCreatePartnerWithPoints(), 0);
            setTimeout(() => testEarnPoints(), 2000);
            setTimeout(() => testUsePoints(), 5000);
            setTimeout(() => testConvertPointsToCash(), 7000);
            setTimeout(() => testGetPartnerStatus(), 9000);
            
            setTimeout(() => {
                addResult(`âœ… å®Œæ•´å ´æ™¯æ¸¬è©¦å®Œæˆï¼`, 'success');
            }, 11000);
        }
    </script>
</body>
</html>