<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœè¬æ£®æ— - Apps Script è¨­å®šå·¥å…·</title>
    <style>
        body { font-family: 'Arial', sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #218838; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        textarea { width: 100%; height: 400px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 12px; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
        .step { border: 1px solid #ddd; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .step h3 { color: #2c3e50; margin-top: 0; }
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; }
        .highlight { background: #ffeb3b; padding: 2px 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ² éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« - Apps Script è¨­å®š</h1>
        
        <div class="step">
            <h3>æ­¥é©Ÿ 1: æº–å‚™è¨­å®šè³‡è¨Š</h3>
            <p>è«‹è¼¸å…¥æ‚¨çš„ Google Sheets IDï¼ˆå¾ä¸Šå€‹æ­¥é©Ÿå–å¾—ï¼‰ï¼š</p>
            <input type="text" id="sheetsId" placeholder="æ‚¨çš„ Google Sheets ID">
            <div class="warning">
                <strong>é‡è¦ï¼š</strong>è«‹ç¢ºä¿æ‚¨å·²å®Œæˆ Google Sheets è³‡æ–™åº«å»ºç«‹ï¼Œä¸¦ä¸”æœå‹™å¸³è™Ÿæœ‰ç·¨è¼¯æ¬Šé™ï¼
            </div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 2: å»ºç«‹ Apps Script å°ˆæ¡ˆ</h3>
            <button onclick="window.open('https://script.google.com', '_blank')">é–‹å•Ÿ Google Apps Script</button>
            <div class="info">
                <ol>
                    <li>é»æ“Šã€Œæ–°å°ˆæ¡ˆã€</li>
                    <li>å°‡å°ˆæ¡ˆåç¨±æ”¹ç‚ºï¼š<code>éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•«-API</code></li>
                    <li>åˆªé™¤é è¨­çš„ myFunction</li>
                </ol>
            </div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 3: è²¼ä¸Š Apps Script ç¨‹å¼ç¢¼</h3>
            <button onclick="generateAppsScript()" id="generateBtn">ç”Ÿæˆ Apps Script ç¨‹å¼ç¢¼</button>
            <textarea id="appsScriptCode" placeholder="é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”Ÿæˆç¨‹å¼ç¢¼..."></textarea>
            <button onclick="copyToClipboard(document.getElementById('appsScriptCode').value)" class="secondary">è¤‡è£½ç¨‹å¼ç¢¼</button>
            
            <div class="info">
                <strong>æ“ä½œæ­¥é©Ÿï¼š</strong>
                <ol>
                    <li>è¤‡è£½ä¸Šé¢çš„ç¨‹å¼ç¢¼</li>
                    <li>åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­å…¨é¸ä¸¦è²¼ä¸Š</li>
                    <li>æŒ‰ Ctrl+S å„²å­˜</li>
                </ol>
            </div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 4: æˆæ¬Šå’Œéƒ¨ç½²</h3>
            <div class="warning">
                <strong>é‡è¦æˆæ¬Šæ­¥é©Ÿï¼š</strong>
                <ol>
                    <li>åœ¨ Apps Script ä¸­é»æ“Šã€ŒåŸ·è¡Œã€æŒ‰éˆ•ï¼ˆç¬¬ä¸€æ¬¡æœƒè¦æ±‚æˆæ¬Šï¼‰</li>
                    <li>é¸æ“‡ã€Œæª¢è¦–æ¬Šé™ã€â†’ã€Œå‰å¾€å°ˆæ¡ˆåç¨±ã€</li>
                    <li>é¸æ“‡æ‚¨çš„ Google å¸³è™Ÿ</li>
                    <li>é»æ“Šã€Œå…è¨±ã€çµ¦äºˆå¿…è¦æ¬Šé™</li>
                </ol>
            </div>
            
            <h4>éƒ¨ç½²ç‚º Web Appï¼š</h4>
            <div class="info">
                <ol>
                    <li>é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€</li>
                    <li>é¡å‹é¸æ“‡ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ã€</li>
                    <li>èªªæ˜å¡«å…¥ï¼š<code>éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« API v1.0</code></li>
                    <li>åŸ·è¡Œèº«åˆ†ï¼š<strong>æˆ‘</strong></li>
                    <li>å…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ï¼š<strong>ä»»ä½•äºº</strong></li>
                    <li>é»æ“Šã€Œéƒ¨ç½²ã€</li>
                </ol>
            </div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 5: å–å¾— Web App URL</h3>
            <p>éƒ¨ç½²å®Œæˆå¾Œï¼Œè¤‡è£½ã€Œç¶²è·¯æ‡‰ç”¨ç¨‹å¼ URLã€ï¼š</p>
            <input type="text" id="webAppUrl" placeholder="è²¼ä¸Šæ‚¨çš„ Web App URL">
            <button onclick="updateFrontendConfig()" id="updateBtn">æ›´æ–°å‰ç«¯è¨­å®š</button>
            <div id="updateResult"></div>
        </div>

        <div class="step">
            <h3>æ­¥é©Ÿ 6: æ¸¬è©¦ API åŠŸèƒ½</h3>
            <button onclick="testAPI()" id="testBtn">æ¸¬è©¦ API é€£ç·š</button>
            <div id="testResult"></div>
        </div>
    </div>

    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }

        function generateAppsScript() {
            const sheetsId = document.getElementById('sheetsId').value;
            if (!sheetsId) {
                alert('è«‹å…ˆè¼¸å…¥ Google Sheets ID');
                return;
            }

            const appsScriptCode = `/**
 * éœè¬æ£®æ—çŸ¥éŸ³è¨ˆç•« - Apps Script Web App
 * è™•ç†æ¨è–¦é€£çµè¿½è¹¤å’Œè³‡æ–™è¨˜éŒ„
 */

// è¨­å®šæ‚¨çš„ Google Sheets ID
const SHEETS_ID = '${sheetsId}';
const GITHUB_PAGES_URL = 'https://didi1119.github.io/forest-gift-v1';
const LINE_COUPON_URL = 'https://line.me/R/ti/p/@forest.house';

/**
 * Web App ä¸»è¦è™•ç†å‡½æ•¸
 */
function doGet(e) {
  try {
    const params = e.parameter;
    
    // è¨˜éŒ„é»æ“Šäº‹ä»¶
    if (params.pid || params.subid) {
      recordClick(params);
    }
    
    // æ ¹æ“š dest åƒæ•¸æ±ºå®šè·³è½‰ç›®æ¨™
    const destination = params.dest || 'landing';
    let redirectUrl;
    
    switch (destination) {
      case 'coupon':
        redirectUrl = LINE_COUPON_URL;
        break;
      case 'landing':
      default:
        // å»ºæ§‹å¸¶æœ‰æ¨è–¦åƒæ•¸çš„ä¸»é é€£çµ
        const subid = params.pid || params.subid || '';
        redirectUrl = subid ? 
          \`\${GITHUB_PAGES_URL}?subid=\${encodeURIComponent(subid)}\` : 
          GITHUB_PAGES_URL;
        break;
    }
    
    // åŸ·è¡Œé‡æ–°å°å‘
    return HtmlService.createHtmlOutput(\`
      <script>
        window.top.location.href = "\${redirectUrl}";
      </script>
    \`);
    
  } catch (error) {
    Logger.log('doGet Error: ' + error.toString());
    
    // éŒ¯èª¤æ™‚é‡æ–°å°å‘åˆ°ä¸»é 
    return HtmlService.createHtmlOutput(\`
      <script>
        window.top.location.href = "\${GITHUB_PAGES_URL}";
      </script>
    \`);
  }
}

/**
 * è™•ç† POST è«‹æ±‚ï¼ˆç”¨æ–¼å„²å­˜å¤¥ä¼´è³‡æ–™ç­‰ï¼‰
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    switch (data.action) {
      case 'create_partner':
        return createPartner(data);
      case 'get_stats':
        return getPartnerStats(data);
      default:
        throw new Error('Unknown action: ' + data.action);
    }
    
  } catch (error) {
    Logger.log('doPost Error: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * è¨˜éŒ„é»æ“Šäº‹ä»¶
 */
function recordClick(params) {
  try {
    const sheet = SpreadsheetApp.openById(SHEETS_ID).getSheetByName('Clicks');
    
    const timestamp = new Date();
    const partnerCode = params.pid || params.subid || 'UNKNOWN';
    const destination = params.dest || 'landing';
    
    // å–å¾—ç”¨æˆ¶è³‡è¨Šï¼ˆApps Script ç’°å¢ƒé™åˆ¶ï¼Œéƒ¨åˆ†è³‡è¨Šç„¡æ³•å–å¾—ï¼‰
    const clickData = [
      '', // click_id - ç”± Sheets è‡ªå‹•ç·¨è™Ÿ
      partnerCode,
      timestamp,
      '', // ip_address - Apps Script ç„¡æ³•å–å¾—
      '', // user_agent - Apps Script ç„¡æ³•å–å¾—  
      params.referrer || '',
      destination,
      params.utm_source || '',
      params.utm_medium || '',
      params.utm_campaign || '',
      Utilities.getUuid(), // session_id
      '', // country
      '', // city
      '', // device_type
      'pending', // conversion_status
      timestamp
    ];
    
    sheet.appendRow(clickData);
    Logger.log('Click recorded: ' + JSON.stringify(params));
    
  } catch (error) {
    Logger.log('recordClick Error: ' + error.toString());
  }
}

/**
 * å»ºç«‹æ–°çš„å¤¥ä¼´è³‡æ–™
 */
function createPartner(data) {
  try {
    const sheet = SpreadsheetApp.openById(SHEETS_ID).getSheetByName('Partners');
    
    const timestamp = new Date();
    const partnerData = [
      '', // partner_id - ç”± Sheets è‡ªå‹•ç·¨è™Ÿ
      data.partner_code,
      data.name,
      data.email || '',
      data.phone || '',
      timestamp, // join_date
      'LV1_INSIDER', // level
      'active', // status
      0, // total_referrals
      0, // successful_referrals
      0, // current_year_referrals
      data.landing_link || '',
      data.coupon_link || '',
      data.coupon_code || '',
      data.notes || '',
      timestamp, // created_at
      timestamp  // updated_at
    ];
    
    sheet.appendRow(partnerData);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'å¤¥ä¼´è³‡æ–™å»ºç«‹æˆåŠŸ',
        partner_code: data.partner_code
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('createPartner Error: ' + error.toString());
    throw error;
  }
}

/**
 * å–å¾—å¤¥ä¼´çµ±è¨ˆè³‡æ–™
 */
function getPartnerStats(data) {
  try {
    const clicksSheet = SpreadsheetApp.openById(SHEETS_ID).getSheetByName('Clicks');
    const partnersSheet = SpreadsheetApp.openById(SHEETS_ID).getSheetByName('Partners');
    
    // ç°¡å–®çš„çµ±è¨ˆæŸ¥è©¢ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½éœ€è¦æ›´è¤‡é›œçš„æŸ¥è©¢ï¼‰
    const allClicks = clicksSheet.getDataRange().getValues();
    const partnerClicks = allClicks.filter(row => row[1] === data.partner_code);
    
    const stats = {
      total_clicks: partnerClicks.length,
      today_clicks: partnerClicks.filter(row => {
        const clickDate = new Date(row[2]);
        const today = new Date();
        return clickDate.toDateString() === today.toDateString();
      }).length,
      conversions: partnerClicks.filter(row => row[14] === 'converted').length
    };
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        stats: stats
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('getPartnerStats Error: ' + error.toString());
    throw error;
  }
}

/**
 * æ¸¬è©¦å‡½æ•¸ - ç”¨æ–¼åˆå§‹åŒ–å’Œæ¸¬è©¦
 */
function testFunction() {
  Logger.log('Apps Script æ¸¬è©¦æˆåŠŸï¼');
  Logger.log('SHEETS_ID: ' + SHEETS_ID);
  
  try {
    const spreadsheet = SpreadsheetApp.openById(SHEETS_ID);
    Logger.log('Sheets é€£ç·šæˆåŠŸï¼š' + spreadsheet.getName());
    
    const sheets = ['Partners', 'Clicks', 'Bookings', 'Payouts'];
    sheets.forEach(sheetName => {
      const sheet = spreadsheet.getSheetByName(sheetName);
      if (sheet) {
        Logger.log(sheetName + ' å·¥ä½œè¡¨å­˜åœ¨ï¼Œè¡Œæ•¸ï¼š' + sheet.getLastRow());
      } else {
        Logger.log('è­¦å‘Šï¼š' + sheetName + ' å·¥ä½œè¡¨ä¸å­˜åœ¨');
      }
    });
    
  } catch (error) {
    Logger.log('Sheets é€£ç·šå¤±æ•—ï¼š' + error.toString());
  }
  
  return 'æ¸¬è©¦å®Œæˆï¼Œè«‹æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„';
}`;

            document.getElementById('appsScriptCode').value = appsScriptCode;
            
            document.getElementById('generateBtn').textContent = 'âœ… ç¨‹å¼ç¢¼å·²ç”Ÿæˆ';
            document.getElementById('generateBtn').style.background = '#28a745';
        }

        function updateFrontendConfig() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            if (!webAppUrl) {
                document.getElementById('updateResult').innerHTML = 
                    '<div class="error">è«‹å…ˆè¼¸å…¥ Web App URL</div>';
                return;
            }

            // ç”Ÿæˆæ›´æ–°æŒ‡ä»¤
            const updateInstructions = \`
                <div class="success">
                    <h4>å‰ç«¯è¨­å®šæ›´æ–°æŒ‡å¼•ï¼š</h4>
                    <p>è«‹åœ¨æ‚¨çš„ <code>link-generator.html</code> æª”æ¡ˆä¸­æ‰¾åˆ°ç¬¬132è¡Œï¼š</p>
                    <div class="code-block">const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/DEPLOYMENT_PLACEHOLDER/exec';</div>
                    <p>æ›¿æ›ç‚ºï¼š</p>
                    <div class="code-block highlight">const APPS_SCRIPT_URL = '\${webAppUrl}';</div>
                    <p>æ›´æ–°å¾Œè«‹é‡æ–°æ¨é€åˆ° GitHubï¼</p>
                    
                    <h4>Git æŒ‡ä»¤ï¼š</h4>
                    <div class="code-block">git add link-generator.html
git commit -m "æ›´æ–° Apps Script URL"
git push origin main</div>
                </div>
            \`;

            document.getElementById('updateResult').innerHTML = updateInstructions;
        }

        function testAPI() {
            const webAppUrl = document.getElementById('webAppUrl').value;
            if (!webAppUrl) {
                document.getElementById('testResult').innerHTML = 
                    '<div class="error">è«‹å…ˆè¼¸å…¥ Web App URL</div>';
                return;
            }

            document.getElementById('testResult').innerHTML = 
                '<div class="info">æ­£åœ¨æ¸¬è©¦ API...</div>';

            // æ¸¬è©¦åŸºæœ¬çš„ GET è«‹æ±‚
            const testUrl = webAppUrl + '?pid=TEST123&dest=landing';
            
            setTimeout(() => {
                document.getElementById('testResult').innerHTML = \`
                    <div class="success">
                        <h4>API æ¸¬è©¦ï¼š</h4>
                        <p><strong>æ¸¬è©¦ URLï¼š</strong> <a href="\${testUrl}" target="_blank">\${testUrl}</a></p>
                        <p>é»æ“Šä¸Šæ–¹é€£çµæ¸¬è©¦é‡æ–°å°å‘åŠŸèƒ½</p>
                        <p>å¦‚æœèƒ½æ­£å¸¸è·³è½‰åˆ°ä¸»é ï¼Œè¡¨ç¤º API è¨­å®šæˆåŠŸï¼</p>
                        
                        <h4>é€²éšæ¸¬è©¦ï¼š</h4>
                        <p>è«‹æª¢æŸ¥æ‚¨çš„ Google Sheets ä¸­çš„ Clicks å·¥ä½œè¡¨ï¼Œæ‡‰è©²æœƒæ–°å¢ä¸€ç­†æ¸¬è©¦è¨˜éŒ„ã€‚</p>
                    </div>
                \`;
            }, 1000);
        }
    </script>
</body>
</html>