<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æ¸¬è©¦é é¢ - éœè¬æ£®æ—</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #4caf50;
        }
        .error {
            border-left: 4px solid #f44336;
        }
        input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            margin-left: 10px;
        }
        .status.online {
            background: #4caf50;
        }
        .status.offline {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ² API åŠŸèƒ½æ¸¬è©¦ <span id="status" class="status offline">é›¢ç·š</span></h1>
        
        <div class="test-section">
            <h2>1. æ¸¬è©¦ API é€£æ¥</h2>
            <button onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
            <div id="connection-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. ç²å–å¤§ä½¿åˆ—è¡¨</h2>
            <button onclick="getAmbassadors()">ç²å–åˆ—è¡¨</button>
            <div id="ambassadors-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. å‰µå»ºæ¸¬è©¦å¤§ä½¿</h2>
            <input type="text" id="test-name" placeholder="å¤§ä½¿åç¨±" value="æ¸¬è©¦å¤§ä½¿">
            <input type="text" id="test-id" placeholder="å¤§ä½¿ ID" value="TEST001">
            <input type="text" id="test-line" placeholder="LINE é€£çµ" value="https://line.me/test">
            <button onclick="createTestAmbassador()">å‰µå»ºå¤§ä½¿</button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. è¿½è¹¤æ•ˆèƒ½æ¸¬è©¦</h2>
            <input type="text" id="track-id" placeholder="å¤§ä½¿ ID" value="TEST001">
            <button onclick="trackClick()">æ¨¡æ“¬é»æ“Š</button>
            <button onclick="trackConversion()">æ¨¡æ“¬è½‰æ›</button>
            <div id="track-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. å®Œæ•´æµç¨‹æ¸¬è©¦</h2>
            <button onclick="runFullTest()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
            <div id="full-test-result" class="result"></div>
        </div>
    </div>

    <script>
        // ç²å– API åŸºç¤ URL
        const API_BASE = window.location.origin + '/api';
        
        // æª¢æŸ¥ API ç‹€æ…‹
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/get-ambassadors`);
                if (response.ok) {
                    document.getElementById('status').textContent = 'åœ¨ç·š';
                    document.getElementById('status').className = 'status online';
                }
            } catch (error) {
                document.getElementById('status').textContent = 'é›¢ç·š';
                document.getElementById('status').className = 'status offline';
            }
        }

        // æ¸¬è©¦é€£æ¥
        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.textContent = 'æ¸¬è©¦ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE}/get-ambassadors`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… API é€£æ¥æˆåŠŸï¼\n' + JSON.stringify(data, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ API è¿”å›éŒ¯èª¤ï¼š\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ é€£æ¥å¤±æ•—ï¼š' + error.message;
            }
        }

        // ç²å–å¤§ä½¿åˆ—è¡¨
        async function getAmbassadors() {
            const resultDiv = document.getElementById('ambassadors-result');
            resultDiv.textContent = 'è¼‰å…¥ä¸­...';
            
            try {
                const response = await fetch(`${API_BASE}/get-ambassadors`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æˆåŠŸç²å– ${data.total} ä½å¤§ä½¿ï¼š\n` + 
                        JSON.stringify(data.ambassadors, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ ç²å–å¤±æ•—ï¼š\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message;
            }
        }

        // å‰µå»ºæ¸¬è©¦å¤§ä½¿
        async function createTestAmbassador() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.textContent = 'å‰µå»ºä¸­...';
            
            const ambassadorName = document.getElementById('test-name').value;
            const ambassadorId = document.getElementById('test-id').value;
            const lineLink = document.getElementById('test-line').value;
            
            try {
                const response = await fetch(`${API_BASE}/create-ambassador`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ambassadorName,
                        ambassadorId,
                        lineLink,
                        contactInfo: 'æ¸¬è©¦è¯çµ¡è³‡è¨Š'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… å‰µå»ºæˆåŠŸï¼\n' + JSON.stringify(data, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ å‰µå»ºå¤±æ•—ï¼š\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message;
            }
        }

        // è¿½è¹¤é»æ“Š
        async function trackClick() {
            await trackPerformance('click');
        }

        // è¿½è¹¤è½‰æ›
        async function trackConversion() {
            await trackPerformance('conversion');
        }

        // è¿½è¹¤æ•ˆèƒ½
        async function trackPerformance(eventType) {
            const resultDiv = document.getElementById('track-result');
            resultDiv.textContent = 'è¿½è¹¤ä¸­...';
            
            const ambassadorId = document.getElementById('track-id').value;
            
            try {
                const response = await fetch(`${API_BASE}/track-performance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ambassadorId,
                        eventType,
                        eventData: {
                            test: true,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ${eventType} è¿½è¹¤æˆåŠŸï¼\n` + JSON.stringify(data, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ è¿½è¹¤å¤±æ•—ï¼š\n' + JSON.stringify(data, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ è«‹æ±‚å¤±æ•—ï¼š' + error.message;
            }
        }

        // å®Œæ•´æµç¨‹æ¸¬è©¦
        async function runFullTest() {
            const resultDiv = document.getElementById('full-test-result');
            let results = [];
            
            resultDiv.textContent = 'åŸ·è¡Œå®Œæ•´æ¸¬è©¦æµç¨‹...\n';
            
            // 1. æ¸¬è©¦é€£æ¥
            results.push('1. æ¸¬è©¦ API é€£æ¥...');
            try {
                const response = await fetch(`${API_BASE}/get-ambassadors`);
                if (response.ok) {
                    results.push('   âœ… API é€£æ¥æ­£å¸¸');
                } else {
                    results.push('   âŒ API é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                results.push('   âŒ API é€£æ¥éŒ¯èª¤: ' + error.message);
            }
            
            // 2. å‰µå»ºæ¸¬è©¦å¤§ä½¿
            results.push('\n2. å‰µå»ºæ¸¬è©¦å¤§ä½¿...');
            const testId = 'FULLTEST_' + Date.now();
            try {
                const response = await fetch(`${API_BASE}/create-ambassador`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ambassadorName: 'å®Œæ•´æ¸¬è©¦å¤§ä½¿',
                        ambassadorId: testId,
                        lineLink: 'https://line.me/fulltest',
                        contactInfo: 'å®Œæ•´æ¸¬è©¦'
                    })
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    results.push('   âœ… å¤§ä½¿å‰µå»ºæˆåŠŸ');
                    results.push('   å°ˆå±¬é€£çµ: ' + data.siteUrl);
                } else {
                    results.push('   âŒ å¤§ä½¿å‰µå»ºå¤±æ•—: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                results.push('   âŒ å‰µå»ºéŒ¯èª¤: ' + error.message);
            }
            
            // 3. è¿½è¹¤é»æ“Š
            results.push('\n3. æ¸¬è©¦è¿½è¹¤åŠŸèƒ½...');
            try {
                const response = await fetch(`${API_BASE}/track-performance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ambassadorId: testId,
                        eventType: 'click',
                        eventData: { test: true }
                    })
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    results.push('   âœ… é»æ“Šè¿½è¹¤æˆåŠŸ');
                } else {
                    results.push('   âŒ é»æ“Šè¿½è¹¤å¤±æ•—');
                }
            } catch (error) {
                results.push('   âŒ è¿½è¹¤éŒ¯èª¤: ' + error.message);
            }
            
            // 4. ç²å–æ›´æ–°å¾Œçš„åˆ—è¡¨
            results.push('\n4. é©—è­‰æ•¸æ“šæ›´æ–°...');
            try {
                const response = await fetch(`${API_BASE}/get-ambassadors`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const testAmbassador = data.ambassadors.find(a => a.ambassadorId === testId);
                    if (testAmbassador) {
                        results.push('   âœ… æ‰¾åˆ°æ¸¬è©¦å¤§ä½¿');
                        results.push('   é»æ“Šæ¬¡æ•¸: ' + testAmbassador.totalClicks);
                    } else {
                        results.push('   âŒ æœªæ‰¾åˆ°æ¸¬è©¦å¤§ä½¿');
                    }
                }
            } catch (error) {
                results.push('   âŒ é©—è­‰éŒ¯èª¤: ' + error.message);
            }
            
            results.push('\n========== æ¸¬è©¦å®Œæˆ ==========');
            
            resultDiv.className = 'result';
            resultDiv.textContent = results.join('\n');
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
        window.onload = function() {
            checkStatus();
            setInterval(checkStatus, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
        };
    </script>
</body>
</html>