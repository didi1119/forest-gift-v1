<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥éŸ³å¤§ä½¿å°ˆå±¬é€£çµç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .forest-gradient {
            background: linear-gradient(135deg, #1e3c1e 0%, #2d5a2d 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .link-display {
            word-break: break-all;
            background: #f0f9f0;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #d0e8d0;
            font-family: monospace;
            font-size: 14px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-50 min-h-screen">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="forest-gradient text-white p-8 rounded-2xl mb-8 card-shadow">
            <h1 class="text-3xl font-bold mb-2">ğŸŒ² çŸ¥éŸ³å¤§ä½¿å°ˆå±¬é€£çµç”Ÿæˆå™¨</h1>
            <p class="text-green-100">ç‚ºæ¯ä½å¤§ä½¿ç”Ÿæˆå°ˆå±¬çš„æ¨è–¦é€£çµï¼Œé–‹å•Ÿæ£®æ—æ—…ç¨‹</p>
        </div>

        <!-- Main Form -->
        <div class="bg-white rounded-2xl p-8 mb-6 card-shadow">
            <h2 class="text-2xl font-bold text-green-800 mb-6">ğŸ“ å¤§ä½¿è³‡è¨Š</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Basic Info -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å¤¥ä¼´ä»£ç¢¼ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="ä¾‹å¦‚ï¼šFOREST001" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å¤¥ä¼´å§“å <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="partnerName" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="ä¾‹å¦‚ï¼šæ—å°æ£®" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email
                    </label>
                    <input type="email" id="partnerEmail" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="ä¾‹å¦‚ï¼špartner@example.com">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        è¯çµ¡é›»è©± <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="partnerPhone" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="ä¾‹å¦‚ï¼š0912345678" required>
                </div>
            </div>

            <!-- Coupon Info -->
            <div class="mt-6 p-6 bg-amber-50 rounded-lg border-2 border-amber-200">
                <h3 class="text-lg font-bold text-amber-800 mb-4">ğŸ« å°ˆå±¬å„ªæƒ åˆ¸è¨­å®š</h3>
                <p class="text-sm text-amber-700 mb-4">
                    âš ï¸ é‡è¦ï¼šè«‹å…ˆåˆ° LINE å®˜æ–¹å¸³è™Ÿå¾Œå°å»ºç«‹å°ˆå±¬å„ªæƒ åˆ¸ï¼Œç„¶å¾Œå°‡é€£çµè²¼åœ¨ä¸‹æ–¹
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            å„ªæƒ åˆ¸ä»£ç¢¼
                        </label>
                        <input type="text" id="couponCode" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼šFOREST20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            LINE å„ªæƒ åˆ¸é€£çµ <span class="text-red-500">*</span>
                        </label>
                        <input type="url" id="couponUrl" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="https://lin.ee/xxxxx" required>
                    </div>
                </div>
            </div>

            <!-- Bank Info -->
            <div class="mt-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ¦ éŠ€è¡Œè³‡è¨Šï¼ˆé¸å¡«ï¼‰</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">éŠ€è¡Œåç¨±</label>
                        <input type="text" id="bankName" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼šå°ç£éŠ€è¡Œ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">éŠ€è¡Œä»£ç¢¼</label>
                        <input type="text" id="bankCode" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼š004">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†è¡Œåç¨±</label>
                        <input type="text" id="bankBranch" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©åˆ†è¡Œ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¶å</label>
                        <input type="text" id="bankAccountName" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼šæ—å°æ£®">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¸³è™Ÿ</label>
                        <input type="text" id="bankAccountNumber" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚ï¼š1234567890123">
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button onclick="generateLinks()" 
                    class="mt-8 w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:from-green-700 hover:to-emerald-700 transition duration-200 shadow-lg">
                ğŸ”— ç”Ÿæˆå°ˆå±¬é€£çµ
            </button>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="bg-white rounded-2xl p-8 card-shadow hidden">
            <h2 class="text-2xl font-bold text-green-800 mb-6">âœ¨ ç”Ÿæˆçµæœ</h2>
            
            <!-- Links Display -->
            <div class="space-y-4 mb-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">ğŸ  ä¸»é é€£çµï¼ˆçŸ­ç¶²å€ï¼‰</h3>
                    <div class="link-display" id="landingLink">ç”Ÿæˆä¸­...</div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">ğŸ å„ªæƒ åˆ¸é€£çµï¼ˆçŸ­ç¶²å€ï¼‰</h3>
                    <div class="link-display" id="couponLink">ç”Ÿæˆä¸­...</div>
                </div>
            </div>

            <!-- Share Template -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-2">ğŸ“± åˆ†äº«ç¯„æœ¬</h3>
                <textarea id="shareTemplate" class="w-full h-48 p-4 border border-gray-300 rounded-lg" readonly>ç”Ÿæˆä¸­...</textarea>
                <button onclick="copyShareTemplate()" 
                        class="mt-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                    ğŸ“‹ è¤‡è£½åˆ†äº«æ–‡æ¡ˆ
                </button>
            </div>

            <!-- Save Button -->
            <button onclick="saveToSheets()" 
                    class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:from-amber-600 hover:to-orange-600 transition duration-200 shadow-lg">
                ğŸ’¾ å„²å­˜åˆ° Google Sheets
            </button>
            
            <div id="saveStatus" class="mt-4 text-center text-sm text-gray-600 hidden">
                æ­£åœ¨å„²å­˜è³‡æ–™...
            </div>

            <!-- Tips -->
            <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                <p><strong class="text-green-800">ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong></p>
                <ul class="text-sm text-green-700 mt-2 space-y-1">
                    <li>â€¢ çŸ­ç¶²å€æ›´ç¾è§€æ˜“è¨˜ï¼Œé©åˆåˆ†äº«</li>
                    <li>â€¢ è«‹ç¢ºä¿å„ªæƒ åˆ¸é€£çµæ˜¯å¤§ä½¿å°ˆå±¬çš„</li>
                    <li>â€¢ å„²å­˜æˆåŠŸå¾Œå¯åœ¨ç®¡ç†å¾Œå°æŸ¥çœ‹</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden iframe for form submission -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        // Configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        const GITHUB_PAGES_URL = 'https://didi1119.github.io/forest-gift-v1';
        
        let generatedData = null;

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Create short URL using TinyURL
        async function createShortUrl(originalUrl) {
            try {
                const response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(originalUrl));
                if (response.ok) {
                    const shortUrl = await response.text();
                    if (shortUrl && shortUrl.startsWith('https://tinyurl.com/')) {
                        return shortUrl;
                    }
                }
            } catch (error) {
                console.warn('çŸ­ç¶²å€ç”Ÿæˆå¤±æ•—:', error);
            }
            return originalUrl; // Return original URL if shortening fails
        }

        // Generate links
        async function generateLinks() {
            const partnerCode = document.getElementById('partnerCode').value.trim();
            const partnerName = document.getElementById('partnerName').value.trim();
            const partnerEmail = document.getElementById('partnerEmail').value.trim();
            const partnerPhone = document.getElementById('partnerPhone').value.trim();
            const couponCode = document.getElementById('couponCode').value.trim();
            const couponUrl = document.getElementById('couponUrl').value.trim();

            // Validation
            if (!partnerCode || !partnerName) {
                alert('è«‹å¡«å¯«å¤¥ä¼´ä»£ç¢¼å’Œå§“å');
                return;
            }
            
            if (!partnerPhone) {
                alert('è«‹å¡«å¯«è¯çµ¡é›»è©±');
                return;
            }

            if (!couponUrl) {
                alert('è«‹æä¾›å°ˆå±¬å„ªæƒ åˆ¸é€£çµï¼\n\nè«‹åˆ° LINE å®˜æ–¹å¸³è™Ÿå¾Œå°å»ºç«‹å°ˆå±¬å„ªæƒ åˆ¸ï¼Œç„¶å¾Œå°‡é€£çµè²¼ä¸Šã€‚');
                return;
            }

            // Show result section
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('landingLink').textContent = 'ç”ŸæˆçŸ­ç¶²å€ä¸­...';
            document.getElementById('couponLink').textContent = 'ç”ŸæˆçŸ­ç¶²å€ä¸­...';
            document.getElementById('shareTemplate').textContent = 'ç”Ÿæˆä¸­...';
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

            try {
                // Generate tracking URLs (include coupon_url in landing page URL)
                const landingUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=landing&coupon_url=${encodeURIComponent(couponUrl)}`;
                const trackedCouponUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=coupon&target=${encodeURIComponent(couponUrl)}`;

                // Generate short URLs
                const shortLandingUrl = await createShortUrl(landingUrl);
                const shortCouponUrl = await createShortUrl(trackedCouponUrl);

                // Generate share template
                const shareText = `ğŸŒ² ä¾†è‡ªéœè¬æ£®æ—çš„ç‰¹åˆ¥é‚€è«‹

è¦ªæ„›çš„æœ‹å‹ï¼Œæˆ‘æƒ³èˆ‡ä½ åˆ†äº«ä¸€å€‹å¾ˆç‰¹åˆ¥çš„åœ°æ–¹ â€”â€” ä¸€ç‰‡èƒ½è®“å¿ƒéˆçœŸæ­£ä¼‘æ¯çš„æ£®æ—ã€‚

é€™è£¡ä¸åªæ˜¯ä½å®¿ï¼Œæ›´æ˜¯ä¸€å ´å›åˆ°å…§å¿ƒå®¶åœ’çš„æ—…ç¨‹ã€‚æˆ‘ç‚ºä½ æº–å‚™äº†ä¸€ä»½å°ˆå±¬çš„æ£®æ—ç¦®ç‰©ï¼Œå¸Œæœ›èƒ½ç‚ºä½ çš„ç”Ÿæ´»å¸¶ä¾†ä¸€äº›ä¸ä¸€æ¨£çš„å¯§éœèˆ‡æ„Ÿå‹•ã€‚

ğŸ é»æ“Šé€£çµï¼Œé–‹å§‹ä½ çš„æ£®æ—ä¹‹æ—…ï¼š
${shortLandingUrl}

ğŸ« å°ˆå±¬å„ªæƒ åˆ¸ï¼š
${shortCouponUrl}

æœŸå¾…ä½ ä¹Ÿèƒ½åœ¨é€™è£¡ï¼Œæ‰¾åˆ°å±¬æ–¼è‡ªå·±çš„é‚£ä»½å®‰éœã€‚

â€”â€” ${partnerName} çœŸèª æ¨è–¦ â¤ï¸`;

                // Save generated data
                generatedData = {
                    partner_code: partnerCode,
                    partner_name: partnerName,
                    contact_email: partnerEmail,
                    contact_phone: partnerPhone,
                    coupon_code: couponCode,
                    coupon_url: couponUrl, // User's custom coupon URL
                    landing_link: landingUrl,
                    coupon_link: trackedCouponUrl,
                    short_landing_link: shortLandingUrl,
                    short_coupon_link: shortCouponUrl,
                    bank_name: document.getElementById('bankName').value.trim(),
                    bank_code: document.getElementById('bankCode').value.trim(),
                    bank_branch: document.getElementById('bankBranch').value.trim(),
                    bank_account_name: document.getElementById('bankAccountName').value.trim(),
                    bank_account_number: document.getElementById('bankAccountNumber').value.trim()
                };

                // Display results
                document.getElementById('landingLink').textContent = shortLandingUrl;
                document.getElementById('couponLink').textContent = shortCouponUrl;
                document.getElementById('shareTemplate').textContent = shareText;

                showToast('âœ… é€£çµç”ŸæˆæˆåŠŸï¼');

            } catch (error) {
                console.error('ç”Ÿæˆé€£çµå¤±æ•—:', error);
                showToast('âŒ ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // Copy share template
        function copyShareTemplate() {
            const shareTemplate = document.getElementById('shareTemplate');
            shareTemplate.select();
            document.execCommand('copy');
            showToast('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
        }

        // Save to Google Sheets
        function saveToSheets() {
            if (!generatedData) {
                alert('è«‹å…ˆç”Ÿæˆé€£çµ');
                return;
            }

            const button = document.querySelector('button[onclick="saveToSheets()"]');
            const originalText = button.textContent;
            button.textContent = 'å„²å­˜ä¸­...';
            button.disabled = true;
            document.getElementById('saveStatus').classList.remove('hidden');
            document.getElementById('saveStatus').textContent = 'æ­£åœ¨å„²å­˜è³‡æ–™åˆ° Google Sheets...';

            try {
                // Prepare complete partner data
                const partnerData = {
                    action: 'create_partner',
                    // Basic info
                    partner_code: generatedData.partner_code,
                    partner_name: generatedData.partner_name,
                    contact_email: generatedData.contact_email || '',
                    contact_phone: generatedData.contact_phone || '',
                    
                    // Level info (initial values)
                    partner_level: 'LV1_INSIDER',
                    successful_referrals: '0',
                    yearly_referrals: '0',
                    
                    // Commission info (initial values)
                    commission_preference: 'ACCOMMODATION',
                    total_commission_earned: '0',
                    total_commission_paid: '0',
                    available_points: '0',
                    points_used: '0',
                    pending_commission: '0',
                    
                    // Coupon info (IMPORTANT: User's custom coupon)
                    coupon_code: generatedData.coupon_code || '',
                    coupon_url: generatedData.coupon_url || '', // User's custom coupon URL
                    
                    // Link info
                    landing_link: generatedData.landing_link || '',
                    coupon_link: generatedData.coupon_link || '',
                    short_landing_link: generatedData.short_landing_link || '',
                    short_coupon_link: generatedData.short_coupon_link || '',
                    
                    // Bank info
                    bank_account: generatedData.bank_account_number || '',
                    bank_name: generatedData.bank_name || '',
                    bank_code: generatedData.bank_code || '',
                    bank_branch: generatedData.bank_branch || '',
                    bank_account_name: generatedData.bank_account_name || ''
                };

                // Create form for submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // Add all partner data as form fields
                Object.keys(partnerData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = partnerData[key];
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();

                // Show success after a delay
                setTimeout(() => {
                    document.body.removeChild(form);
                    button.textContent = originalText;
                    button.disabled = false;
                    document.getElementById('saveStatus').textContent = 'âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ° Google Sheetsï¼';
                    showToast('âœ… å¤§ä½¿è³‡æ–™å·²å„²å­˜æˆåŠŸï¼');
                    
                    // Clear form after success
                    setTimeout(() => {
                        if (confirm('è³‡æ–™å·²å„²å­˜æˆåŠŸï¼æ˜¯å¦æ¸…ç©ºè¡¨å–®ä»¥å»ºç«‹æ–°çš„å¤§ä½¿ï¼Ÿ')) {
                            location.reload();
                        }
                    }, 1000);
                }, 3000);

            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                button.textContent = originalText;
                button.disabled = false;
                document.getElementById('saveStatus').textContent = 'âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦';
                showToast('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }
    </script>
</body>
</html>