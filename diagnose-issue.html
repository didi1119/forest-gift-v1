<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>診斷資料結構問題</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">診斷資料結構問題</h1>
        <p class="text-gray-600 mb-4">這個工具會直接從 Google Apps Script 獲取資料並分析結構</p>
        
        <div class="bg-white rounded-lg shadow p-6">
            <button onclick="diagnose()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mb-4">
                開始診斷
            </button>
            
            <div id="results" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        async function diagnose() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="text-gray-500">載入中...</div>';
            
            try {
                const response = await fetch(APPS_SCRIPT_URL + '?action=get_all_data');
                const data = await response.json();
                
                if (!data.success) {
                    results.innerHTML = `<div class="text-red-600">錯誤: ${data.error}</div>`;
                    return;
                }
                
                // 分析 Bookings 資料
                if (data.data.bookings && data.data.bookings.length > 0) {
                    const firstBooking = data.data.bookings[0];
                    const keys = Object.keys(firstBooking);
                    
                    let html = '<div class="border-l-4 border-blue-500 pl-4">';
                    html += '<h3 class="font-bold text-lg mb-2">Bookings 資料結構分析</h3>';
                    html += `<p class="mb-2">欄位數量: <span class="font-bold">${keys.length}</span> 個</p>`;
                    html += '<p class="mb-2">欄位列表:</p>';
                    html += '<ol class="list-decimal list-inside bg-gray-50 p-3 rounded">';
                    keys.forEach((key, index) => {
                        const value = firstBooking[key];
                        const valueStr = value === null ? 'null' : 
                                       value === undefined ? 'undefined' : 
                                       value === '' ? '(空字串)' : 
                                       String(value).substring(0, 50);
                        html += `<li class="py-1">`;
                        html += `<span class="font-mono bg-yellow-100 px-1">"${key}"</span>`;
                        html += ` = <span class="text-gray-600">${valueStr}</span>`;
                        html += `</li>`;
                    });
                    html += '</ol>';
                    
                    // 檢查第一個欄位
                    html += '<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded">';
                    html += '<p class="font-bold text-red-700">關鍵問題：</p>';
                    html += `<p>第 0 個欄位是: <span class="font-mono bg-red-100 px-1">"${keys[0]}"</span></p>`;
                    html += `<p>第 1 個欄位是: <span class="font-mono bg-red-100 px-1">"${keys[1]}"</span></p>`;
                    
                    if (keys[0] !== 'id') {
                        html += `<p class="mt-2 text-red-600 font-bold">⚠️ 第一個欄位不是 'id'！</p>`;
                        if (keys[0] === 'ID') {
                            html += `<p class="text-red-600">是大寫的 'ID'，需要檢查 Google Sheets</p>`;
                        }
                    }
                    
                    // 檢查是否有重複的 id/ID
                    const hasLowerId = keys.includes('id');
                    const hasUpperId = keys.includes('ID');
                    if (hasLowerId && hasUpperId) {
                        html += `<p class="mt-2 text-red-600 font-bold">⚠️ 同時存在 'id' 和 'ID' 欄位！</p>`;
                        html += `<p>'id' 在位置: ${keys.indexOf('id')}</p>`;
                        html += `<p>'ID' 在位置: ${keys.indexOf('ID')}</p>`;
                    }
                    
                    html += '</div>';
                    html += '</div>';
                    
                    // 顯示原始 JSON（前 500 字元）
                    html += '<div class="mt-4 border-l-4 border-gray-500 pl-4">';
                    html += '<h3 class="font-bold text-lg mb-2">原始資料（第一筆）</h3>';
                    html += '<pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto">';
                    html += JSON.stringify(firstBooking, null, 2);
                    html += '</pre>';
                    html += '</div>';
                    
                    results.innerHTML = html;
                } else {
                    results.innerHTML = '<div class="text-yellow-600">沒有 Bookings 資料</div>';
                }
                
            } catch (error) {
                results.innerHTML = `<div class="text-red-600">錯誤: ${error.message}</div>`;
                console.error('診斷錯誤:', error);
            }
        }
        
        // 自動執行
        window.onload = () => diagnose();
    </script>
</body>
</html>