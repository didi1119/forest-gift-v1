<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å‹•è¨‚æˆ¿ç™»è¨˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF8; color: #5C544B; }
        h1, h2, h3, .font-serif { font-family: 'Noto Serif TC', serif; }
        .brand-accent { color: #2E4B36; }
        .brand-card { background-color: #FFFFFF; border: 1px solid #EAE6E1; border-radius: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="antialiased min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold brand-accent mb-4">æ‰‹å‹•è¨‚æˆ¿ç™»è¨˜ç³»çµ±</h1>
            <p class="text-lg text-stone-600">å¿«é€Ÿç™»è¨˜é›»è©±è¨‚æˆ¿ã€ç§äººæ¨è–¦ç­‰è¨‚æˆ¿è³‡è¨Š</p>
        </header>

        <!-- å¿«é€Ÿç™»è¨˜è¡¨å–® -->
        <div class="brand-card p-8 mb-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ğŸ“ æ–°å¢è¨‚æˆ¿è¨˜éŒ„</h2>
            
            <form id="bookingForm" class="space-y-6">
                <!-- æˆ¿å®¢åŸºæœ¬è³‡è¨Š -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-2">æˆ¿å®¢å§“å *</label>
                        <input type="text" id="guestName" required class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="ä¾‹ï¼šå¼µå°æ˜">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-2">æˆ¿å®¢é›»è©± *</label>
                        <input type="tel" id="guestPhone" required class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="ä¾‹ï¼š0912345678">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-2">æˆ¿å®¢Email</label>
                        <input type="email" id="guestEmail" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="guest@example.com">
                    </div>
                </div>

                <!-- æ¨è–¦å¤§ä½¿è³‡è¨Š -->
                <div class="bg-green-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">ğŸ‘¤ æ¨è–¦å¤§ä½¿è³‡è¨Š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">æ¨è–¦å¤§ä½¿ä»£ç¢¼</label>
                            <input type="text" id="partnerCode" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="ä¾‹ï¼šWANG001">
                            <p class="text-xs text-stone-500 mt-1">ç•™ç©ºè¡¨ç¤ºéå¤§ä½¿æ¨è–¦</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">è¨‚æˆ¿ä¾†æº *</label>
                            <select id="bookingSource" required class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                                <option value="">è«‹é¸æ“‡è¨‚æˆ¿ä¾†æº</option>
                                <option value="PHONE_BOOKING">é›»è©±è¨‚æˆ¿</option>
                                <option value="REFERRAL_LINK">æ¨è–¦é€£çµ</option>
                                <option value="MANUAL_ENTRY">ç¾å ´ç™»è¨˜</option>
                                <option value="SOCIAL_MEDIA">ç¤¾ç¾¤åª’é«”</option>
                                <option value="WORD_OF_MOUTH">å£è€³ç›¸å‚³</option>
                                <option value="OTHER">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ä½å®¿è³‡è¨Š -->
                <div class="bg-blue-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">ğŸ  ä½å®¿è³‡è¨Š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">å…¥ä½æ—¥æœŸ *</label>
                            <input type="date" id="checkinDate" required class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">é€€æˆ¿æ—¥æœŸ *</label>
                            <input type="date" id="checkoutDate" required class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">å¯¦éš›æˆ¿åƒ¹ *</label>
                            <input type="number" id="roomPrice" required min="0" step="1" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="5000">
                        </div>
                    </div>
                </div>

                <!-- ç‹€æ…‹è¨­å®š -->
                <div class="bg-amber-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold text-amber-800 mb-4">ğŸ“Š åˆå§‹ç‹€æ…‹</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">å…¥ä½ç‹€æ…‹</label>
                            <select id="stayStatus" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                                <option value="PENDING">å¾…å…¥ä½</option>
                                <option value="CHECKED_IN">å·²å…¥ä½</option>
                                <option value="COMPLETED">å·²å®Œæˆ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">ä»˜æ¬¾ç‹€æ…‹</label>
                            <select id="paymentStatus" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                                <option value="PENDING">å¾…ä»˜æ¬¾</option>
                                <option value="PARTIAL">éƒ¨åˆ†ä»˜æ¬¾</option>
                                <option value="PAID">å·²ä»˜æ¸…</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- å‚™è¨» -->
                <div>
                    <label class="block text-sm font-medium text-stone-700 mb-2">å‚™è¨»</label>
                    <textarea id="notes" rows="3" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none" placeholder="ä¾‹ï¼šå®¢äººç‰¹åˆ¥è¦æ±‚ã€æ¨è–¦ä¾†æºè©³æƒ…ç­‰..."></textarea>
                </div>

                <!-- æäº¤æŒ‰éˆ• -->
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-green-800 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-900 transition duration-300">
                        ğŸ’¾ ç™»è¨˜è¨‚æˆ¿
                    </button>
                    <button type="button" onclick="resetForm()" class="px-6 py-3 border-2 border-stone-200 text-stone-600 rounded-lg font-semibold hover:bg-stone-50 transition duration-300">
                        ğŸ”„ æ¸…ç©ºè¡¨å–®
                    </button>
                </div>
            </form>
        </div>

        <!-- æœ€è¿‘ç™»è¨˜è¨˜éŒ„ -->
        <div class="brand-card p-8">
            <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ğŸ“‹ æœ€è¿‘ç™»è¨˜è¨˜éŒ„</h2>
            <div id="recentBookings" class="space-y-4">
                <p class="text-stone-500 text-center py-8">å°šç„¡ç™»è¨˜è¨˜éŒ„</p>
            </div>
        </div>
    </div>

    <!-- éš±è—çš„ iframe ç”¨æ–¼æ¥æ”¶è¡¨å–®å›æ‡‰ -->
    <iframe id="hiddenFrame" name="hiddenFrame" style="display:none;"></iframe>

    <script>
        // è¨­å®šå€¼
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        // è¡¨å–®æäº¤è™•ç†
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitBooking();
        });

        async function submitBooking() {
            // æ”¶é›†è¡¨å–®è³‡æ–™
            const formData = {
                action: 'create_booking',
                partner_code: document.getElementById('partnerCode').value.trim() || null,
                guest_name: document.getElementById('guestName').value.trim(),
                guest_phone: document.getElementById('guestPhone').value.trim(),
                guest_email: document.getElementById('guestEmail').value.trim(),
                checkin_date: document.getElementById('checkinDate').value,
                checkout_date: document.getElementById('checkoutDate').value,
                room_price: parseInt(document.getElementById('roomPrice').value) || 0,
                booking_source: document.getElementById('bookingSource').value,
                stay_status: document.getElementById('stayStatus').value,
                payment_status: document.getElementById('paymentStatus').value,
                notes: document.getElementById('notes').value.trim()
            };

            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!formData.guest_name || !formData.guest_phone || !formData.checkin_date || !formData.checkout_date || !formData.room_price || !formData.booking_source) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                return;
            }

            // é©—è­‰æ—¥æœŸé‚è¼¯
            if (new Date(formData.checkin_date) >= new Date(formData.checkout_date)) {
                alert('é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸï¼');
                return;
            }

            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'ç™»è¨˜ä¸­...';
            submitButton.disabled = true;

            try {
                // ä½¿ç”¨è¡¨å–®æäº¤æ–¹å¼ï¼ˆé¿å…CORSå•é¡Œï¼‰
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // æ·»åŠ æ‰€æœ‰æ•¸æ“šä½œç‚ºéš±è—è¼¸å…¥
                for (const [key, value] of Object.entries(formData)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value || '';
                    form.appendChild(input);
                }

                // ç›£è½ iframe è¼‰å…¥å®Œæˆäº‹ä»¶
                const iframe = document.getElementById('hiddenFrame');
                iframe.onload = function() {
                    setTimeout(() => {
                        showToast('âœ… è¨‚æˆ¿è¨˜éŒ„å·²æˆåŠŸç™»è¨˜ï¼');
                        
                        // æ·»åŠ åˆ°æœ€è¿‘è¨˜éŒ„
                        addToRecentBookings(formData);
                        
                        // é‡ç½®è¡¨å–®
                        resetForm();
                        
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    }, 1000);
                };

                // æäº¤è¡¨å–®
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);

            } catch (error) {
                console.error('ç™»è¨˜å¤±æ•—:', error);
                alert('âŒ ç™»è¨˜å¤±æ•—ï¼š' + error.message);
                
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        function resetForm() {
            document.getElementById('bookingForm').reset();
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkinDate').value = today;
            
            // è¨­å®šé è¨­é€€æˆ¿æ—¥æœŸç‚ºæ˜å¤©
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('checkoutDate').value = tomorrow.toISOString().split('T')[0];
        }

        function addToRecentBookings(booking) {
            const container = document.getElementById('recentBookings');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ç­†è¨˜éŒ„ï¼Œæ¸…ç©ºæç¤ºæ–‡å­—
            if (container.children.length === 1 && container.children[0].textContent.includes('å°šç„¡ç™»è¨˜è¨˜éŒ„')) {
                container.innerHTML = '';
            }

            const bookingElement = document.createElement('div');
            bookingElement.className = 'bg-gray-50 p-4 rounded-lg border-l-4 border-green-500';
            bookingElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-semibold text-stone-800">${booking.guest_name}</h3>
                        <div class="text-sm text-stone-600 mt-1">
                            <p>ğŸ“ ${booking.guest_phone}</p>
                            <p>ğŸ“… ${booking.checkin_date} ~ ${booking.checkout_date}</p>
                            <p>ğŸ’° $${booking.room_price}</p>
                            ${booking.partner_code ? `<p>ğŸ‘¤ æ¨è–¦å¤§ä½¿ï¼š${booking.partner_code}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            ${getStatusText(booking.stay_status)}
                        </span>
                        <p class="text-stone-500 mt-1">${new Date().toLocaleString('zh-TW')}</p>
                    </div>
                </div>
            `;
            
            // æ’å…¥åˆ°æœ€å‰é¢
            container.insertBefore(bookingElement, container.firstChild);
            
            // é™åˆ¶æœ€å¤šé¡¯ç¤º10ç­†è¨˜éŒ„
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…å…¥ä½',
                'CHECKED_IN': 'å·²å…¥ä½', 
                'COMPLETED': 'å·²å®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // åˆå§‹åŒ–æ—¥æœŸæ¬„ä½
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkinDate').value = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('checkoutDate').value = tomorrow.toISOString().split('T')[0];
        });

        // è‡ªå‹•è¨ˆç®—ä½å®¿å¤©æ•¸æç¤º
        document.getElementById('checkinDate').addEventListener('change', updateStayDuration);
        document.getElementById('checkoutDate').addEventListener('change', updateStayDuration);

        function updateStayDuration() {
            const checkin = new Date(document.getElementById('checkinDate').value);
            const checkout = new Date(document.getElementById('checkoutDate').value);
            
            if (checkin && checkout && checkout > checkin) {
                const days = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
                console.log(`ä½å®¿å¤©æ•¸ï¼š${days} æ™š`);
            }
        }
    </script>
</body>
</html>