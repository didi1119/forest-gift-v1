<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿæ¸¬è©¦ - é©—è­‰æ¬„ä½ä¿®å¾©</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">å¿«é€Ÿæ¸¬è©¦ - é©—è­‰æ¬„ä½ä¿®å¾©</h1>
        <p class="text-green-600 mb-8">âœ… Google Sheets å·²æ·»åŠ æ‰€æœ‰å¿…è¦æ¬„ä½ï¼Œç¾åœ¨æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸</p>
        
        <!-- é…ç½® -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Google Apps Script URL
                </label>
                <input type="text" id="scriptUrl" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md"
                       value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
            </div>
        </div>

        <!-- æ¸¬è©¦æŒ‰éˆ• -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <button onclick="runQuickTest()" 
                    class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-lg font-semibold">
                ğŸš€ åŸ·è¡Œå¿«é€Ÿæ¸¬è©¦
            </button>
        </div>

        <!-- çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="results" class="space-y-2">
                <p class="text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...</p>
            </div>
        </div>
    </div>

    <script>
        const TEST_CODE = 'QUICK_TEST_' + Date.now();
        
        async function runQuickTest() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            try {
                // æ­¥é©Ÿ 1: å‰µå»ºæœ‰ 9999 é»çš„æ¸¬è©¦å¤§ä½¿
                addResult('ğŸ“ æ­¥é©Ÿ 1: å‰µå»ºæ¸¬è©¦å¤§ä½¿ï¼ˆ9999é»ï¼‰...', 'info');
                
                const createParams = new URLSearchParams({
                    action: 'create_partner',
                    partner_code: TEST_CODE,
                    partner_name: 'å¿«é€Ÿæ¸¬è©¦å¤§ä½¿',
                    contact_phone: '0999123456',
                    contact_email: 'quicktest@example.com',
                    bank_account: '9999888877776666',
                    commission_preference: 'ACCOMMODATION',
                    available_points: '9999',
                    notes: 'å¿«é€Ÿæ¸¬è©¦ - åˆå§‹é»æ•¸æ‡‰ç‚º9999'
                });
                
                const createResponse = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: createParams.toString()
                });
                
                const createResult = await createResponse.json();
                
                if (createResult.success) {
                    addResult('âœ… å¤§ä½¿å‰µå»ºæˆåŠŸ', 'success');
                    
                    // æ­¥é©Ÿ 2: æŸ¥è©¢ä¸¦é©—è­‰é»æ•¸
                    addResult('ğŸ“ æ­¥é©Ÿ 2: æŸ¥è©¢å¤§ä½¿è³‡æ–™...', 'info');
                    await delay(2000);
                    
                    const dataResponse = await fetch(`${scriptUrl}?action=get_all_data`);
                    const allData = await dataResponse.json();
                    
                    if (allData.success && allData.data.partners) {
                        const partner = allData.data.partners.find(p => p.partner_code === TEST_CODE);
                        
                        if (partner) {
                            addResult('âœ… æ‰¾åˆ°å¤§ä½¿è³‡æ–™', 'success');
                            
                            // æª¢æŸ¥é—œéµæ¬„ä½
                            const checks = [
                                { field: 'available_points', expected: 9999, actual: partner.available_points },
                                { field: 'partner_level æˆ– level', expected: 'LV1_INSIDER', actual: partner.partner_level || partner.level },
                                { field: 'points_used', expected: 0, actual: partner.points_used },
                                { field: 'commission_preference', expected: 'ACCOMMODATION', actual: partner.commission_preference }
                            ];
                            
                            let allPassed = true;
                            checks.forEach(check => {
                                if (check.actual === check.expected) {
                                    addResult(`âœ… ${check.field}: ${check.actual}`, 'success');
                                } else {
                                    addResult(`âŒ ${check.field}: ${check.actual} (é æœŸ: ${check.expected})`, 'error');
                                    allPassed = false;
                                }
                            });
                            
                            if (allPassed) {
                                // æ­¥é©Ÿ 3: æ¸¬è©¦ä½¿ç”¨é»æ•¸
                                addResult('ğŸ“ æ­¥é©Ÿ 3: æ¸¬è©¦ä½¿ç”¨ 1000 é»...', 'info');
                                
                                const useParams = new URLSearchParams({
                                    action: 'use_accommodation_points',
                                    partner_code: TEST_CODE,
                                    deduct_amount: '1000',
                                    checkin_date: '2024-12-30',
                                    room_price: '5000'
                                });
                                
                                const useResponse = await fetch(scriptUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: useParams.toString()
                                });
                                
                                const useResult = await useResponse.json();
                                
                                if (useResult.success) {
                                    addResult('âœ… æˆåŠŸä½¿ç”¨ 1000 é»', 'success');
                                    
                                    // å†æ¬¡æŸ¥è©¢ç¢ºèªé»æ•¸è®ŠåŒ–
                                    await delay(2000);
                                    const finalResponse = await fetch(`${scriptUrl}?action=get_all_data`);
                                    const finalData = await finalResponse.json();
                                    
                                    if (finalData.success && finalData.data.partners) {
                                        const finalPartner = finalData.data.partners.find(p => p.partner_code === TEST_CODE);
                                        if (finalPartner) {
                                            addResult(`æœ€çµ‚é»æ•¸ç‹€æ…‹:`, 'info');
                                            addResult(`â€¢ å¯ç”¨é»æ•¸: ${finalPartner.available_points} (æ‡‰è©²æ˜¯ 8999)`, 
                                                      finalPartner.available_points === 8999 ? 'success' : 'error');
                                            addResult(`â€¢ å·²ä½¿ç”¨é»æ•¸: ${finalPartner.points_used} (æ‡‰è©²æ˜¯ 1000)`, 
                                                      finalPartner.points_used === 1000 ? 'success' : 'error');
                                        }
                                    }
                                } else {
                                    addResult(`âŒ ä½¿ç”¨é»æ•¸å¤±æ•—: ${useResult.error}`, 'error');
                                }
                            }
                            
                            // é¡¯ç¤ºå®Œæ•´è³‡æ–™
                            addResult('\nğŸ“Š å®Œæ•´å¤§ä½¿è³‡æ–™:', 'info');
                            const importantFields = ['partner_code', 'available_points', 'points_used', 
                                                    'partner_level', 'level', 'total_commission_earned'];
                            importantFields.forEach(field => {
                                if (partner[field] !== undefined) {
                                    addResult(`â€¢ ${field}: ${partner[field]}`, 'data');
                                }
                            });
                            
                        } else {
                            addResult('âŒ æ‰¾ä¸åˆ°å¤§ä½¿è³‡æ–™', 'error');
                        }
                    }
                } else {
                    addResult(`âŒ å‰µå»ºå¤±æ•—: ${createResult.error}`, 'error');
                }
                
                addResult('\nğŸ‰ æ¸¬è©¦å®Œæˆï¼', 'header');
                
            } catch (error) {
                addResult(`âŒ éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const colors = {
                success: 'text-green-600 font-semibold',
                error: 'text-red-600 font-semibold',
                warning: 'text-yellow-600',
                info: 'text-blue-600',
                data: 'text-gray-700 ml-4',
                header: 'text-purple-600 font-bold text-lg'
            };
            
            resultsDiv.innerHTML += `<div class="${colors[type]}">${message}</div>`;
        }
    </script>
</body>
</html>