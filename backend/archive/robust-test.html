<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©©å¥æ¸¬è©¦å¥—ä»¶ v2 - å®Œæ•´è¨ºæ–·ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { font-family: monospace; font-size: 12px; }
        .log-success { color: green; }
        .log-error { color: red; }
        .log-warning { color: orange; }
        .log-info { color: blue; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-green-800 mb-4">ğŸ›¡ï¸ ç©©å¥æ¸¬è©¦å¥—ä»¶ v2</h1>
            <p class="text-gray-600 mb-2">ç‰ˆæœ¬ï¼š2.0.0 | æ›´æ–°æ™‚é–“ï¼š2025-08-19</p>
            <p class="text-red-600 font-semibold mb-4">âš ï¸ å¦‚æœçœ‹åˆ° "Failed to fetch" éŒ¯èª¤ï¼Œè«‹å¼·åˆ¶é‡æ–°æ•´ç†é é¢ (Ctrl+F5 æˆ– Cmd+Shift+R)</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Google Apps Script URL</label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¸¬è©¦å‰ç¶´ï¼ˆç”¨æ–¼è­˜åˆ¥ï¼‰</label>
                    <input type="text" id="testPrefix" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                           value="ROBUST" readonly>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="runAllTests()" 
                        class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-semibold">
                    ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦
                </button>
                <button onclick="runSingleTest('partner')" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    æ¸¬è©¦å¤§ä½¿
                </button>
                <button onclick="runSingleTest('booking')" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    æ¸¬è©¦è¨‚æˆ¿
                </button>
                <button onclick="runSingleTest('points')" 
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    æ¸¬è©¦é»æ•¸
                </button>
                <button onclick="clearLog()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    æ¸…é™¤æ—¥èªŒ
                </button>
            </div>
        </div>

        <!-- Test Status -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦ç‹€æ…‹</h2>
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded">
                    <div class="text-2xl font-bold" id="totalTests">0</div>
                    <div class="text-sm text-gray-600">ç¸½æ¸¬è©¦</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded">
                    <div class="text-2xl font-bold text-green-600" id="passedTests">0</div>
                    <div class="text-sm text-gray-600">é€šé</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded">
                    <div class="text-2xl font-bold text-red-600" id="failedTests">0</div>
                    <div class="text-sm text-gray-600">å¤±æ•—</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-600" id="runningTests">0</div>
                    <div class="text-sm text-gray-600">åŸ·è¡Œä¸­</div>
                </div>
            </div>
        </div>

        <!-- Detailed Log -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">è©³ç´°æ—¥èªŒ</h2>
            <div id="testLog" class="space-y-1 max-h-96 overflow-y-auto bg-gray-50 p-4 rounded">
                <div class="log-entry log-info">ç­‰å¾…é–‹å§‹æ¸¬è©¦...</div>
            </div>
        </div>
    </div>

    <!-- Hidden iframe for form submissions -->
    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <script>
        // Test state
        let testStats = { total: 0, passed: 0, failed: 0, running: 0 };
        let testPartnerCode = '';
        let testBookingId = '';
        let initialPartnerState = null;
        
        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }
        
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('runningTests').textContent = testStats.running;
        }
        
        // Utility functions
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function generateTestCode() {
            return `ROBUST_${Date.now()}_${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
        }
        
        // Form submission helper
        async function submitForm(scriptUrl, data) {
            return new Promise((resolve) => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = scriptUrl;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                Object.keys(data).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = data[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                
                // Listen for response
                window.addEventListener('message', function handler(event) {
                    if (event.data && event.data.source === 'apps-script-response') {
                        window.removeEventListener('message', handler);
                        document.body.removeChild(form);
                        resolve(event.data);
                    }
                });
                
                form.submit();
                
                // Timeout fallback
                setTimeout(() => {
                    document.body.removeChild(form);
                    resolve({ success: true, message: 'Form submitted (no response)' });
                }, 3000);
            });
        }
        
        // Get data helper
        async function getData(scriptUrl) {
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                return await response.json();
            } catch (error) {
                log(`ç²å–æ•¸æ“šå¤±æ•—: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Test: Create Partner
        async function testCreatePartner(scriptUrl) {
            log('=== æ¸¬è©¦å‰µå»ºå¤§ä½¿ ===', 'info');
            testStats.running++;
            updateStats();
            
            try {
                testPartnerCode = generateTestCode();
                log(`ç”Ÿæˆæ¸¬è©¦ä»£ç¢¼: ${testPartnerCode}`, 'info');
                
                const partnerData = {
                    action: 'create_partner',
                    partner_code: testPartnerCode,
                    partner_name: 'ç©©å¥æ¸¬è©¦å¤§ä½¿',
                    partner_level: 'LV1_INSIDER',
                    contact_phone: '0912345678',
                    contact_email: 'robust@test.com',
                    commission_preference: 'ACCOMMODATION',
                    available_points: '8000',
                    points_used: '0',
                    successful_referrals: '0',
                    bank_account: '1234567890123456'
                };
                
                log('æäº¤å‰µå»ºå¤§ä½¿è¡¨å–®...', 'info');
                await submitForm(scriptUrl, partnerData);
                
                log('ç­‰å¾… 2 ç§’...', 'info');
                await delay(2000);
                
                // Verify creation
                const data = await getData(scriptUrl);
                if (data && data.data && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === testPartnerCode);
                    if (partner) {
                        initialPartnerState = { ...partner };
                        log(`âœ… å¤§ä½¿å‰µå»ºæˆåŠŸ: ${testPartnerCode}`, 'success');
                        log(`  åˆå§‹é»æ•¸: ${partner.available_points}`, 'info');
                        log(`  ç­‰ç´š: ${partner.partner_level || partner.level}`, 'info');
                        testStats.passed++;
                        testStats.running--;
                        updateStats();
                        return true;
                    }
                }
                
                throw new Error('ç„¡æ³•æ‰¾åˆ°å‰µå»ºçš„å¤§ä½¿');
                
            } catch (error) {
                log(`âŒ å‰µå»ºå¤§ä½¿å¤±æ•—: ${error.message}`, 'error');
                testStats.failed++;
                testStats.running--;
                updateStats();
                return false;
            }
        }
        
        // Test: Create Booking
        async function testCreateBooking(scriptUrl) {
            log('=== æ¸¬è©¦å‰µå»ºè¨‚æˆ¿ ===', 'info');
            testStats.running++;
            updateStats();
            
            try {
                if (!testPartnerCode) {
                    throw new Error('æ²’æœ‰æ¸¬è©¦å¤§ä½¿ä»£ç¢¼');
                }
                
                const bookingData = {
                    action: 'create_booking',
                    partner_code: testPartnerCode,
                    guest_name: 'æ¸¬è©¦æˆ¿å®¢_' + Date.now(),
                    guest_phone: '0911' + Math.floor(Math.random() * 1000000),
                    checkin_date: '2024-12-25',
                    checkout_date: '2024-12-27',
                    room_price: '5000',
                    booking_source: 'REFERRAL',
                    notes: 'ç©©å¥æ¸¬è©¦è¨‚æˆ¿'
                };
                
                log('æäº¤å‰µå»ºè¨‚æˆ¿è¡¨å–®...', 'info');
                log(`  å¤§ä½¿ä»£ç¢¼: ${testPartnerCode}`, 'info');
                await submitForm(scriptUrl, bookingData);
                
                log('ç­‰å¾… 3 ç§’...', 'info');
                await delay(3000);
                
                // Find booking
                const data = await getData(scriptUrl);
                if (data && data.data && data.data.bookings) {
                    const bookings = data.data.bookings.filter(b => b.partner_code === testPartnerCode);
                    if (bookings.length > 0) {
                        testBookingId = bookings[bookings.length - 1].id;
                        log(`âœ… è¨‚æˆ¿å‰µå»ºæˆåŠŸ: ID=${testBookingId}`, 'success');
                        testStats.passed++;
                        testStats.running--;
                        updateStats();
                        return true;
                    }
                }
                
                throw new Error('ç„¡æ³•æ‰¾åˆ°å‰µå»ºçš„è¨‚æˆ¿');
                
            } catch (error) {
                log(`âŒ å‰µå»ºè¨‚æˆ¿å¤±æ•—: ${error.message}`, 'error');
                testStats.failed++;
                testStats.running--;
                updateStats();
                return false;
            }
        }
        
        // Test: Confirm Checkin
        async function testConfirmCheckin(scriptUrl) {
            log('=== æ¸¬è©¦ç¢ºèªå…¥ä½ ===', 'info');
            testStats.running++;
            updateStats();
            
            try {
                if (!testBookingId) {
                    throw new Error('æ²’æœ‰æ¸¬è©¦è¨‚æˆ¿ID');
                }
                
                const confirmData = {
                    action: 'confirm_checkin_completion',
                    booking_id: testBookingId,
                    confirmed_by: 'robust_test'
                };
                
                log(`æäº¤ç¢ºèªå…¥ä½è¡¨å–® (ID=${testBookingId})...`, 'info');
                await submitForm(scriptUrl, confirmData);
                
                log('ç­‰å¾… 3 ç§’è™•ç†ä½£é‡‘...', 'info');
                await delay(3000);
                
                // Check commission
                const data = await getData(scriptUrl);
                if (data && data.data) {
                    // Check booking status
                    const booking = data.data.bookings.find(b => b.id === testBookingId);
                    if (booking) {
                        log(`  è¨‚æˆ¿ç‹€æ…‹: ${booking.stay_status}`, 'info');
                        log(`  ä½£é‡‘ç‹€æ…‹: ${booking.commission_status}`, 'info');
                        log(`  ä½£é‡‘é‡‘é¡: ${booking.commission_amount}`, 'info');
                    }
                    
                    // Check partner points
                    const partner = data.data.partners.find(p => p.partner_code === testPartnerCode);
                    if (partner && initialPartnerState) {
                        const pointsChange = (partner.available_points || 0) - (initialPartnerState.available_points || 0);
                        const referralsChange = (partner.successful_referrals || 0) - (initialPartnerState.successful_referrals || 0);
                        
                        log(`  é»æ•¸è®ŠåŒ–: ${pointsChange}`, 'info');
                        log(`  æ¨è–¦æ•¸è®ŠåŒ–: ${referralsChange}`, 'info');
                        
                        // Expected: 1000 base + 1500 first bonus = 2500
                        const expectedCommission = 2500;
                        if (Math.abs(pointsChange - expectedCommission) < 1) {
                            log(`âœ… ä½£é‡‘è¨ˆç®—æ­£ç¢º: ${pointsChange} (é æœŸ ${expectedCommission})`, 'success');
                            testStats.passed++;
                        } else {
                            log(`âš ï¸ ä½£é‡‘è¨ˆç®—å·®ç•°: ${pointsChange} (é æœŸ ${expectedCommission})`, 'warning');
                            testStats.failed++;
                        }
                    }
                }
                
                testStats.running--;
                updateStats();
                return true;
                
            } catch (error) {
                log(`âŒ ç¢ºèªå…¥ä½å¤±æ•—: ${error.message}`, 'error');
                testStats.failed++;
                testStats.running--;
                updateStats();
                return false;
            }
        }
        
        // Test: Use Points
        async function testUsePoints(scriptUrl) {
            log('=== æ¸¬è©¦ä½¿ç”¨ä½å®¿é‡‘ ===', 'info');
            testStats.running++;
            updateStats();
            
            try {
                if (!testPartnerCode) {
                    throw new Error('æ²’æœ‰æ¸¬è©¦å¤§ä½¿ä»£ç¢¼');
                }
                
                const useData = {
                    action: 'use_accommodation_points',
                    partner_code: testPartnerCode,
                    deduct_amount: '1000',
                    checkin_date: '2024-12-30',
                    room_price: '5000',
                    notes: 'æ¸¬è©¦ä½¿ç”¨ä½å®¿é‡‘'
                };
                
                log('æäº¤ä½¿ç”¨ä½å®¿é‡‘è¡¨å–®...', 'info');
                await submitForm(scriptUrl, useData);
                
                log('ç­‰å¾… 2 ç§’...', 'info');
                await delay(2000);
                
                log(`âœ… ä½¿ç”¨ä½å®¿é‡‘è«‹æ±‚å·²ç™¼é€`, 'success');
                testStats.passed++;
                testStats.running--;
                updateStats();
                return true;
                
            } catch (error) {
                log(`âŒ ä½¿ç”¨ä½å®¿é‡‘å¤±æ•—: ${error.message}`, 'error');
                testStats.failed++;
                testStats.running--;
                updateStats();
                return false;
            }
        }
        
        // Test: Convert to Cash
        async function testConvertToCash(scriptUrl) {
            log('=== æ¸¬è©¦è½‰æ›ç¾é‡‘ ===', 'info');
            testStats.running++;
            updateStats();
            
            try {
                if (!testPartnerCode) {
                    throw new Error('æ²’æœ‰æ¸¬è©¦å¤§ä½¿ä»£ç¢¼');
                }
                
                const convertData = {
                    action: 'convert_points_to_cash',
                    partner_code: testPartnerCode,
                    points_used: '2000',  // æ­£ç¢ºçš„åƒæ•¸åç¨±
                    notes: 'æ¸¬è©¦è½‰æ›ç¾é‡‘'
                };
                
                log('æäº¤è½‰æ›ç¾é‡‘è¡¨å–®...', 'info');
                await submitForm(scriptUrl, convertData);
                
                log('ç­‰å¾… 2 ç§’...', 'info');
                await delay(2000);
                
                log(`âœ… è½‰æ›ç¾é‡‘è«‹æ±‚å·²ç™¼é€`, 'success');
                testStats.passed++;
                testStats.running--;
                updateStats();
                return true;
                
            } catch (error) {
                log(`âŒ è½‰æ›ç¾é‡‘å¤±æ•—: ${error.message}`, 'error');
                testStats.failed++;
                testStats.running--;
                updateStats();
                return false;
            }
        }
        
        // Run all tests
        async function runAllTests() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            // Reset stats
            testStats = { total: 5, passed: 0, failed: 0, running: 0 };
            updateStats();
            
            log('===== é–‹å§‹å®Œæ•´æ¸¬è©¦ =====', 'info');
            log(`æ¸¬è©¦ URL: ${scriptUrl}`, 'info');
            log(`æ¸¬è©¦æ™‚é–“: ${new Date().toLocaleString()}`, 'info');
            
            // Run tests in sequence
            await testCreatePartner(scriptUrl);
            await delay(1000);
            
            await testCreateBooking(scriptUrl);
            await delay(1000);
            
            await testConfirmCheckin(scriptUrl);
            await delay(1000);
            
            await testUsePoints(scriptUrl);
            await delay(1000);
            
            await testConvertToCash(scriptUrl);
            
            // Final summary
            log('===== æ¸¬è©¦å®Œæˆ =====', 'info');
            log(`é€šé: ${testStats.passed}/${testStats.total}`, testStats.passed === testStats.total ? 'success' : 'warning');
            log(`å¤±æ•—: ${testStats.failed}/${testStats.total}`, testStats.failed > 0 ? 'error' : 'info');
        }
        
        // Run single test
        async function runSingleTest(type) {
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            switch(type) {
                case 'partner':
                    testStats = { total: 1, passed: 0, failed: 0, running: 0 };
                    updateStats();
                    await testCreatePartner(scriptUrl);
                    break;
                case 'booking':
                    if (!testPartnerCode) {
                        log('è«‹å…ˆæ¸¬è©¦å‰µå»ºå¤§ä½¿', 'warning');
                        return;
                    }
                    testStats = { total: 1, passed: 0, failed: 0, running: 0 };
                    updateStats();
                    await testCreateBooking(scriptUrl);
                    break;
                case 'points':
                    if (!testPartnerCode) {
                        log('è«‹å…ˆæ¸¬è©¦å‰µå»ºå¤§ä½¿', 'warning');
                        return;
                    }
                    testStats = { total: 1, passed: 0, failed: 0, running: 0 };
                    updateStats();
                    await testUsePoints(scriptUrl);
                    break;
            }
        }
        
        // Initialize
        log('ç©©å¥æ¸¬è©¦å¥—ä»¶ v2.0.0 å·²è¼‰å…¥', 'success');
        log('æç¤ºï¼šå¦‚æœé‡åˆ°å•é¡Œï¼Œè«‹å¼·åˆ¶é‡æ–°æ•´ç†é é¢', 'warning');
    </script>
</body>
</html>