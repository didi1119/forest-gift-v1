<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€£çµç”Ÿæˆå™¨æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">é€£çµç”Ÿæˆå™¨åŠŸèƒ½æ¸¬è©¦</h1>
        
        <!-- æ¸¬è©¦èªªæ˜ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">æ¸¬è©¦æ­¥é©Ÿ</h2>
            <ol class="list-decimal list-inside space-y-2 text-blue-700">
                <li>é–‹å•Ÿé€£çµç”Ÿæˆå™¨é é¢</li>
                <li>å¡«å¯«æ¸¬è©¦è³‡æ–™ä¸¦ç”Ÿæˆé€£çµ</li>
                <li>é»æ“Šã€Œå„²å­˜åˆ° Google Sheetsã€</li>
                <li>é»æ“Šä¸‹æ–¹ã€Œæª¢æŸ¥ Partner è³‡æ–™ã€é©—è­‰</li>
            </ol>
        </div>

        <!-- é…ç½®å€ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Google Apps Script URL
                    </label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        æ¸¬è©¦å¤¥ä¼´ä»£ç¢¼
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="è¼¸å…¥å‰›åœ¨é€£çµç”Ÿæˆå™¨å‰µå»ºçš„ä»£ç¢¼"
                           value="">
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦æŒ‰éˆ• -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">é©—è­‰åŠŸèƒ½</h2>
            <div class="space-y-3">
                <button onclick="openLinkGenerator()" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    1. é–‹å•Ÿé€£çµç”Ÿæˆå™¨é é¢
                </button>
                
                <button onclick="checkPartnerData()" 
                        class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    2. æª¢æŸ¥ Partner è³‡æ–™
                </button>
                
                <button onclick="verifyAllFields()" 
                        class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    3. é©—è­‰æ‰€æœ‰æ¬„ä½
                </button>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤º -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æª¢æŸ¥çµæœ</h2>
            <div id="results" class="space-y-4">
                <p class="text-gray-500">æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
            </div>
        </div>
    </div>

    <script>
        // é–‹å•Ÿé€£çµç”Ÿæˆå™¨
        function openLinkGenerator() {
            window.open('../frontend/admin/link-generator-form.html', '_blank');
            addResult('âœ… å·²é–‹å•Ÿé€£çµç”Ÿæˆå™¨é é¢ï¼Œè«‹å¡«å¯«è³‡æ–™ä¸¦å„²å­˜', 'info');
        }

        // æª¢æŸ¥ Partner è³‡æ–™
        async function checkPartnerData() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            if (!partnerCode) {
                addResult('âŒ è«‹è¼¸å…¥å¤¥ä¼´ä»£ç¢¼', 'error');
                return;
            }
            
            try {
                addResult('ğŸ” æ­£åœ¨æŸ¥è©¢ Partner è³‡æ–™...', 'info');
                
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === partnerCode);
                    
                    if (partner) {
                        displayPartnerData(partner);
                    } else {
                        addResult(`âŒ æ‰¾ä¸åˆ°å¤¥ä¼´ä»£ç¢¼: ${partnerCode}`, 'error');
                    }
                } else {
                    addResult('âŒ ç„¡æ³•ç²å–è³‡æ–™', 'error');
                }
            } catch (error) {
                addResult(`âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // é¡¯ç¤º Partner è³‡æ–™
        function displayPartnerData(partner) {
            const resultsDiv = document.getElementById('results');
            
            const requiredFields = [
                'partner_code', 'partner_name', 'partner_level',
                'contact_phone', 'contact_email',
                'commission_preference', 'total_commission_earned',
                'available_points', 'line_coupon_url',
                'short_landing_link', 'short_coupon_link'
            ];
            
            let html = `
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">Partner è³‡æ–™æª¢æŸ¥</h3>
                    
                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2">åŸºæœ¬è³‡æ–™</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>ä»£ç¢¼: <span class="font-mono ${partner.partner_code ? 'text-green-600' : 'text-red-600'}">${partner.partner_code || 'âŒ ç¼ºå°‘'}</span></div>
                            <div>å§“å: <span class="font-mono ${partner.partner_name ? 'text-green-600' : 'text-red-600'}">${partner.partner_name || 'âŒ ç¼ºå°‘'}</span></div>
                            <div>ç­‰ç´š: <span class="font-mono ${partner.partner_level === 'LV1_INSIDER' ? 'text-green-600' : 'text-yellow-600'}">${partner.partner_level || 'âŒ ç¼ºå°‘'}</span></div>
                            <div>æ‰‹æ©Ÿ: <span class="font-mono ${partner.contact_phone ? 'text-green-600' : 'text-yellow-600'}">${partner.contact_phone || 'âš ï¸ ç¼ºå°‘'}</span></div>
                            <div>Email: <span class="font-mono ${partner.contact_email ? 'text-green-600' : 'text-yellow-600'}">${partner.contact_email || 'âš ï¸ ç¼ºå°‘'}</span></div>
                        </div>
                    </div>
                    
                    <!-- ä½£é‡‘è³‡æ–™ -->
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2">ä½£é‡‘è³‡æ–™</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>åå¥½: <span class="font-mono text-green-600">${partner.commission_preference || 'ACCOMMODATION'}</span></div>
                            <div>ç´¯ç©ä½£é‡‘: <span class="font-mono">NT$ ${partner.total_commission_earned || 0}</span></div>
                            <div>å¯ç”¨é»æ•¸: <span class="font-mono">${partner.available_points || 0}</span></div>
                            <div>å¾…æ”¯ä»˜: <span class="font-mono">NT$ ${partner.pending_commission || 0}</span></div>
                        </div>
                    </div>
                    
                    <!-- é€£çµè³‡æ–™ -->
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2">é€£çµè³‡æ–™</h4>
                        <div class="space-y-1 text-sm">
                            <div>å„ªæƒ åˆ¸URL: <span class="font-mono ${partner.line_coupon_url ? 'text-green-600' : 'text-red-600'}">${partner.line_coupon_url ? 'âœ… æœ‰' : 'âŒ ç¼ºå°‘'}</span></div>
                            <div>çŸ­ç¶²å€(ä¸»é ): <span class="font-mono ${partner.short_landing_link ? 'text-green-600' : 'text-red-600'}">${partner.short_landing_link ? 'âœ… æœ‰' : 'âŒ ç¼ºå°‘'}</span></div>
                            <div>çŸ­ç¶²å€(å„ªæƒ ): <span class="font-mono ${partner.short_coupon_link ? 'text-green-600' : 'text-red-600'}">${partner.short_coupon_link ? 'âœ… æœ‰' : 'âŒ ç¼ºå°‘'}</span></div>
                        </div>
                    </div>
                    
                    <!-- éŠ€è¡Œè³‡æ–™ -->
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2">éŠ€è¡Œè³‡æ–™</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>éŠ€è¡Œä»£ç¢¼: <span class="font-mono">${partner.bank_code || 'æœªå¡«'}</span></div>
                            <div>å¸³è™Ÿ: <span class="font-mono">${partner.bank_account ? 'å·²å¡«å¯«' : 'æœªå¡«'}</span></div>
                        </div>
                    </div>
                    
                    <!-- çµ±è¨ˆè³‡æ–™ -->
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">çµ±è¨ˆè³‡æ–™</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>ç¸½æ¨è–¦: ${partner.total_referrals || 0}</div>
                            <div>æˆåŠŸæ¨è–¦: ${partner.successful_referrals || 0}</div>
                            <div>å¹´åº¦æ¨è–¦: ${partner.yearly_referrals || 0}</div>
                            <div>ç­‰ç´šé€²åº¦: ${partner.level_progress || 0}</div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å­˜åœ¨
            const missingFields = requiredFields.filter(field => !partner[field]);
            if (missingFields.length > 0) {
                addResult(`âš ï¸ ç¼ºå°‘æ¬„ä½: ${missingFields.join(', ')}`, 'warning');
            } else {
                addResult('âœ… æ‰€æœ‰å¿…è¦æ¬„ä½éƒ½å·²æ­£ç¢ºå„²å­˜ï¼', 'success');
            }
            
            // ç‰¹åˆ¥æª¢æŸ¥åˆå§‹ç­‰ç´š
            if (partner.partner_level === 'LV1_INSIDER') {
                addResult('âœ… åˆå§‹ç­‰ç´šæ­£ç¢ºè¨­å®šç‚º LV1_INSIDER', 'success');
            } else {
                addResult(`âš ï¸ ç­‰ç´šä¸æ˜¯ LV1_INSIDER: ${partner.partner_level}`, 'warning');
            }
        }

        // é©—è­‰æ‰€æœ‰æ¬„ä½
        async function verifyAllFields() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            if (!partnerCode) {
                addResult('âŒ è«‹è¼¸å…¥å¤¥ä¼´ä»£ç¢¼', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === partnerCode);
                    
                    if (partner) {
                        // å®Œæ•´æ¬„ä½åˆ—è¡¨
                        const expectedFields = {
                            // åŸºæœ¬è³‡æ–™
                            'partner_code': 'å¤¥ä¼´ä»£ç¢¼',
                            'partner_name': 'å¤¥ä¼´å§“å',
                            'partner_level': 'ç­‰ç´šï¼ˆæ‡‰ç‚º LV1_INSIDERï¼‰',
                            
                            // è¯çµ¡è³‡æ–™
                            'contact_phone': 'æ‰‹æ©Ÿè™Ÿç¢¼',
                            'contact_email': 'Email',
                            
                            // ä½£é‡‘è³‡æ–™
                            'commission_preference': 'ä½£é‡‘åå¥½',
                            'total_commission_earned': 'ç´¯ç©ä½£é‡‘',
                            'total_commission_paid': 'å·²æ”¯ä»˜ä½£é‡‘',
                            'pending_commission': 'å¾…æ”¯ä»˜ä½£é‡‘',
                            'available_points': 'å¯ç”¨é»æ•¸',
                            'points_used': 'å·²ä½¿ç”¨é»æ•¸',
                            
                            // æ¨è–¦çµ±è¨ˆ
                            'total_referrals': 'ç¸½æ¨è–¦æ•¸',
                            'successful_referrals': 'æˆåŠŸæ¨è–¦æ•¸',
                            'yearly_referrals': 'å¹´åº¦æ¨è–¦æ•¸',
                            'level_progress': 'ç­‰ç´šé€²åº¦',
                            
                            // é€£çµè³‡æ–™
                            'line_coupon_url': 'LINE å„ªæƒ åˆ¸ URL',
                            'coupon_code': 'å„ªæƒ åˆ¸ä»£ç¢¼',
                            'short_landing_link': 'çŸ­ç¶²å€ï¼ˆä¸»é ï¼‰',
                            'short_coupon_link': 'çŸ­ç¶²å€ï¼ˆå„ªæƒ åˆ¸ï¼‰',
                            
                            // éŠ€è¡Œè³‡æ–™
                            'bank_code': 'éŠ€è¡Œä»£ç¢¼',
                            'bank_account': 'éŠ€è¡Œå¸³è™Ÿ',
                            
                            // å…¶ä»–
                            'is_active': 'å•Ÿç”¨ç‹€æ…‹',
                            'join_date': 'åŠ å…¥æ—¥æœŸ'
                        };
                        
                        let allFieldsOk = true;
                        let fieldReport = '<div class="space-y-1">';
                        
                        for (const [field, description] of Object.entries(expectedFields)) {
                            const value = partner[field];
                            const hasValue = value !== undefined && value !== null && value !== '';
                            
                            if (!hasValue) {
                                allFieldsOk = false;
                                fieldReport += `<div class="text-red-600">âŒ ${description}: ç¼ºå°‘</div>`;
                            } else {
                                fieldReport += `<div class="text-green-600">âœ… ${description}: ${value}</div>`;
                            }
                        }
                        
                        fieldReport += '</div>';
                        
                        const resultsDiv = document.getElementById('results');
                        resultsDiv.innerHTML = `
                            <div class="border rounded-lg p-4">
                                <h3 class="font-semibold text-lg mb-3">å®Œæ•´æ¬„ä½é©—è­‰</h3>
                                ${fieldReport}
                            </div>
                        `;
                        
                        if (allFieldsOk) {
                            addResult('ğŸ‰ å®Œç¾ï¼æ‰€æœ‰æ¬„ä½éƒ½å·²æ­£ç¢ºå„²å­˜', 'success');
                        } else {
                            addResult('âš ï¸ éƒ¨åˆ†æ¬„ä½ç¼ºå¤±ï¼Œè«‹æª¢æŸ¥ä¸Šæ–¹è©³ç´°å ±å‘Š', 'warning');
                        }
                        
                    } else {
                        addResult(`âŒ æ‰¾ä¸åˆ°å¤¥ä¼´: ${partnerCode}`, 'error');
                    }
                }
            } catch (error) {
                addResult(`âŒ é©—è­‰å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // æ·»åŠ çµæœè¨Šæ¯
        function addResult(message, type = 'info') {
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600',
                info: 'text-blue-600'
            };
            
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const resultItem = `<div class="${colors[type]}">
                <span class="text-gray-500">[${timestamp}]</span> ${message}
            </div>`;
            
            const resultsDiv = document.getElementById('results');
            if (resultsDiv.innerHTML.includes('æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                resultsDiv.innerHTML = resultItem;
            } else {
                resultsDiv.innerHTML = resultItem + resultsDiv.innerHTML;
            }
        }
    </script>
</body>
</html>