<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»æ“Šè¿½è¹¤æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">é»æ“Šè¿½è¹¤åŠŸèƒ½æ¸¬è©¦</h1>
        
        <!-- é…ç½®å€ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Google Apps Script URL
                    </label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        æ¸¬è©¦å¤¥ä¼´ä»£ç¢¼
                    </label>
                    <input type="text" id="partnerCode" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           placeholder="TEST001"
                           value="TEST001">
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦é€£çµ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦é€£çµ</h2>
            <div class="space-y-4">
                <!-- ä¸»é é€£çµ -->
                <div class="border rounded p-4">
                    <h3 class="font-semibold mb-2">ä¸»é é€£çµ</h3>
                    <div class="mb-2">
                        <a id="landingLink" href="#" target="_blank" 
                           class="text-blue-600 hover:underline break-all"></a>
                    </div>
                    <button onclick="testClick('landing')" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æ¸¬è©¦é»æ“Š (landing)
                    </button>
                </div>

                <!-- å„ªæƒ åˆ¸é€£çµ -->
                <div class="border rounded p-4">
                    <h3 class="font-semibold mb-2">å„ªæƒ åˆ¸é€£çµ</h3>
                    <div class="mb-2">
                        <a id="couponLink" href="#" target="_blank" 
                           class="text-green-600 hover:underline break-all"></a>
                    </div>
                    <button onclick="testClick('coupon')" 
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        æ¸¬è©¦é»æ“Š (coupon)
                    </button>
                </div>

                <!-- å« UTM åƒæ•¸çš„é€£çµ -->
                <div class="border rounded p-4">
                    <h3 class="font-semibold mb-2">å« UTM åƒæ•¸çš„é€£çµ</h3>
                    <div class="mb-2">
                        <a id="utmLink" href="#" target="_blank" 
                           class="text-purple-600 hover:underline break-all"></a>
                    </div>
                    <button onclick="testClick('landing', true)" 
                            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        æ¸¬è©¦é»æ“Š (å« UTM)
                    </button>
                </div>
            </div>
        </div>

        <!-- é»æ“Šçµ±è¨ˆ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">é»æ“Šçµ±è¨ˆ</h2>
            <button onclick="getClickStats()" 
                    class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 mb-4">
                ç²å–é»æ“Šçµ±è¨ˆ
            </button>
            <div id="statsResult" class="space-y-4">
                <p class="text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç²å–çµ±è¨ˆæ•¸æ“š</p>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="results" class="space-y-2">
                <p class="text-gray-500">æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
            </div>
        </div>
    </div>

    <script>
        // ç”Ÿæˆæ¸¬è©¦é€£çµ
        function generateLinks() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            if (!scriptUrl || !partnerCode) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            // ä¸»é é€£çµ
            const landingUrl = `${scriptUrl}?pid=${partnerCode}&dest=landing`;
            document.getElementById('landingLink').href = landingUrl;
            document.getElementById('landingLink').textContent = landingUrl;
            
            // å„ªæƒ åˆ¸é€£çµ
            const couponUrl = `${scriptUrl}?pid=${partnerCode}&dest=coupon&target=${encodeURIComponent('https://lin.ee/q38pqot')}`;
            document.getElementById('couponLink').href = couponUrl;
            document.getElementById('couponLink').textContent = couponUrl;
            
            // UTM é€£çµ
            const utmUrl = `${scriptUrl}?pid=${partnerCode}&dest=landing&utm_source=facebook&utm_medium=social&utm_campaign=winter2024`;
            document.getElementById('utmLink').href = utmUrl;
            document.getElementById('utmLink').textContent = utmUrl;
        }
        
        // æ¸¬è©¦é»æ“Š
        function testClick(destination, withUtm = false) {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            let url = `${scriptUrl}?pid=${partnerCode}&dest=${destination}`;
            
            if (destination === 'coupon') {
                url += `&target=${encodeURIComponent('https://lin.ee/q38pqot')}`;
            }
            
            if (withUtm) {
                url += '&utm_source=facebook&utm_medium=social&utm_campaign=winter2024';
            }
            
            // é–‹å•Ÿæ–°è¦–çª—
            window.open(url, '_blank');
            
            // è¨˜éŒ„æ¸¬è©¦
            addResult(`âœ… å·²ç™¼é€é»æ“Šæ¸¬è©¦: ${destination}${withUtm ? ' (å«UTM)' : ''}`);
            
            // 3ç§’å¾Œè‡ªå‹•ç²å–çµ±è¨ˆ
            setTimeout(() => {
                getClickStats();
            }, 3000);
        }
        
        // ç²å–é»æ“Šçµ±è¨ˆ
        async function getClickStats() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const partnerCode = document.getElementById('partnerCode').value;
            
            try {
                addResult('ğŸ“Š æ­£åœ¨ç²å–é»æ“Šçµ±è¨ˆ...');
                
                // ç²å–å…¨éƒ¨çµ±è¨ˆ
                const allStatsUrl = `${scriptUrl}?action=get_click_stats`;
                const allResponse = await fetch(allStatsUrl);
                const allData = await allResponse.json();
                
                // ç²å–ç‰¹å®šå¤¥ä¼´çµ±è¨ˆ
                const partnerStatsUrl = `${scriptUrl}?action=get_click_stats&partner_code=${partnerCode}`;
                const partnerResponse = await fetch(partnerStatsUrl);
                const partnerData = await partnerResponse.json();
                
                // é¡¯ç¤ºçµ±è¨ˆçµæœ
                displayStats(allData, partnerData);
                
                addResult('âœ… æˆåŠŸç²å–é»æ“Šçµ±è¨ˆ');
                
            } catch (error) {
                addResult(`âŒ ç²å–çµ±è¨ˆå¤±æ•—: ${error.message}`);
                console.error('ç²å–çµ±è¨ˆéŒ¯èª¤:', error);
            }
        }
        
        // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
        function displayStats(allData, partnerData) {
            const statsDiv = document.getElementById('statsResult');
            
            if (!allData.success) {
                statsDiv.innerHTML = `<p class="text-red-600">ç²å–å…¨éƒ¨çµ±è¨ˆå¤±æ•—: ${allData.error || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
                return;
            }
            
            const stats = allData.data;
            const partnerStats = partnerData.success ? partnerData.data : null;
            
            let html = `
                <div class="grid grid-cols-2 gap-4">
                    <!-- ç¸½é«”çµ±è¨ˆ -->
                    <div class="border rounded p-4">
                        <h3 class="font-semibold mb-2">ç¸½é«”çµ±è¨ˆ</h3>
                        <p>ç¸½é»æ“Šæ•¸: <span class="font-bold">${stats.total_clicks}</span></p>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">ç›®çš„åœ°åˆ†å¸ƒ:</p>
                            ${Object.entries(stats.destination_stats || {}).map(([dest, count]) => 
                                `<p class="text-sm ml-2">â€¢ ${dest}: ${count}</p>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <!-- ç‰¹å®šå¤¥ä¼´çµ±è¨ˆ -->
                    <div class="border rounded p-4">
                        <h3 class="font-semibold mb-2">å¤¥ä¼´çµ±è¨ˆ (${document.getElementById('partnerCode').value})</h3>
                        ${partnerStats ? `
                            <p>å¤¥ä¼´é»æ“Šæ•¸: <span class="font-bold">${partnerStats.total_clicks}</span></p>
                            <div class="mt-2">
                                <p class="text-sm text-gray-600">ç›®çš„åœ°åˆ†å¸ƒ:</p>
                                ${Object.entries(partnerStats.stats.destinations || {}).map(([dest, count]) => 
                                    `<p class="text-sm ml-2">â€¢ ${dest}: ${count}</p>`
                                ).join('')}
                            </div>
                        ` : '<p class="text-gray-500">ç„¡æ•¸æ“š</p>'}
                    </div>
                </div>
                
                <!-- UTM çµ±è¨ˆ -->
                ${stats.utm_stats && Object.keys(stats.utm_stats.sources || {}).length > 0 ? `
                    <div class="border rounded p-4 mt-4">
                        <h3 class="font-semibold mb-2">UTM åƒæ•¸çµ±è¨ˆ</h3>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="font-medium">ä¾†æº (source):</p>
                                ${Object.entries(stats.utm_stats.sources || {}).map(([source, count]) => 
                                    `<p class="ml-2">â€¢ ${source}: ${count}</p>`
                                ).join('')}
                            </div>
                            <div>
                                <p class="font-medium">åª’ä»‹ (medium):</p>
                                ${Object.entries(stats.utm_stats.mediums || {}).map(([medium, count]) => 
                                    `<p class="ml-2">â€¢ ${medium}: ${count}</p>`
                                ).join('')}
                            </div>
                            <div>
                                <p class="font-medium">æ´»å‹• (campaign):</p>
                                ${Object.entries(stats.utm_stats.campaigns || {}).map(([campaign, count]) => 
                                    `<p class="ml-2">â€¢ ${campaign}: ${count}</p>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- æœ€è¿‘çš„é»æ“Š -->
                ${stats.recent_clicks && stats.recent_clicks.length > 0 ? `
                    <div class="border rounded p-4 mt-4">
                        <h3 class="font-semibold mb-2">æœ€è¿‘çš„é»æ“Š</h3>
                        <div class="overflow-x-auto">
                            <table class="text-sm w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="text-left p-2">æ™‚é–“</th>
                                        <th class="text-left p-2">å¤¥ä¼´</th>
                                        <th class="text-left p-2">ç›®çš„åœ°</th>
                                        <th class="text-left p-2">UTM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stats.recent_clicks.slice(0, 5).map(click => `
                                        <tr class="border-b">
                                            <td class="p-2">${new Date(click.click_time).toLocaleString('zh-TW')}</td>
                                            <td class="p-2">${click.partner_code || '-'}</td>
                                            <td class="p-2">${click.destination || '-'}</td>
                                            <td class="p-2 text-xs">
                                                ${click.utm_source ? `src:${click.utm_source}` : ''}
                                                ${click.utm_medium ? ` med:${click.utm_medium}` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;
            
            statsDiv.innerHTML = html;
        }
        
        // æ·»åŠ æ¸¬è©¦çµæœ
        function addResult(message) {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const resultItem = `<div class="text-sm"><span class="text-gray-500">[${timestamp}]</span> ${message}</div>`;
            
            if (resultsDiv.innerHTML.includes('æ¸¬è©¦çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                resultsDiv.innerHTML = resultItem;
            } else {
                resultsDiv.innerHTML = resultItem + resultsDiv.innerHTML;
            }
        }
        
        // é é¢è¼‰å…¥æ™‚ç”Ÿæˆé€£çµ
        window.onload = function() {
            generateLinks();
        };
    </script>
</body>
</html>