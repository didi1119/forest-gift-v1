<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>連結生成器測試診斷</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">🔧 連結生成器測試診斷</h1>
        
        <!-- Test 1: Generate Links -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">測試 1：生成連結</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">大使代碼</label>
                    <input type="text" id="testCode" value="TEST123" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">專屬優惠券連結</label>
                    <input type="text" id="testCoupon" value="https://lin.ee/SPECIAL123" class="w-full px-3 py-2 border rounded">
                </div>
            </div>
            <button onclick="testGenerateLinks()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                測試生成連結
            </button>
            <div id="linkResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 2: Save to Sheets -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">測試 2：儲存到 Google Sheets</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">大使代碼</label>
                    <input type="text" id="saveCode" value="SAVE_TEST_123" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">大使姓名</label>
                    <input type="text" id="saveName" value="測試大使" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">專屬優惠券連結</label>
                    <input type="text" id="saveCoupon" value="https://lin.ee/MY_COUPON" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="text" id="saveEmail" value="test@example.com" class="w-full px-3 py-2 border rounded">
                </div>
            </div>
            <button onclick="testSaveToSheets()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                測試儲存
            </button>
            <div id="saveResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 3: Check Backend -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">測試 3：檢查後端狀態</h2>
            <button onclick="checkBackend()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                檢查後端
            </button>
            <div id="backendResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 4: Direct API Test -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">測試 4：直接 API 測試</h2>
            <button onclick="directAPITest()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                直接測試 API
            </button>
            <div id="apiResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
    </div>
    
    <iframe name="hiddenFrame" style="display:none;"></iframe>
    
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            const color = isError ? 'text-red-600' : 'text-green-600';
            element.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
        }
        
        // Test 1: Generate Links
        function testGenerateLinks() {
            const code = document.getElementById('testCode').value;
            const couponUrl = document.getElementById('testCoupon').value;
            const resultDiv = document.getElementById('linkResult');
            resultDiv.innerHTML = '';
            
            log('linkResult', '開始生成連結...');
            
            // Generate URLs
            const landingUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(code)}&dest=landing`;
            const trackedCouponUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(code)}&dest=coupon&target=${encodeURIComponent(couponUrl)}`;
            
            log('linkResult', `主頁連結: ${landingUrl}`);
            log('linkResult', `優惠券連結: ${trackedCouponUrl}`);
            
            // Check if coupon URL is included
            if (trackedCouponUrl.includes(encodeURIComponent(couponUrl))) {
                log('linkResult', '✅ 優惠券連結正確包含專屬連結');
            } else {
                log('linkResult', '❌ 優惠券連結未包含專屬連結', true);
            }
        }
        
        // Test 2: Save to Sheets
        async function testSaveToSheets() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.innerHTML = '';
            
            const partnerData = {
                action: 'create_partner',
                partner_code: document.getElementById('saveCode').value,
                partner_name: document.getElementById('saveName').value,
                contact_email: document.getElementById('saveEmail').value,
                coupon_url: document.getElementById('saveCoupon').value,
                partner_level: 'LV1_INSIDER',
                commission_preference: 'ACCOMMODATION',
                available_points: '0',
                points_used: '0',
                successful_referrals: '0'
            };
            
            log('saveResult', '準備儲存資料...');
            log('saveResult', `資料: ${JSON.stringify(partnerData, null, 2)}`);
            
            try {
                // Method 1: Form submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                Object.keys(partnerData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = partnerData[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
                
                log('saveResult', '表單已提交');
                
                setTimeout(() => {
                    document.body.removeChild(form);
                    log('saveResult', '等待 3 秒後檢查結果...');
                    
                    // Check if partner was created
                    fetch(`${APPS_SCRIPT_URL}?action=get_all_data`)
                        .then(res => res.json())
                        .then(data => {
                            if (data && data.data && data.data.partners) {
                                const partner = data.data.partners.find(p => p.partner_code === partnerData.partner_code);
                                if (partner) {
                                    log('saveResult', `✅ 找到大使: ${partner.partner_code}`);
                                    log('saveResult', `優惠券連結: ${partner.coupon_url}`);
                                    if (partner.coupon_url === partnerData.coupon_url) {
                                        log('saveResult', '✅ 優惠券連結正確儲存');
                                    } else {
                                        log('saveResult', `❌ 優惠券連結不符 - 預期: ${partnerData.coupon_url}, 實際: ${partner.coupon_url}`, true);
                                    }
                                } else {
                                    log('saveResult', '❌ 找不到大使', true);
                                }
                            }
                        })
                        .catch(err => {
                            log('saveResult', `錯誤: ${err.message}`, true);
                        });
                }, 3000);
                
            } catch (error) {
                log('saveResult', `錯誤: ${error.message}`, true);
            }
        }
        
        // Test 3: Check Backend
        async function checkBackend() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.innerHTML = '';
            
            log('backendResult', '檢查後端狀態...');
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success !== false) {
                    log('backendResult', '✅ 後端回應正常');
                    log('backendResult', `Partners 數量: ${data.data.partners?.length || 0}`);
                    log('backendResult', `Bookings 數量: ${data.data.bookings?.length || 0}`);
                    
                    // Check if Partners table has coupon_url field
                    if (data.data.partners && data.data.partners.length > 0) {
                        const firstPartner = data.data.partners[0];
                        if ('coupon_url' in firstPartner) {
                            log('backendResult', '✅ Partners 表格有 coupon_url 欄位');
                        } else {
                            log('backendResult', '❌ Partners 表格缺少 coupon_url 欄位', true);
                            log('backendResult', `可用欄位: ${Object.keys(firstPartner).join(', ')}`);
                        }
                    }
                } else {
                    log('backendResult', `❌ 後端錯誤: ${data.error}`, true);
                }
            } catch (error) {
                log('backendResult', `❌ 無法連接後端: ${error.message}`, true);
            }
        }
        
        // Test 4: Direct API Test
        async function directAPITest() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '';
            
            const testData = {
                action: 'create_partner',
                partner_code: 'API_TEST_' + Date.now(),
                partner_name: 'API測試大使',
                contact_email: 'api@test.com',
                coupon_url: 'https://lin.ee/API_TEST_COUPON',
                partner_level: 'LV1_INSIDER',
                available_points: '1000'
            };
            
            log('apiResult', '測試直接 API 呼叫...');
            log('apiResult', `測試資料: ${JSON.stringify(testData, null, 2)}`);
            
            try {
                // Try fetch first
                log('apiResult', '嘗試 fetch API...');
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData).toString()
                });
                
                const result = await response.text();
                log('apiResult', `回應: ${result}`);
                
                // Parse if JSON
                try {
                    const json = JSON.parse(result);
                    if (json.success) {
                        log('apiResult', '✅ API 呼叫成功');
                    } else {
                        log('apiResult', `❌ API 錯誤: ${json.error}`, true);
                    }
                } catch (e) {
                    log('apiResult', '回應不是 JSON 格式');
                }
                
            } catch (error) {
                log('apiResult', `❌ Fetch 失敗: ${error.message}`, true);
                log('apiResult', '可能是 CORS 問題，這是正常的');
            }
        }
        
        // Auto-run checks on load
        window.addEventListener('load', () => {
            console.log('連結生成器測試診斷工具已載入');
            console.log('APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
        });
    </script>
</body>
</html>