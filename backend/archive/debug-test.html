<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½£é‡‘ç³»çµ±å•é¡Œè¨ºæ–·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">ä½£é‡‘ç³»çµ±å•é¡Œè¨ºæ–·å·¥å…·</h1>
        <p class="text-red-600 mb-8">é€™å€‹å·¥å…·æœƒå¹«åŠ©æ‰¾å‡ºç‚ºä»€éº¼é»æ•¸å’Œä½£é‡‘æ²’æœ‰æ­£ç¢ºæ›´æ–°</p>
        
        <!-- é…ç½® -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">è¨ºæ–·é…ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Google Apps Script URL
                    </label>
                    <input type="text" id="scriptUrl" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md"
                           value="https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec">
                </div>
            </div>
        </div>

        <!-- è¨ºæ–·æ¸¬è©¦ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">è¨ºæ–·æ¸¬è©¦</h2>
            <div class="space-y-3">
                <button onclick="testStep1()" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æ­¥é©Ÿ 1: å‰µå»ºæœ‰åˆå§‹é»æ•¸çš„å¤§ä½¿
                </button>
                
                <button onclick="testStep2()" 
                        class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        æ­¥é©Ÿ 2: é©—è­‰å¤§ä½¿è³‡æ–™æ˜¯å¦æ­£ç¢ºå„²å­˜
                </button>
                
                <button onclick="testStep3()" 
                        class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        æ­¥é©Ÿ 3: å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèª
                </button>
                
                <button onclick="testStep4()" 
                        class="w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        æ­¥é©Ÿ 4: æª¢æŸ¥ä½£é‡‘è¨ˆç®—
                </button>
                
                <button onclick="testStep5()" 
                        class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        æ­¥é©Ÿ 5: æ¸¬è©¦é»æ•¸ä½¿ç”¨
                </button>
                
                <button onclick="runAllDiagnostics()" 
                        class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                        åŸ·è¡Œå®Œæ•´è¨ºæ–·
                </button>
            </div>
        </div>

        <!-- è¨ºæ–·çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">è¨ºæ–·çµæœ</h2>
            <div id="results" class="space-y-2 font-mono text-sm">
                <p class="text-gray-500">è¨ºæ–·çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</p>
            </div>
        </div>
    </div>

    <script>
        const TEST_PARTNER_CODE = 'DEBUG_' + Date.now();
        const TEST_GUEST_NAME = 'DEBUG_GUEST_' + Date.now();
        
        // æ­¥é©Ÿ 1: å‰µå»ºæœ‰åˆå§‹é»æ•¸çš„å¤§ä½¿
        async function testStep1() {
            addResult('=== æ­¥é©Ÿ 1: å‰µå»ºå¤§ä½¿ ===', 'header');
            
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            // æ–¹æ³• 1: ä½¿ç”¨ fetch API
            try {
                const params = new URLSearchParams({
                    action: 'create_partner',
                    partner_code: TEST_PARTNER_CODE,
                    partner_name: 'è¨ºæ–·æ¸¬è©¦å¤§ä½¿',
                    contact_phone: '0999888777',
                    contact_email: 'debug@test.com',
                    bank_account: '99998888777766',
                    commission_preference: 'ACCOMMODATION',
                    available_points: '8888',  // æ˜ç¢ºçš„æ¸¬è©¦æ•¸å­—
                    notes: 'è¨ºæ–·æ¸¬è©¦ - åˆå§‹é»æ•¸æ‡‰ç‚º8888'
                });
                
                addResult(`ç™¼é€è³‡æ–™: available_points=8888`, 'info');
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addResult(`âœ… å‰µå»ºæˆåŠŸï¼Œä»£ç¢¼: ${TEST_PARTNER_CODE}`, 'success');
                    if (result.data) {
                        addResult(`å›å‚³çš„ available_points: ${result.data.available_points}`, 'info');
                    }
                } else {
                    addResult(`âŒ å‰µå»ºå¤±æ•—: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`âŒ API éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        // æ­¥é©Ÿ 2: é©—è­‰å¤§ä½¿è³‡æ–™
        async function testStep2() {
            addResult('=== æ­¥é©Ÿ 2: é©—è­‰å¤§ä½¿è³‡æ–™ ===', 'header');
            
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success && data.data.partners) {
                    const partner = data.data.partners.find(p => p.partner_code === TEST_PARTNER_CODE);
                    
                    if (partner) {
                        addResult('æ‰¾åˆ°å¤§ä½¿è³‡æ–™:', 'info');
                        addResult(`â€¢ partner_code: ${partner.partner_code}`, 'data');
                        addResult(`â€¢ partner_level: ${partner.partner_level}`, 'data');
                        addResult(`â€¢ available_points: ${partner.available_points} ${partner.available_points === 8888 ? 'âœ…' : 'âŒ æ‡‰è©²æ˜¯8888'}`, partner.available_points === 8888 ? 'success' : 'error');
                        addResult(`â€¢ points_used: ${partner.points_used}`, 'data');
                        addResult(`â€¢ total_commission_earned: ${partner.total_commission_earned}`, 'data');
                        addResult(`â€¢ pending_commission: ${partner.pending_commission}`, 'data');
                        
                        if (partner.available_points !== 8888) {
                            addResult(`âš ï¸ å•é¡Œ: åˆå§‹é»æ•¸æ²’æœ‰æ­£ç¢ºå„²å­˜ï¼`, 'error');
                        }
                    } else {
                        addResult(`âŒ æ‰¾ä¸åˆ°å¤§ä½¿: ${TEST_PARTNER_CODE}`, 'error');
                        addResult('å¯èƒ½åŸå› : è³‡æ–™æ²’æœ‰å¯«å…¥ Google Sheets', 'warning');
                    }
                } else {
                    addResult('âŒ ç„¡æ³•ç²å–è³‡æ–™', 'error');
                }
            } catch (error) {
                addResult(`âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ­¥é©Ÿ 3: å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèª
        async function testStep3() {
            addResult('=== æ­¥é©Ÿ 3: å‰µå»ºè¨‚æˆ¿ä¸¦ç¢ºèªå…¥ä½ ===', 'header');
            
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            // å‰µå»ºè¨‚æˆ¿
            try {
                const bookingParams = new URLSearchParams({
                    action: 'create_booking',
                    partner_code: TEST_PARTNER_CODE,
                    guest_name: TEST_GUEST_NAME,
                    guest_phone: '0911222333',
                    checkin_date: '2024-12-25',
                    checkout_date: '2024-12-27',
                    room_price: '10000'
                });
                
                addResult('å‰µå»ºè¨‚æˆ¿...', 'info');
                
                const bookingResponse = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: bookingParams.toString()
                });
                
                const bookingResult = await bookingResponse.json();
                
                if (bookingResult.success) {
                    addResult(`âœ… è¨‚æˆ¿å‰µå»ºæˆåŠŸ`, 'success');
                    
                    // ç¢ºèªå…¥ä½
                    setTimeout(async () => {
                        const confirmParams = new URLSearchParams({
                            action: 'confirm_checkin_completion',
                            guest_name: TEST_GUEST_NAME,
                            guest_phone: '0911222333',
                            checkin_date: '2024-12-25'
                        });
                        
                        addResult('ç¢ºèªå…¥ä½å®Œæˆ...', 'info');
                        
                        const confirmResponse = await fetch(scriptUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: confirmParams.toString()
                        });
                        
                        const confirmResult = await confirmResponse.json();
                        
                        if (confirmResult.success) {
                            addResult(`âœ… å…¥ä½ç¢ºèªæˆåŠŸ`, 'success');
                            if (confirmResult.commission) {
                                addResult(`è¨ˆç®—çš„ä½£é‡‘: ${confirmResult.commission}`, 'info');
                            }
                        } else {
                            addResult(`âŒ å…¥ä½ç¢ºèªå¤±æ•—: ${confirmResult.error}`, 'error');
                        }
                    }, 2000);
                } else {
                    addResult(`âŒ è¨‚æˆ¿å‰µå»ºå¤±æ•—: ${bookingResult.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`âŒ æ“ä½œå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ­¥é©Ÿ 4: æª¢æŸ¥ä½£é‡‘è¨ˆç®—
        async function testStep4() {
            addResult('=== æ­¥é©Ÿ 4: æª¢æŸ¥ä½£é‡‘è¨ˆç®— ===', 'header');
            
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            try {
                const response = await fetch(`${scriptUrl}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success) {
                    // æª¢æŸ¥å¤§ä½¿è³‡æ–™
                    if (data.data.partners) {
                        const partner = data.data.partners.find(p => p.partner_code === TEST_PARTNER_CODE);
                        if (partner) {
                            addResult('å¤§ä½¿ä½£é‡‘ç‹€æ…‹:', 'info');
                            addResult(`â€¢ å¯ç”¨é»æ•¸: ${partner.available_points} (æ‡‰è©² > 8888)`, partner.available_points > 8888 ? 'success' : 'error');
                            addResult(`â€¢ ç´¯ç©ä½£é‡‘: ${partner.total_commission_earned} (æ‡‰è©² > 0)`, partner.total_commission_earned > 0 ? 'success' : 'error');
                            addResult(`â€¢ æˆåŠŸæ¨è–¦: ${partner.successful_referrals}`, 'data');
                        }
                    }
                    
                    // æª¢æŸ¥è¨‚æˆ¿è³‡æ–™
                    if (data.data.bookings) {
                        const booking = data.data.bookings.find(b => b.guest_name === TEST_GUEST_NAME);
                        if (booking) {
                            addResult('è¨‚æˆ¿ä½£é‡‘ç‹€æ…‹:', 'info');
                            addResult(`â€¢ commission_status: ${booking.commission_status}`, 'data');
                            addResult(`â€¢ commission_amount: ${booking.commission_amount}`, 'data');
                            addResult(`â€¢ commission_type: ${booking.commission_type}`, 'data');
                            addResult(`â€¢ stay_status: ${booking.stay_status}`, 'data');
                            
                            if (booking.commission_amount === 0 || !booking.commission_amount) {
                                addResult('âš ï¸ å•é¡Œ: ä½£é‡‘æ²’æœ‰è¢«è¨ˆç®—ï¼', 'error');
                            }
                        }
                    }
                }
            } catch (error) {
                addResult(`âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // æ­¥é©Ÿ 5: æ¸¬è©¦é»æ•¸ä½¿ç”¨
        async function testStep5() {
            addResult('=== æ­¥é©Ÿ 5: æ¸¬è©¦é»æ•¸ä½¿ç”¨ ===', 'header');
            
            const scriptUrl = document.getElementById('scriptUrl').value;
            
            try {
                const params = new URLSearchParams({
                    action: 'use_accommodation_points',
                    partner_code: TEST_PARTNER_CODE,
                    deduct_amount: '500',
                    checkin_date: '2024-12-30',
                    room_price: '2000',
                    notes: 'è¨ºæ–·æ¸¬è©¦ - ä½¿ç”¨500é»'
                });
                
                addResult('å˜—è©¦ä½¿ç”¨500é»...', 'info');
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addResult(`âœ… æˆåŠŸä½¿ç”¨500é»`, 'success');
                    
                    // å†æ¬¡æª¢æŸ¥é»æ•¸
                    setTimeout(async () => {
                        const checkResponse = await fetch(`${scriptUrl}?action=get_all_data`);
                        const checkData = await checkResponse.json();
                        
                        if (checkData.success && checkData.data.partners) {
                            const partner = checkData.data.partners.find(p => p.partner_code === TEST_PARTNER_CODE);
                            if (partner) {
                                addResult(`ä½¿ç”¨å¾Œçš„é»æ•¸: ${partner.available_points}`, 'info');
                                addResult(`å·²ä½¿ç”¨é»æ•¸: ${partner.points_used}`, 'info');
                            }
                        }
                    }, 1000);
                } else {
                    addResult(`âŒ ä½¿ç”¨å¤±æ•—: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addResult(`âŒ æ“ä½œå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        async function runAllDiagnostics() {
            addResult('ğŸ” é–‹å§‹å®Œæ•´è¨ºæ–·...', 'header');
            
            await testStep1();
            await delay(3000);
            
            await testStep2();
            await delay(2000);
            
            await testStep3();
            await delay(5000);
            
            await testStep4();
            await delay(2000);
            
            await testStep5();
            await delay(3000);
            
            await testStep2(); // æœ€å¾Œå†æª¢æŸ¥ä¸€æ¬¡
            
            addResult('âœ… è¨ºæ–·å®Œæˆ', 'header');
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            
            const colors = {
                success: 'text-green-600 font-bold',
                error: 'text-red-600 font-bold',
                warning: 'text-yellow-600',
                info: 'text-blue-600',
                data: 'text-gray-700 ml-4',
                header: 'text-purple-600 font-bold text-base mt-4'
            };
            
            const resultItem = `<div class="${colors[type]}">
                ${type !== 'header' && type !== 'data' ? `<span class="text-gray-500">[${timestamp}]</span>` : ''} ${message}
            </div>`;
            
            if (resultsDiv.innerHTML.includes('è¨ºæ–·çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                resultsDiv.innerHTML = resultItem;
            } else {
                resultsDiv.innerHTML += resultItem;
            }
            
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
    </script>
</body>
</html>