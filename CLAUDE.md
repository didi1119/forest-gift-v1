# çŸ¥éŸ³è¨ˆç•« - æ£®æ—ä½å®¿å¤§ä½¿æ¨è–¦ç³»çµ±

## å°ˆæ¡ˆæ¦‚è¿°

çŸ¥éŸ³è¨ˆç•«æ˜¯ä¸€å€‹æ£®æ—ä½å®¿æ¨è–¦ç³»çµ±ï¼Œé€éå¤§ä½¿æ¨è–¦æ©Ÿåˆ¶ä¾†æ¨å»£å„ªè³ªä½å®¿é«”é©—ã€‚ç³»çµ±åŒ…å«å®Œæ•´çš„å¤§ä½¿ç®¡ç†ã€è¨‚æˆ¿è¿½è¹¤ã€ä½£é‡‘è¨ˆç®—å’Œçµç®—åŠŸèƒ½ã€‚

## æŠ€è¡“æ¶æ§‹

### å‰ç«¯æŠ€è¡“æ£§
- **HTML5 + JavaScript (ES6+)**ï¼šä¸»è¦é–‹ç™¼èªè¨€
- **Tailwind CSS**ï¼šUI æ¡†æ¶ï¼Œæ¡ç”¨ JIT æ¨¡å¼
- **Noto Fonts**ï¼šä¸­æ–‡å­—é«”æ”¯æ´
- **åŸç”Ÿ Fetch API + è¡¨å–®æäº¤**ï¼šæ··åˆ API é€šè¨Šæ¨¡å¼

### å¾Œç«¯æŠ€è¡“æ£§
- **Google Apps Script**ï¼šç„¡ä¼ºæœå™¨å¾Œç«¯è§£æ±ºæ–¹æ¡ˆ
- **Google Sheets**ï¼šè³‡æ–™åº«å­˜å„²
- **CORS è™•ç†**ï¼šæ”¯æ´è·¨åŸŸè«‹æ±‚

### éƒ¨ç½²æ¶æ§‹
- **å‰ç«¯**ï¼šGitHub Pages éœæ…‹è¨—ç®¡
- **å¾Œç«¯**ï¼šGoogle Apps Script é›²ç«¯åŸ·è¡Œ
- **è³‡æ–™åº«**ï¼šGoogle Sheets é›²ç«¯å­˜å„²

## å°ˆæ¡ˆçµæ§‹

```
çŸ¥éŸ³è¨ˆç•«/
â”œâ”€â”€ CLAUDE.md                           # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶ ğŸ†•
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ admin/                          # ç®¡ç†å¾Œå°
â”‚       â”œâ”€â”€ admin-dashboard-real.html   # ä¸»æ§åˆ¶å° ğŸ¯
â”‚       â”œâ”€â”€ manual-booking.html         # æ‰‹å‹•è¨‚æˆ¿é é¢
â”‚       â”œâ”€â”€ manual-checkin-confirm.html # å…¥ä½ç¢ºèªé é¢
â”‚       â”œâ”€â”€ link-generator-form.html    # é€£çµç”Ÿæˆå™¨
â”‚       â”œâ”€â”€ commission-management.js    # ä½£é‡‘ç®¡ç†æ¨¡çµ„
â”‚       â”œâ”€â”€ payout-functions.js         # çµç®—åŠŸèƒ½æ¨¡çµ„
â”‚       â””â”€â”€ google-apps-script-fix.html # æ•…éšœæ’é™¤æŒ‡å—
â””â”€â”€ backend/                            # Google Apps Script ä»£ç¢¼
    â””â”€â”€ apps-script-commission-v3.js    # ä¸»è¦å¾Œç«¯é‚è¼¯
```

## æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„

### 1. å¤§ä½¿ç®¡ç†ç³»çµ± (Partners)
- **å¤§ä½¿è¨»å†Š**ï¼šå§“åã€ä»£ç¢¼ã€è¯çµ¡è³‡è¨Šã€éŠ€è¡Œå¸³æˆ¶
- **ç­‰ç´šåˆ¶åº¦**ï¼šLV1 çŸ¥éŸ³å¤§ä½¿ â†’ LV2 æ£®æ—åš®å° â†’ LV3 ç§˜å¢ƒå®ˆè­·è€…
- **ä½£é‡‘åå¥½**ï¼šç¾é‡‘ vs ä½å®¿é‡‘é¸æ“‡
- **ç¸¾æ•ˆè¿½è¹¤**ï¼šæ¨è–¦æˆåŠŸæ•¸ã€ç´¯ç©ä½£é‡‘

### 2. è¨‚æˆ¿ç®¡ç†ç³»çµ± (Bookings) ğŸ¯
**æ¨™æº–åŒ–è³‡æ–™çµæ§‹ (22 å€‹æ¬„ä½)ï¼š**



| æ¬„ä½ | èªªæ˜ | é¡å‹ | å¿…å¡« |
|------|------|------|------|
| id | å”¯ä¸€è­˜åˆ¥ç¬¦ | String | è‡ªå‹•ç”Ÿæˆ |
| partner_code | æ¨è–¦å¤§ä½¿ä»£ç¢¼ | String | âŒ |
| guest_name | æˆ¿å®¢å§“å | String | âœ… |
| guest_phone | æˆ¿å®¢é›»è©± | String | âœ… |
| guest_email | æˆ¿å®¢Email | String | âŒ |
| bank_account_last5 | éŠ€è¡Œå¸³è™Ÿå¾Œ5ç¢¼ | String | âŒ |
| checkin_date | å…¥ä½æ—¥æœŸ | Date | âœ… |
| checkout_date | é€€æˆ¿æ—¥æœŸ | Date | âœ… |
| room_price | æˆ¿åƒ¹ | Number | âœ… |
| booking_source | è¨‚æˆ¿ä¾†æº | String | è‡ªå‹•è¨­å®š |
| stay_status | ä½å®¿ç‹€æ…‹ | String | è‡ªå‹•è¨­å®š |
| payment_status | ä»˜æ¬¾ç‹€æ…‹ | String | è‡ªå‹•è¨­å®š |
| commission_status | ä½£é‡‘ç‹€æ…‹ | String | è‡ªå‹•è¨­å®š |
| commission_amount | ä½£é‡‘é‡‘é¡ | Number | è‡ªå‹•è¨ˆç®— |
| commission_type | ä½£é‡‘é¡å‹ | String | è‡ªå‹•è¨­å®š |
| is_first_referral_bonus | é¦–æ¬¡æ¨è–¦çå‹µ | Boolean | è‡ªå‹•è¨­å®š |
| first_referral_bonus_amount | é¦–æ¬¡æ¨è–¦çå‹µé‡‘é¡ | Number | è‡ªå‹•è¨ˆç®— |
| manually_confirmed_by | æ‰‹å‹•ç¢ºèªè€… | String | è‡ªå‹•è¨˜éŒ„ |
| manually_confirmed_at | æ‰‹å‹•ç¢ºèªæ™‚é–“ | DateTime | è‡ªå‹•è¨˜éŒ„ |
| notes | å‚™è¨» | String | âŒ |
| created_at | å‰µå»ºæ™‚é–“ | DateTime | è‡ªå‹•ç”Ÿæˆ |
| updated_at | æ›´æ–°æ™‚é–“ | DateTime | è‡ªå‹•æ›´æ–° |

### 3. ä½£é‡‘ç®¡ç†ç³»çµ± (Commission)
- **è‡ªå‹•è¨ˆç®—**ï¼šæ ¹æ“šå¤§ä½¿ç­‰ç´š

- **ä½£é‡‘ç‡è¡¨**ï¼š
  
  - LV1: 1000ä½å®¿é‡‘ / 500ç¾é‡‘
  
  - LV2: 1200ä½å®¿é‡‘ / 600ç¾é‡‘  
  
  - LV3: 1500ä½å®¿é‡‘ / 750ç¾é‡‘
  
    ç¾é‡‘éƒ½æ˜¯ä½å®¿é‡‘çš„50%
  
- **é¦–æ¬¡æ¨è–¦çå‹µ**ï¼š1500ä½å®¿é‡‘ï¼ˆåƒ…lv1)

- **æ‰‹å‹•èª¿æ•´**ï¼šæ”¯æ´ç‰¹æ®Šæƒ…æ³è™•ç†

### 4. çµç®—ç®¡ç†ç³»çµ± (Payouts)
- **æ··åˆçµç®—**ï¼šç¾é‡‘ + ä½å®¿é‡‘çµ„åˆ
- **ä½å®¿é‡‘é»æ•¸**ï¼šç´¯ç©ã€ä½¿ç”¨ã€æŠµæ‰£è¿½è¹¤
- **éŠ€è¡ŒåŒ¯æ¬¾**ï¼šæ”¯æ´å°ç£ä¸»è¦éŠ€è¡Œ
- **çµç®—è¨˜éŒ„**ï¼šå®Œæ•´çš„æ­·å²ç´€éŒ„

### 4.1 ä½å®¿é‡‘æŠ˜æŠµåŠŸèƒ½ ğŸ†•
- **å³æ™‚æŠ˜æŠµ**ï¼šå¤§ä½¿å¯ä½¿ç”¨ç´¯ç©çš„ä½å®¿é‡‘é»æ•¸æŠ˜æŠµæˆ¿è²»
- **é‡‘é¡é©—è­‰**ï¼šè‡ªå‹•é©—è­‰æŠ˜æŠµé‡‘é¡ä¸è¶…éå¯ç”¨é»æ•¸
- **æ¨¡æ…‹æ¡†ç•Œé¢**ï¼šå°ˆæ¥­çš„æŠ˜æŠµç”³è«‹ç•Œé¢
  - å…¥ä½æ—¥æœŸé¸æ“‡ï¼ˆå¿…å¡«ï¼‰
  - æŠ˜æŠµé‡‘é¡è¼¸å…¥èˆ‡å³æ™‚é©—è­‰
  - å¿«é€Ÿé‡‘é¡æŒ‰éˆ•ï¼ˆ$1000, $2000, $3000, å…¨éƒ¨ï¼‰
  - ç›¸é—œè¨‚æˆ¿IDå’Œå‚™è¨»æ¬„ä½
- **å³æ™‚æ›´æ–°**ï¼šå‰ç«¯æ•¸æ“šç«‹å³åæ˜ è®ŠåŒ–
- **Google Sheets é€£å‹•**ï¼šè‡ªå‹•æ›´æ–° `available_points` å’Œ `points_used` æ¬„ä½
- **CORS ç›¸å®¹**ï¼šä½¿ç”¨è¡¨å–®æäº¤é¿å…ç€è¦½å™¨é™åˆ¶

### 5. é€£çµç”Ÿæˆç³»çµ± (Link Generator)
- **è¿½è¹¤é€£çµ**ï¼šé€é Apps Script ä¸­ç¹¼æœå‹™
- **çŸ­ç¶²å€**ï¼šTinyURL / is.gd æ•´åˆ
- **åˆ†äº«ç¯„æœ¬**ï¼šé è¨­çš„æ¨è–¦æ–‡æ¡ˆ
- **ç¸¾æ•ˆçµ±è¨ˆ**ï¼šé»æ“Šæ•¸èˆ‡è½‰æ›ç‡

## è³‡æ–™æµç¨‹åœ–

```
æˆ¿å®¢é»æ“Šå¤§ä½¿é€£çµ â†’ GitHub Pages å¼•å°é  â†’ å®˜æ–¹è¨‚æˆ¿
                â†“
è¨‚æˆ¿ç¢ºèª â†’ æ‰‹å‹•ç™»è¨˜åˆ°ç³»çµ± â†’ å…¥ä½å®Œæˆç¢ºèª
                â†“
è‡ªå‹•è¨ˆç®—ä½£é‡‘ â†’ æ›´æ–°å¤§ä½¿ç­‰ç´š â†’ å‰µå»ºçµç®—è¨˜éŒ„
                â†“
çµç®—æ”¯ä»˜ â†’ ä½å®¿é‡‘ç´¯ç© â†’ é»æ•¸ä½¿ç”¨è¿½è¹¤ ğŸ†•
```

## é—œéµæŠ€è¡“å¯¦ä½œ

### 1. BookingDataManager æ•¸æ“šç®¡ç†å™¨
```javascript
const BookingDataManager = {
    validateBooking(booking),      // æ•¸æ“šé©—è­‰
    normalizeBooking(rawBooking),  // æ•¸æ“šæ¨™æº–åŒ–
    createNewBooking(formData),    // æ–°å»ºè¨‚æˆ¿
    updateBooking(existing, data), // æ›´æ–°è¨‚æˆ¿
    detectDataIssues(bookings),    // å•é¡Œè¨ºæ–·
    createOrderedParams(data)      // æ¨™æº–åŒ– API åƒæ•¸
}
```

### 2. æ··åˆ API é€šè¨Šæ¨¡å¼

**æ–¹å¼ä¸€ï¼šFetch APIï¼ˆæ¨è–¦ç”¨æ–¼æ•¸æ“šç²å–ï¼‰**
```javascript
const params = BookingDataManager.createOrderedParams(submitData);
const response = await fetch(APPS_SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: params.toString()
});
```

**æ–¹å¼äºŒï¼šè¡¨å–®æäº¤ï¼ˆç”¨æ–¼é¿å… CORS å•é¡Œï¼‰** ğŸ†•
```javascript
const form = document.createElement('form');
form.method = 'POST';
form.action = APPS_SCRIPT_URL;
form.target = 'hiddenFrame';  // ä½¿ç”¨éš±è— iframe æ¥æ”¶å›æ‡‰
form.style.display = 'none';

Object.keys(submitData).forEach(key => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = submitData[key];
    form.appendChild(input);
});

document.body.appendChild(form);
form.submit();
```



## é‡è¦é–‹ç™¼é‡Œç¨‹ç¢‘

### 2024-08-16 ä¿®å¾©403éŒ¯èª¤å•é¡Œ ğŸ”§
- **å•é¡Œ**ï¼šä½¿ç”¨form.submit()å¾Œèª¿ç”¨loadRealData()æœƒå°è‡´403éŒ¯èª¤
- **åŸå› **ï¼šGoogle Apps Scriptçš„form.submit()å›æ‡‰æœƒè§¸ç™¼é¡å¤–çš„è«‹æ±‚ï¼Œèˆ‡loadRealData()è¡çª
- **ç—‡ç‹€**ï¼š
  - è½‰æ›ç¾é‡‘æˆåŠŸä½†å‡ºç¾403éŒ¯èª¤ï¼š`script.googleusercontent.com/macros/echo Failed to load resource: 403`
  - Consoleé¡¯ç¤ºï¼š`âœ… æˆåŠŸè½‰æ› 166 é»ç‚º NT$ 83ï¼` ä½†æœ‰éŒ¯èª¤
  - ä½¿ç”¨ä½å®¿é‡‘ä¹Ÿæœ‰403éŒ¯èª¤ä½†æ•¸æ“šæœ‰æ›´æ–°
  - è½‰æ›ç¾é‡‘æ²’æœ‰403éŒ¯èª¤ï¼ˆç§»é™¤loadRealDataå¾Œï¼‰ä½†æ•¸æ“šå¯èƒ½æ²’æ›´æ–°
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  1. ç§»é™¤æ‰€æœ‰form.submit()å¾Œçš„loadRealData()èª¿ç”¨
  2. å»¶é•·setTimeoutç­‰å¾…æ™‚é–“åˆ°2ç§’ï¼Œç¢ºä¿å¾Œç«¯æœ‰è¶³å¤ æ™‚é–“è™•ç†
  3. åªæ›´æ–°æœ¬åœ°æ•¸æ“šï¼Œé¿å…ç«‹å³é‡æ–°è«‹æ±‚
  4. æ·»åŠ è©³ç´°çš„console.logèª¿è©¦ä¿¡æ¯
- **æ³¨æ„äº‹é …**ï¼š
  - form.submit()æ˜¯ç•°æ­¥æ“ä½œï¼Œéœ€è¦è¶³å¤ çš„ç­‰å¾…æ™‚é–“
  - 403éŒ¯èª¤ä¾†è‡ªGoogle Apps Scriptçš„è‡ªå‹•é‡å®šå‘éŸ¿æ‡‰
  - æ‰¹é‡æ“ä½œç­‰åŠŸèƒ½å¦‚éœ€é‡è¼‰æ•¸æ“šï¼Œæ‡‰ä½¿ç”¨è¼ƒé•·çš„å»¶é²æ™‚é–“

### 2024-08-16 è½‰æ›ç¾é‡‘åŠŸèƒ½å¾Œç«¯å•é¡Œ ğŸš¨
- **å•é¡Œ**ï¼š`"æœªçŸ¥çš„å‹•ä½œ: convert_points_to_cash"`
- **æ ¹å› **ï¼šGoogle Apps Scriptå¾Œç«¯ä»£ç¢¼ç‰ˆæœ¬éèˆŠï¼Œç¼ºå°‘æ–°åŠŸèƒ½è™•ç†å‡½æ•¸
- **ç—‡ç‹€**ï¼š
  - ä½¿ç”¨ä½å®¿é‡‘æ­£å¸¸ï¼ˆèˆŠåŠŸèƒ½å­˜åœ¨ï¼‰
  - è½‰æ›ç¾é‡‘å¤±æ•—ï¼ˆæ–°åŠŸèƒ½ä¸å­˜åœ¨ï¼‰
  - 200ç‹€æ…‹ç¢¼ä½†è¿”å›éŒ¯èª¤ï¼š`{"success":false,"error":"æœªçŸ¥çš„å‹•ä½œ: convert_points_to_cash"}`
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  1. æ›´æ–°Google Apps Scriptä»£ç¢¼ç‚ºæœ€æ–°ç‰ˆæœ¬
  2. ç¢ºä¿åŒ…å«`handleConvertPointsToCash`å‡½æ•¸
  3. é‡æ–°éƒ¨ç½²Google Apps Script
- **é é˜²æªæ–½**ï¼š
  - æœ¬åœ°ä»£ç¢¼æ›´æ–°å¾Œï¼ŒåŠæ™‚åŒæ­¥åˆ°Google Apps Script
  - æ¸¬è©¦æ–°åŠŸèƒ½å‰ç¢ºèªå¾Œç«¯ä»£ç¢¼å·²éƒ¨ç½²

### 2024-08-16 Google Sheetsæ¬„ä½éŒ¯ä½å•é¡Œ ğŸ”§
- **å•é¡Œ**ï¼šPayoutsè¡¨æ ¼æ•¸æ“šå¯«å…¥éŒ¯ä½ï¼Œæ¬„ä½ä¸åŒ¹é…
- **æ ¹å› **ï¼šå¾Œç«¯`payoutData`é™£åˆ—å…ƒç´ æ•¸é‡èˆ‡Google Sheetsæ¬„ä½æ•¸é‡ä¸åŒ¹é…
- **ç—‡ç‹€**ï¼š
  - è½‰æ›ç¾é‡‘åŠŸèƒ½æ­£å¸¸ä½†æ•¸æ“šå¯«å…¥ä½ç½®éŒ¯èª¤
  - Payoutsè¡¨æ ¼æœ‰14å€‹æ¬„ä½ä½†å¾Œç«¯åªæä¾›10å€‹å€¼
  - å°è‡´æ•¸æ“šå¯«å…¥åˆ°éŒ¯èª¤çš„æ¬„ä½ä¸­
- **å…·é«”éŒ¯ä½**ï¼š
  ```javascript
  // éŒ¯èª¤çš„é™£åˆ—ï¼ˆ10å€‹å…ƒç´ ï¼‰
  [ID, partner_code, payout_type, amount, payout_status, payout_date, booking_ids, notes, created_at, updated_at]
  
  // æ­£ç¢ºçš„é™£åˆ—ï¼ˆ14å€‹å…ƒç´ ï¼‰
  [ID, partner_code, payout_type, amount, related_booking_ids, payout_method, payout_status, 
   bank_transfer_date, bank_transfer_reference, accommodation_voucher_code, notes, created_by, created_at, updated_at]
  ```
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  1. æª¢æŸ¥Google Sheetså¯¦éš›æ¬„ä½çµæ§‹
  2. ä¿®æ­£`handleConvertPointsToCash`å‡½æ•¸ä¸­çš„`payoutData`é™£åˆ—
  3. ç¢ºä¿é™£åˆ—å…ƒç´ æ•¸é‡èˆ‡è¡¨æ ¼æ¬„ä½å®Œå…¨åŒ¹é…
  4. é‡æ–°éƒ¨ç½²Google Apps Scriptå¾Œç«¯ä»£ç¢¼
- **é é˜²æªæ–½**ï¼š
  - å‰µå»ºæ–°è¡¨æ ¼æˆ–ä¿®æ”¹æ¬„ä½æ™‚ï¼ŒåŒæ­¥æ›´æ–°å¾Œç«¯ä»£ç¢¼
  - ä½¿ç”¨æ¨™æº–åŒ–çš„æ¬„ä½æ˜ å°„æ–‡æª”
  - æ¸¬è©¦æ™‚æª¢æŸ¥æ•¸æ“šæ˜¯å¦å¯«å…¥æ­£ç¢ºä½ç½®

### 2024-08-16 form.submit vs fetch APIç¶“é©—ç¸½çµ ğŸš€
- **æ ¸å¿ƒç™¼ç¾**ï¼šform.submit()æœƒè§¸ç™¼403éŒ¯èª¤ä½†æ•¸æ“šèƒ½æ­£å¸¸è™•ç†ï¼Œfetch APIç„¡éŒ¯èª¤ä¸”èƒ½ç²å¾—è©³ç´°å›æ‡‰
- **æŠ€è¡“å°æ¯”**ï¼š
  ```javascript
  // form.submit() - æœ‰403éŒ¯èª¤ä½†åŠŸèƒ½æ­£å¸¸
  form.submit() â†’ 403éŒ¯èª¤ + æ•¸æ“šæˆåŠŸå¯«å…¥ + ç„¡è©³ç´°éŒ¯èª¤ä¿¡æ¯
  
  // fetch API - ç„¡éŒ¯èª¤ä¸”æœ‰è©³ç´°å›æ‡‰  
  fetch() â†’ 200æˆåŠŸ + æ•¸æ“šæˆåŠŸå¯«å…¥ + è©³ç´°JSONå›æ‡‰ + éŒ¯èª¤è¨ºæ–·ä¿¡æ¯
  ```
- **æœ€ä½³å¯¦è¸**ï¼š
  1. æ–°åŠŸèƒ½çµ±ä¸€ä½¿ç”¨fetch API
  2. èˆŠåŠŸèƒ½é€æ­¥é·ç§»åˆ°fetch API
  3. ä¿ç•™è©³ç´°çš„console.logèª¿è©¦ä¿¡æ¯
  4. æª¢æŸ¥å¾Œç«¯å›æ‡‰çš„successå­—æ®µ
- **èª¿è©¦ç¶“é©—**ï¼š
  - 403éŒ¯èª¤ä¸ä¸€å®šä»£è¡¨åŠŸèƒ½å¤±æ•—ï¼Œå¯èƒ½åªæ˜¯Google Apps Scriptçš„é‡å®šå‘éŸ¿æ‡‰
  - ä½¿ç”¨fetch APIèƒ½ç²å¾—çœŸæ­£çš„å¾Œç«¯éŒ¯èª¤ä¿¡æ¯
  - console.logæ˜¯è¨ºæ–·å‰å¾Œç«¯é€šä¿¡å•é¡Œçš„æœ€ä½³å·¥å…·



### 2024å¹´8æœˆä½å®¿é‡‘æŠ˜æŠµåŠŸèƒ½é–‹ç™¼ ğŸ†•
- **æ–°å¢åŠŸèƒ½**ï¼šå®Œæ•´çš„ä½å®¿é‡‘æŠ˜æŠµç³»çµ±
- **æŠ€è¡“æŒ‘æˆ°**ï¼š
  1. **CORS å•é¡Œ**ï¼šfetch API è¢«ç€è¦½å™¨ CORS æ”¿ç­–é˜»æ“‹
  2. **æ•¸æ“šæŒä¹…æ€§**ï¼šé¿å…ç³»çµ±é‡è¼‰å¾Œé»æ•¸å¾©åŸ
  3. **é‡‘é¡é©—è­‰**ï¼šç¢ºä¿æŠ˜æŠµé‡‘é¡ä¸è¶…éå¯ç”¨é»æ•¸
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  1. ä½¿ç”¨è¡¨å–®æäº¤ + éš±è— iframe é¿å… CORS
  2. ç«‹å³æ›´æ–°å‰ç«¯æ•¸æ“šï¼Œç§»é™¤è‡ªå‹•é‡è¼‰æ©Ÿåˆ¶
  3. æ·»åŠ å³æ™‚é©—è­‰å’Œæ™ºæ…§å¿«é€Ÿé¸æ“‡æŒ‰éˆ•
  4. ä½¿ç”¨ `update_partner_commission` API ç«¯é»æ›´æ–°é»æ•¸

### API ä¸€è‡´æ€§æ›´æ–°
- **å•é¡Œ**ï¼šéƒ¨åˆ†åŠŸèƒ½å‡ºç¾ 403 Forbidden éŒ¯èª¤
- **åŸå› **ï¼šæ··ç”¨ form.submit() å’Œ fetch() æ–¹å¼
- **è§£æ±º**ï¼šæ¡ç”¨æ··åˆæ¨¡å¼ï¼Œæ ¹æ“šåŠŸèƒ½éœ€æ±‚é¸æ“‡é©ç•¶çš„é€šè¨Šæ–¹å¼

## Google Apps Script å¾Œç«¯æ¶æ§‹

### ä¸»è¦ç«¯é»
- `POST /?action=create_booking` - å‰µå»ºæ–°è¨‚æˆ¿
- `POST /?action=update_booking` - æ›´æ–°è¨‚æˆ¿è³‡æ–™
- `POST /?action=confirm_checkin_completion` - ç¢ºèªå…¥ä½å®Œæˆ
- `POST /?action=create_payout` - å‰µå»ºçµç®—è¨˜éŒ„
- `POST /?action=update_partner_commission` - æ›´æ–°å¤§ä½¿ä½£é‡‘ ğŸ†•
- `GET /?action=get_all_data` - ç²å–æ‰€æœ‰æ•¸æ“š

### Partners è³‡æ–™è¡¨æ¬„ä½ ğŸ†•
- `available_points` - å¯ç”¨ä½å®¿é‡‘é»æ•¸
- `points_used` - å·²ä½¿ç”¨é»æ•¸
- `total_commission_earned` - ç´¯ç©ç¸½ä½£é‡‘

## æ¸¬è©¦èˆ‡é™¤éŒ¯

### å‰ç«¯é™¤éŒ¯å·¥å…·
- **Console æ—¥èªŒ**ï¼šè©³ç´°çš„æ•¸æ“šæµç¨‹è¿½è¹¤
- **æ•¸æ“šè¨ºæ–·**ï¼šè‡ªå‹•åµæ¸¬æ¬„ä½æ˜ å°„å•é¡Œ
- **éŒ¯èª¤è™•ç†**ï¼šå®Œæ•´çš„éŒ¯èª¤æç¤ºå’Œä¿®å¾©å»ºè­°
- **ä½å®¿é‡‘åŠŸèƒ½é™¤éŒ¯**ï¼šæäº¤æ•¸æ“šå’Œæ›´æ–°ç‹€æ…‹çš„è©³ç´°æ—¥èªŒ ğŸ†•

### æ¸¬è©¦æµç¨‹
1. **æ•¸æ“šæ¨™æº–åŒ–æ¸¬è©¦**ï¼šç¢ºèª BookingDataManager æ­£ç¢ºè™•ç†å„ç¨®è¼¸å…¥
2. **API é€šè¨Šæ¸¬è©¦**ï¼šæª¢æŸ¥æ•¸æ“šæŒ‰æ­£ç¢ºé †åºç™¼é€
3. **æ¬„ä½æ˜ å°„æ¸¬è©¦**ï¼šé©—è­‰ Google Sheets å¯«å…¥æ­£ç¢ºä½ç½®
4. **æ•´åˆæ¸¬è©¦**ï¼šå®Œæ•´çš„è¨‚æˆ¿-å…¥ä½-çµç®—æµç¨‹
5. **ä½å®¿é‡‘æŠ˜æŠµæ¸¬è©¦**ï¼šé‡‘é¡é©—è­‰ã€CORS è™•ç†ã€æ•¸æ“šæŒä¹…æ€§ ğŸ†•

## å®‰å…¨æ€§è€ƒé‡

### æ•¸æ“šä¿è­·
- **æ•æ„Ÿè³‡æ–™**ï¼šéŠ€è¡Œå¸³è™Ÿåªå­˜å¾Œ5ç¢¼
- **æ¬Šé™æ§åˆ¶**ï¼šç®¡ç†å¾Œå°è¨ªå•é™åˆ¶
- **è³‡æ–™é©—è­‰**ï¼šå‰å¾Œç«¯é›™é‡é©—è­‰
- **é‡‘é¡é©—è­‰**ï¼šä½å®¿é‡‘æŠ˜æŠµåš´æ ¼é©—è­‰å¯ç”¨é¤˜é¡ ğŸ†•

### API å®‰å…¨
- **CORS é…ç½®**ï¼šé©ç•¶çš„è·¨åŸŸè«‹æ±‚è¨­å®š
- **æ··åˆé€šè¨Š**ï¼šæ ¹æ“šå®‰å…¨éœ€æ±‚é¸æ“‡é€šè¨Šæ–¹å¼ ğŸ†•
- **éŒ¯èª¤è™•ç†**ï¼šé¿å…æ•æ„Ÿè³‡è¨Šæ´©æ¼
- **è¼¸å…¥é©—è­‰**ï¼šé˜²æ­¢æƒ¡æ„æ•¸æ“šæ³¨å…¥

## ç¶­è­·æŒ‡å—

### å¸¸è¦‹å•é¡Œæ’é™¤
1. **æ•¸æ“šéŒ¯ä½**ï¼šæª¢æŸ¥ BOOKING_FIELDS å®šç¾©æ˜¯å¦èˆ‡ Google Sheets ä¸€è‡´
2. **CORS éŒ¯èª¤**ï¼šç¢ºèªä½¿ç”¨è¡¨å–®æäº¤è€Œé fetch() ğŸ†•
3. **æ¬„ä½é©—è­‰å¤±æ•—**ï¼šæª¢æŸ¥å¿…å¡«æ¬„ä½å’Œæ•¸æ“šé¡å‹
4. **ä½å®¿é‡‘é»æ•¸å•é¡Œ**ï¼šæª¢æŸ¥ available_points å’Œ points_used æ¬„ä½ ğŸ†•

### æ·»åŠ æ–°åŠŸèƒ½
1. **å‰ç«¯**ï¼šä½¿ç”¨ BookingDataManager è™•ç†æ•¸æ“š
2. **å¾Œç«¯**ï¼šéµå¾ªæ¨™æº–åŒ– API è¨­è¨ˆæ¨¡å¼
3. **CORS è™•ç†**ï¼šè€ƒæ…®æ˜¯å¦éœ€è¦è¡¨å–®æäº¤æ–¹å¼ ğŸ†•
4. **æ¸¬è©¦**ï¼šç¢ºä¿ä¸å½±éŸ¿ç¾æœ‰æ•¸æ“šçµæ§‹

### ä½å®¿é‡‘åŠŸèƒ½ç¶­è­· ğŸ†•
- **é©—è­‰é‚è¼¯**ï¼šç¢ºä¿é‡‘é¡é©—è­‰å‡½æ•¸æ­£ç¢ºé‹ä½œ
- **UI æ›´æ–°**ï¼šæª¢æŸ¥å¿«é€Ÿé¸æ“‡æŒ‰éˆ•å’Œé©—è­‰æç¤º
- **æ•¸æ“šåŒæ­¥**ï¼šç¢ºèªå‰ç«¯æ›´æ–°èˆ‡å¾Œç«¯ä¸€è‡´
- **è¡¨å–®æäº¤**ï¼šç¶­è­·éš±è— iframe å’Œè¡¨å–®ç”Ÿæˆé‚è¼¯

## éƒ¨ç½²è³‡è¨Š

### GitHub Pages è¨­å®š
- **Repository**: `didi1119/forest-gift-v1`
- **Branch**: `main`
- **Path**: `/` (æ ¹ç›®éŒ„)
- **URL**: `https://didi1119.github.io/forest-gift-v1/`

### ä¸»è¦é é¢
- **ç®¡ç†å¾Œå°**: `/frontend/admin/admin-dashboard-real.html`
- **æ‰‹å‹•è¨‚æˆ¿**: `/frontend/admin/manual-booking.html`
- **å…¥ä½ç¢ºèª**: `/frontend/admin/manual-checkin-confirm.html`

## Google Sheets è³‡æ–™è¡¨çµæ§‹ ğŸ“Š

### Partners è¡¨æ ¼æ¬„ä½ï¼ˆå…± 25 æ¬„ï¼‰
```
id, partner_code, name, email, phone, level, level_progress,
total_successful_referrals, commission_preference, total_commission_earned,
total_commission_paid, pending_commission, coupon_code, coupon_url,
landing_link, coupon_link, short_landing_link, short_coupon_link,
bank_name, bank_code, bank_branch, bank_account_name, bank_account_number,
created_at, updated_at
```

### Bookings è¡¨æ ¼æ¬„ä½ï¼ˆå…± 22 æ¬„ï¼‰
```
id, partner_code, guest_name, guest_phone, guest_email, bank_account_last5,
checkin_date, checkout_date, room_price, booking_source, stay_status,
payment_status, commission_status, commission_amount, commission_type,
is_first_referral_bonus, first_referral_bonus_amount, manually_confirmed_by,
manually_confirmed_at, notes, created_at, updated_at
```

### Payouts è¡¨æ ¼æ¬„ä½ï¼ˆå…± 14 æ¬„ï¼‰
```
id, partner_code, payout_type, amount, related_booking_ids,
payout_method, payout_status, bank_transfer_date, bank_transfer_reference,
accommodation_voucher_code, notes, created_by, created_at, updated_at
```

## è¯çµ¡è³‡è¨Š

- **å°ˆæ¡ˆæ€§è³ª**ï¼šæ£®æ—ä½å®¿æ¨è–¦ç³»çµ±
- **é–‹ç™¼éšæ®µ**ï¼šæŒçºŒè¿­ä»£ä¸­
- **æŠ€è¡“æ”¯æ´**ï¼šClaude AI è¼”åŠ©é–‹ç™¼
- **æœ€æ–°åŠŸèƒ½**ï¼šä½å®¿é‡‘æŠ˜æŠµç³»çµ± ğŸ†•

---

*æœ¬æ–‡ä»¶éš¨å°ˆæ¡ˆæ›´æ–°è€ŒæŒçºŒç¶­è­·ï¼Œæœ€å¾Œæ›´æ–°ï¼š2024å¹´12æœˆ*
- ç´€éŒ„è¡¨å–®çµæ§‹é‚„æœ‰æ¥­å‹™é‚è¼¯
- ã€‚Google Apps Script åœ¨ GitHub Pages ä¸Šç¢ºå¯¦æœƒè¢« CORS æ”¿ç­–é˜»æ“‹ï¼Œæˆ‘éœ€è¦æ”¹å›ä½¿ç”¨ form æäº¤æ–¹å¼ã€‚
- COMMISSION-SYSTEM-ARCHITECTURE.md æ›´æ–°åˆ°claude.md