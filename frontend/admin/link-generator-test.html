<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€£çµç”Ÿæˆå™¨æ¸¬è©¦è¨ºæ–·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ”§ é€£çµç”Ÿæˆå™¨æ¸¬è©¦è¨ºæ–·</h1>
        
        <!-- Test 1: Generate Links -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">æ¸¬è©¦ 1ï¼šç”Ÿæˆé€£çµ</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">å¤§ä½¿ä»£ç¢¼</label>
                    <input type="text" id="testCode" value="TEST123" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">å°ˆå±¬å„ªæƒ åˆ¸é€£çµ</label>
                    <input type="text" id="testCoupon" value="https://lin.ee/SPECIAL123" class="w-full px-3 py-2 border rounded">
                </div>
            </div>
            <button onclick="testGenerateLinks()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                æ¸¬è©¦ç”Ÿæˆé€£çµ
            </button>
            <div id="linkResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 2: Save to Sheets -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">æ¸¬è©¦ 2ï¼šå„²å­˜åˆ° Google Sheets</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">å¤§ä½¿ä»£ç¢¼</label>
                    <input type="text" id="saveCode" value="SAVE_TEST_123" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">å¤§ä½¿å§“å</label>
                    <input type="text" id="saveName" value="æ¸¬è©¦å¤§ä½¿" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">å°ˆå±¬å„ªæƒ åˆ¸é€£çµ</label>
                    <input type="text" id="saveCoupon" value="https://lin.ee/MY_COUPON" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="text" id="saveEmail" value="test@example.com" class="w-full px-3 py-2 border rounded">
                </div>
            </div>
            <button onclick="testSaveToSheets()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                æ¸¬è©¦å„²å­˜
            </button>
            <div id="saveResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 3: Check Backend -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">æ¸¬è©¦ 3ï¼šæª¢æŸ¥å¾Œç«¯ç‹€æ…‹</h2>
            <button onclick="checkBackend()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                æª¢æŸ¥å¾Œç«¯
            </button>
            <div id="backendResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
        
        <!-- Test 4: Direct API Test -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">æ¸¬è©¦ 4ï¼šç›´æ¥ API æ¸¬è©¦</h2>
            <button onclick="directAPITest()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                ç›´æ¥æ¸¬è©¦ API
            </button>
            <div id="apiResult" class="mt-4 p-4 bg-gray-50 rounded font-mono text-sm"></div>
        </div>
    </div>
    
    <iframe name="hiddenFrame" style="display:none;"></iframe>
    
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            const color = isError ? 'text-red-600' : 'text-green-600';
            element.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
        }
        
        // Test 1: Generate Links
        function testGenerateLinks() {
            const code = document.getElementById('testCode').value;
            const couponUrl = document.getElementById('testCoupon').value;
            const resultDiv = document.getElementById('linkResult');
            resultDiv.innerHTML = '';
            
            log('linkResult', 'é–‹å§‹ç”Ÿæˆé€£çµ...');
            
            // Generate URLs
            const landingUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(code)}&dest=landing`;
            const trackedCouponUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(code)}&dest=coupon&target=${encodeURIComponent(couponUrl)}`;
            
            log('linkResult', `ä¸»é é€£çµ: ${landingUrl}`);
            log('linkResult', `å„ªæƒ åˆ¸é€£çµ: ${trackedCouponUrl}`);
            
            // Check if coupon URL is included
            if (trackedCouponUrl.includes(encodeURIComponent(couponUrl))) {
                log('linkResult', 'âœ… å„ªæƒ åˆ¸é€£çµæ­£ç¢ºåŒ…å«å°ˆå±¬é€£çµ');
            } else {
                log('linkResult', 'âŒ å„ªæƒ åˆ¸é€£çµæœªåŒ…å«å°ˆå±¬é€£çµ', true);
            }
        }
        
        // Test 2: Save to Sheets
        async function testSaveToSheets() {
            const resultDiv = document.getElementById('saveResult');
            resultDiv.innerHTML = '';
            
            const partnerData = {
                action: 'create_partner',
                partner_code: document.getElementById('saveCode').value,
                partner_name: document.getElementById('saveName').value,
                contact_email: document.getElementById('saveEmail').value,
                coupon_url: document.getElementById('saveCoupon').value,
                partner_level: 'LV1_INSIDER',
                commission_preference: 'ACCOMMODATION',
                available_points: '0',
                points_used: '0',
                successful_referrals: '0'
            };
            
            log('saveResult', 'æº–å‚™å„²å­˜è³‡æ–™...');
            log('saveResult', `è³‡æ–™: ${JSON.stringify(partnerData, null, 2)}`);
            
            try {
                // Method 1: Form submission
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                Object.keys(partnerData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = partnerData[key];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
                
                log('saveResult', 'è¡¨å–®å·²æäº¤');
                
                setTimeout(() => {
                    document.body.removeChild(form);
                    log('saveResult', 'ç­‰å¾… 3 ç§’å¾Œæª¢æŸ¥çµæœ...');
                    
                    // Check if partner was created
                    fetch(`${APPS_SCRIPT_URL}?action=get_all_data`)
                        .then(res => res.json())
                        .then(data => {
                            if (data && data.data && data.data.partners) {
                                const partner = data.data.partners.find(p => p.partner_code === partnerData.partner_code);
                                if (partner) {
                                    log('saveResult', `âœ… æ‰¾åˆ°å¤§ä½¿: ${partner.partner_code}`);
                                    log('saveResult', `å„ªæƒ åˆ¸é€£çµ: ${partner.coupon_url}`);
                                    if (partner.coupon_url === partnerData.coupon_url) {
                                        log('saveResult', 'âœ… å„ªæƒ åˆ¸é€£çµæ­£ç¢ºå„²å­˜');
                                    } else {
                                        log('saveResult', `âŒ å„ªæƒ åˆ¸é€£çµä¸ç¬¦ - é æœŸ: ${partnerData.coupon_url}, å¯¦éš›: ${partner.coupon_url}`, true);
                                    }
                                } else {
                                    log('saveResult', 'âŒ æ‰¾ä¸åˆ°å¤§ä½¿', true);
                                }
                            }
                        })
                        .catch(err => {
                            log('saveResult', `éŒ¯èª¤: ${err.message}`, true);
                        });
                }, 3000);
                
            } catch (error) {
                log('saveResult', `éŒ¯èª¤: ${error.message}`, true);
            }
        }
        
        // Test 3: Check Backend
        async function checkBackend() {
            const resultDiv = document.getElementById('backendResult');
            resultDiv.innerHTML = '';
            
            log('backendResult', 'æª¢æŸ¥å¾Œç«¯ç‹€æ…‹...');
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const data = await response.json();
                
                if (data.success !== false) {
                    log('backendResult', 'âœ… å¾Œç«¯å›æ‡‰æ­£å¸¸');
                    log('backendResult', `Partners æ•¸é‡: ${data.data.partners?.length || 0}`);
                    log('backendResult', `Bookings æ•¸é‡: ${data.data.bookings?.length || 0}`);
                    
                    // Check if Partners table has coupon_url field
                    if (data.data.partners && data.data.partners.length > 0) {
                        const firstPartner = data.data.partners[0];
                        if ('coupon_url' in firstPartner) {
                            log('backendResult', 'âœ… Partners è¡¨æ ¼æœ‰ coupon_url æ¬„ä½');
                        } else {
                            log('backendResult', 'âŒ Partners è¡¨æ ¼ç¼ºå°‘ coupon_url æ¬„ä½', true);
                            log('backendResult', `å¯ç”¨æ¬„ä½: ${Object.keys(firstPartner).join(', ')}`);
                        }
                    }
                } else {
                    log('backendResult', `âŒ å¾Œç«¯éŒ¯èª¤: ${data.error}`, true);
                }
            } catch (error) {
                log('backendResult', `âŒ ç„¡æ³•é€£æ¥å¾Œç«¯: ${error.message}`, true);
            }
        }
        
        // Test 4: Direct API Test
        async function directAPITest() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '';
            
            const testData = {
                action: 'create_partner',
                partner_code: 'API_TEST_' + Date.now(),
                partner_name: 'APIæ¸¬è©¦å¤§ä½¿',
                contact_email: 'api@test.com',
                coupon_url: 'https://lin.ee/API_TEST_COUPON',
                partner_level: 'LV1_INSIDER',
                available_points: '1000'
            };
            
            log('apiResult', 'æ¸¬è©¦ç›´æ¥ API å‘¼å«...');
            log('apiResult', `æ¸¬è©¦è³‡æ–™: ${JSON.stringify(testData, null, 2)}`);
            
            try {
                // Try fetch first
                log('apiResult', 'å˜—è©¦ fetch API...');
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(testData).toString()
                });
                
                const result = await response.text();
                log('apiResult', `å›æ‡‰: ${result}`);
                
                // Parse if JSON
                try {
                    const json = JSON.parse(result);
                    if (json.success) {
                        log('apiResult', 'âœ… API å‘¼å«æˆåŠŸ');
                    } else {
                        log('apiResult', `âŒ API éŒ¯èª¤: ${json.error}`, true);
                    }
                } catch (e) {
                    log('apiResult', 'å›æ‡‰ä¸æ˜¯ JSON æ ¼å¼');
                }
                
            } catch (error) {
                log('apiResult', `âŒ Fetch å¤±æ•—: ${error.message}`, true);
                log('apiResult', 'å¯èƒ½æ˜¯ CORS å•é¡Œï¼Œé€™æ˜¯æ­£å¸¸çš„');
            }
        }
        
        // Auto-run checks on load
        window.addEventListener('load', () => {
            console.log('é€£çµç”Ÿæˆå™¨æ¸¬è©¦è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
            console.log('APPS_SCRIPT_URL:', APPS_SCRIPT_URL);
        });
    </script>
</body>
</html>