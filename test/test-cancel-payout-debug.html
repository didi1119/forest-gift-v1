<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–æ¶ˆçµç®—é™¤éŒ¯æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">ğŸ”§ å–æ¶ˆçµç®—é™¤éŒ¯æ¸¬è©¦</h1>
        
        <!-- æ­¥é©Ÿ 1: å‰µå»ºæ¸¬è©¦å¤¥ä¼´ -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-bold mb-4">æ­¥é©Ÿ 1: å‰µå»ºæ¸¬è©¦å¤¥ä¼´</h2>
            <button onclick="createTestPartner()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                å‰µå»ºæ¸¬è©¦å¤¥ä¼´ TEST_DEBUG_001
            </button>
            <div id="step1Result" class="mt-4 p-3 bg-gray-50 rounded text-sm"></div>
        </div>

        <!-- æ­¥é©Ÿ 2: å‰µå»ºæ¸¬è©¦ Payout -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-bold mb-4">æ­¥é©Ÿ 2: å‰µå»ºæ¸¬è©¦ Payout</h2>
            <button onclick="createTestPayout()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                å‰µå»ºä½å®¿é‡‘ Payout (2000é»)
            </button>
            <div id="step2Result" class="mt-4 p-3 bg-gray-50 rounded text-sm"></div>
        </div>

        <!-- æ­¥é©Ÿ 3: å–æ¶ˆ Payout -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-bold mb-4">æ­¥é©Ÿ 3: å–æ¶ˆ Payout</h2>
            <input type="text" id="payoutIdInput" placeholder="è¼¸å…¥ Payout ID" class="border rounded px-3 py-2 mr-2">
            <button onclick="cancelPayout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                å–æ¶ˆ Payout
            </button>
            <div id="step3Result" class="mt-4 p-3 bg-gray-50 rounded text-sm"></div>
        </div>

        <!-- æ­¥é©Ÿ 4: é©—è­‰çµæœ -->
        <div class="bg-white rounded-lg shadow p-6 mb-4">
            <h2 class="text-lg font-bold mb-4">æ­¥é©Ÿ 4: é©—è­‰çµæœ</h2>
            <button onclick="verifyResults()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                é©—è­‰æ•¸æ“šè®ŠåŒ–
            </button>
            <div id="step4Result" class="mt-4 p-3 bg-gray-50 rounded text-sm"></div>
        </div>

        <!-- èª¿è©¦æ—¥èªŒ -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-6">
            <h3 class="text-white font-bold mb-4">èª¿è©¦æ—¥èªŒ</h3>
            <div id="debugLog" class="font-mono text-xs h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        let testPartnerId = null;
        let testPayoutId = null;
        let beforeData = null;
        let afterData = null;

        // å‰µå»ºæ¸¬è©¦å¤¥ä¼´
        async function createTestPartner() {
            log('å‰µå»ºæ¸¬è©¦å¤¥ä¼´...', 'info');
            
            try {
                // å…ˆæª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const checkResponse = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const checkData = await checkResponse.json();
                
                const existingPartner = checkData.data.partners.find(p => p.partner_code === 'TEST_DEBUG_001');
                
                if (existingPartner) {
                    log('å¤¥ä¼´å·²å­˜åœ¨ï¼Œä½¿ç”¨ç¾æœ‰è³‡æ–™', 'warning');
                    testPartnerId = existingPartner.partner_code;
                    document.getElementById('step1Result').innerHTML = `
                        <div class="text-green-600">âœ… ä½¿ç”¨ç¾æœ‰å¤¥ä¼´</div>
                        <div>ä»£ç¢¼: ${existingPartner.partner_code}</div>
                        <div>å¯ç”¨é»æ•¸: ${existingPartner.available_points}</div>
                        <div>å·²ä½¿ç”¨é»æ•¸: ${existingPartner.points_used}</div>
                        <div>ç¸½ä½£é‡‘: ${existingPartner.total_commission_earned}</div>
                    `;
                    return;
                }
                
                // å‰µå»ºæ–°å¤¥ä¼´
                const params = new URLSearchParams({
                    action: 'create_partner',
                    partner_code: 'TEST_DEBUG_001',
                    partner_name: 'é™¤éŒ¯æ¸¬è©¦å¤¥ä¼´',
                    partner_level: 'LV2_GUIDE',
                    available_points: 5000,
                    points_used: 1000,
                    total_commission_earned: 6000,
                    pending_commission: 0,
                    contact_phone: '0900000001',
                    commission_preference: 'ACCOMMODATION'
                });
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                
                const result = await response.json();
                log('å‰µå»ºå¤¥ä¼´å›æ‡‰: ' + JSON.stringify(result), 'debug');
                
                if (result.success) {
                    testPartnerId = 'TEST_DEBUG_001';
                    document.getElementById('step1Result').innerHTML = `
                        <div class="text-green-600">âœ… å‰µå»ºæˆåŠŸ</div>
                        <div>ä»£ç¢¼: TEST_DEBUG_001</div>
                        <div>åˆå§‹é»æ•¸: 5000</div>
                    `;
                } else {
                    throw new Error(result.error || 'å‰µå»ºå¤±æ•—');
                }
                
            } catch (error) {
                log('å‰µå»ºå¤¥ä¼´å¤±æ•—: ' + error.message, 'error');
                document.getElementById('step1Result').innerHTML = `
                    <div class="text-red-600">âŒ ${error.message}</div>
                `;
            }
        }

        // å‰µå»ºæ¸¬è©¦ Payout
        async function createTestPayout() {
            log('å‰µå»ºæ¸¬è©¦ Payout...', 'info');
            
            if (!testPartnerId) {
                alert('è«‹å…ˆå‰µå»ºæ¸¬è©¦å¤¥ä¼´');
                return;
            }
            
            try {
                const params = new URLSearchParams({
                    action: 'create_payout',
                    partner_code: 'TEST_DEBUG_001',
                    payout_type: 'ACCOMMODATION',
                    amount: 2000,
                    payout_status: 'PENDING',
                    notes: 'é™¤éŒ¯æ¸¬è©¦ç”¨ Payout'
                });
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                
                const result = await response.json();
                log('å‰µå»º Payout å›æ‡‰: ' + JSON.stringify(result), 'debug');
                
                if (result.success) {
                    testPayoutId = result.data.id || result.data.ID;
                    document.getElementById('payoutIdInput').value = testPayoutId;
                    document.getElementById('step2Result').innerHTML = `
                        <div class="text-green-600">âœ… å‰µå»ºæˆåŠŸ</div>
                        <div>Payout ID: ${testPayoutId}</div>
                        <div>é¡å‹: ACCOMMODATION</div>
                        <div>é‡‘é¡: 2000 é»</div>
                    `;
                    
                    // è¨˜éŒ„å–æ¶ˆå‰çš„ç‹€æ…‹
                    await getPartnerData('before');
                    
                } else {
                    throw new Error(result.error || 'å‰µå»ºå¤±æ•—');
                }
                
            } catch (error) {
                log('å‰µå»º Payout å¤±æ•—: ' + error.message, 'error');
                document.getElementById('step2Result').innerHTML = `
                    <div class="text-red-600">âŒ ${error.message}</div>
                `;
            }
        }

        // å–æ¶ˆ Payout
        async function cancelPayout() {
            const payoutId = document.getElementById('payoutIdInput').value;
            if (!payoutId) {
                alert('è«‹è¼¸å…¥ Payout ID');
                return;
            }
            
            log(`é–‹å§‹å–æ¶ˆ Payout: ${payoutId}`, 'info');
            
            try {
                // ä½¿ç”¨ fetch API ç›´æ¥èª¿ç”¨
                const params = new URLSearchParams({
                    action: 'cancel_payout',
                    payout_id: payoutId
                });
                
                log('ç™¼é€è«‹æ±‚: ' + params.toString(), 'debug');
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                
                const responseText = await response.text();
                log('åŸå§‹å›æ‡‰: ' + responseText, 'debug');
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    log('å›æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ JSON: ' + responseText, 'error');
                    throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
                }
                
                log('å–æ¶ˆ Payout å›æ‡‰: ' + JSON.stringify(result), 'debug');
                
                if (result.success) {
                    document.getElementById('step3Result').innerHTML = `
                        <div class="text-green-600">âœ… å–æ¶ˆæˆåŠŸ</div>
                        <div>${result.message}</div>
                    `;
                    
                    // è¨˜éŒ„å–æ¶ˆå¾Œçš„ç‹€æ…‹
                    await getPartnerData('after');
                    
                } else {
                    throw new Error(result.error || 'å–æ¶ˆå¤±æ•—');
                }
                
            } catch (error) {
                log('å–æ¶ˆ Payout å¤±æ•—: ' + error.message, 'error');
                document.getElementById('step3Result').innerHTML = `
                    <div class="text-red-600">âŒ ${error.message}</div>
                `;
            }
        }

        // ç²å–å¤¥ä¼´æ•¸æ“š
        async function getPartnerData(timing) {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const data = await response.json();
                
                const partner = data.data.partners.find(p => p.partner_code === 'TEST_DEBUG_001');
                const payouts = data.data.payouts.filter(p => p.partner_code === 'TEST_DEBUG_001');
                
                if (timing === 'before') {
                    beforeData = { partner, payouts };
                    log(`å–æ¶ˆå‰æ•¸æ“š: é»æ•¸=${partner.available_points}, ç¸½ä½£é‡‘=${partner.total_commission_earned}`, 'info');
                } else {
                    afterData = { partner, payouts };
                    log(`å–æ¶ˆå¾Œæ•¸æ“š: é»æ•¸=${partner.available_points}, ç¸½ä½£é‡‘=${partner.total_commission_earned}`, 'info');
                }
                
            } catch (error) {
                log(`ç²å–æ•¸æ“šå¤±æ•— (${timing}): ${error.message}`, 'error');
            }
        }

        // é©—è­‰çµæœ
        async function verifyResults() {
            log('é–‹å§‹é©—è­‰çµæœ...', 'info');
            
            if (!beforeData || !afterData) {
                alert('è«‹å…ˆåŸ·è¡Œå–æ¶ˆæ“ä½œ');
                return;
            }
            
            const before = beforeData.partner;
            const after = afterData.partner;
            
            const changes = {
                available_points: after.available_points - before.available_points,
                total_commission_earned: after.total_commission_earned - before.total_commission_earned,
                points_used: after.points_used - before.points_used
            };
            
            const validations = [];
            
            // é©—è­‰é»æ•¸æ‡‰è©²æ¸›å°‘ 2000
            if (changes.available_points === -2000) {
                validations.push('âœ… é»æ•¸æ­£ç¢ºæ¸›å°‘ 2000');
            } else {
                validations.push(`âŒ é»æ•¸è®ŠåŒ–éŒ¯èª¤: ${changes.available_points} (é æœŸ -2000)`);
            }
            
            // é©—è­‰ç¸½ä½£é‡‘æ‡‰è©²æ¸›å°‘ 2000
            if (changes.total_commission_earned === -2000) {
                validations.push('âœ… ç¸½ä½£é‡‘æ­£ç¢ºæ¸›å°‘ 2000');
            } else {
                validations.push(`âŒ ç¸½ä½£é‡‘è®ŠåŒ–éŒ¯èª¤: ${changes.total_commission_earned} (é æœŸ -2000)`);
            }
            
            // æª¢æŸ¥ Payout ç‹€æ…‹
            const cancelledPayout = afterData.payouts.find(p => 
                (p.id == testPayoutId || p.ID == testPayoutId) && p.payout_status === 'CANCELLED'
            );
            
            if (cancelledPayout) {
                validations.push('âœ… Payout ç‹€æ…‹å·²æ›´æ–°ç‚º CANCELLED');
            } else {
                validations.push('âŒ Payout ç‹€æ…‹æœªæ­£ç¢ºæ›´æ–°');
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ’¤éŠ·è¨˜éŒ„
            const reversalPayout = afterData.payouts.find(p => 
                p.payout_type === 'COMMISSION_REVERSAL' && p.amount == -2000
            );
            
            if (reversalPayout) {
                validations.push('âœ… å·²å‰µå»ºæ’¤éŠ·è¨˜éŒ„');
            } else {
                validations.push('âŒ æœªæ‰¾åˆ°æ’¤éŠ·è¨˜éŒ„');
            }
            
            document.getElementById('step4Result').innerHTML = `
                <div class="space-y-2">
                    <div class="font-bold">æ•¸æ“šè®ŠåŒ–ï¼š</div>
                    <div>é»æ•¸: ${before.available_points} â†’ ${after.available_points} (${changes.available_points > 0 ? '+' : ''}${changes.available_points})</div>
                    <div>ç¸½ä½£é‡‘: ${before.total_commission_earned} â†’ ${after.total_commission_earned} (${changes.total_commission_earned > 0 ? '+' : ''}${changes.total_commission_earned})</div>
                    <div class="mt-3 font-bold">é©—è­‰çµæœï¼š</div>
                    ${validations.map(v => `<div>${v}</div>`).join('')}
                </div>
            `;
            
            const allPassed = validations.every(v => v.startsWith('âœ…'));
            log(allPassed ? 'æ‰€æœ‰é©—è­‰é€šéï¼' : 'éƒ¨åˆ†é©—è­‰å¤±æ•—', allPassed ? 'success' : 'error');
        }

        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logEl = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-gray-400',
                'debug': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || 'text-gray-400';
            div.textContent = `[${time}] ${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é™¤éŒ¯æ¸¬è©¦å·¥å…·å°±ç·’', 'success');
            log('è«‹æŒ‰é †åºåŸ·è¡Œæ­¥é©Ÿ 1-4', 'info');
        });
    </script>
</body>
</html>