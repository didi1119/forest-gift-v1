<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- é˜²æ­¢ç€è¦½å™¨å¿«å– -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>çŸ¥éŸ³å¤§ä½¿ç®¡ç†å¾Œå° - çœŸå¯¦æ•¸æ“šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // æŠ‘åˆ¶ Tailwind CSS ç”Ÿç”¢ç’°å¢ƒè­¦å‘Š
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                mode: 'jit'
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFBF8;
            color: #5C544B;
        }
        h1, h2, h3, .font-serif {
            font-family: 'Noto Serif TC', serif;
        }
        .brand-accent {
            color: #2E4B36;
        }
        .brand-card {
            background-color: #FFFFFF;
            border: 1px solid #EAE6E1;
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: #6B7280;
            background-color: #F9FAFB;
            border: 1px solid #E5E7EB;
            transition: all 0.2s;
        }
        .tab-button:hover {
            background-color: #F3F4F6;
        }
        .tab-button.active {
            background-color: #2E4B36;
            color: #FFFFFF;
            border-color: #2E4B36;
        }
        .tab-content {
            display: block;
        }
        .tab-content.hidden {
            display: none;
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2E4B36;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ–°ç‰ˆè¯ç›Ÿå¤¥ä¼´åˆ—è¡¨æ¨£å¼ */
        .kpi-item {
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 4.5rem;
        }

        @media (min-width: 1024px) {
            .kpi-divider:not(:last-child) {
                border-right: 1px solid #F3F4F6;
            }
        }
        
        @media (max-width: 1023px) {
            .kpi-divider {
                border-bottom: 1px solid #F3F4F6;
                padding-bottom: 1rem;
            }
            .kpi-divider:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body class="antialiased min-h-screen py-12">
    <div class="max-w-7xl mx-auto px-6">
        <!-- 403 éŒ¯èª¤æç¤ºå€åŸŸ -->
        <div id="script-error-banner" class="hidden mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="text-red-400 text-2xl">âš ï¸</div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-lg font-medium text-red-800">Google Apps Script é€£ç·šå•é¡Œ</h3>
                    <p class="mt-1 text-sm text-red-700">
                        åµæ¸¬åˆ° 403 æ¬Šé™éŒ¯èª¤ï¼Œç¢ºèªå…¥ä½å’Œç·¨è¼¯åŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œã€‚
                    </p>
                    <div class="mt-3 flex space-x-3">
                        <button onclick="window.open('./google-apps-script-fix.html', '_blank')" 
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-red-800 bg-red-100 border border-red-300 rounded-md hover:bg-red-200">
                            ğŸ”§ ä¿®å¾©æŒ‡å—
                        </button>
                        <button onclick="hideErrorBanner()" 
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-red-600 bg-white border border-red-300 rounded-md hover:bg-red-50">
                            éš±è—æç¤º
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold brand-accent mb-4">çŸ¥éŸ³å¤§ä½¿ç®¡ç†å¾Œå°</h1>
            <p class="text-lg text-stone-600">å³æ™‚ç›£æ§æ‰€æœ‰çŸ¥éŸ³å¤§ä½¿çš„æ¨å»£æˆæ•ˆ</p>
            <div class="bg-green-50 p-3 rounded-lg mt-4">
                <p class="text-green-800 text-sm">ğŸ”„ é€£æ¥çœŸå¯¦ Google Sheets æ•¸æ“š</p>
            </div>
        </header>

        <!-- çµ±è¨ˆæ¦‚è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold brand-accent" id="totalPartners">
                    <div class="loading-spinner"></div>
                </div>
                <div class="text-sm text-stone-600 mt-1">ç¸½å¤¥ä¼´æ•¸</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="totalClicks">
                    <div class="loading-spinner"></div>
                </div>
                <div class="text-sm text-stone-600 mt-1">ç¸½é»æ“Šæ•¸</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="totalStayCompleted">
                    <div class="loading-spinner"></div>
                </div>
                <div class="text-sm text-stone-600 mt-1">å®Œæˆå…¥ä½æ•¸</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="stayCompletionRate">
                    <div class="loading-spinner"></div>
                </div>
                <div class="text-sm text-stone-600 mt-1">å…¥ä½å®Œæˆç‡</div>
            </div>
            <div class="brand-card p-6 text-center">
                <div class="text-3xl font-bold text-amber-600" id="totalPayouts">
                    <div class="loading-spinner"></div>
                </div>
                <div class="text-sm text-stone-600 mt-1">å¾…æ”¯ä»˜ç¾é‡‘ç¸½é¡</div>
            </div>
        </div>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="flex space-x-6 mb-8">
            <button onclick="showTab('overview')" id="tab-overview" class="tab-button active">
                ğŸ“Š æ¦‚è¦½å„€è¡¨
            </button>
            <button onclick="showTab('bookings')" id="tab-bookings" class="tab-button">
                ğŸ“‹ è¨‚å–®ç®¡ç†
            </button>
            <button onclick="showTab('payouts')" id="tab-payouts" class="tab-button">
                ğŸ’° çµç®—ç®¡ç†
            </button>
            <button onclick="showTab('analytics')" id="tab-analytics" class="tab-button">
                ğŸ“ˆ æ•¸æ“šåˆ†æ
            </button>
            <button onclick="showTab('linkgen')" id="tab-linkgen" class="tab-button">
                ğŸ”— é€£çµç”Ÿæˆå™¨
            </button>
        </div>

        <!-- æ¦‚è¦½å„€è¡¨æ¨™ç±¤å…§å®¹ -->
        <div id="content-overview" class="tab-content">
            <!-- è¯ç›Ÿå¤¥ä¼´åˆ—è¡¨ -->
            <div class="brand-card p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-2xl font-semibold brand-accent">è¯ç›Ÿå¤¥ä¼´åˆ—è¡¨</h2>
                    <div class="flex space-x-4">
                        <button onclick="exportPartnersData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            ğŸ“¥ åŒ¯å‡ºæ•¸æ“š
                        </button>
                        <button onclick="refreshData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ğŸ”„ é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                </div>

                <!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
                <div id="batchToolbar" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <div class="selection-info">
                            å·²é¸æ“‡ <span id="selectedCount" class="font-bold text-blue-600">0</span> ä½å¤¥ä¼´
                        </div>
                        <div class="flex space-x-3">
                            <select id="batchOperation" class="px-3 py-2 border rounded-lg">
                                <option value="">é¸æ“‡æ‰¹é‡æ“ä½œ...</option>
                                <option value="convert_all">å…¨éƒ¨è½‰ç‚ºç¾é‡‘</option>
                                <option value="payout_pending">çµç®—å¾…ä»˜ç¾é‡‘</option>
                                <option value="export_selected">åŒ¯å‡ºé¸ä¸­è³‡æ–™</option>
                            </select>
                            <button onclick="executeBatchAction()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">åŸ·è¡Œ</button>
                            <button onclick="clearSelection()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">å–æ¶ˆé¸æ“‡</button>
                        </div>
                    </div>
                </div>

                <!-- å¡ç‰‡å¼å¤¥ä¼´åˆ—è¡¨ -->
                <div id="partnersContainer" class="space-y-4">
                    <div class="text-center py-12 text-stone-500">
                        <div class="loading-spinner"></div>
                        <p class="mt-4">è¼‰å…¥å¤¥ä¼´è³‡æ–™ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»å‹• -->
            <div class="brand-card p-8 mt-8">
                <h3 class="font-serif text-xl font-semibold brand-accent mb-4">æœ€è¿‘æ´»å‹•è¨˜éŒ„</h3>
                <div id="recentActivity" class="space-y-2">
                    <div class="text-center py-4 text-stone-500">
                        <div class="loading-spinner"></div> è¼‰å…¥ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨‚å–®ç®¡ç†æ¨™ç±¤å…§å®¹ -->
        <div id="content-bookings" class="tab-content hidden">
            <div class="brand-card p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-2xl font-semibold brand-accent">è¨‚å–®ç®¡ç†</h2>
                    <div class="flex space-x-4">
                        <button onclick="openManualBookingModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            â• æ‰‹å‹•ç™»è¨˜è¨‚æˆ¿
                        </button>
                        <a href="manual-checkin-confirm.html" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            âœ… ç¢ºèªå…¥ä½å®Œæˆ
                        </a>
                    </div>
                </div>

                <!-- ç¯©é¸å™¨ -->
                <div class="flex gap-4 mb-6">
                    <select id="bookingStatusFilter" class="p-2 border rounded" onchange="filterBookings()">
                        <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="PENDING">å¾…å…¥ä½</option>
                        <option value="CHECKED_IN">å·²å…¥ä½</option>
                        <option value="COMPLETED">å·²å®Œæˆ</option>
                        <option value="CANCELLED">å·²å–æ¶ˆ</option>
                    </select>
                    <input type="text" id="searchBooking" placeholder="æœå°‹æˆ¿å®¢æˆ–å¤§ä½¿ä»£ç¢¼" class="p-2 border rounded flex-1" onkeyup="filterBookings()">
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">æˆ¿å®¢è³‡è¨Š</th>
                                <th class="text-left py-3 px-4">æ¨è–¦å¤§ä½¿</th>
                                <th class="text-left py-3 px-4">å…¥ä½æœŸé–“</th>
                                <th class="text-center py-3 px-4">é‡‘é¡</th>
                                <th class="text-center py-3 px-4">å¸³è™Ÿæœ«äº”ç¢¼</th>
                                <th class="text-center py-3 px-4">ç‹€æ…‹</th>
                                <th class="text-center py-3 px-4">ä½£é‡‘</th>
                                <th class="text-center py-3 px-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-stone-500">
                                    <div class="loading-spinner"></div> è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- çµç®—ç®¡ç†æ¨™ç±¤å…§å®¹ -->
        <div id="content-payouts" class="tab-content hidden">
            <div class="brand-card p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-2xl font-semibold brand-accent">çµç®—ç®¡ç†</h2>
                    <div class="flex space-x-3">
                        <button onclick="diagnoseSheetFields()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            ğŸ”§ è¨ºæ–·æ¬„ä½å•é¡Œ
                        </button>
                        <button onclick="diagnosePayout()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                            ğŸ”§ è¨ºæ–·çµç®—å•é¡Œ
                        </button>
                        <button onclick="generatePayoutReport()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            ğŸ“Š ç”Ÿæˆçµç®—å ±è¡¨
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4">å¤§ä½¿è³‡è¨Š</th>
                                <th class="text-center py-3 px-4">é¡å‹</th>
                                <th class="text-center py-3 px-4">é‡‘é¡</th>
                                <th class="text-left py-3 px-4">ç›¸é—œè¨‚æˆ¿</th>
                                <th class="text-left py-3 px-4">ä¾†æº</th>
                                <th class="text-left py-3 px-4">å»ºç«‹æ™‚é–“</th>
                                <th class="text-center py-3 px-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="payoutsTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-stone-500">
                                    <div class="loading-spinner"></div> è¼‰å…¥ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ•¸æ“šåˆ†ææ¨™ç±¤å…§å®¹ -->
        <div id="content-analytics" class="tab-content hidden">
            <div class="space-y-8">
                
                <!-- æ ¸å¿ƒæŒ‡æ¨™æ¦‚è¦½ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="brand-card p-6 text-center">
                        <div class="text-3xl font-bold text-green-600" id="totalConversionRate">-</div>
                        <div class="text-sm text-stone-600 mt-1">æ•´é«”è½‰æ›ç‡</div>
                        <div class="text-xs text-stone-500 mt-1">é»æ“Šâ†’å…¥ä½å®Œæˆ</div>
                    </div>
                    <div class="brand-card p-6 text-center">
                        <div class="text-3xl font-bold text-blue-600" id="avgCommissionPerBooking">-</div>
                        <div class="text-sm text-stone-600 mt-1">å¹³å‡ä½£é‡‘</div>
                        <div class="text-xs text-stone-500 mt-1">æ¯ç­†å®Œæˆè¨‚æˆ¿</div>
                    </div>
                    <div class="brand-card p-6 text-center">
                        <div class="text-3xl font-bold text-purple-600" id="topAmbassadorConversion">-</div>
                        <div class="text-sm text-stone-600 mt-1">æœ€ä½³å¤§ä½¿è½‰æ›ç‡</div>
                        <div class="text-xs text-stone-500 mt-1" id="topAmbassadorName">-</div>
                    </div>
                    <div class="brand-card p-6 text-center">
                        <div class="text-3xl font-bold text-amber-600" id="mostPopularGift">-</div>
                        <div class="text-sm text-stone-600 mt-1">æœ€å—æ­¡è¿ç¦®ç‰©</div>
                        <div class="text-xs text-stone-500 mt-1">ç¦®ç‰©é»æ“Šçµ±è¨ˆ</div>
                    </div>
                </div>

                <!-- å¤§ä½¿è¡¨ç¾åˆ†æ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- å¤§ä½¿ç¸¾æ•ˆæ’è¡Œ -->
                    <div class="brand-card p-8">
                        <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">å¤§ä½¿ç¸¾æ•ˆæ’è¡Œ</h2>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="ambassadorPerformanceChart"></canvas>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between text-sm text-stone-600 mb-2">
                                <span>æ’åºæ–¹å¼ï¼š</span>
                                <select id="performanceSort" onchange="updateAmbassadorChart()" class="text-xs border rounded px-2 py-1">
                                    <option value="conversion">è½‰æ›ç‡</option>
                                    <option value="clicks">é»æ“Šæ•¸</option>
                                    <option value="commission">ä½£é‡‘ç¸½é¡</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- å¤§ä½¿ç­‰ç´šåˆ†ä½ˆ -->
                    <div class="brand-card p-8">
                        <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">å¤§ä½¿ç­‰ç´šåˆ†ä½ˆ</h2>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="levelDistributionChart"></canvas>
                        </div>
                        <div class="mt-4 space-y-2">
                            <div class="flex justify-between">
                                <span class="text-sm flex items-center">
                                    <span class="w-3 h-3 bg-green-500 rounded mr-2"></span>
                                    LV1 çŸ¥éŸ³å¤§ä½¿
                                </span>
                                <span class="text-sm font-semibold" id="lv1Count">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm flex items-center">
                                    <span class="w-3 h-3 bg-blue-500 rounded mr-2"></span>
                                    LV2 æ£®æ—åš®å°
                                </span>
                                <span class="text-sm font-semibold" id="lv2Count">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm flex items-center">
                                    <span class="w-3 h-3 bg-purple-500 rounded mr-2"></span>
                                    LV3 ç§˜å¢ƒå®ˆè­·è€…
                                </span>
                                <span class="text-sm font-semibold" id="lv3Count">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ£®æ—ç¦®ç‰©é»æ“Šåˆ†æ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ç¦®ç‰©é»æ“Šçµ±è¨ˆ -->
                    <div class="brand-card p-8">
                        <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">æ£®æ—ç¦®ç‰©é»æ“Šçµ±è¨ˆ</h2>
                        <div class="chart-container" style="position: relative; height: 300px;">
                            <canvas id="giftClickChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <div class="text-sm text-stone-600">
                                ç¸½é»æ“Šæ¬¡æ•¸ï¼š<span id="totalGiftClicks" class="font-semibold">-</span>
                            </div>
                            <div class="text-xs text-stone-500 mt-1">
                                ä¾†è‡ª index.html çš„å››å€‹ç¦®ç‰©
                            </div>
                        </div>
                    </div>

                    <!-- ç†±é–€ç¦®ç‰©æ’è¡Œ -->
                    <div class="brand-card p-8">
                        <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">ç†±é–€ç¦®ç‰©æ’è¡Œ</h2>
                        <div id="popularGiftsRanking" class="space-y-3">
                            <div class="text-center py-8 text-stone-500">
                                <div class="text-lg font-semibold text-blue-800 mb-2">ğŸš§ é–‹ç™¼ä¸­</div>
                                <p class="text-sm text-blue-600 mb-4">æ­¤åŠŸèƒ½å°‡è¿½è¹¤ index.html ä¸­å››å€‹ç¦®ç‰©çš„ä½¿ç”¨è€…é»æ“Šåå¥½</p>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div class="bg-blue-50 p-2 rounded">ğŸµ è²éŸ³çš„é¢¨æ™¯</div>
                                    <div class="bg-green-50 p-2 rounded">ğŸ“– æ–‡å­—çš„ç¾…ç›¤</div>
                                    <div class="bg-purple-50 p-2 rounded">ğŸ”® æ£®æ—çš„æŒ‡å¼•</div>
                                    <div class="bg-amber-50 p-2 rounded">ğŸ“š ç¨å®¶çš„æ•…äº‹</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-stone-600 bg-blue-50 p-3 rounded-lg">
                            ğŸ’¡ æœªä¾†åŠŸèƒ½ï¼šåˆ†æç”¨æˆ¶å°ä¸åŒç¦®ç‰©çš„åå¥½ï¼Œä½œç‚ºå…§å®¹å„ªåŒ–ä¾æ“š
                        </div>
                    </div>
                </div>

                <!-- è½‰æ›æ¼æ–—åˆ†æ -->
                <div class="brand-card p-8">
                    <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">è½‰æ›æ¼æ–—åˆ†æ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="bg-blue-100 rounded-lg p-6 mb-3">
                                <div class="text-3xl font-bold text-blue-600" id="funnelClicks">-</div>
                                <div class="text-sm text-blue-700">é»æ“Šé€£çµ</div>
                            </div>
                            <div class="text-xs text-stone-500">100%</div>
                        </div>
                        <div class="text-center">
                            <div class="bg-green-100 rounded-lg p-6 mb-3">
                                <div class="text-3xl font-bold text-green-600" id="funnelBookings">-</div>
                                <div class="text-sm text-green-700">å®Œæˆè¨‚æˆ¿</div>
                            </div>
                            <div class="text-xs text-stone-500" id="bookingConversionRate">-%</div>
                        </div>
                        <div class="text-center">
                            <div class="bg-purple-100 rounded-lg p-6 mb-3">
                                <div class="text-3xl font-bold text-purple-600" id="funnelCheckedIn">-</div>
                                <div class="text-sm text-purple-700">å¯¦éš›å…¥ä½</div>
                            </div>
                            <div class="text-xs text-stone-500" id="checkinConversionRate">-%</div>
                        </div>
                        <div class="text-center">
                            <div class="bg-amber-100 rounded-lg p-6 mb-3">
                                <div class="text-3xl font-bold text-amber-600" id="funnelCompleted">-</div>
                                <div class="text-sm text-amber-700">å®Œæˆå…¥ä½</div>
                            </div>
                            <div class="text-xs text-stone-500" id="completionConversionRate">-%</div>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°æ•¸æ“šè¡¨æ ¼ -->
                <div class="brand-card p-8">
                    <h2 class="font-serif text-2xl font-semibold brand-accent mb-6">è©³ç´°æ•¸æ“šåˆ†æ</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-4">å¤§ä½¿ä»£ç¢¼</th>
                                    <th class="text-center py-3 px-4">ç­‰ç´š</th>
                                    <th class="text-center py-3 px-4">é»æ“Šæ•¸</th>
                                    <th class="text-center py-3 px-4">è¨‚æˆ¿æ•¸</th>
                                    <th class="text-center py-3 px-4">å®Œæˆæ•¸</th>
                                    <th class="text-center py-3 px-4">è½‰æ›ç‡</th>
                                    <th class="text-center py-3 px-4">ç´¯ç©ä½£é‡‘</th>
                                    <th class="text-center py-3 px-4">å¹³å‡å®¢å–®åƒ¹</th>
                                </tr>
                            </thead>
                            <tbody id="detailedAnalyticsTable">
                                <tr>
                                    <td colspan="8" class="text-center py-8 text-stone-500">è¼‰å…¥ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿé€£çµ -->
                <div class="brand-card p-6">
                    <div class="flex justify-center space-x-4">
                        <a href="resources.html" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ğŸŒ² è³‡æºä¸­å¿ƒ
                        </a>
                        <button onclick="exportAnalyticsReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            ğŸ“Š åŒ¯å‡ºåˆ†æå ±è¡¨
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€£çµç”Ÿæˆå™¨æ¨™ç±¤å…§å®¹ -->
        <div id="content-linkgen" class="tab-content hidden">
            <div class="brand-card p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-2xl font-semibold brand-accent">ğŸ”— çŸ¥éŸ³å¤§ä½¿å°ˆå±¬é€£çµç”Ÿæˆå™¨</h2>
                    <div class="flex space-x-3">
                        <button onclick="loadPartnersForLinkGen()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            ğŸ”„ é‡æ–°è¼‰å…¥å¤¥ä¼´
                        </button>
                        <a href="link-generator-form.html" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            ğŸ“ ç¨ç«‹é é¢ç‰ˆæœ¬
                        </a>
                    </div>
                </div>

                <!-- ç”Ÿæˆè¡¨å–® -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h3 class="font-bold text-lg mb-4">ç”Ÿæˆå°ˆå±¬é€£çµ</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">é¸æ“‡å¤¥ä¼´æˆ–è¼¸å…¥æ–°å¤¥ä¼´</label>
                            <select id="linkgen_partner_select" onchange="onPartnerSelect()" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                                <option value="">-- é¸æ“‡ç¾æœ‰å¤¥ä¼´æˆ–æ–°å¢ --</option>
                                <option value="new">â• æ–°å¢å¤¥ä¼´</option>
                            </select>
                        </div>
                        
                        <div id="linkgen_new_partner_name" class="hidden">
                            <label class="block text-sm font-medium text-stone-700 mb-2">å¤¥ä¼´å§“å *</label>
                            <input type="text" id="linkgen_partnerName" placeholder="ä¾‹ï¼šç‹å°æ˜" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">å¤¥ä¼´ä»£ç¢¼ *</label>
                            <input type="text" id="linkgen_partnerCode" placeholder="ä¾‹ï¼šWANG001" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            <p class="text-xs text-stone-500 mt-1">å»ºè­°æ ¼å¼ï¼šå¤§å¯«å­—æ¯+æ•¸å­—</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">Email</label>
                            <input type="email" id="linkgen_partnerEmail" placeholder="partner@example.com" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">å„ªæƒ åˆ¸ä»£ç¢¼</label>
                            <input type="text" id="linkgen_couponCode" placeholder="ä¾‹ï¼šFOREST_WANG001" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-stone-700 mb-2">å°ˆå±¬å„ªæƒ åˆ¸é€£çµ *</label>
                            <input type="url" id="linkgen_couponUrl" placeholder="ä¾‹ï¼šhttps://lin.ee/abc123" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            <p class="text-xs text-stone-500 mt-1">è«‹è²¼ä¸Šå¾ LINE å®˜æ–¹å¸³è™Ÿå¾Œå°å–å¾—çš„å°ˆå±¬å„ªæƒ åˆ¸é€£çµ</p>
                        </div>
                    </div>
                    
                    <!-- éŠ€è¡Œå¸³æˆ¶è³‡è¨Š -->
                    <div class="bg-white p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-stone-800 mb-4">ğŸ’° åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-2">éŠ€è¡Œåç¨±</label>
                                <input type="text" id="linkgen_bankName" placeholder="ä¾‹ï¼šå°ç£éŠ€è¡Œ" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-2">éŠ€è¡Œä»£ç¢¼</label>
                                <input type="text" id="linkgen_bankCode" placeholder="ä¾‹ï¼š004" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-2">åˆ†è¡Œåç¨±</label>
                                <input type="text" id="linkgen_bankBranch" placeholder="ä¾‹ï¼šä¿¡ç¾©åˆ†è¡Œ" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-2">æˆ¶å</label>
                                <input type="text" id="linkgen_bankAccountName" placeholder="å¸³æˆ¶æŒæœ‰äººå§“å" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-stone-700 mb-2">å¸³è™Ÿ</label>
                                <input type="text" id="linkgen_bankAccountNumber" placeholder="ä¾‹ï¼š1234567890123" class="w-full p-3 border-2 border-stone-200 rounded-lg focus:border-green-800 focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="generatePartnerLinks()" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                            ğŸ”— ç”Ÿæˆå°ˆå±¬é€£çµ
                        </button>
                        
                        <button onclick="savePartnerToSheets()" class="flex-1 bg-green-800 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-900 transition duration-300">
                            ğŸ’¾ å„²å­˜åˆ° Google Sheets
                        </button>
                    </div>
                </div>

                <!-- ç”Ÿæˆçµæœ -->
                <div id="linkgen_resultSection" class="bg-white p-6 rounded-lg hidden">
                    <h3 class="font-bold text-lg mb-4">ç”Ÿæˆçµæœ</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">ä¸»é é€£çµ</label>
                            <div class="bg-gray-100 p-3 rounded font-mono text-sm break-all" id="linkgen_landingLink"></div>
                            <button onclick="copyLinkText('linkgen_landingLink')" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ğŸ“‹ è¤‡è£½é€£çµ
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-2">LINE å®˜æ–¹å¸³è™Ÿé€£çµ</label>
                            <div class="bg-gray-100 p-3 rounded font-mono text-sm break-all" id="linkgen_couponLink"></div>
                            <button onclick="copyLinkText('linkgen_couponLink')" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                ğŸ“‹ è¤‡è£½é€£çµ
                            </button>
                        </div>
                        
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-amber-800 mb-2">ğŸ“± åˆ†äº«ç¯„æœ¬</h4>
                            <div class="text-sm text-amber-700 whitespace-pre-wrap" id="linkgen_shareTemplate"></div>
                            <button onclick="copyLinkText('linkgen_shareTemplate')" class="mt-3 px-3 py-1 bg-amber-600 text-white text-xs rounded hover:bg-amber-700">
                                ğŸ“‹ è¤‡è£½ç¯„æœ¬
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Apps Script API é…ç½®
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        // ğŸ¯ æ¨™æº–åŒ–çš„ Booking æ¬„ä½å®šç¾©ï¼ˆèˆ‡ Google Sheets å®Œå…¨å°æ‡‰ï¼‰
        const BOOKING_FIELDS = {
            // æ¬„ä½é †åºå¿…é ˆèˆ‡ Google Sheets å®Œå…¨ä¸€è‡´
            FIELD_ORDER: [
                'id',                           // Aåˆ— - å”¯ä¸€è­˜åˆ¥ç¬¦ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
                'partner_code',                 // Båˆ— - æ¨è–¦å¤§ä½¿ä»£ç¢¼
                'guest_name',                   // Cåˆ— - æˆ¿å®¢å§“å
                'guest_phone',                  // Dåˆ— - æˆ¿å®¢é›»è©±  
                'guest_email',                  // Eåˆ— - æˆ¿å®¢Email
                'bank_account_last5',           // Fåˆ— - éŠ€è¡Œå¸³è™Ÿå¾Œ5ç¢¼
                'checkin_date',                 // Gåˆ— - å…¥ä½æ—¥æœŸ
                'checkout_date',                // Håˆ— - é€€æˆ¿æ—¥æœŸ
                'room_price',                   // Iåˆ— - æˆ¿åƒ¹ï¼ˆæ•¸å­—ï¼‰
                'booking_source',               // Jåˆ— - è¨‚æˆ¿ä¾†æº
                'stay_status',                  // Kåˆ— - ä½å®¿ç‹€æ…‹
                'payment_status',               // Låˆ— - ä»˜æ¬¾ç‹€æ…‹
                'commission_status',            // Måˆ— - ä½£é‡‘ç‹€æ…‹
                'commission_amount',            // Nåˆ— - ä½£é‡‘é‡‘é¡ï¼ˆæ•¸å­—ï¼‰
                'commission_type',              // Oåˆ— - ä½£é‡‘é¡å‹
                'is_first_referral_bonus',      // Påˆ— - æ˜¯å¦é¦–æ¬¡æ¨è–¦çå‹µ
                'first_referral_bonus_amount',  // Qåˆ— - é¦–æ¬¡æ¨è–¦çå‹µé‡‘é¡
                'manually_confirmed_by',        // Råˆ— - æ‰‹å‹•ç¢ºèªè€…
                'manually_confirmed_at',        // Såˆ— - æ‰‹å‹•ç¢ºèªæ™‚é–“
                'notes',                        // Tåˆ— - å‚™è¨»
                'created_at',                   // Uåˆ— - å‰µå»ºæ™‚é–“
                'updated_at'                    // Våˆ— - æ›´æ–°æ™‚é–“
            ],
            
            // æ¬„ä½é è¨­å€¼
            DEFAULTS: {
                commission_status: 'NOT_ELIGIBLE',
                commission_amount: 0,
                commission_type: 'ACCOMMODATION',
                is_first_referral_bonus: false,
                first_referral_bonus_amount: 0,
                manually_confirmed_by: '',
                manually_confirmed_at: '',
                notes: ''
            },
            
            // å¿…å¡«æ¬„ä½
            REQUIRED: ['guest_name', 'guest_phone', 'checkin_date', 'checkout_date', 'room_price'],
            
            // æ•¸å­—æ¬„ä½
            NUMERIC: ['room_price', 'commission_amount', 'first_referral_bonus_amount']
        };
        
        // ğŸ”§ çµ±ä¸€çš„ Booking æ•¸æ“šè™•ç†å‡½æ•¸
        const BookingDataManager = {
            
            // é©—è­‰ booking æ•¸æ“šæ˜¯å¦ç¬¦åˆæ¨™æº–æ ¼å¼
            validateBooking(booking) {
                if (!booking || typeof booking !== 'object') {
                    return { valid: false, errors: ['æ•¸æ“šä¸å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤'] };
                }
                
                const errors = [];
                
                // æª¢æŸ¥å¿…å¡«æ¬„ä½
                BOOKING_FIELDS.REQUIRED.forEach(field => {
                    if (!booking[field] || String(booking[field]).trim() === '') {
                        errors.push(`ç¼ºå°‘å¿…å¡«æ¬„ä½: ${field}`);
                    }
                });
                
                // æª¢æŸ¥æ•¸å­—æ¬„ä½
                BOOKING_FIELDS.NUMERIC.forEach(field => {
                    if (booking[field] !== undefined && booking[field] !== null && booking[field] !== '') {
                        const num = Number(booking[field]);
                        if (isNaN(num)) {
                            errors.push(`${field} å¿…é ˆæ˜¯æ•¸å­—ï¼Œç•¶å‰å€¼: ${booking[field]}`);
                        }
                    }
                });
                
                // æª¢æŸ¥æ—¥æœŸæ ¼å¼
                if (booking.checkin_date && booking.checkout_date) {
                    const checkinDate = new Date(booking.checkin_date);
                    const checkoutDate = new Date(booking.checkout_date);
                    
                    if (isNaN(checkinDate.getTime())) {
                        errors.push(`å…¥ä½æ—¥æœŸæ ¼å¼éŒ¯èª¤: ${booking.checkin_date}`);
                    }
                    if (isNaN(checkoutDate.getTime())) {
                        errors.push(`é€€æˆ¿æ—¥æœŸæ ¼å¼éŒ¯èª¤: ${booking.checkout_date}`);
                    }
                    if (checkinDate >= checkoutDate) {
                        errors.push('é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ');
                    }
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            },
            
            // æ¨™æº–åŒ– booking æ•¸æ“šæ ¼å¼
            normalizeBooking(rawBooking) {
                const normalized = {};
                
                // æŒ‰ç…§æ¨™æº–æ¬„ä½é †åºè™•ç†æ•¸æ“š
                BOOKING_FIELDS.FIELD_ORDER.forEach(field => {
                    if (rawBooking.hasOwnProperty(field)) {
                        normalized[field] = rawBooking[field];
                    } else if (BOOKING_FIELDS.DEFAULTS.hasOwnProperty(field)) {
                        normalized[field] = BOOKING_FIELDS.DEFAULTS[field];
                    } else {
                        normalized[field] = null;
                    }
                });
                
                // æ•¸å­—æ¬„ä½ç‰¹æ®Šè™•ç†
                BOOKING_FIELDS.NUMERIC.forEach(field => {
                    if (normalized[field] !== null && normalized[field] !== undefined) {
                        normalized[field] = Number(normalized[field]) || 0;
                    }
                });
                
                // å¸ƒæ—æ¬„ä½ç‰¹æ®Šè™•ç†
                if (normalized.is_first_referral_bonus !== null) {
                    normalized.is_first_referral_bonus = Boolean(normalized.is_first_referral_bonus);
                }
                
                return normalized;
            },
            
            // å‰µå»ºæ–° booking çš„æ¨™æº–æ ¼å¼ï¼ˆç”¨æ–¼æ‰‹å‹•æ–°å¢ï¼‰
            createNewBooking(formData) {
                const booking = {
                    // id ç”±å¾Œç«¯è‡ªå‹•ç”Ÿæˆï¼Œä¸åŒ…å«åœ¨å‰ç«¯æäº¤æ•¸æ“šä¸­
                    partner_code: formData.partner_code || null,
                    guest_name: formData.guest_name?.trim() || '',
                    guest_phone: formData.guest_phone?.trim() || '',
                    guest_email: formData.guest_email?.trim() || '',
                    bank_account_last5: formData.bank_account_last5?.trim() || '',
                    checkin_date: formData.checkin_date || '',
                    checkout_date: formData.checkout_date || '',
                    room_price: Number(formData.room_price) || 0,
                    booking_source: formData.booking_source || 'MANUAL_ENTRY',
                    stay_status: formData.stay_status || 'PENDING',
                    payment_status: formData.payment_status || 'PENDING',
                    commission_status: formData.commission_status || 'NOT_ELIGIBLE',
                    commission_amount: Number(formData.commission_amount) || 0,
                    commission_type: formData.commission_type || 'ACCOMMODATION',
                    is_first_referral_bonus: Boolean(formData.is_first_referral_bonus) || false,
                    first_referral_bonus_amount: Number(formData.first_referral_bonus_amount) || 0,
                    manually_confirmed_by: formData.manually_confirmed_by || '',
                    manually_confirmed_at: formData.manually_confirmed_at || '',
                    notes: formData.notes?.trim() || ''
                    // created_at å’Œ updated_at ç”±å¾Œç«¯è‡ªå‹•ç”Ÿæˆ
                };
                
                return this.normalizeBooking(booking);
            },
            
            // æ›´æ–° booking çš„æ¨™æº–æ ¼å¼ï¼ˆç”¨æ–¼ç·¨è¼¯ï¼‰
            updateBooking(existingBooking, updateData) {
                const updated = { ...existingBooking };
                
                // åªæ›´æ–°æä¾›çš„æ¬„ä½
                Object.keys(updateData).forEach(key => {
                    if (BOOKING_FIELDS.FIELD_ORDER.includes(key)) {
                        updated[key] = updateData[key];
                    }
                });
                
                // è‡ªå‹•æ›´æ–° updated_atï¼ˆç”±å¾Œç«¯è™•ç†ï¼Œé€™è£¡æ¨™è¨˜ï¼‰
                updated._needsTimestampUpdate = true;
                
                return this.normalizeBooking(updated);
            },
            
            // å‰µå»ºæ¨™æº–åŒ–çš„ URLSearchParamsï¼ˆç¢ºä¿æŒ‰ç…§æ­£ç¢ºé †åºç™¼é€æ•¸æ“šï¼‰
            createOrderedParams(data) {
                const params = new URLSearchParams();
                
                // é¦–å…ˆæ·»åŠ  actionï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (data.action) {
                    params.append('action', data.action);
                }
                
                // ç„¶å¾Œæ·»åŠ  booking_idï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (data.booking_id !== undefined) {
                    params.append('booking_id', data.booking_id);
                }
                
                // æŒ‰ç…§ BOOKING_FIELDS.FIELD_ORDER çš„é †åºæ·»åŠ æ¬„ä½
                BOOKING_FIELDS.FIELD_ORDER.forEach(fieldName => {
                    if (data.hasOwnProperty(fieldName) && data[fieldName] !== undefined) {
                        params.append(fieldName, data[fieldName] !== null ? data[fieldName] : '');
                    }
                });
                
                // æ·»åŠ å…¶ä»–éæ¨™æº–æ¬„ä½
                Object.keys(data).forEach(key => {
                    if (key !== 'action' && key !== 'booking_id' && !BOOKING_FIELDS.FIELD_ORDER.includes(key)) {
                        if (data[key] !== undefined) {
                            params.append(key, data[key] !== null ? data[key] : '');
                        }
                    }
                });
                
                return params;
            },

            // æª¢æ¸¬æ•¸æ“šæ˜¯å¦æœ‰æ ¼å¼å•é¡Œï¼ˆç”¨æ–¼è¨ºæ–·ï¼‰
            detectDataIssues(bookings) {
                if (!bookings || bookings.length === 0) {
                    return { hasIssues: false, issues: [] };
                }
                
                const issues = [];
                const firstBooking = bookings[0];
                
                // æª¢æŸ¥æ¬„ä½æ˜ å°„å•é¡Œ
                const actualFields = Object.keys(firstBooking);
                const expectedFields = BOOKING_FIELDS.FIELD_ORDER;
                
                if (actualFields.length !== expectedFields.length) {
                    issues.push(`æ¬„ä½æ•¸é‡ä¸åŒ¹é…ï¼šå¯¦éš› ${actualFields.length} å€‹ï¼ŒæœŸæœ› ${expectedFields.length} å€‹`);
                }
                
                // æª¢æŸ¥æ¬„ä½é †åºå’Œåç¨±
                actualFields.forEach((actualField, index) => {
                    const expectedField = expectedFields[index];
                    if (actualField !== expectedField) {
                        issues.push(`æ¬„ä½ ${index} ä¸åŒ¹é…ï¼šå¾—åˆ° "${actualField}"ï¼ŒæœŸæœ› "${expectedField}"`);
                    }
                });
                
                // æª¢æŸ¥æ•¸æ“šé¡å‹å•é¡Œ
                BOOKING_FIELDS.NUMERIC.forEach(field => {
                    if (firstBooking[field] !== undefined && firstBooking[field] !== null) {
                        const value = firstBooking[field];
                        if (typeof value === 'string' && isNaN(Number(value))) {
                            issues.push(`${field} æ‡‰è©²æ˜¯æ•¸å­—ï¼Œä½†åŒ…å«éæ•¸å­—å…§å®¹: "${value}"`);
                        }
                    }
                });
                
                // æª¢æŸ¥æ—¥æœŸæ ¼å¼
                ['checkin_date', 'checkout_date'].forEach(field => {
                    if (firstBooking[field]) {
                        const dateValue = firstBooking[field];
                        if (typeof dateValue === 'string' && !dateValue.includes('-') && !dateValue.includes('/')) {
                            if (dateValue.length < 8) {
                                issues.push(`${field} æ ¼å¼ç•°å¸¸: "${dateValue}"`);
                            }
                        }
                    }
                });
                
                return {
                    hasIssues: issues.length > 0,
                    issues: issues,
                    firstBooking: firstBooking
                };
            }
        };
        
        // æª¢æŸ¥ Apps Script é€£ç·šç‹€æ…‹
        async function checkAppsScriptConnection() {
            try {
                console.log('ğŸ” æª¢æŸ¥ Apps Script é€£ç·š...');
                const testUrl = `${APPS_SCRIPT_URL}?action=test`;
                
                // å˜—è©¦ä½¿ç”¨ fetch
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'no-cors' // é¿å… CORS å•é¡Œ
                });
                
                console.log('âœ… Apps Script é€£ç·šæ¸¬è©¦å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ Apps Script é€£ç·šå¤±æ•—:', error);
                showErrorMessage(`Apps Script é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥ï¼š
1. é–‹å•Ÿ google-apps-script-fix.html æŸ¥çœ‹ä¿®å¾©æŒ‡å—
2. ç¢ºèª Apps Script å·²æ­£ç¢ºéƒ¨ç½²
3. æ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººã€
4. åŸ·è¡Œèº«åˆ†ç‚ºã€Œæˆ‘ã€`);
                return false;
            }
        }
        
        // å…¨åŸŸè®Šæ•¸
        let allData = {
            partners: [],
            bookings: [],
            payouts: [],
            clicks: []
        };


        // è¼‰å…¥çœŸå¯¦æ•¸æ“š
        async function loadRealData() {
            try {
                showLoadingSpinner('è¼‰å…¥æ•¸æ“šä¸­...');
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥çœŸå¯¦æ•¸æ“š...');
                console.log('ğŸŒ è«‹æ±‚ URL:', APPS_SCRIPT_URL);
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_dashboard_data'
                });
                
                console.log('ğŸ“¡ æ”¶åˆ°å›æ‡‰:', response.status, response.statusText);
                console.log('ğŸ“¡ å›æ‡‰é¡å‹:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.text();
                console.log('ğŸ“„ åŸå§‹å›æ‡‰å…§å®¹:', result);
                
                let data;
                try {
                    data = JSON.parse(result);
                } catch (parseError) {
                    console.error('âŒ JSON è§£æå¤±æ•—:', parseError);
                    console.error('åŸå§‹å…§å®¹:', result);
                    throw new Error('å›æ‡‰æ ¼å¼ä¸æ­£ç¢º: ' + parseError.message);
                }
                
                console.log('ğŸ“Š è§£æå¾Œçš„æ•¸æ“š:', data);
                
                if (data.success) {
                    allData = data.data;
                    console.log('âœ… è¼‰å…¥çœŸå¯¦æ•¸æ“šæˆåŠŸ:');
                    console.log('- Partners:', allData.partners?.length || 0);
                    console.log('- Bookings:', allData.bookings?.length || 0);
                    console.log('- Payouts:', allData.payouts?.length || 0);
                    console.log('- Clicks:', allData.clicks?.length || 0);
                    
                    // è©³ç´°è¨ºæ–· Bookings è³‡æ–™çµæ§‹
                    if (allData.bookings && allData.bookings.length > 0) {
                        console.log('ğŸ” Bookings è³‡æ–™çµæ§‹è¨ºæ–·:');
                        const firstBooking = allData.bookings[0];
                        const actualFields = Object.keys(firstBooking);
                        console.log('  å¯¦éš›æ¬„ä½æ•¸é‡:', actualFields.length);
                        console.log('  å¯¦éš›æ¬„ä½é †åº:', actualFields);
                        console.log('  ç¬¬ä¸€ç­†è³‡æ–™ç¯„ä¾‹:', firstBooking);
                        
                        // æ¯”å°æœŸæœ›çš„æ¬„ä½
                        const expectedFields = BOOKING_FIELDS.FIELD_ORDER;
                        console.log('  æœŸæœ›æ¬„ä½æ•¸é‡:', expectedFields.length);
                        console.log('  æœŸæœ›æ¬„ä½é †åº:', expectedFields);
                        
                        // é¡¯ç¤ºå·®ç•°
                        console.log('  æ¬„ä½å·®ç•°åˆ†æ:');
                        actualFields.forEach((field, index) => {
                            if (field !== expectedFields[index]) {
                                console.log(`    ç´¢å¼• ${index}: å¯¦éš›="${field}" vs æœŸæœ›="${expectedFields[index]}"`);
                            }
                        });
                        
                        // ç‰¹åˆ¥æª¢æŸ¥ BOOKING_FIELDS.FIELD_ORDER çš„å…§å®¹
                        console.log('âš ï¸ BOOKING_FIELDS.FIELD_ORDER å®Œæ•´å…§å®¹:');
                        BOOKING_FIELDS.FIELD_ORDER.forEach((field, index) => {
                            console.log(`    [${index}] = "${field}"`);
                        });
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰äººä¿®æ”¹äº† FIELD_ORDER
                        if (BOOKING_FIELDS.FIELD_ORDER[0] !== 'id') {
                            console.error('âŒ éŒ¯èª¤ï¼šFIELD_ORDER[0] ä¸æ˜¯ "id"ï¼Œè€Œæ˜¯:', BOOKING_FIELDS.FIELD_ORDER[0]);
                        }
                    }
                    
                    // æª¢æŸ¥ Payouts æ•¸æ“šçµæ§‹
                    if (allData.payouts && allData.payouts.length > 0) {
                        console.log('ğŸ“Š Payouts æ•¸æ“šçµæ§‹æª¢æŸ¥:');
                        allData.payouts.forEach((payout, index) => {
                            console.log(`  Payout ${index}:`, {
                                id: payout.id,
                                partner_code: payout.partner_code,
                                payout_type: payout.payout_type,
                                amount: payout.amount,
                                payout_status: payout.payout_status
                            });
                        });
                    }
                    
                    showSuccessMessage(`æˆåŠŸè¼‰å…¥ ${allData.partners?.length || 0} ä½å¤¥ä¼´çš„è³‡æ–™ï¼`);
                } else {
                    throw new Error(data.error || 'è¼‰å…¥æ•¸æ“šå¤±æ•—');
                }
                
                hideLoadingSpinner();
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥çœŸå¯¦æ•¸æ“šå¤±æ•—:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', {
                    message: error.message,
                    stack: error.stack
                });
                
                hideLoadingSpinner();
                
                // æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                let errorMsg = 'è¼‰å…¥çœŸå¯¦æ•¸æ“šå¤±æ•—: ' + error.message;
                
                if (error.message.includes('403')) {
                    errorMsg += '\nâš ï¸ Google Apps Script æ¬Šé™å•é¡Œï¼';
                    showAppsScriptFixModal();
                    return; // ä¸é¡¯ç¤ºä¸€èˆ¬éŒ¯èª¤è¨Šæ¯ï¼Œè€Œæ˜¯é¡¯ç¤ºå°ˆé–€çš„ä¿®å¾©æŒ‡å°
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '\nç¶²è·¯é€£ç·šå•é¡Œï¼Œè«‹ç¢ºèªç¶²è·¯ç‹€æ…‹ã€‚';
                }
                
                showErrorMessage(errorMsg);
                
                // ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                loadMockData();
                console.log('ğŸ”„ å·²åˆ‡æ›åˆ°æ¨¡æ“¬æ•¸æ“šæ¨¡å¼');
            }
        }

        // è¼‰å…¥æ¦‚è¦½æ•¸æ“š
        async function loadOverviewData() {
            await loadRealData();
            displayPartners(allData.partners);
            updateStats();
            displayRecentActivity();
        }

        // è¼‰å…¥æ¨¡æ“¬æ•¸æ“šï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        function loadMockData() {
            allData.partners = [
                {
                    partner_code: 'DEMO001',
                    name: 'ç¤ºç¯„å¤§ä½¿',
                    email: 'demo@example.com',
                    level: 'LV1_INSIDER',
                    level_progress: 2,
                    total_successful_referrals: 2,
                    available_points: 1500,  // å¯ç”¨é»æ•¸
                    pending_cash: 500,      // å¾…æ”¯ä»˜ç¾é‡‘ (NTD)
                    total_points_earned: 2000,  // æ­·å²ç´¯ç©é»æ•¸
                    total_points_used: 500,     // å·²ä½¿ç”¨é»æ•¸
                    total_commission_earned: 1500,  // å‘å¾Œç›¸å®¹
                    pending_commission: 1000,       // å‘å¾Œç›¸å®¹
                    commission_preference: 'ACCOMMODATION'
                }
            ];

            allData.bookings = [
                {
                    id: 1,
                    partner_code: 'DEMO001',
                    guest_name: 'ç¤ºç¯„æˆ¿å®¢',
                    guest_phone: '0912345678',
                    checkin_date: '2024-02-15',
                    checkout_date: '2024-02-17',
                    room_price: 5000,
                    stay_status: 'COMPLETED',
                    payment_status: 'PAID',
                    commission_amount: 500
                }
            ];

            allData.payouts = [];
            allData.clicks = [];
        }

        // é¡¯ç¤ºå¤¥ä¼´åˆ—è¡¨ (å…¨æ–°å¡ç‰‡å¼è¨­è¨ˆ)
        function displayPartners(partners) {
            const container = document.getElementById('partnersContainer');
            
            if (!partners || partners.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-stone-500">
                        <div class="text-6xl mb-4">ğŸ•ï¸</div>
                        <p class="text-lg font-medium mb-2">å°šæœªæœ‰ä»»ä½•è¯ç›Ÿå¤¥ä¼´</p>
                        <p class="text-sm">é–‹å§‹æ¨å»£æ‚¨çš„æ£®æ—ä½å®¿é«”é©—å§ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = partners.map(partner => {
                return generatePartnerCard(partner);
            }).join('');
        }

        /**
         * ç”Ÿæˆå–®å€‹å¤¥ä¼´çš„å¡ç‰‡ HTML (V5 - è²¡å‹™é‡é»ç‰ˆ)
         * @param {object} partner - å¾å¾Œç«¯ç²å–çš„å¤¥ä¼´è³‡æ–™ç‰©ä»¶
         * @returns {string} - è¿”å›å®Œæ•´çš„å¡ç‰‡ HTML å­—ä¸²
         */
        function generatePartnerCard(partner) {
            // --- è³‡æ–™è¨ˆç®— (ä¿æŒèˆ‡ç¾æœ‰ç‰ˆæœ¬ä¸€è‡´) ---
            const levelClass = getLevelClass(partner.level);
            const levelText = getLevelText(partner.level);
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const accommodationBalance = totalEarned - totalPaid;
            const pendingCash = parseFloat(partner.pending_commission) || 0;
            const totalClicks = getPartnerClicks(partner.partner_code);
            const completedReferrals = partner.total_successful_referrals || 0;

            // --- å‘¼å«æ“ä½œæŒ‰éˆ•ç”Ÿæˆå‡½å¼ ---
            const smartActions = generateSmartActions(partner);

            // --- HTML çµæ§‹ ---
            return `
                <div class="brand-card transition-shadow duration-200 hover:shadow-lg" data-partner-code="${partner.partner_code}">
                    <div class="p-6 flex flex-col lg:flex-row items-start lg:items-center gap-6">
                        
                        <!-- çµæ§‹ä¸€ï¼šå·¦å´å¤¥ä¼´åŸºæœ¬è³‡è¨Š -->
                        <div class="flex items-center gap-4 w-full lg:w-auto lg:flex-1">
                            <input type="checkbox" class="partner-selector h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 flex-shrink-0" 
                                   onchange="updateSelection()" data-partner-code="${partner.partner_code}">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h3 class="font-bold text-lg text-stone-800 hover:text-blue-600 cursor-pointer transition-colors" 
                                        onclick="viewPartnerDetails('${partner.partner_code}')"
                                        title="é»æ“ŠæŸ¥çœ‹è©³æƒ…">
                                        ${partner.name || 'æœªè¨­å®šå§“å'}
                                    </h3>
                                    <span class="text-sm text-stone-500 font-mono">${partner.partner_code}</span>
                                </div>
                                <div class="mt-1">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${levelClass}">${levelText}</span>
                                </div>
                            </div>
                        </div>

                        <!-- çµæ§‹äºŒï¼šä¸­é–“çš„æ•¸æ“šæŒ‡æ¨™ç¶²æ ¼ -->
                        <div class="flex-grow grid grid-cols-2 sm:grid-cols-5 gap-4 text-center w-full lg:w-auto lg:flex-[2]">
                            
                            <!-- 2a. ä¸»è¦è²¡å‹™æŒ‡æ¨™ (æœ€é‡è¦ï¼Œæ”¾åœ¨æœ€å‰) -->
                            <div class="kpi-item col-span-1">
                                <div class="font-bold text-2xl text-blue-600">${accommodationBalance.toLocaleString()}</div>
                                <div class="text-xs text-blue-800 font-medium mt-1">å¯ç”¨é»æ•¸</div>
                            </div>
                            <div class="kpi-item col-span-1">
                                ${pendingCash > 0 ? `
                                    <div class="font-bold text-2xl text-amber-600">
                                        <span class="text-lg">NT$</span> ${pendingCash.toLocaleString()}
                                    </div>
                                    <div class="text-xs text-amber-800 font-medium mt-1">å¾…æ”¯ä»˜ç¾é‡‘</div>
                                ` : `
                                     <div class="font-semibold text-xl text-gray-400">NT$ 0</div>
                                     <div class="text-xs text-gray-400 mt-1">å¾…æ”¯ä»˜ç¾é‡‘</div>
                                `}
                            </div>

                            <!-- 2b. æ¬¡è¦ç¸¾æ•ˆæŒ‡æ¨™ -->
                            <div class="kpi-item kpi-divider">
                                <div class="font-semibold text-lg text-stone-700">${partner.level_progress || 0} / <span class="text-base font-normal">${getNextLevelRequirement(partner.level)}</span></div>
                                <div class="text-xs text-stone-500 mt-1">æœ¬å¹´é€²åº¦</div>
                            </div>
                            <div class="kpi-item kpi-divider">
                                <div class="font-semibold text-lg text-stone-700">${totalClicks}</div>
                                <div class="text-xs text-stone-500 mt-1">é»æ“Šæ•¸</div>
                            </div>
                            <div class="kpi-item kpi-divider">
                                <div class="font-semibold text-lg text-green-600">${completedReferrals}</div>
                                <div class="text-xs text-stone-500 mt-1">å®Œæˆå…¥ä½</div>
                            </div>
                        </div>

                        <!-- çµæ§‹ä¸‰ï¼šå³å´æ“ä½œå€ -->
                        <div class="w-full lg:w-auto pt-4 lg:pt-0 border-t lg:border-t-0 lg:border-l border-gray-200 lg:pl-6">
                            ${smartActions}
                        </div>
                    </div>
                </div>
            `;
        }


        /**
         * ç”Ÿæˆæ™ºèƒ½æ“ä½œæŒ‰éˆ• (æ¥µç°¡æ“ä½œå€ï¼Œä¸¦å®Œæ•´ä¿ç•™åŸæœ‰åŠŸèƒ½)
         * @param {object} partner - å¤¥ä¼´è³‡æ–™ç‰©ä»¶
         * @returns {string} - è¿”å›æ“ä½œå€çš„ HTML å­—ä¸²
         */
        function generateSmartActions(partner) {
            // --- è³‡æ–™è¨ˆç®— (èˆ‡åŸç‰ˆç›¸åŒï¼Œç”¨æ–¼åˆ¤æ–·æŒ‰éˆ•ç‹€æ…‹) ---
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const accommodationBalance = totalEarned - totalPaid;
            const pendingCash = parseFloat(partner.pending_commission) || 0;
            const dropdownId = `actions-dropdown-${partner.partner_code}`;
            
            // --- é‚è¼¯ä¸€ï¼šå‹•æ…‹ç”Ÿæˆã€Œä½¿ç”¨é»æ•¸ã€æŒ‰éˆ• ---
            // æ ¹æ“šæ˜¯å¦æœ‰å¯ç”¨é»æ•¸ï¼Œæ±ºå®šæŒ‰éˆ•æ˜¯å¯é»æ“Šé‚„æ˜¯ç¦ç”¨ç‹€æ…‹ã€‚
            let usePointsButtonHTML = '';
            if (accommodationBalance > 0) {
                // **é—œéµ**ï¼šonclick äº‹ä»¶ç¶å®šåŸæœ‰çš„ `showPartnerActionsModal` å‡½å¼
                usePointsButtonHTML = `
                    <button onclick="showPartnerActionsModal('${partner.partner_code}', 'accommodation')" class="w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition-all">
                        ä½¿ç”¨é»æ•¸
                    </button>`;
            } else {
                usePointsButtonHTML = `
                    <button class="w-full sm:w-auto bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-xs font-bold cursor-not-allowed" disabled>
                        ä½¿ç”¨é»æ•¸
                    </button>`;
            }

            // --- é‚è¼¯äºŒï¼šçµ„åˆä¸»è¦æŒ‰éˆ•å’Œä¸‹æ‹‰é¸å–® ---
            return `
                <div class="flex items-center justify-end gap-2">
                    ${usePointsButtonHTML}
                    
                    <div class="relative flex-shrink-0">
                        <!-- ã€Œæ›´å¤šæ“ä½œã€æŒ‰éˆ•ï¼Œè§¸ç™¼ä¸‹æ‹‰é¸å–® -->
                        <button onclick="toggleActionsDropdown('${dropdownId}', event)" class="text-gray-500 hover:text-gray-800 hover:bg-gray-100 p-2 rounded-full transition-all">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                            </svg>
                        </button>
                        
                        <!-- ç°¡åŒ–çš„ä¸‹æ‹‰é¸å–®ï¼šåªä¿ç•™å¿…è¦åŠŸèƒ½ -->
                        <div id="${dropdownId}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20 border">
                            <a href="#" onclick="viewPartnerDetails('${partner.partner_code}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸ“‹ æŸ¥çœ‹è©³æƒ…</a>
                            ${pendingCash > 0 ? `<a href="#" onclick="showPartnerActionsModal('${partner.partner_code}', 'cash')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸ’° è™•ç†çµç®—</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // è¼‰å…¥è¨‚å–®æ•¸æ“š
        async function loadBookingsData() {
            if (allData.bookings.length === 0) {
                await loadRealData();
            }
            displayBookings(allData.bookings);
        }

        // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
        function displayBookings(bookings) {
            const table = document.getElementById('bookingsTable');
            
            if (!bookings || bookings.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8 text-stone-500">
                            å°šæœªæœ‰ä»»ä½•è¨‚å–®
                        </td>
                    </tr>
                `;
                return;
            }

            // ä½¿ç”¨ BookingDataManager æª¢æ¸¬ä¸¦è¨ºæ–·æ•¸æ“šå•é¡Œ
            const dataIssues = BookingDataManager.detectDataIssues(bookings);
            if (dataIssues.hasIssues) {
                console.error('âŒ BookingDataManager åµæ¸¬åˆ°æ•¸æ“šæ ¼å¼å•é¡Œ:', dataIssues.issues);
                
                // é¡¯ç¤ºéŒ¯èª¤æç¤º
                table.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md mx-auto">
                                <div class="text-red-600 font-bold mb-2">âŒ æ•¸æ“šæ ¼å¼éŒ¯èª¤</div>
                                <div class="text-sm text-red-700 mb-3">
                                    ${dataIssues.issues.join('<br>')}
                                </div>
                                <button onclick="fixDataMapping()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">
                                    ğŸ”§ è¨ºæ–·ä¸¦ä¿®å¾©
                                </button>
                                <div class="text-xs text-red-600 mt-2">
                                    è«‹é»æ“Šè¨ºæ–·æŒ‰éˆ•è‡ªå‹•åµæ¸¬æ­£ç¢ºçš„æ¬„ä½å°æ‡‰
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // æ¨™æº–åŒ–æ‰€æœ‰ booking æ•¸æ“šä»¥ç¢ºä¿ä¸€è‡´æ€§
            const normalizedBookings = bookings.map(booking => {
                const normalized = BookingDataManager.normalizeBooking(booking);
                // é©—è­‰æ¯ç­†æ•¸æ“š
                const validation = BookingDataManager.validateBooking(normalized);
                if (!validation.valid) {
                    console.warn('âš ï¸ è¨‚æˆ¿æ•¸æ“šé©—è­‰å¤±æ•—:', validation.errors, normalized);
                }
                return normalized;
            });

            console.log('ğŸ”§ å·²æ¨™æº–åŒ– ' + normalizedBookings.length + ' ç­†è¨‚æˆ¿æ•¸æ“š');
            
            // æª¢æŸ¥æ•¸æ“šå®Œæ•´æ€§ï¼ˆåŸºæ–¼æ¨™æº–åŒ–å¾Œçš„æ•¸æ“šï¼‰
            if (normalizedBookings.length > 0) {
                console.log('ğŸ“Š ç¬¬ä¸€ç­†æ¨™æº–åŒ–å¾Œæ•¸æ“š:', normalizedBookings[0]);
            }

            table.innerHTML = normalizedBookings.map((booking, index) => {
                const statusClass = getStatusClass(booking.stay_status);
                const statusText = getStatusText(booking.stay_status);
                const partner = booking.partner_code ? allData.partners.find(p => p.partner_code === booking.partner_code) : null;
                const expectedCommission = partner ? calculateExpectedCommission(partner.level, booking.room_price) : null;
                const isCheckoutPassed = booking.checkout_date && new Date(booking.checkout_date) < new Date();
                const canConfirmStay = booking.stay_status !== 'COMPLETED' && isCheckoutPassed;
                
                
                return `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="py-4 px-4">
                            <div>
                                <div class="font-semibold">${booking.guest_name}</div>
                                <div class="text-sm text-stone-600">${booking.guest_phone || ''}</div>
                                ${booking.guest_email ? `<div class="text-xs text-stone-500">${booking.guest_email}</div>` : ''}
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            ${booking.partner_code ? `
                                <div class="font-medium text-green-700">${booking.partner_code}</div>
                                ${partner ? `
                                    <div class="text-xs text-stone-600">${partner.name}</div>
                                    <div class="text-xs text-stone-500">${getLevelText(partner.level)}</div>
                                ` : ''}
                            ` : `
                                <span class="text-stone-400">éæ¨è–¦è¨‚æˆ¿</span>
                            `}
                        </td>
                        <td class="py-4 px-4 text-sm">
                            <div>${booking.checkin_date}</div>
                            <div class="text-stone-500">~ ${booking.checkout_date}</div>
                            ${canConfirmStay ? `
                                <div class="text-xs text-orange-600 mt-1">â° å¯ç¢ºèªå…¥ä½</div>
                            ` : ''}
                        </td>
                        <td class="py-4 px-4 text-center font-semibold">
                            $${(booking.room_price || 0).toLocaleString()}
                        </td>
                        <td class="py-4 px-4 text-center">
                            ${booking.bank_account_last5 ? `
                                <div class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">
                                    *****${booking.bank_account_last5}
                                </div>
                            ` : `
                                <span class="text-gray-400 text-xs">æœªæä¾›</span>
                            `}
                        </td>
                        <td class="py-4 px-4 text-center">
                            <span class="px-2 py-1 rounded text-xs ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="py-4 px-4 text-center">
                            ${booking.commission_amount ? `
                                <div class="font-semibold text-green-600">$${booking.commission_amount}</div>
                                <div class="text-xs text-stone-500">å¯¦éš›ä½£é‡‘</div>
                            ` : expectedCommission ? `
                                <div class="font-medium text-green-600">$${expectedCommission.accommodation}</div>
                                <div class="text-xs text-stone-500">é è¨ˆä½å®¿é‡‘</div>
                                <div class="text-xs text-stone-400">($${expectedCommission.cash}ç¾é‡‘)</div>
                            ` : `
                                <span class="text-stone-400">-</span>
                            `}
                        </td>
                        <td class="py-4 px-4 text-center">
                            <div class="flex flex-col space-y-1">
                                ${canConfirmStay ? `
                                    <button onclick="confirmStayCompletion(${index})" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                        âœ… ç¢ºèªå…¥ä½
                                    </button>
                                ` : ''}
                                <button onclick="editBooking(${index})" 
                                    class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    âœï¸ ç·¨è¼¯è¨‚å–®
                                </button>
                                <button onclick="viewBookingDetails(${index})" 
                                    class="text-blue-600 hover:underline text-xs">
                                    è©³æƒ…
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è¼‰å…¥çµç®—æ•¸æ“š
        async function loadPayoutsData() {
            if (allData.payouts.length === 0) {
                await loadRealData();
            }
            displayPayouts(allData.payouts);
        }

        // é¡¯ç¤ºçµç®—åˆ—è¡¨
        function displayPayouts(payouts) {
            const table = document.getElementById('payoutsTable');
            
            if (!payouts || payouts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-stone-500">
                            å°šæœªæœ‰ä»»ä½•çµç®—è¨˜éŒ„
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = payouts.map((payout, index) => {
                // ä½¿ç”¨ payout.id æˆ– index ä½œç‚ºå‚™ç”¨
                const payoutIdentifier = payout.id || index;
                console.log(`ğŸ“‹ Payout ${index}:`, {
                    id: payout.id,
                    identifier: payoutIdentifier,
                    partner_code: payout.partner_code,
                    amount: payout.amount
                });
                
                // ç”Ÿæˆä¾†æºæè¿°
                const sourceInfo = generatePayoutSourceDescription(payout);
                
                return `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="py-4 px-4">
                            <div class="font-semibold">${payout.partner_code}</div>
                        </td>
                        <td class="py-4 px-4 text-center">
                            ${payout.payout_type === 'CASH' ? 'ç¾é‡‘' : 
                              payout.payout_type === 'ADJUSTMENT' ? 'èª¿æ•´' : 'ä½å®¿é‡‘'}
                        </td>
                        <td class="py-4 px-4 text-center font-semibold">
                            ${payout.amount < 0 ? '-' : ''}$${Math.abs(payout.amount || 0).toLocaleString()}
                        </td>
                        <td class="py-4 px-4">
                            ${payout.related_booking_ids || '-'}
                        </td>
                        <td class="py-4 px-4">
                            <div class="space-y-1">
                                <span class="inline-block px-2 py-1 rounded text-xs ${sourceInfo.class}">
                                    ${sourceInfo.text}
                                </span>
                                ${sourceInfo.detail ? `<div class="text-xs text-gray-600">${sourceInfo.detail}</div>` : ''}
                            </div>
                        </td>
                        <td class="py-4 px-4 text-sm text-stone-600">
                            ${formatDate(payout.created_at)}
                        </td>
                        <td class="py-4 px-4 text-center">
                            <button onclick="viewPayoutDetails('${payoutIdentifier}')" 
                                class="text-blue-600 hover:underline text-sm"
                                title="æŸ¥çœ‹çµç®—è©³æƒ… (ID: ${payoutIdentifier})">
                                è©³æƒ…
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // è¼‰å…¥åˆ†ææ•¸æ“š
        async function loadAnalyticsData() {
            if (allData.clicks.length === 0) {
                await loadRealData();
            }
            displayAnalytics();
        }

        // é¡¯ç¤ºåˆ†ææ•¸æ“š
        function displayAnalytics() {
            // TODO: å¯¦ä½œåœ–è¡¨é¡¯ç¤º
            console.log('é¡¯ç¤ºåˆ†ææ•¸æ“š');
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const totalPartners = allData.partners.length;
            const totalClicks = allData.clicks.length;
            const completedBookings = allData.bookings.filter(b => b.stay_status === 'COMPLETED').length;
            const totalPayouts = allData.partners.reduce((sum, p) => sum + (p.pending_cash || p.pending_commission || 0), 0);
            
            const completionRate = totalClicks > 0 ? ((completedBookings / totalClicks) * 100).toFixed(1) : '0.0';

            document.getElementById('totalPartners').textContent = totalPartners;
            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('totalStayCompleted').textContent = completedBookings;
            document.getElementById('stayCompletionRate').textContent = completionRate + '%';
            document.getElementById('totalPayouts').textContent = `$${totalPayouts.toLocaleString()}`;
        }

        // é¡¯ç¤ºæœ€è¿‘æ´»å‹•
        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            // æ¨¡æ“¬æœ€è¿‘æ´»å‹•
            const activities = [
                { text: 'ç³»çµ±å·²è¼‰å…¥çœŸå¯¦æ•¸æ“š', time: 'å‰›å‰›' },
                { text: 'ç­‰å¾…æ›´å¤šæ´»å‹•è¨˜éŒ„', time: '1 åˆ†é˜å‰' }
            ];

            container.innerHTML = activities.map(activity => `
                <div class="flex justify-between items-center py-2 px-4 bg-stone-50 rounded">
                    <span class="text-sm">${activity.text}</span>
                    <span class="text-xs text-stone-500">${activity.time}</span>
                </div>
            `).join('');
        }

        // å³æ™‚æ›´æ–°ç•¶å‰æ¨™ç±¤é çš„é¡¯ç¤ºï¼ˆä¸é‡æ–°è¼‰å…¥æ•¸æ“šï¼‰
        function updateCurrentTabDisplay() {
            const activeTab = document.querySelector('.tab-button.active');
            if (!activeTab) return;
            
            const tabName = activeTab.id.replace('tab-', '');
            console.log(`ğŸ”„ æ›´æ–° ${tabName} é¡¯ç¤º`);
            
            switch(tabName) {
                case 'overview':
                    updateStats();
                    displayRecentActivity();
                    break;
                case 'bookings':
                    displayBookings(allData.bookings);
                    break;
                case 'partners':
                    displayPartners(allData.partners);
                    break;
                case 'payouts':
                    displayPayouts(allData.payouts);
                    break;
            }
        }

        // åˆ·æ–°ç‰¹å®šé¡å‹çš„æ•¸æ“šï¼ˆå¾å¾Œç«¯é‡æ–°è¼‰å…¥ï¼‰
        async function refreshData(dataType) {
            try {
                console.log(`ğŸ”„ åˆ·æ–° ${dataType} æ•¸æ“š...`);
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const newData = await response.json();
                
                if (newData.success && newData.data) {
                    // æ›´æ–°ç‰¹å®šé¡å‹çš„æ•¸æ“š
                    if (dataType === 'bookings' && newData.data.bookings) {
                        allData.bookings = normalizeBookings(newData.data.bookings);
                        displayBookings(allData.bookings);
                    } else if (dataType === 'payouts' && newData.data.payouts) {
                        allData.payouts = newData.data.payouts;
                        displayPayouts(allData.payouts);
                    } else if (dataType === 'partners' && newData.data.partners) {
                        allData.partners = newData.data.partners;
                        displayPartners(allData.partners);
                    }
                    console.log(`âœ… ${dataType} æ•¸æ“šå·²åˆ·æ–°`);
                }
            } catch (error) {
                console.error(`åˆ·æ–° ${dataType} å¤±æ•—:`, error);
            }
        }

        // çµ±ä¸€çš„ iframe è¡¨å–®æäº¤å‡½æ•¸ï¼ˆé¿å… CORS å•é¡Œï¼‰
        function submitToBackendViaForm(data) {
            // å‰µå»ºéš±è—çš„ iframe ä¾†æ¥æ”¶å›æ‡‰
            let iframe = document.getElementById('hiddenFrame');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.name = 'hiddenFrame';
                iframe.id = 'hiddenFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // å‰µå»ºè¡¨å–®
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = APPS_SCRIPT_URL;
            form.target = 'hiddenFrame';
            form.style.display = 'none';
            
            // æ·»åŠ æ•¸æ“šä½œç‚ºè¡¨å–®æ¬„ä½
            Object.keys(data).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = data[key] || '';
                form.appendChild(input);
            });
            
            // æäº¤è¡¨å–®
            document.body.appendChild(form);
            form.submit();
            
            // æ¸…ç†è¡¨å–®å…ƒç´ 
            setTimeout(() => {
                document.body.removeChild(form);
            }, 1000);
            
            console.log('ğŸ“¤ è¡¨å–®å·²æäº¤:', data);
        }

        // è¼”åŠ©å‡½æ•¸
        function getLevelClass(level) {
            const classes = {
                'LV1_INSIDER': 'bg-green-100 text-green-800',
                'LV2_GUIDE': 'bg-blue-100 text-blue-800',
                'LV3_GUARDIAN': 'bg-purple-100 text-purple-800'
            };
            return classes[level] || 'bg-gray-100 text-gray-800';
        }

        function getLevelText(level) {
            const texts = {
                'LV1_INSIDER': 'LV1 çŸ¥éŸ³å¤§ä½¿',
                'LV2_GUIDE': 'LV2 æ£®æ—åš®å°',
                'LV3_GUARDIAN': 'LV3 ç§˜å¢ƒå®ˆè­·è€…'
            };
            return texts[level] || level || 'LV1 çŸ¥éŸ³å¤§ä½¿';
        }

        function getNextLevelRequirement(level) {
            const requirements = {
                'LV1_INSIDER': 4,
                'LV2_GUIDE': 10,
                'LV3_GUARDIAN': 'âˆ'
            };
            return requirements[level] || 4;
        }

        function getPartnerClicks(partnerCode) {
            return allData.clicks.filter(click => click.partner_code === partnerCode).length;
        }

        function getStatusClass(status) {
            const classes = {
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'CHECKED_IN': 'bg-blue-100 text-blue-800',
                'COMPLETED': 'bg-green-100 text-green-800',
                'CANCELLED': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const texts = {
                'PENDING': 'å¾…å…¥ä½',
                'CHECKED_IN': 'å·²å…¥ä½',
                'COMPLETED': 'å·²å®Œæˆ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                return new Date(dateStr).toLocaleDateString('zh-TW');
            } catch (e) {
                return dateStr;
            }
        }

        function showLoadingSpinner(message) {
            console.log('Loading:', message);
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ å¯¦éš›çš„ loading UI
        }

        function hideLoadingSpinner() {
            console.log('Loading complete');
        }
        
        function showSuccessMessage(message) {
            console.log('âœ… Success:', message);
            // å‰µå»ºæˆåŠŸæç¤º
            const toast = createToast(message, 'success');
            document.body.appendChild(toast);
        }
        
        function showErrorMessage(message) {
            console.error('âŒ Error:', message);
            // å‰µå»ºéŒ¯èª¤æç¤º
            const toast = createToast(message, 'error');
            document.body.appendChild(toast);
        }
        
        function createToast(message, type) {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
            toast.textContent = message;
            
            // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
            
            return toast;
        }

        // åŠŸèƒ½æŒ‰éˆ•
        function refreshData() {
            location.reload();
        }

        function exportPartnersData() {
            const data = allData.partners.map(p => ({
                'å¤¥ä¼´ä»£ç¢¼': p.partner_code,
                'å§“å': p.name,
                'ç­‰ç´š': getLevelText(p.level),
                'æœ¬å¹´é€²åº¦': p.level_progress,
                'ç´¯ç©æ¨è–¦': p.total_successful_referrals,
                'å¯ç”¨é»æ•¸': (parseFloat(p.total_commission_earned) || 0) - (parseFloat(p.total_commission_paid) || 0),
                'å¾…æ”¯ä»˜ç¾é‡‘': p.pending_cash || p.pending_commission || 0
            }));
            
            downloadCSV(data, 'å¤¥ä¼´æ•¸æ“š.csv');
        }

        function downloadCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // æŸ¥çœ‹çµç®—è©³æƒ…
        function viewPayoutDetails(payoutId) {
            const payout = allData.payouts.find(p => p.id == payoutId);
            if (!payout) {
                alert('æ‰¾ä¸åˆ°çµç®—è¨˜éŒ„');
                return;
            }
            
            createPayoutDetailsModal(payout);
        }
        
        // å‰µå»ºçµç®—è©³æƒ…æ¨¡æ…‹æ¡†
        function createPayoutDetailsModal(payout) {
            // æ‰¾åˆ°ç›¸é—œçš„å¤¥ä¼´ä¿¡æ¯
            const partner = allData.partners.find(p => p.partner_code === payout.partner_code) || {};
            
            // æ‰¾åˆ°ç›¸é—œçš„è¨‚æˆ¿è¨˜éŒ„
            const relatedBookings = allData.bookings.filter(booking => {
                return booking.partner_code === payout.partner_code && 
                       booking.commission_status === 'CALCULATED';
            });
            
            const modal = document.createElement('div');
            modal.id = 'payoutDetailsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-2xl font-bold">çµç®—è©³æƒ…</h3>
                        <button onclick="closeModal('payoutDetailsModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- çµç®—åŸºæœ¬ä¿¡æ¯ -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-3">çµç®—åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">çµç®—IDï¼š</span>
                                <span class="font-medium">${payout.id || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">å¤§ä½¿ä»£ç¢¼ï¼š</span>
                                <span class="font-medium">${payout.partner_code}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">å¤§ä½¿å§“åï¼š</span>
                                <span class="font-medium">${partner.name || 'æœªè¨­å®š'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">ç­‰ç´šï¼š</span>
                                <span class="font-medium">${getLevelText(partner.level || '')}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">çµç®—é¡å‹ï¼š</span>
                                <span class="font-medium">${payout.payout_type === 'CASH' ? 'ç¾é‡‘' : 'ä½å®¿é‡‘'}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">çµç®—é‡‘é¡ï¼š</span>
                                <span class="font-medium text-lg text-green-600">$${(payout.amount || 0).toLocaleString()}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">ç‹€æ…‹ï¼š</span>
                                <span class="font-medium ${payout.payout_status === 'COMPLETED' ? 'text-green-600' : 'text-yellow-600'}">
                                    ${payout.payout_status === 'COMPLETED' ? 'å·²ä»˜æ¬¾' : 'å¾…ä»˜æ¬¾'}
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-600">å»ºç«‹æ™‚é–“ï¼š</span>
                                <span class="font-medium">${formatDateDisplay(payout.created_at) || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç›¸é—œè¨‚æˆ¿è¨˜éŒ„ -->
                    <div class="mb-6">
                        <h4 class="font-bold mb-3">ç›¸é—œè¨‚æˆ¿è¨˜éŒ„ (${relatedBookings.length}ç­†)</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left py-2 px-3 border">æˆ¿å®¢</th>
                                        <th class="text-center py-2 px-3 border">å…¥ä½æœŸé–“</th>
                                        <th class="text-center py-2 px-3 border">æˆ¿åƒ¹</th>
                                        <th class="text-center py-2 px-3 border">ä½£é‡‘</th>
                                        <th class="text-center py-2 px-3 border">é¡å‹</th>
                                        <th class="text-center py-2 px-3 border">ç¢ºèªæ™‚é–“</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${relatedBookings.map(booking => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="py-2 px-3 border">
                                                <div class="font-medium">${booking.guest_name}</div>
                                                <div class="text-xs text-gray-500">${booking.guest_phone}</div>
                                            </td>
                                            <td class="py-2 px-3 border text-center">
                                                <div>${formatDateDisplay(booking.checkin_date)}</div>
                                                <div class="text-xs text-gray-500">~ ${formatDateDisplay(booking.checkout_date)}</div>
                                            </td>
                                            <td class="py-2 px-3 border text-center font-medium">
                                                $${(booking.room_price || 0).toLocaleString()}
                                            </td>
                                            <td class="py-2 px-3 border text-center font-medium text-green-600">
                                                $${(booking.commission_amount || 0).toLocaleString()}
                                            </td>
                                            <td class="py-2 px-3 border text-center">
                                                ${booking.commission_type === 'CASH' ? 'ç¾é‡‘' : 'ä½å®¿é‡‘'}
                                            </td>
                                            <td class="py-2 px-3 border text-center text-xs">
                                                ${formatDateDisplay(booking.manually_confirmed_at) || '-'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="cancelPayout('${payout.id || payout.ID}')" 
                            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            ğŸš« å–æ¶ˆæ­¤çµç®—
                        </button>
                        <button type="button" onclick="editPayout('${payout.id || payout.ID}')" 
                            class="px-6 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                            âœï¸ ä¿®æ”¹çµç®—
                        </button>
                        <button type="button" onclick="closeModal('payoutDetailsModal')" 
                            class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generatePayoutReport() {
            createPayoutReportModal();
        }

        // æŸ¥çœ‹å¤¥ä¼´è©³æƒ…
        async function viewPartnerDetails(partnerCode) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            // å‰µå»ºæ¨¡æ…‹æ¡†é¡¯ç¤ºè©³ç´°è³‡è¨Š
            const modal = createPartnerModal(partner);
            document.body.appendChild(modal);
        }
        
        // å‰µå»ºå¤¥ä¼´è©³æƒ…æ¨¡æ…‹æ¡†
        function createPartnerModal(partner) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'partnerModal';
            
            const bookings = allData.bookings.filter(b => b.partner_code === partner.partner_code);
            const totalRevenue = bookings.reduce((sum, b) => sum + (b.room_price || 0), 0);
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">å¤¥ä¼´è©³æƒ…</h3>
                        <button onclick="closeModal('partnerModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">å¤¥ä¼´ä»£ç¢¼</p>
                                <p class="font-semibold">${partner.partner_code}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">å§“å</p>
                                <p class="font-semibold">${partner.name || 'æœªè¨­å®š'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Email</p>
                                <p class="font-semibold">${partner.email || 'æœªè¨­å®š'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">é›»è©±</p>
                                <p class="font-semibold">${partner.phone || 'æœªè¨­å®š'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç­‰ç´š</p>
                                <p class="font-semibold">${getLevelText(partner.level)}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æœ¬å¹´é€²åº¦</p>
                                <p class="font-semibold">${partner.level_progress || 0} / ${getNextLevelRequirement(partner.level)}</p>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold">ä½£é‡‘è³‡è¨Š</h4>
                                <button onclick="enableCommissionEdit('${partner.partner_code}')" 
                                        class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                                    ğŸ“ ç·¨è¼¯
                                </button>
                            </div>
                            <div id="commission-view-${partner.partner_code}" class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">å¯ç”¨é»æ•¸</p>
                                    <p class="font-semibold text-blue-600">${((parseFloat(partner.total_commission_earned) || 0) - (parseFloat(partner.total_commission_paid) || 0)).toLocaleString()} é»</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">å·²ä½¿ç”¨é»æ•¸</p>
                                    <p class="font-semibold text-gray-600">${(parseFloat(partner.total_commission_paid) || 0).toLocaleString()} é»</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">å¾…æ”¯ä»˜ç¾é‡‘</p>
                                    <p class="font-semibold text-amber-600">NT$ ${(partner.pending_cash || partner.pending_commission || 0).toLocaleString()}</p>
                                </div>
                            </div>
                            <div id="commission-edit-${partner.partner_code}" class="hidden space-y-3">
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-600">ç´¯ç©ä½£é‡‘</label>
                                        <input type="number" id="edit-total-earned-${partner.partner_code}" 
                                               value="${parseFloat(partner.total_commission_earned) || 0}"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">å·²ä½¿ç”¨é»æ•¸</label>
                                        <input type="number" id="edit-total-paid-${partner.partner_code}" 
                                               value="${parseFloat(partner.total_commission_paid) || 0}"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600">å¾…æ”¯ä»˜ç¾é‡‘</label>
                                        <input type="number" id="edit-pending-cash-${partner.partner_code}" 
                                               value="${parseFloat(partner.pending_cash || partner.pending_commission) || 0}"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-600">èª¿æ•´å‚™è¨»</label>
                                    <input type="text" id="edit-notes-${partner.partner_code}" 
                                           placeholder="è«‹èªªæ˜èª¿æ•´åŸå› ..."
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="saveCommissionEdit('${partner.partner_code}')" 
                                            class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600 transition-colors">
                                        âœ… å„²å­˜
                                    </button>
                                    <button onclick="cancelCommissionEdit('${partner.partner_code}')" 
                                            class="bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600 transition-colors">
                                        âŒ å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2">æ¨è–¦çµ±è¨ˆ</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">ç´¯ç©æ¨è–¦æ•¸</p>
                                    <p class="font-semibold">${partner.total_successful_referrals || 0}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">ç¸½è¨‚æˆ¿æ•¸</p>
                                    <p class="font-semibold">${bookings.length}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">ç¸½ç‡Ÿæ”¶è²¢ç»</p>
                                    <p class="font-semibold">$${totalRevenue.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2">é€£çµè³‡è¨Š</h4>
                            <div class="space-y-2">
                                ${partner.landing_link ? `
                                    <div>
                                        <p class="text-sm text-gray-600">æ¨å»£é€£çµ</p>
                                        <p class="text-xs break-all bg-gray-100 p-2 rounded">${partner.short_landing_link || partner.landing_link}</p>
                                    </div>
                                ` : ''}
                                ${partner.coupon_url ? `
                                    <div>
                                        <p class="text-sm text-gray-600">å„ªæƒ åˆ¸é€£çµ</p>
                                        <p class="text-xs break-all bg-gray-100 p-2 rounded">${partner.coupon_url}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2">ğŸ’° åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <p class="text-sm text-gray-600">éŠ€è¡Œåç¨±</p>
                                    <p class="font-semibold">${partner.bank_name || 'æœªè¨­å®š'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">éŠ€è¡Œä»£ç¢¼</p>
                                    <p class="font-semibold">${partner.bank_code || 'æœªè¨­å®š'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">åˆ†è¡Œ</p>
                                    <p class="font-semibold">${partner.bank_branch || 'æœªè¨­å®š'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">æˆ¶å</p>
                                    <p class="font-semibold">${partner.bank_account_name || 'æœªè¨­å®š'}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm text-gray-600">å¸³è™Ÿ</p>
                                    <p class="font-semibold">${partner.bank_account_number || 'æœªè¨­å®š'}</p>
                                </div>
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-3">ğŸ“‹ æ¨è–¦è¨‚å–®è¨˜éŒ„</h4>
                            ${bookings.length > 0 ? `
                                <div class="max-h-60 overflow-y-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="text-left p-2">æˆ¿å®¢</th>
                                                <th class="text-left p-2">å…¥ä½æœŸé–“</th>
                                                <th class="text-center p-2">æˆ¿åƒ¹</th>
                                                <th class="text-center p-2">ä½£é‡‘</th>
                                                <th class="text-center p-2">ç‹€æ…‹</th>
                                                <th class="text-center p-2">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${bookings.map(booking => {
                                                const statusClass = getStatusClass(booking.stay_status);
                                                const statusText = getStatusText(booking.stay_status);
                                                const expectedCommission = calculateExpectedCommission(partner.level, booking.room_price);
                                                const bookingIndex = allData.bookings.findIndex(b => b === booking);
                                                return `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2">
                                                            <div class="font-medium">${booking.guest_name}</div>
                                                            <div class="text-xs text-gray-500">${booking.guest_phone}</div>
                                                        </td>
                                                        <td class="p-2 text-xs">
                                                            <div>${booking.checkin_date}</div>
                                                            <div class="text-gray-500">~${booking.checkout_date}</div>
                                                        </td>
                                                        <td class="p-2 text-center font-medium">
                                                            $${(booking.room_price || 0).toLocaleString()}
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            ${booking.commission_amount ? `
                                                                <div class="text-green-600 font-medium">$${booking.commission_amount}</div>
                                                                <div class="text-xs text-gray-500">${booking.commission_type === 'CASH' ? 'ç¾é‡‘' : 'ä½å®¿é‡‘'}</div>
                                                            ` : `
                                                                <div class="text-blue-600 text-xs">
                                                                    <div>ç¾é‡‘:$${expectedCommission.cash}</div>
                                                                    <div>ä½å®¿:$${expectedCommission.accommodation}</div>
                                                                </div>
                                                            `}
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            <span class="px-1 py-0.5 rounded text-xs ${statusClass}">
                                                                ${statusText}
                                                            </span>
                                                        </td>
                                                        <td class="p-2 text-center">
                                                            <button onclick="viewBookingDetails(${bookingIndex})" 
                                                                class="text-blue-600 hover:underline text-xs">
                                                                è©³æƒ…
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div>
                                            <p class="text-gray-600">ç¸½è¨‚å–®æ•¸</p>
                                            <p class="font-semibold text-blue-600">${bookings.length}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">å·²å®Œæˆ</p>
                                            <p class="font-semibold text-green-600">${bookings.filter(b => b.stay_status === 'COMPLETED').length}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">ç¸½ç‡Ÿæ”¶è²¢ç»</p>
                                            <p class="font-semibold">$${totalRevenue.toLocaleString()}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600">å¯¦éš›ä½£é‡‘</p>
                                            <p class="font-semibold text-green-600">$${bookings.reduce((sum, b) => sum + (b.commission_amount || 0), 0).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center py-8 text-gray-500 bg-gray-50 rounded-lg">
                                    <p>å°šç„¡æ¨è–¦è¨‚å–®è¨˜éŒ„</p>
                                    <p class="text-sm mt-1">æ¨è–¦æˆåŠŸçš„è¨‚æˆ¿å°‡æœƒåœ¨æ­¤é¡¯ç¤º</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-4">
                            <button onclick="editPartner('${partner.partner_code}')" 
                                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ç·¨è¼¯è³‡æ–™
                            </button>
                            <button onclick="closeModal('partnerModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return modal;
        }
        
        // ç·¨è¼¯å¤¥ä¼´è³‡æ–™
        function editPartner(partnerCode) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            // é—œé–‰è©³æƒ…æ¨¡æ…‹æ¡†
            closeModal('partnerModal');
            
            // å‰µå»ºç·¨è¼¯æ¨¡æ…‹æ¡†
            const modal = createEditPartnerModal(partner);
            document.body.appendChild(modal);
        }
        
        // å‰µå»ºç·¨è¼¯å¤¥ä¼´æ¨¡æ…‹æ¡†
        function createEditPartnerModal(partner) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'editPartnerModal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold">ç·¨è¼¯å¤¥ä¼´è³‡æ–™</h3>
                        <button onclick="closeModal('editPartnerModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="editPartnerForm" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å¤¥ä¼´ä»£ç¢¼</label>
                            <input type="text" value="${partner.partner_code}" disabled 
                                class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å§“å</label>
                            <input type="text" id="editName" value="${partner.name || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="editEmail" value="${partner.email || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">é›»è©±</label>
                            <input type="tel" id="editPhone" value="${partner.phone || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ä½£é‡‘åå¥½</label>
                            <select id="editCommissionPref" class="mt-1 block w-full rounded-md border-gray-300">
                                <option value="CASH" ${partner.commission_preference === 'CASH' ? 'selected' : ''}>ç¾é‡‘</option>
                                <option value="ACCOMMODATION" ${partner.commission_preference === 'ACCOMMODATION' ? 'selected' : ''}>ä½å®¿</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2 border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3">ğŸ’° åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h4>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">éŠ€è¡Œåç¨±</label>
                            <input type="text" id="editBankName" value="${partner.bank_name || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">éŠ€è¡Œä»£ç¢¼</label>
                            <input type="text" id="editBankCode" value="${partner.bank_code || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">åˆ†è¡Œåç¨±</label>
                            <input type="text" id="editBankBranch" value="${partner.bank_branch || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æˆ¶å</label>
                            <input type="text" id="editBankAccountName" value="${partner.bank_account_name || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">å¸³è™Ÿ</label>
                            <input type="text" id="editBankAccountNumber" value="${partner.bank_account_number || ''}" 
                                class="mt-1 block w-full rounded-md border-gray-300">
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-4 col-span-2">
                            <button type="button" onclick="savePartnerEdit('${partner.partner_code}')" 
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                å„²å­˜è®Šæ›´
                            </button>
                            <button type="button" onclick="closeModal('editPartnerModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            return modal;
        }
        
        // å„²å­˜å¤¥ä¼´ç·¨è¼¯
        async function savePartnerEdit(partnerCode) {
            showSuccessMessage('å„²å­˜åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè³‡æ–™æš«æ™‚ä¿å­˜åœ¨æœ¬åœ°');
            
            // æ›´æ–°æœ¬åœ°æ•¸æ“šï¼ˆå¯¦éš›æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯ï¼‰
            const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
            if (partnerIndex !== -1) {
                allData.partners[partnerIndex] = {
                    ...allData.partners[partnerIndex],
                    name: document.getElementById('editName').value,
                    email: document.getElementById('editEmail').value,
                    phone: document.getElementById('editPhone').value,
                    commission_preference: document.getElementById('editCommissionPref').value,
                    bank_name: document.getElementById('editBankName').value,
                    bank_code: document.getElementById('editBankCode').value,
                    bank_branch: document.getElementById('editBankBranch').value,
                    bank_account_name: document.getElementById('editBankAccountName').value,
                    bank_account_number: document.getElementById('editBankAccountNumber').value
                };
                
                // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
                displayPartners(allData.partners);
            }
            
            closeModal('editPartnerModal');
        }


        // æŸ¥çœ‹çµç®—è©³æƒ…
        function viewPayoutDetails(payoutId) {
            console.log('ğŸ” æŸ¥æ‰¾çµç®—è¨˜éŒ„ ID:', payoutId);
            console.log('ğŸ“‹ æ‰€æœ‰ payouts æ•¸æ“š:', allData.payouts);
            
            if (!allData.payouts || allData.payouts.length === 0) {
                showErrorMessage('ç³»çµ±ä¸­ç„¡ä»»ä½•çµç®—è¨˜éŒ„');
                return;
            }
            
            // å˜—è©¦å¤šç¨®åŒ¹é…æ–¹å¼
            let payout = allData.payouts.find(p => p.id == payoutId);
            
            if (!payout) {
                // å˜—è©¦ç´¢å¼•åŒ¹é…
                const payoutIndex = parseInt(payoutId);
                if (!isNaN(payoutIndex) && payoutIndex >= 0 && payoutIndex < allData.payouts.length) {
                    payout = allData.payouts[payoutIndex];
                    console.log('âœ… é€šéç´¢å¼•æ‰¾åˆ°çµç®—è¨˜éŒ„:', payout);
                }
            }
            
            if (!payout) {
                console.error('âŒ æ‰¾ä¸åˆ°çµç®—è¨˜éŒ„ï¼ŒID:', payoutId);
                console.error('å¯ç”¨çš„ payout IDs:', allData.payouts.map(p => p.id));
                showErrorMessage(`æ‰¾ä¸åˆ°çµç®—è¨˜éŒ„ (ID: ${payoutId})ã€‚è«‹é‡æ–°è¼‰å…¥æ•¸æ“šå¾Œå†è©¦ã€‚`);
                return;
            }
            
            console.log('âœ… æ‰¾åˆ°çµç®—è¨˜éŒ„:', payout);
            createPayoutDetailsModal(payout);
        }
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // é¡¯ç¤ºè³‡æ–™åº«ä¿®å¾©æç¤º
        function showDatabaseFixAlert() {
            // é¿å…é‡è¤‡é¡¯ç¤º
            if (document.getElementById('dbFixAlert')) return;
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'dbFixAlert';
            alertDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50 max-w-md';
            alertDiv.innerHTML = `
                <div>
                    <h4 class="font-bold">âš ï¸ è³‡æ–™åº«çµæ§‹éŒ¯èª¤</h4>
                    <p class="text-sm mt-1">æª¢æ¸¬åˆ° Google Sheets æ¬„ä½é †åºä¸æ­£ç¢ºï¼Œé€™æœƒå°è‡´ä½£é‡‘é¡¯ç¤ºéŒ¯èª¤ã€‚</p>
                    <div class="mt-3 space-x-2">
                        <button onclick="diagnoseDatabase()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">
                            ğŸ” è¨ºæ–·
                        </button>
                        <button onclick="fixDatabase()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                            ğŸ”§ ä¿®å¾©
                        </button>
                        <button onclick="closeDatabaseAlert()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
        }

        // è¨ºæ–·è³‡æ–™åº«
        async function diagnoseDatabase() {
            try {
                const formData = new URLSearchParams();
                formData.append('action', 'diagnose_bookings');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });

                const result = await response.text();
                const data = JSON.parse(result);
                
                if (data.success) {
                    alert('âœ… è¨ºæ–·å®Œæˆï¼è«‹åˆ° Google Apps Script æ§åˆ¶å°æŸ¥çœ‹è©³ç´°æ—¥èªŒã€‚');
                } else {
                    alert('âŒ è¨ºæ–·å¤±æ•—ï¼š' + data.error);
                }
            } catch (error) {
                alert('âŒ è¨ºæ–·éŒ¯èª¤ï¼š' + error.message);
            }
        }

        // ä¿®å¾©è³‡æ–™åº«çµæ§‹
        async function fixDatabase() {
            // é¡¯ç¤ºæ‰‹å‹•ä¿®å¾©èªªæ˜
            showManualFixInstructions();
        }

        // é¡¯ç¤ºæ‰‹å‹•ä¿®å¾©èªªæ˜
        function showManualFixInstructions() {
            const modal = document.createElement('div');
            modal.id = 'manualFixModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-red-600">ğŸ”§ æ‰‹å‹•ä¿®å¾© Google Sheets çµæ§‹</h3>
                        <button onclick="closeModal('manualFixModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm"><strong>å•é¡Œï¼š</strong>Google Sheets çš„ Bookings è¡¨æ ¼æ¬„ä½é †åºä¸æ­£ç¢ºï¼Œå°è‡´ä½£é‡‘é¡¯ç¤ºéŒ¯èª¤ã€‚</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold mb-2">ğŸ“‹ ä¿®å¾©æ­¥é©Ÿï¼š</h4>
                            <ol class="list-decimal list-inside space-y-2 text-sm">
                                <li>æ‰“é–‹æ‚¨çš„ Google Sheetsï¼š<br>
                                    <a href="https://docs.google.com/spreadsheets/d/1buMGx7T1SFnOIygylkqQURUDFsHGidXcQ-k3kx3Xmn4/edit" target="_blank" class="text-blue-600 underline">é»æ“Šé€™è£¡æ‰“é–‹</a>
                                </li>
                                <li>æ‰¾åˆ° "Bookings" å·¥ä½œè¡¨</li>
                                <li>åˆªé™¤ç¬¬ä¸€è¡Œï¼ˆæ¨™é¡Œè¡Œï¼‰</li>
                                <li>åœ¨ A1 å„²å­˜æ ¼é–‹å§‹ï¼Œä¾åºè¼¸å…¥ä»¥ä¸‹æ¨™é¡Œï¼š</li>
                            </ol>
                        </div>
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold mb-2">ğŸ“ æ­£ç¢ºçš„æ¨™é¡Œè¡Œï¼ˆè«‹ä¾åºè¤‡è£½åˆ° A1:U1ï¼‰ï¼š</h4>
                            <div class="bg-white border rounded p-2 text-xs font-mono">
                                <div class="grid grid-cols-3 gap-1">
                                    <div>A1: id</div>
                                    <div>B1: partner_code</div>
                                    <div>C1: guest_name</div>
                                    <div>D1: guest_phone</div>
                                    <div>E1: guest_email</div>
                                    <div>F1: checkin_date</div>
                                    <div>G1: checkout_date</div>
                                    <div>H1: room_price</div>
                                    <div>I1: booking_source</div>
                                    <div>J1: stay_status</div>
                                    <div>K1: payment_status</div>
                                    <div>L1: commission_status</div>
                                    <div>M1: commission_amount</div>
                                    <div>N1: commission_type</div>
                                    <div>O1: is_first_referral_bonus</div>
                                    <div>P1: first_referral_bonus_amount</div>
                                    <div>Q1: manually_confirmed_by</div>
                                    <div>R1: manually_confirmed_at</div>
                                    <div>S1: notes</div>
                                    <div>T1: created_at</div>
                                    <div>U1: updated_at</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-bold mb-2">âš ï¸ é‡è¦æé†’ï¼š</h4>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                <li>ä¿®å¾©å¾Œéœ€è¦æ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„è¨‚æˆ¿è³‡æ–™è¡Œï¼ˆä¿ç•™æ¨™é¡Œè¡Œï¼‰</li>
                                <li>æˆ–è€…æ‚¨å¯ä»¥å˜—è©¦é‡æ–°æ’åˆ—ç¾æœ‰è³‡æ–™ä»¥ç¬¦åˆæ–°çš„æ¬„ä½é †åº</li>
                                <li>å»ºè­°å…ˆå‚™ä»½ç¾æœ‰è³‡æ–™</li>
                            </ul>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4">
                            <button onclick="copyHeadersToClipboard()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                ğŸ“‹ è¤‡è£½æ¨™é¡Œåˆ°å‰ªè²¼æ¿
                            </button>
                            <button onclick="closeModal('manualFixModal')" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // è¤‡è£½æ¨™é¡Œåˆ°å‰ªè²¼æ¿
        async function copyHeadersToClipboard() {
            const headers = 'id\tpartner_code\tguest_name\tguest_phone\tguest_email\tcheckin_date\tcheckout_date\troom_price\tbooking_source\tstay_status\tpayment_status\tcommission_status\tcommission_amount\tcommission_type\tis_first_referral_bonus\tfirst_referral_bonus_amount\tmanually_confirmed_by\tmanually_confirmed_at\tnotes\tcreated_at\tupdated_at';
            
            try {
                await navigator.clipboard.writeText(headers);
                alert('âœ… æ¨™é¡Œå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼æ‚¨å¯ä»¥åœ¨ Google Sheets ä¸­é¸æ“‡ A1:U1 ç¯„åœå¾Œè²¼ä¸Šã€‚');
            } catch (error) {
                // å‚™ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = headers;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… æ¨™é¡Œå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼æ‚¨å¯ä»¥åœ¨ Google Sheets ä¸­é¸æ“‡ A1:U1 ç¯„åœå¾Œè²¼ä¸Šã€‚');
            }
        }

        // é—œé–‰è³‡æ–™åº«æç¤º
        function closeDatabaseAlert() {
            const alert = document.getElementById('dbFixAlert');
            if (alert) {
                alert.remove();
            }
        }

        // å‰µå»ºæˆ–ç²å–éš±è—çš„ iframeï¼ˆçµ±ä¸€è™•ç† 403 éŒ¯èª¤ï¼‰
        function getOrCreateHiddenIframe() {
            let iframe = document.getElementById('hiddenFrame');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.name = 'hiddenFrame';
                iframe.id = 'hiddenFrame';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            return iframe;
        }

        // è¨ˆç®—é æœŸä½£é‡‘
        function calculateExpectedCommission(level, roomPrice) {
            const commissionRates = {
                'LV1_INSIDER': { accommodation: 1000, cash: 500 },
                'LV2_GUIDE': { accommodation: 1200, cash: 600 },
                'LV3_GUARDIAN': { accommodation: 1500, cash: 750 }
            };
            
            return commissionRates[level] || { accommodation: 0, cash: 0 };
        }

        // ç¢ºèªå…¥ä½å®Œæˆ
        async function confirmStayCompletion(bookingIndex) {
            const booking = allData.bookings[bookingIndex];
            if (!booking) {
                alert('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„');
                return;
            }
            
            console.log('ğŸ” é–‹å§‹ç¢ºèªå…¥ä½æµç¨‹ï¼Œè¨‚æˆ¿ç´¢å¼•:', bookingIndex);
            console.log('ğŸ“‹ è¨‚æˆ¿è³‡æ–™:', booking);

            const partner = booking.partner_code ? allData.partners.find(p => p.partner_code === booking.partner_code) : null;
            if (!partner) {
                if (confirm('æ­¤è¨‚æˆ¿æ²’æœ‰æ¨è–¦å¤§ä½¿ï¼Œæ˜¯å¦ç¢ºèªå®Œæˆå…¥ä½ï¼Ÿ')) {
                    await updateBookingStatus(booking, 'COMPLETED', null);
                }
                return;
            }

            const expectedCommission = calculateExpectedCommission(partner.level, booking.room_price);
            
            // ç°¡åŒ–æµç¨‹ï¼šçµ±ä¸€å…ˆçµ¦ä½å®¿é‡‘ï¼Œå¾ŒçºŒå¯ä»¥è‡ªè¡Œè½‰æ›ç‚ºç¾é‡‘
            const confirmed = confirm(`ç¢ºèª ${booking.guest_name} å®Œæˆå…¥ä½ï¼Ÿ\n\næ¨è–¦å¤§ä½¿ï¼š${booking.partner_code} (${partner.name})\nä½£é‡‘ï¼š$${expectedCommission.accommodation} ä½å®¿é‡‘\n\nï¼ˆå¤§ä½¿å¾ŒçºŒå¯è‡ªè¡Œæ±ºå®šæ˜¯å¦è½‰æ›ç‚ºç¾é‡‘ï¼‰`);

            if (confirmed) {
                await updateBookingStatus(booking, 'COMPLETED', {
                    commission_amount: expectedCommission.accommodation,
                    commission_type: 'ACCOMMODATION',
                    partner_code: booking.partner_code
                });
            }
        }

        // æ›´æ–°è¨‚æˆ¿ç‹€æ…‹ï¼ˆç¢ºèªå…¥ä½å®Œæˆï¼‰
        async function updateBookingStatus(booking, status, commissionData) {
            try {
                console.log('ğŸ” æº–å‚™ç¢ºèªå…¥ä½çš„è¨‚æˆ¿è³‡æ–™:', booking);
                console.log('ğŸ” ä½£é‡‘è³‡æ–™:', commissionData);
                
                // ä½¿ç”¨ BookingDataManager æ¨™æº–åŒ– booking æ•¸æ“š
                const normalizedBooking = BookingDataManager.normalizeBooking(booking);
                console.log('ğŸ”§ æ¨™æº–åŒ–å¾Œçš„è¨‚æˆ¿è³‡æ–™:', normalizedBooking);

                // æº–å‚™æ›´æ–°æ•¸æ“šï¼ˆåŒ…å«ç‹€æ…‹è®Šæ›´å’Œä½£é‡‘è³‡æ–™ï¼‰
                const updateFields = {
                    stay_status: status,
                    ...commissionData
                };

                // ä½¿ç”¨ BookingDataManager æ›´æ–°æ•¸æ“š
                const updatedBooking = BookingDataManager.updateBooking(normalizedBooking, updateFields);
                console.log('ğŸ”§ æ›´æ–°å¾Œçš„å®Œæ•´æ•¸æ“š:', updatedBooking);

                // æº–å‚™æäº¤åˆ°å¾Œç«¯çš„æ•¸æ“š
                const submitData = {
                    action: 'confirm_checkin_completion',
                    booking_id: normalizedBooking.id || '', 
                    // åŒ…å«å®Œæ•´çš„æ¨™æº–åŒ– booking æ•¸æ“šç”¨æ–¼è­˜åˆ¥å’Œæ›´æ–°
                    ...updatedBooking
                };
                
                console.log('ğŸ“¤ ç™¼é€åˆ°å¾Œç«¯çš„æ¨™æº–åŒ–è³‡æ–™:', submitData);

                // ä½¿ç”¨ BookingDataManager å‰µå»ºæ¨™æº–åŒ–åƒæ•¸
                const formData = BookingDataManager.createOrderedParams(submitData);
                console.log('ğŸ“¤ ç¢ºèªå…¥ä½ - æŒ‰æ¨™æº–é †åºç™¼é€çš„åƒæ•¸:', formData.toString());

                console.log('ğŸŒ ç™¼é€è«‹æ±‚åˆ°:', APPS_SCRIPT_URL);
                console.log('ğŸ“¤ è«‹æ±‚å…§å®¹:', formData.toString());

                // ä½¿ç”¨è¡¨å–®æäº¤é¿å… CORS å•é¡Œ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // æ·»åŠ æ‰€æœ‰åƒæ•¸ä½œç‚ºéš±è—è¼¸å…¥
                for (const [key, value] of formData.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                // å‰µå»ºéš±è—çš„ iframe ä¾†æ¥æ”¶å›æ‡‰
                const iframe = getOrCreateHiddenIframe();

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                console.log('ğŸ“¡ è¡¨å–®å·²æäº¤ï¼Œä½¿ç”¨éš±è— iframe æ¥æ”¶å›æ‡‰');
                
                // è¦–ç‚ºæˆåŠŸï¼Œå› ç‚ºè¡¨å–®æäº¤ç„¡æ³•ç²å¾—è©³ç´°å›æ‡‰
                const responseData = { success: true };
                
                if (responseData.success === false) {
                    throw new Error(responseData.error || 'ç¢ºèªå…¥ä½å¤±æ•—');
                }
                
                // ç«‹å³æ›´æ–°å‰ç«¯æ•¸æ“š
                console.log('ğŸ”„ ç¢ºèªå…¥ä½å®Œæˆï¼Œæ›´æ–°å‰ç«¯æ•¸æ“š...', booking.guest_name, booking.guest_phone);
                
                // ç”±æ–¼ booking.id ç‚ºç©ºï¼Œä½¿ç”¨ guest_name + guest_phone ä¾†æ‰¾åˆ°å°æ‡‰è¨˜éŒ„
                const bookingIndex = allData.bookings.findIndex(b => 
                    b.guest_name === booking.guest_name && 
                    String(b.guest_phone) === String(booking.guest_phone) &&
                    b.checkin_date === booking.checkin_date
                );
                console.log('ğŸ“ æ ¹æ“šå§“å+é›»è©±+å…¥ä½æ—¥æœŸæ‰¾åˆ°è¨‚æˆ¿ç´¢å¼•:', bookingIndex);
                
                if (bookingIndex !== -1) {
                    const oldStatus = allData.bookings[bookingIndex].stay_status;
                    allData.bookings[bookingIndex].stay_status = 'COMPLETED';
                    allData.bookings[bookingIndex].updated_at = new Date().toISOString();
                    console.log('âœ… å·²æ›´æ–°è¨‚æˆ¿ç‹€æ…‹:', oldStatus, 'â†’ COMPLETED');
                    
                    if (commissionData) {
                        allData.bookings[bookingIndex].commission_amount = commissionData.commission_amount;
                        allData.bookings[bookingIndex].commission_type = commissionData.commission_type;
                        allData.bookings[bookingIndex].commission_status = 'CALCULATED';
                        console.log('ğŸ’° å·²æ›´æ–°ä½£é‡‘è³‡è¨Š:', commissionData);
                    }
                    
                    // ç«‹å³åˆ·æ–°é¡¯ç¤º
                    console.log('ğŸ”„ é‡æ–°é¡¯ç¤ºè¨‚æˆ¿åˆ—è¡¨...');
                    displayBookings(allData.bookings);
                    
                    showSuccessMessage('âœ… å…¥ä½ç¢ºèªå®Œæˆï¼' + (commissionData ? ' ä½£é‡‘å·²è¨ˆç®—ã€‚' : ''));
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°å°æ‡‰çš„è¨‚æˆ¿è¨˜éŒ„');
                    // å¦‚æœæ‰¾ä¸åˆ°è¨˜éŒ„ï¼Œè¡¨ç¤ºå¯èƒ½æœ‰æ•¸æ“šåŒæ­¥å•é¡Œï¼Œæ­¤æ™‚æ‰é‡æ–°è¼‰å…¥
                    showSuccessMessage('âœ… ç¢ºèªè«‹æ±‚å·²ç™¼é€ï¼Œæ­£åœ¨é‡æ–°è¼‰å…¥æ•¸æ“š...');
                    setTimeout(() => {
                        loadRealData().then(() => {
                            displayBookings(allData.bookings);
                            console.log('âœ… æ•¸æ“šé‡è¼‰å®Œæˆ');
                        });
                    }, 1000);
                }
            } catch (error) {
                console.error('âŒ æ›´æ–°è¨‚æˆ¿ç‹€æ…‹å¤±æ•—:', error);
                
                if (error.message.includes('403')) {
                    // 403 éŒ¯èª¤ç‰¹æ®Šè™•ç†
                    showErrorMessage(`âŒ Google Apps Script æ¬Šé™éŒ¯èª¤ (403)\n\nå¯èƒ½åŸå› ï¼š\n1. Apps Script éƒ¨ç½²æ¬Šé™è¨­å®šä¸æ­£ç¢º\n2. éœ€è¦é‡æ–°æˆæ¬Šæ‡‰ç”¨ç¨‹å¼\n3. éƒ¨ç½² URL å·²éæœŸ\n\nè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿä¿®å¾©ï¼š\n1. å‰å¾€ Google Apps Script æ§åˆ¶å°\n2. é‡æ–°éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼\n3. è¨­å®šåŸ·è¡Œèº«åˆ†ç‚ºã€Œæˆ‘ã€\n4. è¨­å®šå­˜å–æ¬Šé™ç‚ºã€Œä»»ä½•äººã€\n5. æ›´æ–°å‰ç«¯çš„ APPS_SCRIPT_URL`);
                    
                    // æä¾›å¿«é€Ÿé€£çµåˆ°ä¿®å¾©æŒ‡å—
                    const fixGuideBtn = document.createElement('button');
                    fixGuideBtn.textContent = 'ğŸ”§ æŸ¥çœ‹ä¿®å¾©æŒ‡å—';
                    fixGuideBtn.className = 'mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700';
                    fixGuideBtn.onclick = () => {
                        window.open('./google-apps-script-fix.html', '_blank');
                    };
                    
                    // å¦‚æœæœ‰éŒ¯èª¤é¡¯ç¤ºå€åŸŸï¼Œæ·»åŠ æŒ‰éˆ•
                    const errorDisplay = document.querySelector('.error-message');
                    if (errorDisplay) {
                        errorDisplay.appendChild(fixGuideBtn);
                    }
                } else {
                    showErrorMessage('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
                }
            }
        }

        // æŸ¥çœ‹è¨‚æˆ¿è©³æƒ…
        function viewBookingDetails(bookingIndex) {
            const booking = allData.bookings[bookingIndex];
            if (!booking) {
                alert('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„');
                return;
            }

            const partner = booking.partner_code ? allData.partners.find(p => p.partner_code === booking.partner_code) : null;
            const expectedCommission = partner ? calculateExpectedCommission(partner.level, booking.room_price) : null;

            const modal = document.createElement('div');
            modal.id = 'bookingDetailsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">è¨‚æˆ¿è©³æƒ… #${bookingIndex + 1}</h3>
                        <button onclick="closeModal('bookingDetailsModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æˆ¿å®¢å§“å</label>
                                <p class="text-lg">${booking.guest_name}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±</label>
                                <p>${booking.guest_phone || '-'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶</label>
                                <p>${booking.guest_email || '-'}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æˆ¿åƒ¹</label>
                                <p class="text-lg font-semibold">$${(booking.room_price || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å…¥ä½æ—¥æœŸ</label>
                                <p>${booking.checkin_date}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">é€€æˆ¿æ—¥æœŸ</label>
                                <p>${booking.checkout_date}</p>
                            </div>
                        </div>

                        ${partner ? `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">æ¨è–¦å¤§ä½¿è³‡è¨Š</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">å¤§ä½¿ä»£ç¢¼</label>
                                        <p class="font-medium text-green-700">${partner.partner_code}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">å¤§ä½¿å§“å</label>
                                        <p>${partner.name}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">å¤§ä½¿ç­‰ç´š</label>
                                        <p>${getLevelText(partner.level)}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">è¯çµ¡æ–¹å¼</label>
                                        <p class="text-sm">${partner.phone || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-600">æ­¤è¨‚æˆ¿ç„¡æ¨è–¦å¤§ä½¿</p>
                            </div>
                        `}

                        ${expectedCommission ? `
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">ä½£é‡‘è³‡è¨Š</h4>
                                ${booking.commission_amount ? `
                                    <div class="text-green-600">
                                        <p class="font-semibold">âœ… å¯¦éš›ä½£é‡‘ï¼š$${booking.commission_amount}</p>
                                        <p class="text-sm">é¡å‹ï¼š${booking.commission_type === 'CASH' ? 'ç¾é‡‘' : 'ä½å®¿é‡‘'}</p>
                                    </div>
                                ` : `
                                    <div>
                                        <p class="font-medium text-blue-600">é è¨ˆä½£é‡‘ï¼š</p>
                                        <p class="text-sm">ä½å®¿é‡‘ï¼š$${expectedCommission.accommodation}</p>
                                        <p class="text-sm text-gray-600">ï¼ˆå¯è½‰æ›ç¾é‡‘ï¼š$${expectedCommission.cash}ï¼‰</p>
                                    </div>
                                `}
                            </div>
                        ` : ''}

                        ${booking.notes ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                                <p class="bg-gray-50 p-3 rounded">${booking.notes}</p>
                            </div>
                        ` : ''}

                        <div class="flex justify-end space-x-2 pt-4">
                            <button onclick="closeModal('bookingDetailsModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // ç·¨è¼¯è¨‚å–®
        function editBooking(bookingIndex) {
            const booking = allData.bookings[bookingIndex];
            if (!booking) {
                alert('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„');
                return;
            }

            const modal = createBookingEditModal(booking, bookingIndex);
            document.body.appendChild(modal);
        }

        // å‰µå»ºè¨‚å–®ç·¨è¼¯æ¨¡æ…‹æ¡†
        function createBookingEditModal(booking, bookingIndex) {
            // æ ¼å¼åŒ–æ—¥æœŸç‚º HTML date input éœ€è¦çš„æ ¼å¼
            const formatDateForInput = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.getFullYear() + '-' + 
                       String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(date.getDate()).padStart(2, '0');
            };
            
            const modal = document.createElement('div');
            modal.id = 'editBookingModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const partnersOptions = allData.partners.map(partner => 
                `<option value="${partner.partner_code}" ${booking.partner_code === partner.partner_code ? 'selected' : ''}>
                    ${partner.partner_code} - ${partner.name || 'æœªè¨­å®š'} (${getLevelText(partner.level)})
                </option>`
            ).join('');

            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-2xl font-bold">ç·¨è¼¯è¨‚å–® #${booking.id || (bookingIndex + 1)}</h3>
                        <button onclick="closeModal('editBookingModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="editBookingForm" class="space-y-6">
                        <!-- æˆ¿å®¢åŸºæœ¬è³‡è¨Š -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-blue-800">ğŸ‘¤ æˆ¿å®¢è³‡è¨Š</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æˆ¿å®¢å§“å *</label>
                                    <input type="text" id="edit_guest_name" value="${booking.guest_name || ''}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡é›»è©± *</label>
                                    <input type="tel" id="edit_guest_phone" value="${booking.guest_phone || ''}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶</label>
                                    <input type="email" id="edit_guest_email" value="${booking.guest_email || ''}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ’³ åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼</label>
                                    <input type="text" id="edit_bank_account_last5" value="${booking.bank_account_last5 || ''}" 
                                        maxlength="5" pattern="[0-9]{5}"
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                                        placeholder="ä¾‹ï¼š12345">
                                </div>
                            </div>
                        </div>

                        <!-- æ¨è–¦å¤§ä½¿è³‡è¨Š -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-green-800">ğŸ¤ æ¨è–¦å¤§ä½¿</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨è–¦å¤§ä½¿</label>
                                    <select id="edit_partner_code" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-green-500"
                                        onchange="updatePartnerInfo()">
                                        <option value="">ç„¡æ¨è–¦å¤§ä½¿</option>
                                        ${partnersOptions}
                                    </select>
                                </div>
                                <div id="editPartnerInfo" class="text-sm">
                                    ${booking.partner_code ? getPartnerInfoHtml(booking.partner_code) : '<p class="text-gray-500">ç„¡æ¨è–¦å¤§ä½¿</p>'}
                                </div>
                            </div>
                        </div>

                        <!-- ä½å®¿è³‡è¨Š -->
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-amber-800">ğŸ  ä½å®¿è³‡è¨Š</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å…¥ä½æ—¥æœŸ *</label>
                                    <input type="date" id="edit_checkin_date" value="${formatDateForInput(booking.checkin_date)}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-amber-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">é€€æˆ¿æ—¥æœŸ *</label>
                                    <input type="date" id="edit_checkout_date" value="${formatDateForInput(booking.checkout_date)}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-amber-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æˆ¿åƒ¹ *</label>
                                    <input type="number" id="edit_room_price" value="${booking.room_price || ''}" 
                                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-amber-500" 
                                        min="0" step="1" required onchange="updateCommissionPreview()">
                                </div>
                                <div id="commissionPreview" class="flex items-center">
                                    ${getCommissionPreviewHtml(booking)}
                                </div>
                            </div>
                        </div>

                        <!-- ç‹€æ…‹è¨­å®š -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-800">ğŸ“Š è¨‚å–®ç‹€æ…‹</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å…¥ä½ç‹€æ…‹</label>
                                    <select id="edit_stay_status" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-gray-500">
                                        <option value="PENDING" ${booking.stay_status === 'PENDING' ? 'selected' : ''}>å¾…å…¥ä½</option>
                                        <option value="CHECKED_IN" ${booking.stay_status === 'CHECKED_IN' ? 'selected' : ''}>å·²å…¥ä½</option>
                                        <option value="COMPLETED" ${booking.stay_status === 'COMPLETED' ? 'selected' : ''}>å·²å®Œæˆ</option>
                                        <option value="CANCELLED" ${booking.stay_status === 'CANCELLED' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»˜æ¬¾ç‹€æ…‹</label>
                                    <select id="edit_payment_status" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-gray-500">
                                        <option value="PENDING" ${booking.payment_status === 'PENDING' ? 'selected' : ''}>å¾…ä»˜æ¬¾</option>
                                        <option value="PARTIAL" ${booking.payment_status === 'PARTIAL' ? 'selected' : ''}>éƒ¨åˆ†ä»˜æ¬¾</option>
                                        <option value="PAID" ${booking.payment_status === 'PAID' ? 'selected' : ''}>å·²ä»˜æ¸…</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- å‚™è¨» -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                            <textarea id="edit_notes" rows="3" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                                placeholder="è¨‚å–®ç›¸é—œå‚™è¨»...">${booking.notes || ''}</textarea>
                        </div>

                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeModal('editBookingModal')" 
                                class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                å–æ¶ˆ
                            </button>
                            <button type="button" onclick="deleteBooking(${bookingIndex})" 
                                class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                åˆªé™¤è¨‚å–®
                            </button>
                            <button type="submit" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                å„²å­˜è®Šæ›´
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // æ·»åŠ è¡¨å–®æäº¤äº‹ä»¶ç›£è½å™¨
            const form = modal.querySelector('#editBookingForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                // ä½¿ç”¨ booking.id æˆ– bookingIndex ä½œç‚ºæ¨™è­˜ç¬¦
                const bookingIdentifier = booking.id || bookingIndex;
                saveBookingChanges(bookingIdentifier);
            });

            return modal;
        }

        // ç²å–å¤§ä½¿è³‡è¨ŠHTML
        function getPartnerInfoHtml(partnerCode) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) return '<p class="text-gray-500">ç„¡æ¨è–¦å¤§ä½¿</p>';
            
            const expectedCommission = calculateExpectedCommission(partner.level, 0);
            return `
                <div>
                    <p class="font-medium text-green-700">${partner.name || 'æœªè¨­å®šå§“å'}</p>
                    <p class="text-xs text-gray-600">${getLevelText(partner.level)}</p>
                    <p class="text-xs text-gray-600">é›»è©±ï¼š${partner.phone || 'æœªè¨­å®š'}</p>
                    <p class="text-xs text-blue-600">ä½£é‡‘ï¼šä½å®¿é‡‘ $${expectedCommission.accommodation}ï¼ˆå¯è½‰æ›ç¾é‡‘ $${expectedCommission.cash}ï¼‰</p>
                </div>
            `;
        }

        // ç²å–ä½£é‡‘é è¦½HTML
        function getCommissionPreviewHtml(booking) {
            if (!booking.partner_code) return '<p class="text-sm text-gray-500">ç„¡ä½£é‡‘</p>';
            
            const partner = allData.partners.find(p => p.partner_code === booking.partner_code);
            if (!partner) return '<p class="text-sm text-gray-500">å¤§ä½¿ä¸å­˜åœ¨</p>';
            
            const expectedCommission = calculateExpectedCommission(partner.level, booking.room_price || 0);
            return `
                <div class="text-sm">
                    <p class="font-medium text-blue-700">é è¨ˆä½£é‡‘</p>
                    <p class="text-xs text-blue-600">ä½å®¿é‡‘ï¼š$${expectedCommission.accommodation}</p>
                    <p class="text-xs text-gray-500">ï¼ˆå¯è½‰æ›ç¾é‡‘ï¼š$${expectedCommission.cash}ï¼‰</p>
                </div>
            `;
        }

        // æ›´æ–°å¤§ä½¿è³‡è¨Šé¡¯ç¤º
        function updatePartnerInfo() {
            const partnerCode = document.getElementById('edit_partner_code').value;
            const infoDiv = document.getElementById('editPartnerInfo');
            
            if (partnerCode) {
                infoDiv.innerHTML = getPartnerInfoHtml(partnerCode);
            } else {
                infoDiv.innerHTML = '<p class="text-gray-500">ç„¡æ¨è–¦å¤§ä½¿</p>';
            }
            
            // åŒæ™‚æ›´æ–°ä½£é‡‘é è¦½
            updateCommissionPreview();
        }

        // æ›´æ–°ä½£é‡‘é è¦½
        function updateCommissionPreview() {
            const partnerCode = document.getElementById('edit_partner_code').value;
            const roomPrice = parseFloat(document.getElementById('edit_room_price').value) || 0;
            const previewDiv = document.getElementById('commissionPreview');
            
            if (!partnerCode) {
                previewDiv.innerHTML = '<p class="text-sm text-gray-500">ç„¡ä½£é‡‘</p>';
                return;
            }
            
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                previewDiv.innerHTML = '<p class="text-sm text-gray-500">å¤§ä½¿ä¸å­˜åœ¨</p>';
                return;
            }
            
            const expectedCommission = calculateExpectedCommission(partner.level, roomPrice);
            previewDiv.innerHTML = `
                <div class="text-sm">
                    <p class="font-medium text-blue-700">é è¨ˆä½£é‡‘</p>
                    <p class="text-xs text-blue-600">ä½å®¿é‡‘ï¼š$${expectedCommission.accommodation}</p>
                    <p class="text-xs text-gray-500">ï¼ˆå¯è½‰æ›ç¾é‡‘ï¼š$${expectedCommission.cash}ï¼‰</p>
                </div>
            `;
        }

        // å„²å­˜è¨‚å–®è®Šæ›´
        async function saveBookingChanges(bookingIdentifier) {
            try {
                // å„ªå…ˆä½¿ç”¨ id æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†è©¦è©¦ä½œç‚ºç´¢å¼•
                let existingBooking = allData.bookings.find(b => b.id == bookingIdentifier);
                
                // å¦‚æœç”¨ id æ‰¾ä¸åˆ°ï¼Œä¸¦ä¸” identifier æ˜¯æœ‰æ•ˆçš„ç´¢å¼•ï¼Œå‰‡ä½¿ç”¨ç´¢å¼•
                if (!existingBooking && typeof bookingIdentifier === 'number' && 
                    bookingIdentifier >= 0 && bookingIdentifier < allData.bookings.length) {
                    existingBooking = allData.bookings[bookingIdentifier];
                }
                    
                if (!existingBooking) {
                    console.error('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„ï¼ŒbookingIdentifier:', bookingIdentifier);
                    console.error('æ‰€æœ‰è¨‚æˆ¿è¨˜éŒ„:', allData.bookings);
                    showErrorMessage('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„');
                    return;
                }
                
                // æ”¶é›†ç·¨è¼¯è¡¨å–®çš„åŸå§‹è³‡æ–™
                const rawUpdateData = {
                    guest_name: document.getElementById('edit_guest_name').value.trim(),
                    guest_phone: document.getElementById('edit_guest_phone').value.trim(),
                    guest_email: document.getElementById('edit_guest_email').value.trim(),
                    bank_account_last5: document.getElementById('edit_bank_account_last5').value.trim(),
                    partner_code: document.getElementById('edit_partner_code').value || null,
                    checkin_date: document.getElementById('edit_checkin_date').value,
                    checkout_date: document.getElementById('edit_checkout_date').value,
                    room_price: document.getElementById('edit_room_price').value,
                    stay_status: document.getElementById('edit_stay_status').value,
                    payment_status: document.getElementById('edit_payment_status').value,
                    notes: document.getElementById('edit_notes').value.trim()
                };

                console.log('ğŸ“ ç·¨è¼¯è¨‚æˆ¿ - åŸå§‹æ›´æ–°è³‡æ–™:', rawUpdateData);
                console.log('ğŸ“‹ ç·¨è¼¯è¨‚æˆ¿ - ç¾æœ‰è¨‚æˆ¿è³‡æ–™:', existingBooking);

                // ä½¿ç”¨ BookingDataManager æ›´æ–° booking æ•¸æ“š
                const updatedBooking = BookingDataManager.updateBooking(existingBooking, rawUpdateData);
                console.log('ğŸ”§ ç·¨è¼¯è¨‚æˆ¿ - æ¨™æº–åŒ–å¾Œæ•¸æ“š:', updatedBooking);

                // ä½¿ç”¨ BookingDataManager é©—è­‰æ›´æ–°å¾Œçš„æ•¸æ“š
                const validation = BookingDataManager.validateBooking(updatedBooking);
                if (!validation.valid) {
                    alert('è³‡æ–™é©—è­‰å¤±æ•—ï¼š\n' + validation.errors.join('\n'));
                    return;
                }

                // æº–å‚™æäº¤åˆ°å¾Œç«¯çš„æ•¸æ“šï¼ˆåŒ…å« action å’Œè­˜åˆ¥ç¬¦ï¼‰
                // ä¿®å¾©ï¼šç”±æ–¼è³‡æ–™åº« ID æ¬„ä½å¯èƒ½ç‚ºç©ºï¼Œä½¿ç”¨è¤‡åˆæŸ¥æ‰¾æ–¹å¼
                console.log('ğŸ“‹ ç·¨è¼¯è¨‚æˆ¿ - åŸå§‹è¨‚æˆ¿è³‡æ–™ ID:', existingBooking.id);
                
                const submitData = {
                    action: 'update_booking',
                    // å‚³é IDï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰å’ŒæŸ¥æ‰¾å¿…è¦è³‡è¨Š
                    booking_id: existingBooking.id || '',
                    // æ·»åŠ åŸå§‹çš„å§“åå’Œé›»è©±ä½œç‚ºæŸ¥æ‰¾æ¢ä»¶ï¼ˆä½¿ç”¨æ›´æ–°å‰çš„å€¼ï¼‰
                    original_guest_name: existingBooking.guest_name,
                    original_guest_phone: existingBooking.guest_phone,
                    ...updatedBooking
                };

                // ä½¿ç”¨ BookingDataManager å‰µå»ºæ¨™æº–åŒ–åƒæ•¸
                const params = BookingDataManager.createOrderedParams(submitData);
                console.log('ğŸ“¤ ç·¨è¼¯è¨‚æˆ¿ - æŒ‰æ¨™æº–é †åºç™¼é€çš„åƒæ•¸:', params.toString());
                
                console.log('ğŸ“¤ ç·¨è¼¯è¨‚æˆ¿ - ç™¼é€æ•¸æ“š:', submitData);
                
                // ä½¿ç”¨è¡¨å–®æäº¤é¿å… CORS å•é¡Œ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // æ·»åŠ æ‰€æœ‰åƒæ•¸ä½œç‚ºéš±è—è¼¸å…¥
                for (const [key, value] of params.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                // å‰µå»ºéš±è—çš„ iframe ä¾†æ¥æ”¶å›æ‡‰
                const iframe = getOrCreateHiddenIframe();

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                console.log('ğŸ“¡ ç·¨è¼¯è¨‚æˆ¿ - è¡¨å–®å·²æäº¤ï¼Œä½¿ç”¨éš±è— iframe æ¥æ”¶å›æ‡‰');
                
                // è¦–ç‚ºæˆåŠŸï¼Œå› ç‚ºè¡¨å–®æäº¤ç„¡æ³•ç²å¾—è©³ç´°å›æ‡‰
                const responseData = { success: true };
                
                if (responseData.success === false) {
                    throw new Error(responseData.error || 'å¾Œç«¯æ›´æ–°å¤±æ•—');
                }
                
                // ç«‹å³æ›´æ–°å‰ç«¯æ•¸æ“š
                // ä½¿ç”¨åŸå§‹å§“åå’Œé›»è©±æ‰¾åˆ°æ­£ç¢ºçš„è¨˜éŒ„é€²è¡Œæ›´æ–°
                const updateIndex = allData.bookings.findIndex(b => 
                    b.guest_name === existingBooking.guest_name && 
                    String(b.guest_phone) === String(existingBooking.guest_phone)
                );
                
                if (updateIndex !== -1) {
                    // ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„å®Œæ•´ booking æ•¸æ“šæ›´æ–°æœ¬åœ°è¨˜éŒ„
                    allData.bookings[updateIndex] = {
                        ...allData.bookings[updateIndex],
                        ...updatedBooking,
                        updated_at: new Date().toISOString()
                    };
                    console.log('âœ… å·²æ›´æ–°å‰ç«¯è¨‚å–®æ•¸æ“šï¼Œç´¢å¼•:', updateIndex);
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°è¦æ›´æ–°çš„è¨‚å–®');
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œç­‰å¾…å¾Œç«¯è™•ç†å®Œæˆå¾Œé‡æ–°è¼‰å…¥
                    setTimeout(() => {
                        loadRealData();
                    }, 2000);
                }
                
                showSuccessMessage('âœ… è¨‚å–®æ›´æ–°æˆåŠŸï¼');
                closeModal('editBookingModal');
                
                // é‡æ–°é¡¯ç¤ºæ›´æ–°å¾Œçš„è¨‚å–®åˆ—è¡¨
                setTimeout(() => {
                    displayBookings(allData.bookings);
                }, 500);
                
            } catch (error) {
                console.error('æ›´æ–°è¨‚å–®å¤±æ•—:', error);
                alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆªé™¤è¨‚å–®
        async function deleteBooking(bookingIndex) {
            const booking = allData.bookings[bookingIndex];
            if (!booking) {
                alert('æ‰¾ä¸åˆ°è¨‚æˆ¿è¨˜éŒ„');
                return;
            }

            const confirmMessage = `âš ï¸ ç¢ºå®šè¦åˆªé™¤ä»¥ä¸‹è¨‚æˆ¿å—ï¼Ÿ\n\næˆ¿å®¢ï¼š${booking.guest_name}\nå…¥ä½æœŸé–“ï¼š${booking.checkin_date} ~ ${booking.checkout_date}\n${booking.partner_code ? `æ¨è–¦å¤§ä½¿ï¼š${booking.partner_code}` : 'ç„¡æ¨è–¦å¤§ä½¿'}\n\nåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // è½‰æ›ç‚ºå¾Œç«¯æœŸæœ›çš„æ ¼å¼
                const formatDateForBackend = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) return dateStr;
                    return date.getFullYear() + '-' + 
                           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(date.getDate()).padStart(2, '0');
                };
                
                // ä½¿ç”¨ form æäº¤æ–¹å¼é¿å… CORS å•é¡Œ
                const deleteData = {
                    action: 'delete_booking',
                    booking_id: booking.id || '',
                    guest_name: booking.guest_name,
                    guest_phone: booking.guest_phone,
                    checkin_date: formatDateForBackend(booking.checkin_date)
                };
                
                console.log('ğŸ“¤ åˆªé™¤è¨‚æˆ¿ - ç™¼é€æ•¸æ“š:', deleteData);
                
                // ä½¿ç”¨çµ±ä¸€çš„ iframe è¡¨å–®æäº¤å‡½æ•¸
                submitToBackendViaForm(deleteData);
                
                // çµ¦å¾Œç«¯ä¸€äº›æ™‚é–“è™•ç†
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // ç«‹å³æ›´æ–°å‰ç«¯æ•¸æ“š
                console.log('ğŸ—‘ï¸ åˆªé™¤è«‹æ±‚å·²ç™¼é€ï¼Œæ›´æ–°å‰ç«¯æ•¸æ“š...', booking.guest_name);
                    
                // å¾å‰ç«¯æ•¸æ“šä¸­ç§»é™¤è©²è¨˜éŒ„
                const bookingIndexToRemove = allData.bookings.findIndex(b => 
                    b.guest_name === booking.guest_name && 
                    String(b.guest_phone) === String(booking.guest_phone) &&
                    b.checkin_date === booking.checkin_date
                );
                
                if (bookingIndexToRemove !== -1) {
                    allData.bookings.splice(bookingIndexToRemove, 1);
                    console.log('âœ… å·²å¾å‰ç«¯æ•¸æ“šç§»é™¤è¨˜éŒ„');
                    
                    // ç«‹å³åˆ·æ–°é¡¯ç¤º
                    displayBookings(allData.bookings);
                    showSuccessMessage('âœ… è¨‚å–®å·²æˆåŠŸåˆªé™¤ï¼');
                    closeModal('editBookingModal');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è¨˜éŒ„');
                    showSuccessMessage('âœ… åˆªé™¤è«‹æ±‚å·²ç™¼é€ï¼Œè«‹é‡æ–°è¼‰å…¥æŸ¥çœ‹çµæœ');
                }
                
            } catch (error) {
                console.error('åˆªé™¤è¨‚å–®å¤±æ•—:', error);
                alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // å–å¾—ç­‰ç´šæ–‡å­—
        function getLevelText(level) {
            const levelMap = {
                'LV1_INSIDER': 'LV1 æ£®æ—çŸ¥éŸ³',
                'LV2_GUIDE': 'LV2 æ£®æ—åš®å°', 
                'LV3_GUARDIAN': 'LV3 ç§˜å¢ƒå®ˆè­·è€…'
            };
            return levelMap[level] || level;
        }

        function filterBookings() {
            console.log('ç¯©é¸è¨‚å–®');
        }

        // é–‹å•Ÿæ‰‹å‹•è¨‚æˆ¿æ¨¡æ…‹æ¡†
        function openManualBookingModal() {
            createManualBookingModal();
        }

        // å‰µå»ºæ‰‹å‹•è¨‚æˆ¿æ¨¡æ…‹æ¡†
        function createManualBookingModal() {
            const modal = document.createElement('div');
            modal.id = 'manualBookingModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[95vh] overflow-y-auto">
                    <!-- æ¨™é¡Œåˆ— -->
                    <div class="sticky top-0 bg-white border-b px-8 py-6 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-green-800">ğŸ“ æ‰‹å‹•è¨‚æˆ¿ç™»è¨˜</h2>
                        <button onclick="closeModal('manualBookingModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- è¡¨å–®å…§å®¹ -->
                    <div class="p-8">
                        <form id="manualBookingForm" class="space-y-6">
                            <!-- æˆ¿å®¢åŸºæœ¬è³‡è¨Š -->
                            <div class="bg-blue-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-800 mb-4">ğŸ‘¤ æˆ¿å®¢åŸºæœ¬è³‡è¨Š</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¿å®¢å§“å *</label>
                                        <input type="text" id="modal_guest_name" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="ä¾‹ï¼šå¼µå°æ˜">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¿å®¢é›»è©± *</label>
                                        <input type="tel" id="modal_guest_phone" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="ä¾‹ï¼š0912345678">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æˆ¿å®¢Email</label>
                                        <input type="email" id="modal_guest_email" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="guest@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’³ åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ <span class="text-xs text-gray-500">ï¼ˆé¸å¡«ï¼‰</span></label>
                                        <input type="text" id="modal_bank_account_last5" maxlength="5" pattern="[0-9]{5}" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="ä¾‹ï¼š12345" title="è«‹è¼¸å…¥5ä½æ•¸å­—">
                                        <p class="text-xs text-gray-500 mt-1">ç”¨æ–¼å°å¸³ç¢ºèª</p>
                                    </div>
                                </div>
                            </div>

                            <!-- æ¨è–¦å¤§ä½¿è³‡è¨Š -->
                            <div class="bg-green-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold text-green-800 mb-4">ğŸ‘¤ æ¨è–¦å¤§ä½¿è³‡è¨Š</h3>
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">æ¨è–¦å¤§ä½¿ä»£ç¢¼</label>
                                        <select id="modal_partner_code" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none">
                                            <option value="">è«‹é¸æ“‡æ¨è–¦å¤§ä½¿ï¼ˆç„¡æ¨è–¦è«‹ç•™ç©ºï¼‰</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">é¸æ“‡æ¨è–¦å¤§ä½¿æˆ–ç•™ç©ºè¡¨ç¤ºéå¤§ä½¿æ¨è–¦</p>
                                        <div id="modal_partner_info" class="mt-2 p-3 bg-gray-50 rounded-lg hidden">
                                            <!-- é¸ä¸­å¤§ä½¿çš„è©³ç´°è³‡è¨Šæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ä½å®¿è³‡è¨Š -->
                            <div class="bg-amber-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold text-amber-800 mb-4">ğŸ  ä½å®¿è³‡è¨Š</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å…¥ä½æ—¥æœŸ *</label>
                                        <input type="date" id="modal_checkin_date" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">é€€æˆ¿æ—¥æœŸ *</label>
                                        <input type="date" id="modal_checkout_date" required class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯¦éš›æˆ¿åƒ¹ *</label>
                                        <input type="number" id="modal_room_price" required min="0" step="1" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none" placeholder="5000">
                                    </div>
                                </div>
                            </div>

                            <!-- ç‹€æ…‹è¨­å®š -->
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š åˆå§‹ç‹€æ…‹</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">å…¥ä½ç‹€æ…‹</label>
                                        <select id="modal_stay_status" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-gray-500 focus:outline-none">
                                            <option value="PENDING">å¾…å…¥ä½</option>
                                            <option value="CHECKED_IN">å·²å…¥ä½</option>
                                            <option value="COMPLETED">å·²å®Œæˆ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾ç‹€æ…‹</label>
                                        <select id="modal_payment_status" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-gray-500 focus:outline-none">
                                            <option value="PENDING">å¾…ä»˜æ¬¾</option>
                                            <option value="PARTIAL">éƒ¨åˆ†ä»˜æ¬¾</option>
                                            <option value="PAID">å·²ä»˜æ¸…</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- å‚™è¨» -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                                <textarea id="modal_notes" rows="3" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="ä¾‹ï¼šå®¢äººç‰¹åˆ¥è¦æ±‚ã€æ¨è–¦ä¾†æºè©³æƒ…ç­‰..."></textarea>
                            </div>

                            <!-- æäº¤æŒ‰éˆ• -->
                            <div class="flex justify-end space-x-4 pt-4 border-t">
                                <button type="button" onclick="closeModal('manualBookingModal')" class="px-6 py-3 border-2 border-gray-300 text-gray-600 rounded-lg font-semibold hover:bg-gray-50 transition duration-300">
                                    å–æ¶ˆ
                                </button>
                                <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                                    ğŸ’¾ ç™»è¨˜è¨‚æˆ¿
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // åˆå§‹åŒ–è¡¨å–®
            initializeManualBookingForm();
        }

        // åˆå§‹åŒ–æ‰‹å‹•è¨‚æˆ¿è¡¨å–®
        function initializeManualBookingForm() {
            // è¨­å®šé è¨­æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal_checkin_date').value = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('modal_checkout_date').value = tomorrow.toISOString().split('T')[0];

            // å¡«å……å¤§ä½¿ä¸‹æ‹‰é¸å–®
            const partnerSelect = document.getElementById('modal_partner_code');
            if (allData && allData.partners) {
                allData.partners.forEach(partner => {
                    if (partner && partner.partner_code) {
                        const option = document.createElement('option');
                        option.value = partner.partner_code;
                        option.textContent = `${partner.partner_code} - ${partner.name || 'æœªè¨­å®šå§“å'} (${getLevelText(partner.level)})`;
                        partnerSelect.appendChild(option);
                    }
                });
            }

            // è¨­å®šå¤§ä½¿é¸æ“‡ç›£è½å™¨
            partnerSelect.addEventListener('change', function() {
                const selectedCode = this.value;
                const partnerInfoEl = document.getElementById('modal_partner_info');
                
                if (selectedCode === '') {
                    partnerInfoEl.classList.add('hidden');
                    return;
                }
                
                const partner = allData.partners.find(p => p.partner_code === selectedCode);
                if (partner) {
                    // é¡¯ç¤ºå¤§ä½¿è©³ç´°è³‡è¨Š
                    partnerInfoEl.innerHTML = `
                        <div class="text-sm">
                            <p class="font-semibold text-green-800">âœ“ å·²é¸æ“‡æ¨è–¦å¤§ä½¿</p>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div>
                                    <p class="text-gray-600">ä»£ç¢¼ï¼š${partner.partner_code}</p>
                                    <p class="text-gray-600">å§“åï¼š${partner.name || 'æœªè¨­å®š'}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">ç­‰ç´šï¼š${getLevelText(partner.level)}</p>
                                    <p class="text-gray-600">é›»è©±ï¼š${partner.phone || 'æœªè¨­å®š'}</p>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-green-50 rounded">
                                <p class="font-medium text-green-800">é è¨ˆä½£é‡‘ï¼š</p>
                                <p class="text-sm text-green-600">${getCommissionText(partner.level)}</p>
                            </div>
                        </div>
                    `;
                    partnerInfoEl.classList.remove('hidden');
                }
            });

            // è¨­å®šè¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('manualBookingForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitManualBooking();
            });
        }

        // æäº¤æ‰‹å‹•è¨‚æˆ¿
        async function submitManualBooking() {
            // æ”¶é›†è¡¨å–®è³‡æ–™
            const rawFormData = {
                partner_code: document.getElementById('modal_partner_code').value || null,
                guest_name: document.getElementById('modal_guest_name').value.trim(),
                guest_phone: document.getElementById('modal_guest_phone').value.trim(),
                guest_email: document.getElementById('modal_guest_email').value.trim(),
                bank_account_last5: document.getElementById('modal_bank_account_last5').value.trim(),
                checkin_date: document.getElementById('modal_checkin_date').value,
                checkout_date: document.getElementById('modal_checkout_date').value,
                room_price: document.getElementById('modal_room_price').value,
                stay_status: document.getElementById('modal_stay_status').value,
                payment_status: document.getElementById('modal_payment_status').value,
                notes: document.getElementById('modal_notes').value.trim()
            };

            console.log('ğŸ“ æ‰‹å‹•è¨‚æˆ¿ - åŸå§‹è¡¨å–®è³‡æ–™:', rawFormData);

            // ä½¿ç”¨ BookingDataManager å‰µå»ºæ¨™æº–åŒ– booking æ•¸æ“š
            const bookingData = BookingDataManager.createNewBooking(rawFormData);
            console.log('ğŸ”§ æ‰‹å‹•è¨‚æˆ¿ - æ¨™æº–åŒ–å¾Œæ•¸æ“š:', bookingData);

            // ä½¿ç”¨ BookingDataManager é©—è­‰æ•¸æ“š
            const validation = BookingDataManager.validateBooking(bookingData);
            if (!validation.valid) {
                alert('è³‡æ–™é©—è­‰å¤±æ•—ï¼š\n' + validation.errors.join('\n'));
                return;
            }

            // é©—è­‰æ¨è–¦å¤§ä½¿ä»£ç¢¼ï¼ˆå¦‚æœæœ‰é¸æ“‡ï¼‰
            if (bookingData.partner_code && !allData.partners.find(p => p.partner_code === bookingData.partner_code)) {
                alert('é¸æ“‡çš„æ¨è–¦å¤§ä½¿ä»£ç¢¼ç„¡æ•ˆï¼Œè«‹é‡æ–°é¸æ“‡ï¼');
                return;
            }

            // æº–å‚™æäº¤åˆ°å¾Œç«¯çš„æ•¸æ“šï¼ˆåŒ…å« actionï¼‰
            const submitData = {
                action: 'create_booking',
                ...bookingData
            };

            const submitButton = document.querySelector('#manualBookingForm button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'ç™»è¨˜ä¸­...';
            submitButton.disabled = true;

            try {
                console.log('ğŸ“¤ æ‰‹å‹•è¨‚æˆ¿ - ç™¼é€æ•¸æ“š:', submitData);
                
                // ä½¿ç”¨ form æäº¤é¿å… CORS å•é¡Œ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'booking_iframe';
                form.style.display = 'none';

                // æŒ‰æ¨™æº–é †åºæ·»åŠ è¡¨å–®å­—æ®µ
                const params = BookingDataManager.createOrderedParams(submitData);
                console.log('ğŸ“¤ æ‰‹å‹•è¨‚æˆ¿ - æŒ‰æ¨™æº–é †åºç™¼é€çš„åƒæ•¸:', params.toString());
                
                // å°‡ URLSearchParams è½‰æ›ç‚ºè¡¨å–®å­—æ®µ
                for (const [key, value] of params.entries()) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }

                document.body.appendChild(form);

                // å‰µå»ºéš±è—çš„ iframe ç”¨æ–¼æäº¤
                let iframe = document.getElementById('booking_iframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'booking_iframe';
                    iframe.name = 'booking_iframe';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }

                // æäº¤è¡¨å–®
                form.submit();
                console.log('ğŸ“¡ æ‰‹å‹•è¨‚æˆ¿ - è¡¨å–®å·²æäº¤');
                
                // å»¶æ™‚è™•ç†çµæœï¼ˆå› ç‚ºç„¡æ³•è®€å–iframeå…§å®¹ï¼‰
                setTimeout(async () => {
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    showSuccessMessage('âœ… è¨‚æˆ¿è¨˜éŒ„è™•ç†ä¸­...');
                    
                    // é—œé–‰æ¨¡æ…‹æ¡†
                    closeModal('manualBookingModal');
                    
                    // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“šä¸¦åˆ‡æ›åˆ°è¨‚å–®ç®¡ç†é 
                    try {
                        await loadRealData();
                        showTab('bookings');
                        displayBookings(allData.bookings);
                        console.log('âœ… æ‰‹å‹•è¨‚æˆ¿ç™»è¨˜å®Œæˆï¼Œå·²åˆ‡æ›åˆ°è¨‚å–®ç®¡ç†é ');
                        showSuccessMessage('âœ… è¨‚æˆ¿è¨˜éŒ„å·²æˆåŠŸç™»è¨˜ï¼');
                    } catch (error) {
                        console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                        showSuccessMessage('âœ… è¨‚æˆ¿å·²ç™»è¨˜ï¼Œè«‹æ‰‹å‹•é‡æ–°è¼‰å…¥é é¢æŸ¥çœ‹');
                    }
                    
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                    
                    // æ¸…ç†è¡¨å–®
                    if (form && form.parentNode) {
                        document.body.removeChild(form);
                    }
                }, 1500);

            } catch (error) {
                console.error('ç™»è¨˜å¤±æ•—:', error);
                alert('âŒ ç™»è¨˜å¤±æ•—ï¼š' + error.message);
                
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // ç²å–ä½£é‡‘èªªæ˜æ–‡å­—
        function getCommissionText(level) {
            const commissionMap = {
                'LV1_INSIDER': 'NT$1,000 ä½å®¿é‡‘ï¼ˆå¯è½‰æ› NT$500ç¾é‡‘ï¼‰',
                'LV2_GUIDE': 'NT$1,200 ä½å®¿é‡‘ï¼ˆå¯è½‰æ› NT$600ç¾é‡‘ï¼‰',
                'LV3_GUARDIAN': 'NT$1,500 ä½å®¿é‡‘ï¼ˆå¯è½‰æ› NT$750ç¾é‡‘ï¼‰'
            };
            return commissionMap[level] || 'ä¾ç­‰ç´šè¨ˆç®—';
        }

        // é¡¯ç¤º Apps Script ä¿®å¾©æŒ‡å°
        function showAppsScriptFixModal() {
            const modal = document.createElement('div');
            modal.id = 'appsScriptFixModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-red-600">ğŸš¨ Google Apps Script 403 éŒ¯èª¤</h2>
                        <button onclick="closeModal('appsScriptFixModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <h3 class="font-bold text-red-800 mb-2">ğŸ” å•é¡Œè¨ºæ–·ï¼š</h3>
                            <p class="text-sm text-red-700">Google Apps Script å›å‚³ 403 Forbidden éŒ¯èª¤ï¼Œè¡¨ç¤ºæ¬Šé™è¨­å®šæœ‰å•é¡Œã€‚</p>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <h3 class="font-bold text-lg">ğŸ”§ å¿«é€Ÿä¿®å¾©æ­¥é©Ÿï¼š</h3>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">1. é‡æ–°éƒ¨ç½² Apps Script</h4>
                                <ul class="text-sm space-y-1 ml-4">
                                    <li>â€¢ å‰å¾€ <a href="https://script.google.com" target="_blank" class="text-blue-600 underline">Google Apps Script</a></li>
                                    <li>â€¢ æ‰¾åˆ°çŸ¥éŸ³è¨ˆç•«å°ˆæ¡ˆ</li>
                                    <li>â€¢ é»æ“Š "éƒ¨ç½²" â†’ "ç®¡ç†éƒ¨ç½²" â†’ åˆªé™¤èˆŠéƒ¨ç½²</li>
                                    <li>â€¢ é»æ“Š "å»ºç«‹éƒ¨ç½²"ï¼Œé¡å‹é¸æ“‡ "ç¶²è·¯æ‡‰ç”¨ç¨‹å¼"</li>
                                    <li>â€¢ <strong>åŸ·è¡Œèº«åˆ†ï¼šæˆ‘</strong></li>
                                    <li>â€¢ <strong>å­˜å–æ¬Šé™ï¼šä»»ä½•äºº</strong></li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">2. å®Œæˆæˆæ¬Š</h4>
                                <ul class="text-sm space-y-1 ml-4">
                                    <li>â€¢ éƒ¨ç½²æ™‚æœƒè¦æ±‚æˆæ¬Šï¼Œé»æ“Š "æˆæ¬Šå­˜å–"</li>
                                    <li>â€¢ å¦‚æœçœ‹åˆ° "æ­¤æ‡‰ç”¨ç¨‹å¼æœªç¶“é©—è­‰"ï¼Œé»æ“Š "é€²éš" â†’ "å‰å¾€å°ˆæ¡ˆ"</li>
                                    <li>â€¢ é»æ“Š "å…è¨±" å®Œæˆæˆæ¬Š</li>
                                </ul>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">3. æ›´æ–° URL</h4>
                                <p class="text-sm">éƒ¨ç½²å®Œæˆå¾Œï¼Œå°‡æ–°çš„ URL æ›´æ–°åˆ°å‰ç«¯ä»£ç¢¼çš„ <code class="bg-gray-200 px-1 rounded">APPS_SCRIPT_URL</code> è®Šæ•¸ä¸­ã€‚</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="window.open('google-apps-script-fix.html', '_blank')" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                ğŸ“– æŸ¥çœ‹è©³ç´°ä¿®å¾©æŒ‡å—
                            </button>
                            <button onclick="retryConnection()" 
                                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                ğŸ”„ é‡è©¦é€£æ¥
                            </button>
                            <button onclick="closeModal('appsScriptFixModal')" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // é‡è©¦é€£æ¥
        function retryConnection() {
            closeModal('appsScriptFixModal');
            loadRealData().then(() => {
                showSuccessMessage('âœ… é€£æ¥æˆåŠŸï¼å•é¡Œå·²è§£æ±ºã€‚');
            }).catch(error => {
                if (error.message.includes('403')) {
                    showErrorMessage('âš ï¸ ä»æœ‰ 403 éŒ¯èª¤ï¼Œè«‹æŒ‰ç…§ä¿®å¾©æŒ‡å—é‡æ–°éƒ¨ç½² Apps Script');
                } else {
                    showErrorMessage('âŒ é€£æ¥å¤±æ•—: ' + error.message);
                }
            });
        }

        // ç”Ÿæˆçµç®—ä¾†æºæè¿°
        function generatePayoutSourceDescription(payout) {
            // æ ¹æ“šä¸åŒçš„ä¾†æºç”Ÿæˆæè¿°
            const method = payout.payout_method || '';
            const notes = payout.notes || '';
            const relatedBookings = payout.related_booking_ids;
            
            // 1. æ‰‹å‹•èª¿æ•´çš„çµç®—
            if (method === 'MANUAL_ADJUSTMENT' || notes.includes('æ‰‹å‹•èª¿æ•´') || notes.includes('ç®¡ç†è€…') || notes.includes('æ‰‹å‹•ä¿®æ”¹')) {
                return {
                    text: 'ğŸ‘¤ ç®¡ç†è€…æ‰‹å‹•èª¿æ•´',
                    class: 'bg-purple-100 text-purple-800',
                    detail: notes || 'ç®¡ç†è€…æ‰‹å‹•èª¿æ•´ä½£é‡‘'
                };
            }
            
            // 2. ä¾†è‡ªæˆ¿å®¢å…¥ä½å®Œæˆçš„ä½£é‡‘
            // ä¿®å¾©ï¼šç¢ºä¿ relatedBookings æ˜¯å­—ä¸²æ‰å‘¼å« trim()
            const bookingsStr = relatedBookings ? relatedBookings.toString() : '';
            if (bookingsStr && bookingsStr !== '-' && bookingsStr.trim() !== '') {
                // å˜—è©¦æ‰¾åˆ°ç›¸é—œçš„è¨‚æˆ¿è¨˜éŒ„
                const bookingIds = bookingsStr.split(',');
                let guestInfo = '';
                
                if (allData && allData.bookings) {
                    const relatedBooking = allData.bookings.find(b => 
                        bookingIds.some(id => b.id == id.trim())
                    );
                    
                    if (relatedBooking) {
                        guestInfo = `æˆ¿å®¢: ${relatedBooking.guest_name}`;
                        if (relatedBooking.guest_phone) {
                            // åªé¡¯ç¤ºé›»è©±çš„å¾Œ4ä½
                            const phone = relatedBooking.guest_phone.toString();
                            const maskedPhone = phone.length > 4 ? 
                                phone.slice(0, -4).replace(/./g, '*') + phone.slice(-4) : 
                                phone;
                            guestInfo += ` (${maskedPhone})`;
                        }
                    }
                }
                
                return {
                    text: 'ğŸ¨ æˆ¿å®¢å…¥ä½å®Œæˆ',
                    class: 'bg-green-100 text-green-800',
                    detail: guestInfo || `è¨‚æˆ¿ID: ${bookingIds[0]}`
                };
            }
            
            // 3. ç³»çµ±è‡ªå‹•è¨ˆç®—çš„ä½£é‡‘
            if (method === 'AUTO_CALCULATION' || payout.payout_type === 'ACCOMMODATION') {
                return {
                    text: 'âš™ï¸ ç³»çµ±è‡ªå‹•è¨ˆç®—',
                    class: 'bg-blue-100 text-blue-800',
                    detail: 'åŸºæ–¼è¨‚æˆ¿è‡ªå‹•è¨ˆç®—ä½£é‡‘'
                };
            }
            
            // 4. çµç®—æ’¤éŠ·æˆ–èª¿æ•´
            if (payout.payout_type === 'ADJUSTMENT_REVERSAL' || notes.includes('æ’¤éŠ·') || notes.includes('å–æ¶ˆ')) {
                return {
                    text: 'ğŸ”„ çµç®—èª¿æ•´',
                    class: 'bg-orange-100 text-orange-800',
                    detail: 'çµç®—æ’¤éŠ·æˆ–é‡‘é¡èª¿æ•´'
                };
            }
            
            // 5. é è¨­æƒ…æ³
            return {
                text: 'ğŸ“Š ä¸€èˆ¬çµç®—',
                class: 'bg-gray-100 text-gray-800',
                detail: notes || 'å¸¸è¦çµç®—è¨˜éŒ„'
            };
        }

        // è¨ºæ–· Google Sheets æ¬„ä½çµæ§‹
        function diagnoseSheetFields() {
            const modal = document.createElement('div');
            modal.id = 'sheetFieldsDiagnosticModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-2xl font-bold text-red-600">ğŸ”§ Google Sheets æ¬„ä½çµæ§‹è¨ºæ–·</h3>
                        <button onclick="closeModal('sheetFieldsDiagnosticModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-red-800 mb-2">âš ï¸ ç™¼ç¾å•é¡Œï¼šGoogle Sheets æ¬„ä½ç¼ºå¤±</h4>
                        <p class="text-red-700 text-sm">
                            æ ¹æ“šä½ æä¾›çš„è³‡æ–™ï¼ŒGoogle Sheets ä¸­ç¼ºå°‘ <code class="bg-red-100 px-2 py-1 rounded">bank_account_last5</code> æ¬„ä½ï¼Œ
                            å°è‡´åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼è¢«éŒ¯èª¤åœ°æ”¾å…¥ notes æ¬„ä½ï¼Œä¸¦é€ æˆæ‰€æœ‰å¾ŒçºŒæ¬„ä½éŒ¯ä½ã€‚
                        </p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-blue-800 mb-3">ğŸ“‹ æ­£ç¢ºçš„ Bookings å·¥ä½œè¡¨æ¬„ä½é †åº</h4>
                        <div class="bg-white p-4 rounded border">
                            <p class="text-sm font-mono mb-2">ä»¥ä¸‹æ˜¯ Bookings å·¥ä½œè¡¨æ‡‰è©²åŒ…å«çš„æ‰€æœ‰æ¬„ä½ï¼ˆç¬¬ä¸€åˆ—æ¨™é¡Œï¼‰ï¼š</p>
                            <div class="bg-gray-100 p-3 rounded text-xs font-mono">
                                id | partner_code | guest_name | guest_phone | guest_email | bank_account_last5 | 
                                checkin_date | checkout_date | room_price | stay_status | payment_status | 
                                commission_amount | commission_status | notes | created_at | updated_at
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-yellow-800 mb-3">ğŸ”§ ä¿®å¾©æ­¥é©Ÿ</h4>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li><strong>å‚™ä»½æ•¸æ“šï¼š</strong>å…ˆè¤‡è£½ä¸€ä»½ Google Sheets ä½œç‚ºå‚™ä»½</li>
                            <li><strong>åœ¨ç¬¬6æ¬„æ’å…¥æ–°æ¬„ä½ï¼š</strong>åœ¨ guest_email å’Œ checkin_date ä¹‹é–“æ’å…¥ä¸€æ¬„</li>
                            <li><strong>è¨­å®šæ¬„ä½æ¨™é¡Œï¼š</strong>å°‡æ–°æ¬„ä½çš„æ¨™é¡Œè¨­ç‚º <code>bank_account_last5</code></li>
                            <li><strong>ç§»å‹•éŒ¯ä½è³‡æ–™ï¼š</strong>å°‡ notes æ¬„ä½ä¸­çš„æ•¸å­—ï¼ˆå¦‚ 12345ã€12333ï¼‰ç§»å‹•åˆ°æ–°çš„ bank_account_last5 æ¬„ä½</li>
                            <li><strong>æ¸…ç†éŒ¯ä½è³‡æ–™ï¼š</strong>å°‡ created_at æ¬„ä½ä¸­çš„æ–‡å­—ï¼ˆå¦‚ tjgjï¼‰ç§»å› notes æ¬„ä½</li>
                            <li><strong>æ¸¬è©¦æ–°å¢è¨‚æˆ¿ï¼š</strong>å®Œæˆä¿®å¾©å¾Œï¼Œæ¸¬è©¦æ–°å¢ä¸€ç­†è¨‚æˆ¿ç¢ºèªæ¬„ä½å°æ‡‰æ­£ç¢º</li>
                        </ol>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-green-800 mb-3">âœ… å®Œæ•´æ¬„ä½èªªæ˜</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs border">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="border px-2 py-1">æ¬„ä½åç¨±</th>
                                        <th class="border px-2 py-1">è³‡æ–™é¡å‹</th>
                                        <th class="border px-2 py-1">èªªæ˜</th>
                                        <th class="border px-2 py-1">ç¯„ä¾‹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="border px-2 py-1">id</td><td class="border px-2 py-1">æ•¸å­—</td><td class="border px-2 py-1">è¨‚æˆ¿IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</td><td class="border px-2 py-1">1</td></tr>
                                    <tr><td class="border px-2 py-1">partner_code</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">æ¨è–¦å¤§ä½¿ä»£ç¢¼</td><td class="border px-2 py-1">WANG001</td></tr>
                                    <tr><td class="border px-2 py-1">guest_name</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">æˆ¿å®¢å§“å</td><td class="border px-2 py-1">ç‹å°æ˜</td></tr>
                                    <tr><td class="border px-2 py-1">guest_phone</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">æˆ¿å®¢é›»è©±</td><td class="border px-2 py-1">0912345678</td></tr>
                                    <tr><td class="border px-2 py-1">guest_email</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">æˆ¿å®¢Email</td><td class="border px-2 py-1">wang@example.com</td></tr>
                                    <tr class="bg-yellow-100"><td class="border px-2 py-1"><strong>bank_account_last5</strong></td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼</td><td class="border px-2 py-1">12345</td></tr>
                                    <tr><td class="border px-2 py-1">checkin_date</td><td class="border px-2 py-1">æ—¥æœŸ</td><td class="border px-2 py-1">å…¥ä½æ—¥æœŸ</td><td class="border px-2 py-1">2024-08-15</td></tr>
                                    <tr><td class="border px-2 py-1">checkout_date</td><td class="border px-2 py-1">æ—¥æœŸ</td><td class="border px-2 py-1">é€€æˆ¿æ—¥æœŸ</td><td class="border px-2 py-1">2024-08-17</td></tr>
                                    <tr><td class="border px-2 py-1">room_price</td><td class="border px-2 py-1">æ•¸å­—</td><td class="border px-2 py-1">æˆ¿åƒ¹</td><td class="border px-2 py-1">5000</td></tr>
                                    <tr><td class="border px-2 py-1">stay_status</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">å…¥ä½ç‹€æ…‹</td><td class="border px-2 py-1">PENDING/COMPLETED</td></tr>
                                    <tr><td class="border px-2 py-1">payment_status</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">ä»˜æ¬¾ç‹€æ…‹</td><td class="border px-2 py-1">PAID/UNPAID</td></tr>
                                    <tr><td class="border px-2 py-1">commission_amount</td><td class="border px-2 py-1">æ•¸å­—</td><td class="border px-2 py-1">ä½£é‡‘é‡‘é¡</td><td class="border px-2 py-1">500</td></tr>
                                    <tr><td class="border px-2 py-1">commission_status</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">ä½£é‡‘ç‹€æ…‹</td><td class="border px-2 py-1">CALCULATED</td></tr>
                                    <tr><td class="border px-2 py-1">notes</td><td class="border px-2 py-1">æ–‡å­—</td><td class="border px-2 py-1">å‚™è¨»</td><td class="border px-2 py-1">ç‰¹æ®Šè¦æ±‚</td></tr>
                                    <tr><td class="border px-2 py-1">created_at</td><td class="border px-2 py-1">æ™‚é–“æˆ³</td><td class="border px-2 py-1">å»ºç«‹æ™‚é–“</td><td class="border px-2 py-1">2024/8/15 ä¸‹åˆ 3:41:43</td></tr>
                                    <tr><td class="border px-2 py-1">updated_at</td><td class="border px-2 py-1">æ™‚é–“æˆ³</td><td class="border px-2 py-1">æ›´æ–°æ™‚é–“</td><td class="border px-2 py-1">2024/8/15 ä¸‹åˆ 3:41:43</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeModal('sheetFieldsDiagnosticModal')" 
                            class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            é—œé–‰
                        </button>
                        <a href="https://docs.google.com/spreadsheets" target="_blank" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ğŸ“Š å‰å¾€ Google Sheets
                        </a>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // è¨ºæ–·çµç®—å•é¡Œ
        function diagnosePayout() {
            console.log('ğŸ”§ é–‹å§‹è¨ºæ–·çµç®—å•é¡Œ...');
            
            const modal = document.createElement('div');
            modal.id = 'diagnosticModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            let diagnosticResults = [];
            
            // æª¢æŸ¥ allData
            if (!allData) {
                diagnosticResults.push('âŒ allData æœªåˆå§‹åŒ–');
            } else {
                diagnosticResults.push('âœ… allData å·²åˆå§‹åŒ–');
            }
            
            // æª¢æŸ¥ payouts é™£åˆ—
            if (!allData.payouts) {
                diagnosticResults.push('âŒ allData.payouts ä¸å­˜åœ¨');
            } else if (!Array.isArray(allData.payouts)) {
                diagnosticResults.push('âŒ allData.payouts ä¸æ˜¯é™£åˆ—');
            } else {
                diagnosticResults.push(`âœ… allData.payouts æ˜¯é™£åˆ—ï¼Œé•·åº¦: ${allData.payouts.length}`);
                
                if (allData.payouts.length > 0) {
                    diagnosticResults.push('ğŸ“Š Payouts çµæ§‹åˆ†æ:');
                    allData.payouts.forEach((payout, index) => {
                        diagnosticResults.push(`  ${index}: ID=${payout.id || 'undefined'}, partner=${payout.partner_code}, amount=${payout.amount}, status=${payout.payout_status}`);
                    });
                    
                    // æª¢æŸ¥ ID å•é¡Œ
                    const withoutId = allData.payouts.filter(p => !p.id || p.id === '');
                    if (withoutId.length > 0) {
                        diagnosticResults.push(`âš ï¸  ç™¼ç¾ ${withoutId.length} ç­†è¨˜éŒ„æ²’æœ‰ ID`);
                    }
                }
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-yellow-800">ğŸ”§ çµç®—ç³»çµ±è¨ºæ–·å ±å‘Š</h2>
                        <button onclick="closeModal('diagnosticModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="p-6">
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h3 class="font-bold mb-3">è¨ºæ–·çµæœï¼š</h3>
                            <div class="space-y-2 text-sm font-mono">
                                ${diagnosticResults.map(result => `<div>${result}</div>`).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h3 class="font-bold mb-3">å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h3>
                            <ul class="space-y-2 text-sm">
                                <li>1. å¦‚æœçµç®—è¨˜éŒ„ç‚ºç©ºï¼Œè«‹åˆ° <a href="payouts-diagnostic.html" target="_blank" class="text-blue-600 underline">çµç®—è¨ºæ–·å·¥å…·</a> ä¿®å¾©</li>
                                <li>2. å¦‚æœæœ‰è¨˜éŒ„ä½†æ²’æœ‰ IDï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ç´¢å¼•ä½œç‚ºå‚™ç”¨</li>
                                <li>3. å¦‚æœé‡åˆ° 403 éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Google Apps Script éƒ¨ç½²è¨­å®š</li>
                                <li>4. å»ºè­°é‡æ–°è¼‰å…¥æ•¸æ“šå¾Œå†è©¦</li>
                            </ul>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="location.reload()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                ğŸ”„ é‡æ–°è¼‰å…¥é é¢
                            </button>
                            <button onclick="closeModal('diagnosticModal')" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ========== é»æ•¸è½‰æ›åŠŸèƒ½ ==========
        
        // ä½¿ç”¨ä½å®¿é‡‘æŠ˜æŠµ
        // ğŸ¯ çµ±ä¸€çš„å¤¥ä¼´æ“ä½œå½ˆå‡ºè¦–çª—
        async function showPartnerActionsModal(partnerCode, type) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°è©²å¤§ä½¿è³‡æ–™');
                return;
            }

            // âœ… ä½¿ç”¨æ­£ç¢ºçš„ Google Sheets æ¬„ä½è¨ˆç®—
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const accommodationBalance = totalEarned - totalPaid;
            const pendingCash = parseFloat(partner.pending_commission) || 0;

            let modalContent = '';
            
            if (type === 'accommodation') {
                if (accommodationBalance <= 0) {
                    showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰ä½å®¿é‡‘é¤˜é¡');
                    return;
                }
                
                modalContent = `
                    <div class="bg-white rounded-lg max-w-md w-full">
                        <div class="px-6 py-4 border-b flex justify-between items-center bg-blue-50">
                            <h2 class="text-xl font-bold text-blue-800">ğŸ’ é»æ•¸ç®¡ç†</h2>
                            <button onclick="closeModal('partnerActionsModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- é¤˜é¡é¡¯ç¤º -->
                            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                <div class="text-sm text-gray-600">å¤§ä½¿ï¼š${partner.name || partner.partner_code}</div>
                                <div class="text-2xl font-bold text-blue-700">å¯ç”¨é¤˜é¡ï¼š$${accommodationBalance.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ç´¯ç©ï¼š$${totalEarned.toLocaleString()} | å·²ä½¿ç”¨ï¼š$${totalPaid.toLocaleString()}
                                </div>
                            </div>
                            
                            <!-- æ“ä½œé¸é … -->
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="useAccommodationPoints('${partnerCode}')" 
                                        class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-all text-center">
                                    ğŸ  æŠ˜æŠµä½å®¿
                                </button>
                                <button onclick="convertPointsToCash('${partnerCode}')" 
                                        class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-all text-center">
                                    ğŸ’¸ è½‰æ›ç¾é‡‘
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'cash') {
                if (pendingCash <= 0) {
                    showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¾…çµç®—ç¾é‡‘');
                    return;
                }
                
                modalContent = `
                    <div class="bg-white rounded-lg max-w-md w-full">
                        <div class="px-6 py-4 border-b flex justify-between items-center bg-green-50">
                            <h2 class="text-xl font-bold text-green-800">ğŸ’° ç¾é‡‘ç®¡ç†</h2>
                            <button onclick="closeModal('partnerActionsModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- é¤˜é¡é¡¯ç¤º -->
                            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                <div class="text-sm text-gray-600">å¤§ä½¿ï¼š${partner.name || partner.partner_code}</div>
                                <div class="text-2xl font-bold text-green-700">å¾…çµç®—ï¼š$${pendingCash.toLocaleString()}</div>
                                <div class="text-xs text-gray-500 mt-1">éŠ€è¡Œå¸³æˆ¶ï¼š${partner.bank_name || 'æœªè¨­å®š'}</div>
                            </div>
                            
                            <!-- æ“ä½œé¸é … -->
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="processPayout('${partnerCode}')" 
                                        class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-green-700 transition-all text-center">
                                    ğŸ’° åŸ·è¡Œçµç®—
                                </button>
                                <button onclick="revertToCash('${partnerCode}')" 
                                        class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition-all text-center">
                                    ğŸ”„ æ”¹å›ä½å®¿é‡‘
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // å‰µå»ºä¸¦é¡¯ç¤ºå½ˆå‡ºè¦–çª—
            const modal = document.createElement('div');
            modal.id = 'partnerActionsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        async function useAccommodationPoints(partnerCode) {
            closeModal('partnerActionsModal'); // å…ˆé—œé–‰æ“ä½œé¸å–®
            
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            // âœ… ä½¿ç”¨æ­£ç¢ºçš„è¨ˆç®—å…¬å¼
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const availablePoints = totalEarned - totalPaid;
            
            console.log(`ğŸ” ä½¿ç”¨ä½å®¿é‡‘èª¿è©¦ - ${partnerCode}:`, {
                totalEarned,
                totalPaid,
                availablePoints,
                partner: partner
            });
            
            if (availablePoints <= 0) {
                showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¯ç”¨é»æ•¸');
                return;
            }

            // å‰µå»ºä½å®¿é‡‘æŠ˜æŠµæ¨¡æ…‹æ¡†
            const modal = document.createElement('div');
            modal.id = 'usePointsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="px-6 py-4 border-b flex justify-between items-center">
                        <h2 class="text-xl font-bold text-blue-800">ğŸ¨ ä½¿ç”¨ä½å®¿é‡‘æŠ˜æŠµ</h2>
                        <button onclick="closeModal('usePointsModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="usePointsForm" onsubmit="submitUsePoints(event, '${partnerCode}')" class="p-6 space-y-4">
                        <!-- é»æ•¸æ¦‚è¦½ -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm text-gray-600">å¤§ä½¿ï¼š${partner.name || partner.partner_code}</div>
                            <div class="text-lg font-bold text-blue-700">å¯ç”¨é»æ•¸ï¼š$${availablePoints.toLocaleString()}</div>
                        </div>
                        
                        <!-- å…¥ä½æ—¥æœŸ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å…¥ä½æ—¥æœŸ *</label>
                            <input type="date" id="use_checkin_date" required 
                                class="w-full p-2 border rounded-lg focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <!-- ä½¿ç”¨é‡‘é¡ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æŠ˜æŠµé‡‘é¡ *</label>
                            <input type="number" id="use_amount" required min="1" max="${availablePoints}" step="1" 
                                class="w-full p-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="è«‹è¼¸å…¥æŠ˜æŠµé‡‘é¡"
                                oninput="validateUseAmount(this, ${availablePoints})">
                            <div class="text-xs text-gray-500 mt-1">æœ€å¤§å¯ä½¿ç”¨ï¼š$${availablePoints.toLocaleString()}</div>
                            <div class="mt-2 flex gap-2">
                                <button type="button" onclick="setQuickAmount('use_amount', Math.min(1000, ${availablePoints}), ${availablePoints})" 
                                    class="px-3 py-1 bg-gray-100 text-sm rounded hover:bg-gray-200">$1,000</button>
                                <button type="button" onclick="setQuickAmount('use_amount', Math.min(2000, ${availablePoints}), ${availablePoints})" 
                                    class="px-3 py-1 bg-gray-100 text-sm rounded hover:bg-gray-200">$2,000</button>
                                <button type="button" onclick="setQuickAmount('use_amount', Math.min(3000, ${availablePoints}), ${availablePoints})" 
                                    class="px-3 py-1 bg-gray-100 text-sm rounded hover:bg-gray-200">$3,000</button>
                                <button type="button" onclick="setQuickAmount('use_amount', ${availablePoints}, ${availablePoints})" 
                                    class="px-3 py-1 bg-gray-100 text-sm rounded hover:bg-gray-200">å…¨éƒ¨</button>
                            </div>
                        </div>
                        
                        <!-- ç›¸é—œè¨‚æˆ¿ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç›¸é—œè¨‚æˆ¿IDï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="use_booking_ref" 
                                class="w-full p-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="è¼¸å…¥ç›¸é—œçš„è¨‚æˆ¿ç·¨è™Ÿ">
                        </div>
                        
                        <!-- å‚™è¨» -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                            <textarea id="use_notes" rows="2" 
                                class="w-full p-2 border rounded-lg focus:border-blue-500 focus:outline-none"
                                placeholder="é¸å¡«"></textarea>
                        </div>
                        
                        <!-- æŒ‰éˆ• -->
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeModal('usePointsModal')" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                å–æ¶ˆ
                            </button>
                            <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                ç¢ºèªæŠ˜æŠµ
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // æäº¤ä½å®¿é‡‘æŠ˜æŠµ
        async function submitUsePoints(event, partnerCode) {
            event.preventDefault();
            
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            const amount = parseFloat(document.getElementById('use_amount').value);
            const checkinDate = document.getElementById('use_checkin_date').value;
            const bookingRef = document.getElementById('use_booking_ref').value;
            const notes = document.getElementById('use_notes').value;
            
            // âœ… é©—è­‰é‡‘é¡ - ä½¿ç”¨æ­£ç¢ºçš„è¨ˆç®—å…¬å¼
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const availablePoints = totalEarned - totalPaid;
            if (amount <= 0) {
                showErrorMessage('æŠ˜æŠµé‡‘é¡å¿…é ˆå¤§æ–¼ 0');
                return;
            }
            if (amount > availablePoints) {
                showErrorMessage(`æŠ˜æŠµé‡‘é¡ä¸èƒ½è¶…éå¯ç”¨é»æ•¸ $${availablePoints.toLocaleString()}`);
                return;
            }
            
            try {
                console.log('ğŸ“ ä½å®¿é‡‘æŠ˜æŠµ - æäº¤æ•¸æ“š:', {
                    action: 'deduct_accommodation_points',
                    partner_code: partnerCode,
                    deduct_amount: amount,
                    related_booking_id: bookingRef || '',
                    usage_date: checkinDate,
                    available_points: availablePoints
                });
                
                // ä½¿ç”¨ fetch API é¿å… 403 éŒ¯èª¤
                const submitData = {
                    action: 'deduct_accommodation_points',
                    partner_code: partnerCode,
                    deduct_amount: amount,
                    related_booking_id: bookingRef || '',
                    usage_date: checkinDate,
                    notes: notes || `ä½å®¿é‡‘æŠ˜æŠµ $${amount.toLocaleString()} - ${checkinDate || new Date().toLocaleDateString()}`
                };
                
                console.log('ğŸ¨ ä½¿ç”¨ä½å®¿é‡‘ - æäº¤æ•¸æ“š:', submitData);
                
                const params = new URLSearchParams();
                Object.keys(submitData).forEach(key => {
                    params.append(key, submitData[key]);
                });
                
                console.log('ğŸ“¤ æ­£åœ¨æäº¤åˆ° Google Apps Script...');
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                
                console.log('ğŸ“¡ æ”¶åˆ°å›æ‡‰:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.text();
                console.log('ğŸ“„ å¾Œç«¯å›æ‡‰å…§å®¹:', result);
                
                // å˜—è©¦è§£æJSONå›æ‡‰
                let responseData;
                try {
                    responseData = JSON.parse(result);
                    console.log('ğŸ“Š è§£æå¾Œçš„å›æ‡‰:', responseData);
                } catch (parseError) {
                    console.error('âŒ JSON è§£æå¤±æ•—:', parseError);
                    console.error('åŸå§‹å…§å®¹:', result);
                    throw new Error('å¾Œç«¯å›æ‡‰æ ¼å¼ä¸æ­£ç¢º: ' + parseError.message);
                }
                
                if (!responseData.success) {
                    throw new Error(responseData.error || 'ä½¿ç”¨ä½å®¿é‡‘å¤±æ•—');
                }
                
                console.log('âœ… ä½¿ç”¨ä½å®¿é‡‘æˆåŠŸï¼å¾Œç«¯ç¢ºèª:', responseData);
                
                // æ›´æ–°å‰ç«¯æ•¸æ“š
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    // æ›´æ–° total_commission_paidï¼Œé€™æ¨£ä½å®¿é‡‘é¤˜é¡æœƒè‡ªå‹•æ¸›å°‘
                    const currentPaid = parseFloat(allData.partners[partnerIndex].total_commission_paid) || 0;
                    allData.partners[partnerIndex].total_commission_paid = currentPaid + amount;
                    
                    const newBalance = availablePoints - amount;
                    console.log('âœ… å‰ç«¯æ•¸æ“šæ›´æ–°å®Œæˆ:', {
                        partner: partnerCode,
                        total_commission_paid: allData.partners[partnerIndex].total_commission_paid,
                        accommodation_balance: newBalance
                    });
                }
                
                const newBalance = availablePoints - amount;
                showSuccessMessage(`âœ… æˆåŠŸä½¿ç”¨ $${amount.toLocaleString()} ä½å®¿é‡‘ï¼\nå‰©é¤˜é¤˜é¡ï¼š$${newBalance.toLocaleString()}`);
                closeModal('usePointsModal');
                displayPartners(allData.partners);
                
            } catch (error) {
                console.error('ä½¿ç”¨ä½å®¿é‡‘å¤±æ•—:', error);
                showErrorMessage('âŒ ä½¿ç”¨å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¨­å®šå¿«é€Ÿé‡‘é¡
        function setQuickAmount(inputId, amount, max) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = Math.min(amount, max);
                // è§¸ç™¼é©—è­‰
                validateUseAmount(input, max);
            }
        }

        // é©—è­‰ä½¿ç”¨é‡‘é¡
        function validateUseAmount(input, maxAmount) {
            const value = parseFloat(input.value);
            const warningDiv = input.parentNode.querySelector('.amount-warning');
            
            // ç§»é™¤æ—¢æœ‰è­¦å‘Š
            if (warningDiv) {
                warningDiv.remove();
            }
            
            if (value > maxAmount) {
                input.value = maxAmount;
                const warning = document.createElement('div');
                warning.className = 'amount-warning text-xs text-red-600 mt-1';
                warning.textContent = `é‡‘é¡å·²èª¿æ•´ç‚ºæœ€å¤§å¯ç”¨å€¼: $${maxAmount.toLocaleString()}`;
                input.parentNode.appendChild(warning);
                
                setTimeout(() => {
                    if (warning.parentNode) {
                        warning.remove();
                    }
                }, 3000);
            } else if (value <= 0) {
                const warning = document.createElement('div');
                warning.className = 'amount-warning text-xs text-red-600 mt-1';
                warning.textContent = 'é‡‘é¡å¿…é ˆå¤§æ–¼ 0';
                input.parentNode.appendChild(warning);
            }
        }

        // é»æ•¸è½‰ç¾é‡‘
        async function convertPointsToCash(partnerCode) {
            closeModal('partnerActionsModal'); // å…ˆé—œé–‰æ“ä½œé¸å–®
            
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            // âœ… ä¿®å¾©ï¼šä½¿ç”¨æ­£ç¢ºçš„é¤˜é¡è¨ˆç®—
            const totalEarned = parseFloat(partner.total_commission_earned) || 0;
            const totalPaid = parseFloat(partner.total_commission_paid) || 0;
            const availablePoints = totalEarned - totalPaid;
            
            console.log(`ğŸ” è½‰æ›ç¾é‡‘èª¿è©¦ - ${partnerCode}:`, {
                totalEarned,
                totalPaid,
                availablePoints,
                partner: partner
            });
            
            if (availablePoints <= 0) {
                showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¯ç”¨ä½å®¿é‡‘é¤˜é¡');
                return;
            }
            
            createPointsToCashModal(partner, availablePoints);
        }

        // å‰µå»ºé»æ•¸è½‰ç¾é‡‘æ¨¡æ…‹æ¡†
        function createPointsToCashModal(partner, availablePoints) {
            // âœ… ä½¿ç”¨å‚³å…¥çš„æ­£ç¢ºé¤˜é¡åƒæ•¸
            const exchangeRate = 0.5; // é»æ•¸è½‰ç¾é‡‘æ¯”ä¾‹ (50%)
            
            const modal = document.createElement('div');
            modal.id = 'pointsToCashModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-xl font-bold">ğŸ’° é»æ•¸è½‰æ›ç¾é‡‘ - ${partner.partner_code}</h3>
                        <button onclick="closeModal('pointsToCashModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- å¯ç”¨é»æ•¸ -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-bold mb-2">ğŸ’ å¯ç”¨é»æ•¸</h4>
                        <div class="text-2xl font-bold text-blue-600">${availablePoints.toLocaleString()} é»</div>
                        <div class="text-sm text-gray-600 mt-1">è½‰æ›æ¯”ä¾‹ï¼š1 é» = ${exchangeRate} å…ƒæ–°å°å¹£ (50%)</div>
                    </div>
                    
                    <!-- è½‰æ›è¨­å®š -->
                    <form id="pointsToCashForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è½‰æ›é»æ•¸</label>
                            <input type="number" id="points_to_convert" 
                                class="w-full p-3 border rounded-md" min="1" max="${availablePoints}" step="1"
                                placeholder="è¼¸å…¥è¦è½‰æ›çš„é»æ•¸" onchange="updateConvertedCashDisplay()" oninput="updateConvertedCashDisplay()">
                            <div class="text-xs text-gray-500 mt-1">æœ€å¤šå¯è½‰æ› ${availablePoints.toLocaleString()} é»</div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è½‰æ›å¾Œç¾é‡‘é‡‘é¡</label>
                            <div class="bg-gray-100 p-3 rounded font-mono text-lg font-bold text-green-600" id="cash_amount_display">
                                NT$ 0
                            </div>
                        </div>
                        
                        <!-- å¿«é€Ÿé¸æ“‡ -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold mb-2">âš¡ å¿«é€Ÿé¸æ“‡</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <button type="button" onclick="setConvertPoints(${Math.floor(availablePoints * 0.25)})" 
                                    class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                    25% (${Math.floor(availablePoints * 0.25)} é»)
                                </button>
                                <button type="button" onclick="setConvertPoints(${Math.floor(availablePoints * 0.5)})" 
                                    class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                    50% (${Math.floor(availablePoints * 0.5)} é»)
                                </button>
                                <button type="button" onclick="setConvertPoints(${Math.floor(availablePoints * 0.75)})" 
                                    class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                    75% (${Math.floor(availablePoints * 0.75)} é»)
                                </button>
                                <button type="button" onclick="setConvertPoints(${availablePoints})" 
                                    class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">
                                    å…¨éƒ¨ (${availablePoints} é»)
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è½‰æ›èªªæ˜</label>
                            <textarea id="conversion_notes" rows="2" class="w-full p-2 border rounded-md"
                                placeholder="èªªæ˜æ­¤æ¬¡è½‰æ›çš„åŸå› æˆ–ç”¨é€”..."></textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeModal('pointsToCashModal')" 
                                class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                å–æ¶ˆ
                            </button>
                            <button type="button" onclick="submitPointsToCash('${partner.partner_code}')" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                ğŸ’° ç¢ºèªè½‰æ›
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // è¨­å®šè½‰æ›é»æ•¸
        function setConvertPoints(points) {
            document.getElementById('points_to_convert').value = points;
            updateConvertedCashDisplay();
        }

        // æ›´æ–°è½‰æ›å¾Œçš„ç¾é‡‘é¡¯ç¤ºï¼ˆå°ˆé–€ç”¨æ–¼é»æ•¸è½‰æ›ï¼‰
        function updateConvertedCashDisplay() {
            const pointsInput = document.getElementById('points_to_convert');
            const cashDisplay = document.getElementById('cash_amount_display');
            
            if (!pointsInput || !cashDisplay) {
                console.error('æ‰¾ä¸åˆ°é»æ•¸è¼¸å…¥æˆ–ç¾é‡‘é¡¯ç¤ºå…ƒç´ ');
                return;
            }
            
            const points = parseFloat(pointsInput.value) || 0;
            const exchangeRate = 0.5; // è½‰æ›æ¯”ä¾‹ï¼š1é» = 0.5å…ƒ
            const cashAmount = Math.floor(points * exchangeRate);
            
            cashDisplay.textContent = `NT$ ${cashAmount.toLocaleString()}`;
            console.log(`æ›´æ–°ç¾é‡‘é¡¯ç¤º: ${points} é» â†’ NT$ ${cashAmount}`);
        }

        // æ›´æ–°ç¾é‡‘é‡‘é¡é¡¯ç¤ºï¼ˆcommission-management.js ä¸­çš„å‡½æ•¸ä¿ç•™ï¼‰
        // æ³¨æ„ï¼šé€™å€‹å‡½æ•¸åœ¨ commission-management.js ä¸­æœ‰å®Œæ•´å¯¦ç¾
        // é€™è£¡åªæ˜¯é¿å…èª¿ç”¨æ™‚å‡ºéŒ¯çš„å…¼å®¹æ€§è™•ç†
        function updateCashAmount() {
            // å¦‚æœæ˜¯åœ¨é»æ•¸è½‰æ›æ¨¡æ…‹æ¡†ä¸­èª¿ç”¨
            if (document.getElementById('points_to_convert') && document.getElementById('cash_amount_display')) {
                updateConvertedCashDisplay();
                return;
            }
            // å¦å‰‡äº¤çµ¦ commission-management.js è™•ç†
        }

        // æäº¤é»æ•¸è½‰ç¾é‡‘
        async function submitPointsToCash(partnerCode) {
            try {
                const points = parseInt(document.getElementById('points_to_convert').value) || 0;
                const notes = document.getElementById('conversion_notes').value.trim();
                const exchangeRate = 0.5;
                const cashAmount = Math.floor(points * exchangeRate);
                
                if (points <= 0) {
                    showErrorMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„è½‰æ›é»æ•¸');
                    return;
                }
                
                if (!notes) {
                    showErrorMessage('è«‹å¡«å¯«è½‰æ›èªªæ˜');
                    return;
                }
                
                const formData = {
                    action: 'convert_points_to_cash',
                    partner_code: partnerCode,
                    points_used: points,
                    cash_amount: cashAmount,
                    exchange_rate: exchangeRate,
                    notes: notes
                };
                
                console.log('ğŸ’° è½‰æ›ç¾é‡‘ - æäº¤æ•¸æ“š:', formData);
                
                // ä½¿ç”¨ form æäº¤é¿å… CORS å•é¡Œ
                console.log('ğŸ“¤ æ­£åœ¨æäº¤åˆ° Google Apps Script...');
                
                submitToBackendViaForm(formData);
                
                // çµ¦å¾Œç«¯æ™‚é–“è™•ç†
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                console.log('âœ… è½‰æ›ç¾é‡‘è«‹æ±‚å·²ç™¼é€ï¼ˆä½¿ç”¨ form æäº¤ï¼‰');
                
                // âœ… æ›´æ–°å‰ç«¯æ•¸æ“š
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    const partner = allData.partners[partnerIndex];
                    
                    // æ›´æ–°ä½å®¿é‡‘çµ±è¨ˆï¼šå¢åŠ  total_commission_paid
                    const currentPaid = parseFloat(partner.total_commission_paid) || 0;
                    partner.total_commission_paid = currentPaid + points;
                    
                    // æ›´æ–°å¾…çµç®—ç¾é‡‘ï¼šå¢åŠ  pending_commission
                    const currentPending = parseFloat(partner.pending_commission) || 0;
                    partner.pending_commission = currentPending + cashAmount;
                    
                    console.log('âœ… è½‰æ›ç¾é‡‘å‰ç«¯æ•¸æ“šæ›´æ–°:', {
                        partner: partnerCode,
                        points_used: points,
                        cash_amount: cashAmount,
                        total_commission_paid: partner.total_commission_paid,
                        pending_commission: partner.pending_commission
                    });
                }
                
                showSuccessMessage('âœ… æˆåŠŸè½‰æ› ' + points.toLocaleString() + ' é»ç‚º NT$ ' + cashAmount.toLocaleString() + 'ï¼');
                closeModal('pointsToCashModal');
                
                // å³æ™‚æ›´æ–°ç•¶å‰é¡¯ç¤º
                updateCurrentTabDisplay();
                
            } catch (error) {
                console.error('é»æ•¸è½‰æ›å¤±æ•—:', error);
                showErrorMessage('âŒ è½‰æ›å¤±æ•—ï¼š' + error.message);
            }
        }

        // ========== é€£çµç”Ÿæˆå™¨åŠŸèƒ½ ==========
        let linkgenGeneratedData = null;

        // è¼‰å…¥å¤¥ä¼´åˆ—è¡¨åˆ°é¸æ“‡å™¨
        async function loadPartnersForLinkGen() {
            try {
                if (allData.partners.length === 0) {
                    // åªåœ¨æ²’æœ‰æ•¸æ“šæ™‚æ‰é‡æ–°è¼‰å…¥
                    await loadRealData();
                }
                
                const select = document.getElementById('linkgen_partner_select');
                select.innerHTML = `
                    <option value="">-- é¸æ“‡ç¾æœ‰å¤¥ä¼´æˆ–æ–°å¢ --</option>
                    <option value="new">â• æ–°å¢å¤¥ä¼´</option>
                `;
                
                allData.partners.forEach(partner => {
                    const option = document.createElement('option');
                    option.value = partner.partner_code;
                    option.textContent = `${partner.name} (${partner.partner_code})`;
                    select.appendChild(option);
                });
                
                showSuccessMessage('âœ… å¤¥ä¼´åˆ—è¡¨å·²è¼‰å…¥');
            } catch (error) {
                console.error('è¼‰å…¥å¤¥ä¼´å¤±æ•—:', error);
                showErrorMessage('è¼‰å…¥å¤¥ä¼´å¤±æ•—ï¼š' + error.message);
            }
        }

        // é¸æ“‡å¤¥ä¼´æ™‚çš„è™•ç†
        function onPartnerSelect() {
            const select = document.getElementById('linkgen_partner_select');
            const selectedValue = select.value;
            const nameDiv = document.getElementById('linkgen_new_partner_name');
            
            if (selectedValue === 'new') {
                // é¡¯ç¤ºå§“åè¼¸å…¥æ¬„ä½
                nameDiv.classList.remove('hidden');
                // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
                document.getElementById('linkgen_partnerName').value = '';
                document.getElementById('linkgen_partnerCode').value = '';
                document.getElementById('linkgen_partnerEmail').value = '';
                document.getElementById('linkgen_couponCode').value = '';
                document.getElementById('linkgen_couponUrl').value = '';
                document.getElementById('linkgen_bankName').value = '';
                document.getElementById('linkgen_bankCode').value = '';
                document.getElementById('linkgen_bankBranch').value = '';
                document.getElementById('linkgen_bankAccountName').value = '';
                document.getElementById('linkgen_bankAccountNumber').value = '';
            } else if (selectedValue) {
                // é¸æ“‡ç¾æœ‰å¤¥ä¼´
                nameDiv.classList.add('hidden');
                const partner = allData.partners.find(p => p.partner_code === selectedValue);
                if (partner) {
                    document.getElementById('linkgen_partnerCode').value = partner.partner_code;
                    document.getElementById('linkgen_partnerEmail').value = partner.email || '';
                    document.getElementById('linkgen_couponCode').value = partner.coupon_code || '';
                    document.getElementById('linkgen_couponUrl').value = partner.coupon_url || '';
                    document.getElementById('linkgen_bankName').value = partner.bank_name || '';
                    document.getElementById('linkgen_bankCode').value = partner.bank_code || '';
                    document.getElementById('linkgen_bankBranch').value = partner.bank_branch || '';
                    document.getElementById('linkgen_bankAccountName').value = partner.bank_account_name || '';
                    document.getElementById('linkgen_bankAccountNumber').value = partner.bank_account_number || '';
                }
            } else {
                // æœªé¸æ“‡
                nameDiv.classList.add('hidden');
            }
        }

        // ç”Ÿæˆé€£çµ
        async function generatePartnerLinks() {
            const select = document.getElementById('linkgen_partner_select');
            const selectedValue = select.value;
            
            let partnerName = '';
            const partnerCode = document.getElementById('linkgen_partnerCode').value.trim();
            const couponUrl = document.getElementById('linkgen_couponUrl').value.trim();
            
            if (selectedValue === 'new') {
                partnerName = document.getElementById('linkgen_partnerName').value.trim();
                if (!partnerName) {
                    showErrorMessage('è«‹å¡«å¯«å¤¥ä¼´å§“å');
                    return;
                }
            } else if (selectedValue) {
                const partner = allData.partners.find(p => p.partner_code === selectedValue);
                partnerName = partner ? partner.name : '';
            } else {
                showErrorMessage('è«‹é¸æ“‡å¤¥ä¼´æˆ–æ–°å¢å¤¥ä¼´');
                return;
            }
            
            if (!partnerCode) {
                showErrorMessage('è«‹å¡«å¯«å¤¥ä¼´ä»£ç¢¼');
                return;
            }
            
            if (!couponUrl) {
                showErrorMessage('è«‹æä¾›å°ˆå±¬å„ªæƒ åˆ¸é€£çµ');
                return;
            }
            
            // é¡¯ç¤ºçµæœå€åŸŸ
            document.getElementById('linkgen_resultSection').classList.remove('hidden');
            
            // ç”Ÿæˆé€£çµ
            const landingUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=landing`;
            const trackedCouponUrl = `${APPS_SCRIPT_URL}?pid=${encodeURIComponent(partnerCode)}&dest=coupon&target=${encodeURIComponent(couponUrl)}`;
            
            // ç”Ÿæˆåˆ†äº«ç¯„æœ¬
            const shareText = `ğŸŒ² ä¾†è‡ªéœè¬æ£®æ—çš„ç‰¹åˆ¥é‚€è«‹

è¦ªæ„›çš„æœ‹å‹ï¼Œæˆ‘æƒ³èˆ‡ä½ åˆ†äº«ä¸€å€‹å¾ˆç‰¹åˆ¥çš„åœ°æ–¹ â€”â€” ä¸€ç‰‡èƒ½è®“å¿ƒéˆçœŸæ­£ä¼‘æ¯çš„æ£®æ—ã€‚

é€™è£¡ä¸åªæ˜¯ä½å®¿ï¼Œæ›´æ˜¯ä¸€å ´å›åˆ°å…§å¿ƒå®¶åœ’çš„æ—…ç¨‹ã€‚æˆ‘ç‚ºä½ æº–å‚™äº†ä¸€ä»½å°ˆå±¬çš„æ£®æ—ç¦®ç‰©ï¼Œå¸Œæœ›èƒ½ç‚ºä½ çš„ç”Ÿæ´»å¸¶ä¾†ä¸€äº›ä¸ä¸€æ¨£çš„å¯§éœèˆ‡æ„Ÿå‹•ã€‚

ğŸ é»æ“Šé€£çµï¼Œé–‹å§‹ä½ çš„æ£®æ—ä¹‹æ—…ï¼š
${landingUrl}

æœŸå¾…ä½ ä¹Ÿèƒ½åœ¨é€™è£¡ï¼Œæ‰¾åˆ°å±¬æ–¼è‡ªå·±çš„é‚£ä»½å®‰éœã€‚

â€”â€” ${partnerName} çœŸèª æ¨è–¦ â¤ï¸`;
            
            // ä¿å­˜ç”Ÿæˆçš„è³‡æ–™
            linkgenGeneratedData = {
                action: 'create_partner',
                partner_code: partnerCode,
                name: partnerName,
                email: document.getElementById('linkgen_partnerEmail').value.trim(),
                coupon_code: document.getElementById('linkgen_couponCode').value.trim(),
                coupon_url: couponUrl,
                landing_link: landingUrl,
                coupon_link: trackedCouponUrl,
                bank_name: document.getElementById('linkgen_bankName').value.trim(),
                bank_code: document.getElementById('linkgen_bankCode').value.trim(),
                bank_branch: document.getElementById('linkgen_bankBranch').value.trim(),
                bank_account_name: document.getElementById('linkgen_bankAccountName').value.trim(),
                bank_account_number: document.getElementById('linkgen_bankAccountNumber').value.trim()
            };
            
            // é¡¯ç¤ºçµæœ
            document.getElementById('linkgen_landingLink').textContent = landingUrl;
            document.getElementById('linkgen_couponLink').textContent = trackedCouponUrl;
            document.getElementById('linkgen_shareTemplate').textContent = shareText;
            
            showSuccessMessage('âœ… é€£çµç”ŸæˆæˆåŠŸï¼');
            
            // æ»¾å‹•åˆ°çµæœå€åŸŸ
            document.getElementById('linkgen_resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // å„²å­˜åˆ° Google Sheets
        async function savePartnerToSheets() {
            if (!linkgenGeneratedData) {
                showErrorMessage('è«‹å…ˆç”Ÿæˆé€£çµ');
                return;
            }
            
            try {
                // ä½¿ç”¨è¡¨å–®æäº¤æ–¹å¼
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';
                
                // æ·»åŠ æ‰€æœ‰æ•¸æ“šä½œç‚ºéš±è—è¼¸å…¥
                for (const [key, value] of Object.entries(linkgenGeneratedData)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value || '';
                    form.appendChild(input);
                }
                
                // ç¢ºä¿éš±è—iframeå­˜åœ¨
                let hiddenFrame = document.getElementById('hiddenFrame');
                if (!hiddenFrame) {
                    hiddenFrame = document.createElement('iframe');
                    hiddenFrame.id = 'hiddenFrame';
                    hiddenFrame.name = 'hiddenFrame';
                    hiddenFrame.style.display = 'none';
                    document.body.appendChild(hiddenFrame);
                }
                
                document.body.appendChild(form);
                form.submit();
                
                // å»¶æ™‚è™•ç†çµæœ
                setTimeout(() => {
                    showSuccessMessage('âœ… è³‡æ–™å·²å„²å­˜åˆ° Google Sheetsï¼');
                    
                    // ä¸è¦ç«‹å³é‡æ–°è¼‰å…¥æ•¸æ“šï¼Œé¿å…403éŒ¯èª¤
                    // åªæ›´æ–°æœ¬åœ°çš„å¤¥ä¼´åˆ—è¡¨
                    if (linkgenGeneratedData && linkgenGeneratedData.partner_code) {
                        // å°‡æ–°å¤¥ä¼´åŠ å…¥æœ¬åœ°æ•¸æ“š
                        const newPartner = {
                            partner_code: linkgenGeneratedData.partner_code,
                            name: linkgenGeneratedData.name,
                            email: linkgenGeneratedData.email,
                            // å…¶ä»–å¿…è¦æ¬„ä½...
                        };
                        allData.partners.push(newPartner);
                        loadPartnersForLinkGen(); // åªæ›´æ–°ä¸‹æ‹‰é¸å–®
                    }
                    
                    document.body.removeChild(form);
                }, 2000);
                
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                showErrorMessage('âŒ å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¤‡è£½æ–‡å­—
        function copyLinkText(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                // é€€åŒ–æ–¹æ¡ˆï¼šé¸å–æ–‡å­—
                const range = document.createRange();
                range.selectNode(element);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                alert('è«‹æŒ‰ Ctrl+C è¤‡è£½');
            });
        }

        // éš±è—éŒ¯èª¤æ©«å¹…
        function hideErrorBanner() {
            document.getElementById('script-error-banner').classList.add('hidden');
        }
        
        // é¡¯ç¤º 403 éŒ¯èª¤æ©«å¹…
        function show403ErrorBanner() {
            document.getElementById('script-error-banner').classList.remove('hidden');
        }
        
        // æª¢æ¸¬ 403 éŒ¯èª¤
        function detect403Error() {
            // ç›£è½ç¶²è·¯éŒ¯èª¤
            window.addEventListener('unhandledrejection', function(event) {
                if (event.reason && event.reason.message && event.reason.message.includes('403')) {
                    console.error('âŒ åµæ¸¬åˆ° 403 éŒ¯èª¤');
                    show403ErrorBanner();
                }
            });
            
            // ç›£è½ console éŒ¯èª¤
            const originalConsoleError = console.error;
            console.error = function(...args) {
                const message = args.join(' ');
                if (message.includes('403') || message.includes('Forbidden')) {
                    show403ErrorBanner();
                }
                originalConsoleError.apply(console, args);
            };
        }
        
        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // å•Ÿå‹• 403 éŒ¯èª¤æª¢æ¸¬
            detect403Error();
            
            // å…ˆæª¢æŸ¥ Apps Script é€£ç·š
            const isConnected = await checkAppsScriptConnection();
            
            if (!isConnected) {
                // é¡¯ç¤ºæ©«å¹…éŒ¯èª¤æç¤º
                show403ErrorBanner();
                
                // é¡¯ç¤ºå³ä¸Šè§’éŒ¯èª¤æç¤ºï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
                const alertDiv = document.createElement('div');
                alertDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded z-50';
                alertDiv.innerHTML = `
                    <strong>âš ï¸ Apps Script é€£ç·šå•é¡Œ</strong><br>
                    <a href="google-apps-script-fix.html" target="_blank" class="underline">é»æ­¤æŸ¥çœ‹ä¿®å¾©æŒ‡å—</a>
                `;
                document.body.appendChild(alertDiv);
            }
            
            showTab('overview');
            // è‡ªå‹•è¼‰å…¥å¤¥ä¼´åˆ—è¡¨
            setTimeout(() => {
                loadPartnersForLinkGen();
            }, 1000);
        });
        
        // ä¿®å¾©æ•¸æ“šæ˜ å°„å•é¡Œ
        async function fixDataMapping() {
            try {
                console.log('ğŸ”§ é–‹å§‹è¨ºæ–· Google Sheets æ¬„ä½å°æ‡‰...');
                
                // é¡¯ç¤ºè¨ºæ–·ä¸­æç¤º
                const table = document.getElementById('bookingsTable');
                table.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto">
                                <div class="text-blue-600 font-bold mb-2">ğŸ”§ è¨ºæ–·ä¸­...</div>
                                <div class="text-sm text-blue-700">
                                    æ­£åœ¨åˆ†æ Google Sheets æ•¸æ“šçµæ§‹ï¼Œè«‹ç¨å€™...
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // å…ˆç²å–åŸå§‹æ•¸æ“šé€²è¡Œåˆ†æ
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=get_dashboard_data'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.text();
                console.log('ğŸ“¥ è¨ºæ–·ç”¨æ•¸æ“šå›æ‡‰:', result);
                
                // å˜—è©¦è§£æä¸¦åˆ†ææ•¸æ“šçµæ§‹
                let rawData;
                try {
                    rawData = JSON.parse(result);
                } catch (parseError) {
                    console.error('âŒ ç„¡æ³•è§£æåŸå§‹æ•¸æ“š:', parseError);
                    table.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-8">
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md mx-auto">
                                    <div class="text-red-600 font-bold mb-2">âŒ è¨ºæ–·å¤±æ•—</div>
                                    <div class="text-sm text-red-700">
                                        ç„¡æ³•å¾ Google Sheets ç²å–æœ‰æ•ˆæ•¸æ“šã€‚è«‹æª¢æŸ¥ Apps Script æ˜¯å¦æ­£å¸¸é‹ä½œã€‚
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // é¡¯ç¤ºè¨ºæ–·çµæœ
                showDataDiagnosisModal(rawData);
                
            } catch (error) {
                console.error('âŒ è¨ºæ–·å¤±æ•—:', error);
                const table = document.getElementById('bookingsTable');
                table.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-8">
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md mx-auto">
                                <div class="text-red-600 font-bold mb-2">âŒ è¨ºæ–·éŒ¯èª¤</div>
                                <div class="text-sm text-red-700 mb-3">
                                    ${error.message}
                                </div>
                                <button onclick="location.reload()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                                    ğŸ”„ é‡æ–°è¼‰å…¥é é¢
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // é¡¯ç¤ºæ•¸æ“šè¨ºæ–·æ¨¡æ…‹æ¡†
        function showDataDiagnosisModal(rawData) {
            const modal = document.createElement('div');
            modal.id = 'dataDiagnosisModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            let diagnosisContent = '';
            
            if (rawData && rawData.bookings && rawData.bookings.length > 0) {
                const firstBooking = rawData.bookings[0];
                const fieldCount = Object.keys(firstBooking).length;
                
                // å®šç¾©æ­£ç¢ºçš„æ¬„ä½é †åºï¼ˆåŸºæ–¼ç”¨æˆ¶æä¾›çš„å¯¦éš›æ¬„ä½ï¼‰
                const expectedFields = [
                    'id', 'partner_code', 'guest_name', 'guest_phone', 'guest_email', 
                    'bank_account_last5', 'checkin_date', 'checkout_date', 'room_price', 
                    'booking_source', 'stay_status', 'payment_status', 'commission_status', 
                    'commission_amount', 'commission_type', 'is_first_referral_bonus', 
                    'first_referral_bonus_amount', 'manually_confirmed_by', 'manually_confirmed_at', 
                    'notes', 'created_at', 'updated_at'
                ];
                
                // åˆ†ææ•¸æ“šæ˜ å°„
                const actualFields = Object.keys(firstBooking);
                const mappingAnalysis = actualFields.map((actualField, index) => {
                    const expectedField = expectedFields[index];
                    const value = firstBooking[actualField];
                    const isCorrect = actualField === expectedField;
                    
                    return {
                        index,
                        actual: actualField,
                        expected: expectedField,
                        value: JSON.stringify(value),
                        isCorrect,
                        problem: !isCorrect ? `æ‡‰è©²æ˜¯ ${expectedField}` : null
                    };
                });
                
                diagnosisContent = `
                    <h4 class="font-bold mb-3">ğŸ“‹ æ¬„ä½æ˜ å°„åˆ†æï¼š</h4>
                    <div class="bg-gray-50 p-3 rounded text-xs max-h-60 overflow-y-auto mb-4">
                        <div class="font-bold text-blue-600 mb-2">å¯¦éš›æ¬„ä½æ•¸é‡: ${fieldCount} | æœŸæœ›æ¬„ä½æ•¸é‡: ${expectedFields.length}</div>
                        <div class="grid gap-1">
                            ${mappingAnalysis.map(item => 
                                `<div class="flex items-center space-x-2 ${item.isCorrect ? 'text-green-700' : 'text-red-700'}">
                                    <span class="font-mono w-8">[${item.index}]</span>
                                    <span class="w-24 ${item.isCorrect ? 'bg-green-100' : 'bg-red-100'} px-1 rounded">${item.actual}</span>
                                    ${item.isCorrect ? 'âœ…' : 'âŒ'}
                                    ${!item.isCorrect ? `<span class="text-xs">(${item.problem})</span>` : ''}
                                    <span class="text-gray-600 truncate max-w-32">${item.value.substring(0, 30)}${item.value.length > 30 ? '...' : ''}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <h4 class="font-bold mt-4 mb-3">ğŸ” ç™¼ç¾çš„å…·é«”å•é¡Œï¼š</h4>
                    <div class="text-sm space-y-2">
                        ${mappingAnalysis.filter(item => !item.isCorrect).length > 0 ? `
                            <div class="text-red-600">âŒ æœ‰ ${mappingAnalysis.filter(item => !item.isCorrect).length} å€‹æ¬„ä½æ˜ å°„éŒ¯èª¤</div>
                            <div class="bg-red-50 p-2 rounded text-xs">
                                <strong>éŒ¯èª¤è©³æƒ…ï¼š</strong><br>
                                ${mappingAnalysis.filter(item => !item.isCorrect).map(item => 
                                    `â€¢ ä½ç½® ${item.index}: å¾—åˆ° "${item.actual}"ï¼ŒæœŸæœ› "${item.expected}"`
                                ).join('<br>')}
                            </div>
                        ` : '<div class="text-green-600">âœ… æ‰€æœ‰æ¬„ä½æ˜ å°„æ­£ç¢º</div>'}
                        
                        ${actualFields.length !== expectedFields.length ? `
                            <div class="text-orange-600">âš ï¸ æ¬„ä½æ•¸é‡ä¸åŒ¹é…ï¼šå¯¦éš› ${actualFields.length} å€‹ï¼ŒæœŸæœ› ${expectedFields.length} å€‹</div>
                        ` : ''}
                    </div>
                    
                    <h4 class="font-bold mt-4 mb-3">ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š</h4>
                    <div class="text-sm space-y-1 text-gray-700">
                        <div>â€¢ Google Apps Script ä¸­çš„æ¬„ä½æ˜ å°„é‚è¼¯ä¸æ­£ç¢º</div>
                        <div>â€¢ Google Sheets çš„æ•¸æ“šè¡Œç¼ºå°‘ ID æ¬„ä½ï¼ˆæ•¸æ“šå¾ç¬¬2åˆ—é–‹å§‹ï¼‰</div>
                        <div>â€¢ æ‰‹å‹•ç™»è¨˜æ•¸æ“šæ™‚è·³éäº†æŸäº›æ¬„ä½</div>
                        <div>â€¢ Apps Script è™•ç†æ•¸çµ„æ™‚ç´¢å¼•åç§»</div>
                    </div>
                `;
            } else {
                diagnosisContent = '<div class="text-red-600">âŒ ç„¡æ³•ç²å–æœ‰æ•ˆçš„è¨‚æˆ¿æ•¸æ“šæˆ–æ•¸æ“šç‚ºç©º</div>';
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-xl font-bold text-red-800">ğŸ”§ Google Sheets æ•¸æ“šè¨ºæ–·</h3>
                        <button onclick="closeModal('dataDiagnosisModal')" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    ${diagnosisContent}
                    
                    <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-bold text-yellow-800 mb-2">ğŸ› ï¸ å…·é«”ä¿®å¾©æ­¥é©Ÿï¼š</h4>
                        <ol class="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                            <li><strong>ç«‹å³ä¿®å¾©ï¼š</strong>åœ¨ Google Sheets çš„æ•¸æ“šè¡Œç¬¬ä¸€åˆ—ï¼ˆAåˆ—ï¼‰æ·»åŠ  ID å€¼</li>
                            <li><strong>æª¢æŸ¥ Apps Scriptï¼š</strong>ç¢ºèªæ•¸æ“šè™•ç†æ™‚æ˜¯å¦æ­£ç¢ºè™•ç†äº†æ‰€æœ‰22å€‹æ¬„ä½</li>
                            <li><strong>é©—è­‰æ¨™é¡Œè¡Œï¼š</strong>ç¢ºèª Sheets ç¬¬ä¸€è¡Œçš„æ¬„ä½æ¨™é¡Œé †åºèˆ‡æœŸæœ›ä¸€è‡´</li>
                            <li><strong>æ•¸æ“šæ¸…ç†ï¼š</strong>æª¢æŸ¥æ¯è¡Œæ•¸æ“šæ˜¯å¦æœ‰ç¼ºå¤±å€¼æˆ–æ ¼å¼éŒ¯èª¤</li>
                            <li><strong>æ¸¬è©¦ä¿®å¾©ï¼š</strong>æ–°å¢ä¸€ç­†å®Œæ•´æ•¸æ“šæ¸¬è©¦æ¬„ä½æ˜ å°„æ˜¯å¦æ­£ç¢º</li>
                        </ol>
                        <div class="mt-3 p-2 bg-red-100 rounded text-xs text-red-800">
                            <strong>ç·Šæ€¥ä¿®å¾©å»ºè­°ï¼š</strong>æ ¹æ“šå¯¦éš›æ•¸æ“šåˆ†æï¼Œå•é¡Œæ˜¯ç¼ºå°‘ ID æ¬„ä½å°è‡´æ‰€æœ‰æ•¸æ“šå‘å·¦åç§»ä¸€å€‹ä½ç½®ã€‚
                            è«‹åœ¨æ¯ç­†æ•¸æ“šçš„ç¬¬ä¸€åˆ—æ·»åŠ å”¯ä¸€ ID å€¼ï¼ˆå¦‚ï¼š1, 2, 3...ï¼‰ã€‚
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="window.open('https://sheets.google.com', '_blank')" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            ğŸ“Š æ‰“é–‹ Google Sheets
                        </button>
                        <button onclick="window.open('https://script.google.com', '_blank')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            ğŸ”§ Apps Script æ§åˆ¶å°
                        </button>
                        <button onclick="closeModal('dataDiagnosisModal')" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ========== æ–°å¢çš„æ™ºèƒ½æ“ä½œåŠŸèƒ½ ==========

        // æ‰¹é‡é¸æ“‡ç®¡ç†
        let selectedPartners = new Set();

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.partner-selector:checked');
            selectedPartners.clear();
            
            checkboxes.forEach(cb => {
                selectedPartners.add(cb.dataset.partnerCode);
            });
            
            const toolbar = document.getElementById('batchToolbar');
            const countSpan = document.getElementById('selectedCount');
            
            if (selectedPartners.size > 0) {
                toolbar.classList.remove('hidden');
                countSpan.textContent = selectedPartners.size;
            } else {
                toolbar.classList.add('hidden');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.partner-selector').forEach(cb => cb.checked = false);
            selectedPartners.clear();
            document.getElementById('batchToolbar').classList.add('hidden');
        }

        // åŸ·è¡Œæ‰¹é‡æ“ä½œ
        async function executeBatchAction() {
            const operation = document.getElementById('batchOperation').value;
            if (!operation || selectedPartners.size === 0) {
                showErrorMessage('è«‹é¸æ“‡æ“ä½œå’Œå¤¥ä¼´');
                return;
            }

            const confirmed = confirm(`ç¢ºå®šè¦å° ${selectedPartners.size} ä½å¤¥ä¼´åŸ·è¡Œã€Œ${operation}ã€æ“ä½œå—ï¼Ÿ`);
            if (!confirmed) return;

            try {
                const results = [];
                
                for (const partnerCode of selectedPartners) {
                    switch (operation) {
                        case 'convert_all':
                            await quickConvertToCash(partnerCode, true); // true = batch mode
                            break;
                        case 'payout_pending':
                            await processPayout(partnerCode, true);
                            break;
                        case 'export_selected':
                            // æ‰¹é‡åŒ¯å‡ºè™•ç†
                            break;
                    }
                }
                
                showSuccessMessage(`âœ… æ‰¹é‡æ“ä½œå®Œæˆï¼æˆåŠŸè™•ç† ${selectedPartners.size} ä½å¤¥ä¼´`);
                clearSelection();
                
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                setTimeout(() => loadRealData().then(() => displayPartners(allData.partners)), 1000);
                
            } catch (error) {
                console.error('æ‰¹é‡æ“ä½œå¤±æ•—:', error);
                showErrorMessage('âŒ æ‰¹é‡æ“ä½œå¤±æ•—ï¼š' + error.message);
            }
        }

        // ç®¡ç†ä¸‹æ‹‰é¸å–®åˆ‡æ›
        function toggleManagementDropdown(partnerCode) {
            const dropdown = document.getElementById(`management-${partnerCode}`);
            
            // é—œé–‰å…¶ä»–ä¸‹æ‹‰é¸å–®
            document.querySelectorAll('[id^="management-"]').forEach(d => {
                if (d.id !== `management-${partnerCode}`) {
                    d.classList.add('hidden');
                }
            });
            
            dropdown.classList.toggle('hidden');
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰ä¸‹æ‹‰é¸å–®
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[id^="management-"]') && !event.target.closest('button[onclick*="toggleManagementDropdown"]')) {
                document.querySelectorAll('[id^="management-"]').forEach(d => d.classList.add('hidden'));
            }
        });

        // ä¸€éµè½‰æ›ç¾é‡‘ (å„ªåŒ–ç‰ˆ)
        async function quickConvertToCash(partnerCode, batchMode = false) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                if (!batchMode) showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }

            const accommodationPoints = partner.available_points || partner.total_commission_earned || 0;
            if (accommodationPoints <= 0) {
                if (!batchMode) showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¯è½‰æ›çš„ä½å®¿é‡‘');
                return;
            }

            const cashAmount = Math.floor(accommodationPoints * 0.5);
            
            if (!batchMode) {
                // å–®ä¸€æ“ä½œé¡¯ç¤ºç¢ºèªå°è©±æ¡†
                const confirmed = confirm(`ğŸ’° è½‰æ›ç¢ºèª - ${partner.name || partner.partner_code}

ä½å®¿é‡‘ï¼š${accommodationPoints.toLocaleString()} é»
    â†“
ç¾é‡‘ï¼šNT$ ${cashAmount.toLocaleString()}

è½‰æ›å¾Œå°‡åœ¨ä¸‹æœˆ15æ—¥å‰è½‰å¸³çµ¦å¤¥ä¼´

ç¢ºå®šè¦è½‰æ›å—ï¼Ÿ`);
                
                if (!confirmed) return;
            }

            try {
                // ä½¿ç”¨ form æäº¤é¿å… CORS å•é¡Œ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hidden_iframe';
                form.style.display = 'none';

                const submitData = {
                    action: 'create_payout',
                    partner_code: partnerCode,
                    payout_type: 'CASH',
                    amount: cashAmount,
                    payout_method: 'BANK_TRANSFER',
                    notes: `ä½å®¿é‡‘è½‰ç¾é‡‘ï¼š${accommodationPoints} é» â†’ NT$ ${cashAmount} (æ¯”ä¾‹ 50%)`
                };

                // æ·»åŠ è¡¨å–®å­—æ®µ
                Object.keys(submitData).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = submitData[key] || '';
                    form.appendChild(input);
                });

                document.body.appendChild(form);

                // å‰µå»ºéš±è—çš„ iframe ç”¨æ–¼æäº¤
                let iframe = document.getElementById('hidden_iframe');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.id = 'hidden_iframe';
                    iframe.name = 'hidden_iframe';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }

                // æäº¤è¡¨å–®
                form.submit();

                // å»¶æ™‚è™•ç†çµæœï¼ˆæ¨¡æ“¬æˆåŠŸï¼Œå› ç‚ºç„¡æ³•è®€å–iframeå…§å®¹ï¼‰
                setTimeout(() => {
                    // æ›´æ–°å‰ç«¯æ•¸æ“š
                    const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                    if (partnerIndex !== -1) {
                        const p = allData.partners[partnerIndex];
                        p.available_points = 0;
                        p.pending_cash = (p.pending_cash || 0) + cashAmount;
                        p.total_points_used = (p.total_points_used || 0) + accommodationPoints;
                    }

                    if (!batchMode) {
                        showSuccessMessage(`âœ… è½‰æ›è™•ç†ä¸­ï¼${accommodationPoints.toLocaleString()} é» â†’ NT$ ${cashAmount.toLocaleString()}`);
                        displayPartners(allData.partners);
                    }

                    // æ¸…ç†è¡¨å–®
                    if (form && form.parentNode) {
                        document.body.removeChild(form);
                    }
                }, 1000);

            } catch (error) {
                console.error('è½‰æ›å¤±æ•—:', error);
                if (!batchMode) showErrorMessage('âŒ è½‰æ›å¤±æ•—ï¼š' + error.message);
            }
        }

        // è™•ç†çµç®—
        async function processPayout(partnerCode, batchMode = false) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                if (!batchMode) showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }

            const pendingAmount = partner.pending_cash || partner.pending_commission || 0;
            if (pendingAmount <= 0) {
                if (!batchMode) showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¾…æ”¯ä»˜ç¾é‡‘');
                return;
            }

            if (!batchMode) {
                const confirmed = confirm(`ğŸ’³ ç¢ºèªçµç®— - ${partner.name || partner.partner_code}

å¾…æ”¯ä»˜é‡‘é¡ï¼šNT$ ${pendingAmount.toLocaleString()}

ç¢ºå®šå·²è½‰å¸³å®Œæˆï¼Œè¦æ¨™è¨˜ç‚ºã€Œå·²çµç®—ã€å—ï¼Ÿ`);
                
                if (!confirmed) return;
            }

            try {
                // ğŸ¯ æŸ¥æ‰¾å°æ‡‰çš„ pending payout è¨˜éŒ„
                const pendingPayout = allData.payouts.find(p => 
                    p.partner_code === partnerCode && 
                    p.payout_status === 'PENDING' && 
                    p.payout_type === 'CASH' &&
                    parseFloat(p.amount) === pendingAmount
                );

                if (!pendingPayout) {
                    if (!batchMode) showErrorMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„å¾…çµç®—è¨˜éŒ„');
                    return;
                }

                // ğŸ¯ èª¿ç”¨å¾Œç«¯ API æ›´æ–°çµç®—ç‹€æ…‹
                const updateData = {
                    action: 'update_payout',
                    payout_id: pendingPayout.id,
                    amount: pendingAmount,
                    payout_status: 'PAID',
                    notes: `ğŸ‘¤ ç®¡ç†è€…æ‰‹å‹•è™•ç†çµç®— - ${new Date().toLocaleString()}`
                };

                console.log('ğŸš€ æº–å‚™æ›´æ–°çµç®—ç‹€æ…‹:', updateData);

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(updateData)
                });

                const result = await response.json();
                console.log('ğŸ“ çµç®—ç‹€æ…‹æ›´æ–°å›æ‡‰:', result);

                if (!result.success) {
                    throw new Error(result.error || 'æ›´æ–°çµç®—ç‹€æ…‹å¤±æ•—');
                }

                // ğŸ¯ æ›´æ–°æœ¬åœ°æ•¸æ“š
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    allData.partners[partnerIndex].pending_cash = 0;
                    allData.partners[partnerIndex].pending_commission = 0;
                }

                // æ›´æ–° payouts æ•¸æ“š
                const payoutIndex = allData.payouts.findIndex(p => p.id === pendingPayout.id);
                if (payoutIndex !== -1) {
                    allData.payouts[payoutIndex].payout_status = 'PAID';
                    allData.payouts[payoutIndex].notes = updateData.notes;
                }

                if (!batchMode) {
                    showSuccessMessage(`âœ… çµç®—å®Œæˆï¼å·²è½‰å¸³ NT$ ${pendingAmount.toLocaleString()}`);
                    displayPartners(allData.partners);
                    closeModal('partnerActionsModal');
                }

            } catch (error) {
                console.error('âŒ çµç®—å¤±æ•—:', error);
                if (!batchMode) showErrorMessage('âŒ çµç®—å¤±æ•—ï¼š' + error.message);
            }
        }

        // ä½£é‡‘ç·¨è¼¯åŠŸèƒ½
        function enableCommissionEdit(partnerCode) {
            document.getElementById(`commission-view-${partnerCode}`).classList.add('hidden');
            document.getElementById(`commission-edit-${partnerCode}`).classList.remove('hidden');
        }

        function cancelCommissionEdit(partnerCode) {
            document.getElementById(`commission-view-${partnerCode}`).classList.remove('hidden');
            document.getElementById(`commission-edit-${partnerCode}`).classList.add('hidden');
        }

        async function saveCommissionEdit(partnerCode) {
            // ç²å–ç¾æœ‰å¤¥ä¼´æ•¸æ“š
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }
            
            // è¨˜éŒ„åŸå§‹å€¼
            const oldTotalEarned = parseFloat(partner.total_commission_earned) || 0;
            const oldTotalPaid = parseFloat(partner.total_commission_paid) || 0;
            const oldPendingCash = parseFloat(partner.pending_commission) || 0;
            
            // ç²å–æ–°å€¼
            const totalEarned = parseFloat(document.getElementById(`edit-total-earned-${partnerCode}`).value) || 0;
            const totalPaid = parseFloat(document.getElementById(`edit-total-paid-${partnerCode}`).value) || 0;
            const pendingCash = parseFloat(document.getElementById(`edit-pending-cash-${partnerCode}`).value) || 0;
            const notes = document.getElementById(`edit-notes-${partnerCode}`).value.trim();

            if (!notes) {
                showErrorMessage('è«‹å¡«å¯«èª¿æ•´å‚™è¨»');
                return;
            }

            if (totalEarned < 0 || totalPaid < 0 || pendingCash < 0) {
                showErrorMessage('é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸');
                return;
            }

            if (totalPaid > totalEarned) {
                showErrorMessage('å·²ä½¿ç”¨é»æ•¸ä¸èƒ½è¶…éç´¯ç©ä½£é‡‘');
                return;
            }
            
            // è¨ˆç®—èª¿æ•´é‡‘é¡ï¼ˆæ–°å€¼ - èˆŠå€¼ï¼‰
            const adjustmentAmount = totalEarned - oldTotalEarned;
            const adjustmentText = adjustmentAmount >= 0 ? `+${adjustmentAmount}` : `${adjustmentAmount}`;

            try {
                // ğŸ¯ å‰µå»ºæ‰‹å‹•èª¿æ•´è¨˜éŒ„åˆ° Payouts è¡¨
                const adjustmentData = {
                    action: 'create_payout',
                    partner_code: partnerCode,
                    payout_type: 'ADJUSTMENT',
                    amount: adjustmentAmount, // ä¿ç•™åŸå§‹å€¼ï¼ˆå¯èƒ½ç‚ºè² ï¼‰
                    payout_method: 'MANUAL_ADJUSTMENT',
                    payout_status: 'COMPLETED',
                    notes: `ğŸ‘¤ ç®¡ç†è€…æ‰‹å‹•èª¿æ•´ - ${notes} - ç´¯ç©ä½£é‡‘ ${adjustmentText} - ${new Date().toLocaleString()}`
                };

                console.log('ğŸš€ æº–å‚™å‰µå»ºæ‰‹å‹•èª¿æ•´è¨˜éŒ„:', adjustmentData);

                // åªç™¼é€ä¸€æ¬¡è«‹æ±‚ï¼šæ›´æ–°ä½£é‡‘è³‡è¨Šï¼ˆä¸éœ€è¦å–®ç¨å‰µå»º payoutï¼‰
                // å¾Œç«¯æœƒè‡ªå‹•è¨˜éŒ„èª¿æ•´æ­·å²
                const updateData = {
                    action: 'update_partner_commission',
                    partner_code: partnerCode,
                    total_commission_earned: totalEarned,
                    total_commission_paid: totalPaid,
                    pending_commission: pendingCash,
                    adjustment_amount: adjustmentAmount, // å‚³éèª¿æ•´é‡‘é¡
                    adjustment_notes: notes // å‚³éèª¿æ•´å‚™è¨»
                };

                console.log('ğŸš€ æº–å‚™æ›´æ–°å¤¥ä¼´ä½£é‡‘ï¼ˆå«èª¿æ•´è¨˜éŒ„ï¼‰:', updateData);

                // ä½¿ç”¨ form æäº¤æ–¹å¼é¿å… CORS å•é¡Œ
                submitToBackendViaForm(updateData);
                
                // çµ¦å¾Œç«¯æ™‚é–“è™•ç†
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                console.log('âœ… ä½£é‡‘èª¿æ•´è«‹æ±‚å·²ç™¼é€');

                // ğŸ¯ æ›´æ–°æœ¬åœ°æ•¸æ“š
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    allData.partners[partnerIndex].total_commission_earned = totalEarned;
                    allData.partners[partnerIndex].total_commission_paid = totalPaid;
                    allData.partners[partnerIndex].pending_commission = pendingCash;
                    allData.partners[partnerIndex].pending_cash = pendingCash;
                }

                // åªåœ¨æœ¬åœ°æ·»åŠ ä¸€å€‹èª¿æ•´è¨˜éŒ„ï¼ˆä¸è¦é‡è¤‡ï¼‰
                // æ³¨æ„ï¼šå¾Œç«¯æœƒè‡ªå‹•å‰µå»ºè¨˜éŒ„ï¼Œæ‰€ä»¥é€™è£¡åªæ˜¯æš«æ™‚é¡¯ç¤ºç”¨
                const tempAdjustmentRecord = {
                    id: `adj_${Date.now()}`,
                    partner_code: partnerCode,
                    payout_type: 'ADJUSTMENT',
                    amount: adjustmentAmount, // ä¿ç•™åŸå§‹å€¼ï¼ˆå¯èƒ½ç‚ºè² ï¼‰
                    payout_method: 'MANUAL_ADJUSTMENT',
                    payout_status: 'COMPLETED',
                    notes: `æ‰‹å‹•èª¿æ•´ç´¯ç©ä½£é‡‘ ${adjustmentText}`, // ç°¡æ½”çš„èªªæ˜
                    created_at: new Date().toISOString()
                };
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„èª¿æ•´è¨˜éŒ„ï¼ˆé¿å…é‡è¤‡ï¼‰
                const existingRecord = allData.payouts.find(p => 
                    p.partner_code === partnerCode && 
                    p.payout_type === 'ADJUSTMENT' &&
                    p.notes && p.notes.includes(adjustmentText) &&
                    Math.abs(new Date(p.created_at).getTime() - new Date().getTime()) < 5000 // 5ç§’å…§
                );
                
                if (!existingRecord) {
                    allData.payouts.push(tempAdjustmentRecord);
                }

                showSuccessMessage('âœ… ä½£é‡‘è³‡è¨Šå·²æ›´æ–°ï¼Œèª¿æ•´è¨˜éŒ„å·²ä¿å­˜');
                closeModal('partnerModal');
                
                // å³æ™‚æ›´æ–°ç•¶å‰é¡¯ç¤º
                updateCurrentTabDisplay();

            } catch (error) {
                console.error('âŒ ä½£é‡‘ç·¨è¼¯å¤±æ•—:', error);
                showErrorMessage('âŒ ä½£é‡‘ç·¨è¼¯å¤±æ•—ï¼š' + error.message);
            }
        }

        // åè½‰ç‚ºä½å®¿é‡‘
        async function revertToCash(partnerCode) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }

            const pendingCash = partner.pending_cash || partner.pending_commission || 0;
            if (pendingCash <= 0) {
                showErrorMessage('è©²å¤§ä½¿ç›®å‰æ²’æœ‰å¾…æ”¯ä»˜ç¾é‡‘å¯ä»¥è½‰å›');
                return;
            }

            const accommodationPoints = pendingCash * 2; // 50% åå‘è¨ˆç®—

            const confirmed = confirm(`ğŸ”„ è½‰å›ä½å®¿é‡‘ - ${partner.name || partner.partner_code}

å¾…æ”¯ä»˜ç¾é‡‘ï¼šNT$ ${pendingCash.toLocaleString()}
    â†“
ä½å®¿é‡‘ï¼š${accommodationPoints.toLocaleString()} é»

ç¢ºå®šè¦è½‰å›ä½å®¿é‡‘å—ï¼Ÿ`);
            
            if (!confirmed) return;

            try {
                // æ›´æ–°å‰ç«¯æ•¸æ“š
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    const p = allData.partners[partnerIndex];
                    p.pending_cash = 0;
                    p.available_points = (p.available_points || 0) + accommodationPoints;
                    p.total_points_used = Math.max(0, (p.total_points_used || 0) - accommodationPoints);
                }

                showSuccessMessage(`âœ… è½‰æ›å®Œæˆï¼NT$ ${pendingCash.toLocaleString()} â†’ ${accommodationPoints.toLocaleString()} ä½å®¿é‡‘é»æ•¸`);
                displayPartners(allData.partners);

            } catch (error) {
                console.error('è½‰æ›å¤±æ•—:', error);
                showErrorMessage('âŒ è½‰æ›å¤±æ•—ï¼š' + error.message);
            }
        }

        // åœç”¨å¤¥ä¼´
        function suspendPartner(partnerCode) {
            const partner = allData.partners.find(p => p.partner_code === partnerCode);
            if (!partner) {
                showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                return;
            }

            const confirmed = confirm(`âš ï¸ åœç”¨å¸³æˆ¶ - ${partner.name || partner.partner_code}

åœç”¨å¾Œè©²å¤¥ä¼´å°‡ï¼š
â€¢ ç„¡æ³•ç²å¾—æ–°çš„ä½£é‡‘
â€¢ æ¨è–¦é€£çµå¤±æ•ˆ
â€¢ ç„¡æ³•ç™»å…¥ç®¡ç†ä»‹é¢

æ­¤æ“ä½œå¯å¾©åŸã€‚ç¢ºå®šè¦åœç”¨å—ï¼Ÿ`);
            
            if (!confirmed) return;

            try {
                // æš«æ™‚æ¨™è¨˜ç‚ºåœç”¨ç‹€æ…‹
                const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                if (partnerIndex !== -1) {
                    allData.partners[partnerIndex].status = 'SUSPENDED';
                }

                showSuccessMessage(`âœ… å·²åœç”¨å¤¥ä¼´ï¼š${partner.name || partner.partner_code}`);
                displayPartners(allData.partners);

            } catch (error) {
                console.error('åœç”¨å¤±æ•—:', error);
                showErrorMessage('âŒ åœç”¨å¤±æ•—ï¼š' + error.message);
            }
        }

        // ========== å‚™ç”¨å‡½æ•¸å®šç¾© (é˜²æ­¢å¤–éƒ¨JSè¼‰å…¥å¤±æ•—) ==========
        
        // å‚™ç”¨ï¼šç®¡ç†ä½å®¿é‡‘é»æ•¸ (å¦‚æœ commission-management.js è¼‰å…¥å¤±æ•—)
        if (typeof manageAccommodationPoints === 'undefined') {
            window.manageAccommodationPoints = function(partnerCode) {
                const partner = allData.partners.find(p => p.partner_code === partnerCode);
                if (!partner) {
                    showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                    return;
                }
                
                createAccommodationPointsModal(partner);
            };
            
            // å®Œæ•´çš„ä½å®¿é‡‘é»æ•¸ç®¡ç†æ¨¡æ…‹æ¡†
            window.createAccommodationPointsModal = function(partner) {
                const availablePoints = partner.available_points || partner.total_commission_earned || 0;
                const usedPoints = partner.total_points_used || 0;
                const totalPoints = availablePoints + usedPoints;
                
                const modal = document.createElement('div');
                modal.id = 'accommodationPointsModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold">ğŸ¨ ä½å®¿é‡‘é»æ•¸ç®¡ç† - ${partner.partner_code}</h3>
                            <button onclick="closeModal('accommodationPointsModal')" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- é»æ•¸æ¦‚è¦½ -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${totalPoints.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">ç¸½ç²å¾—é»æ•¸</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-red-600">${usedPoints.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">å·²ä½¿ç”¨é»æ•¸</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">${availablePoints.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">å¯ç”¨é»æ•¸</div>
                            </div>
                        </div>
                        
                        <!-- é»æ•¸æŠµæ‰£ -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-bold mb-3">ğŸ’³ é»æ•¸æŠµæ‰£</h4>
                            <form id="pointsDeductionForm" class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æŠµæ‰£é‡‘é¡</label>
                                        <input type="number" id="deduct_amount" 
                                            class="w-full p-2 border rounded-md" min="1" max="${availablePoints}" step="1"
                                            placeholder="è¼¸å…¥è¦æŠµæ‰£çš„é»æ•¸">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å…¥ä½æ—¥æœŸ *</label>
                                        <input type="date" id="checkin_date" 
                                            class="w-full p-2 border rounded-md" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¨‚æˆ¿è¨˜éŒ„ID (é¸å¡«)</label>
                                        <input type="text" id="related_booking_id" 
                                            class="w-full p-2 border rounded-md" placeholder="ç›¸é—œè¨‚æˆ¿ID">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">æŠµæ‰£èªªæ˜</label>
                                    <textarea id="deduction_notes" rows="2" class="w-full p-2 border rounded-md"
                                        placeholder="èªªæ˜æ­¤æ¬¡æŠµæ‰£çš„ç”¨é€”..."></textarea>
                                </div>
                                
                                <!-- å¿«é€Ÿé‡‘é¡æŒ‰éˆ• -->
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" onclick="setDeductAmount(1000)" 
                                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                        $1000
                                    </button>
                                    <button type="button" onclick="setDeductAmount(2000)" 
                                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                        $2000
                                    </button>
                                    <button type="button" onclick="setDeductAmount(5000)" 
                                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">
                                        $5000
                                    </button>
                                    <button type="button" onclick="setDeductAmount(${availablePoints})" 
                                        class="px-3 py-1 bg-red-100 text-red-700 rounded text-xs hover:bg-red-200">
                                        å…¨éƒ¨æŠµæ‰£
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-4 border-t">
                            <button type="button" onclick="closeModal('accommodationPointsModal')" 
                                class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                é—œé–‰
                            </button>
                            <button type="button" onclick="processPointsDeduction('${partner.partner_code}')" 
                                class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                ğŸ’³ åŸ·è¡ŒæŠµæ‰£
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            };
            
            // è¨­å®šæŠµæ‰£é‡‘é¡
            window.setDeductAmount = function(amount) {
                document.getElementById('deduct_amount').value = amount;
            };
            
            // è™•ç†é»æ•¸æŠµæ‰£
            window.processPointsDeduction = async function(partnerCode) {
                try {
                    const deductAmount = parseFloat(document.getElementById('deduct_amount').value) || 0;
                    const checkinDate = document.getElementById('checkin_date').value;
                    const relatedBookingId = document.getElementById('related_booking_id').value.trim();
                    const notes = document.getElementById('deduction_notes').value.trim();
                    
                    if (deductAmount <= 0) {
                        showErrorMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„æŠµæ‰£é‡‘é¡');
                        return;
                    }
                    
                    if (!checkinDate) {
                        showErrorMessage('è«‹é¸æ“‡å…¥ä½æ—¥æœŸ');
                        return;
                    }
                    
                    if (!notes) {
                        showErrorMessage('è«‹å¡«å¯«æŠµæ‰£èªªæ˜');
                        return;
                    }
                    
                    // ä½¿ç”¨ form æäº¤é¿å… CORS å•é¡Œ
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = APPS_SCRIPT_URL;
                    form.target = 'deduction_iframe';
                    form.style.display = 'none';

                    const formData = {
                        action: 'deduct_accommodation_points',
                        partner_code: partnerCode,
                        deduct_amount: deductAmount,
                        checkin_date: checkinDate,
                        related_booking_id: relatedBookingId,
                        notes: notes
                    };
                    
                    // æ·»åŠ è¡¨å–®å­—æ®µ
                    Object.keys(formData).forEach(key => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = formData[key] || '';
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);

                    // å‰µå»ºéš±è—çš„ iframe
                    let iframe = document.getElementById('deduction_iframe');
                    if (!iframe) {
                        iframe = document.createElement('iframe');
                        iframe.id = 'deduction_iframe';
                        iframe.name = 'deduction_iframe';
                        iframe.style.display = 'none';
                        document.body.appendChild(iframe);
                    }

                    // æäº¤è¡¨å–®
                    form.submit();
                    
                    setTimeout(() => {
                        // ç«‹å³æ›´æ–°å‰ç«¯æ•¸æ“š
                        const partnerIndex = allData.partners.findIndex(p => p.partner_code === partnerCode);
                        if (partnerIndex !== -1) {
                            const partner = allData.partners[partnerIndex];
                            const currentPoints = partner.available_points || partner.total_commission_earned || 0;
                            partner.available_points = Math.max(0, currentPoints - deductAmount);
                            partner.total_points_used = (partner.total_points_used || 0) + deductAmount;
                        }
                        
                        showSuccessMessage(`âœ… æˆåŠŸæŠµæ‰£ ${deductAmount.toLocaleString()} ä½å®¿é‡‘é»æ•¸ï¼`);
                        closeModal('accommodationPointsModal');
                        
                        // é‡æ–°é¡¯ç¤ºå¤¥ä¼´åˆ—è¡¨
                        if (typeof displayPartners === 'function') {
                            displayPartners(allData.partners);
                        }
                        
                        // æ¸…ç†è¡¨å–®
                        if (form && form.parentNode) {
                            document.body.removeChild(form);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('é»æ•¸æŠµæ‰£å¤±æ•—:', error);
                    showErrorMessage('âŒ æŠµæ‰£å¤±æ•—ï¼š' + error.message);
                }
            };
        }
        
        // å‚™ç”¨ï¼šå¿«é€Ÿç·¨è¼¯ä½£é‡‘
        if (typeof quickEditCommission === 'undefined') {
            window.quickEditCommission = function(partnerCode) {
                const partner = allData.partners.find(p => p.partner_code === partnerCode);
                if (!partner) {
                    showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                    return;
                }
                
                showErrorMessage('ä½£é‡‘ç·¨è¼¯åŠŸèƒ½æ­£åœ¨ç¶­è­·ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
            };
        }
        
        // å‚™ç”¨ï¼šå‰µå»ºå¤¥ä¼´çµç®—
        if (typeof createPartnerPayout === 'undefined') {
            window.createPartnerPayout = function(partnerCode) {
                const partner = allData.partners.find(p => p.partner_code === partnerCode);
                if (!partner) {
                    showErrorMessage('æ‰¾ä¸åˆ°å¤¥ä¼´è³‡æ–™');
                    return;
                }
                
                showErrorMessage('æ‰‹å‹•çµç®—åŠŸèƒ½æ­£åœ¨ç¶­è­·ä¸­ï¼Œè«‹ä½¿ç”¨å…¶ä»–çµç®—æ–¹å¼');
            };
        }

        /**
         * æ–°ç‰ˆè¯ç›Ÿå¤¥ä¼´åˆ—è¡¨çš„ä¸‹æ‹‰é¸å–®äº’å‹•å‡½æ•¸
         */
        
        /**
         * è¼”åŠ©å‡½å¼ä¸€ï¼šåˆ‡æ›ä¸‹æ‹‰é¸å–®çš„é¡¯ç¤º/éš±è—
         * @param {string} dropdownId - è¦æ“ä½œçš„ä¸‹æ‹‰é¸å–®çš„ ID
         * @param {Event} event - é»æ“Šäº‹ä»¶ï¼Œç”¨ä¾†é˜»æ­¢äº‹ä»¶å†’æ³¡
         */
        function toggleActionsDropdown(dropdownId, event) {
            event.stopPropagation(); // é˜»æ­¢é»æ“Šäº‹ä»¶å‘ä¸Šå†’æ³¡ï¼Œä»¥å…ç«‹åˆ»è¢«ä¸‹ä¸€æ­¥çš„ document click é—œé–‰
            const dropdown = document.getElementById(dropdownId);
            
            // å…ˆé—œé–‰é é¢ä¸Šæ‰€æœ‰å…¶ä»–çš„ä¸‹æ‹‰é¸å–®
            document.querySelectorAll('[id^="actions-dropdown-"]').forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.add('hidden');
                }
            });
            
            // åˆ‡æ›ç•¶å‰é»æ“Šçš„é¸å–®
            dropdown.classList.toggle('hidden');
        }

        /**
         * è¼”åŠ©å‡½å¼äºŒï¼šç›£è½æ•´å€‹é é¢çš„é»æ“Šäº‹ä»¶
         * èªªæ˜ï¼šç•¶ä½¿ç”¨è€…é»æ“Šé é¢ä»»ä½•éé¸å–®å€åŸŸæ™‚ï¼Œè‡ªå‹•é—œé–‰æ‰€æœ‰å·²é–‹å•Ÿçš„ä¸‹æ‹‰é¸å–®ã€‚
         */
        document.addEventListener('click', function(event) {
            // å¦‚æœé»æ“Šçš„ç›®æ¨™ä¸æ˜¯ä¸‹æ‹‰é¸å–®æŒ‰éˆ•ï¼Œå°±é—œé–‰æ‰€æœ‰é¸å–®
            if (!event.target.closest('button[onclick*="toggleActionsDropdown"]')) {
                 document.querySelectorAll('[id^="actions-dropdown-"]').forEach(d => d.classList.add('hidden'));
            }
        });

        // ===== æ•¸æ“šåˆ†æåŠŸèƒ½ =====
        let analyticsCharts = {};
        
        // è¼‰å…¥åˆ†ææ•¸æ“šï¼ˆä½¿ç”¨çœŸå¯¦æ•¸æ“šï¼‰
        function loadAnalyticsData() {
            try {
                if (!allData || !allData.partners) {
                    console.log('ç­‰å¾…çœŸå¯¦æ•¸æ“šè¼‰å…¥...');
                    return;
                }
                
                updateAnalyticsMetrics();
                
                // åªåœ¨åœ–è¡¨å°šæœªåˆå§‹åŒ–æ™‚æ‰åˆå§‹åŒ–
                if (!analyticsCharts.ambassadorPerformance && !analyticsCharts.levelDistribution && !analyticsCharts.giftClick) {
                    initializeAnalyticsCharts();
                }
                
                updateAllAnalyticsCharts();
                updateAnalyticsDetailedTable();
                
            } catch (error) {
                console.error('è¼‰å…¥åˆ†ææ•¸æ“šå¤±æ•—:', error);
            }
        }
        
        // æ›´æ–°æ ¸å¿ƒæŒ‡æ¨™
        function updateAnalyticsMetrics() {
            // è¨ˆç®—æ•´é«”è½‰æ›ç‡ï¼ˆå‡è¨­é»æ“Šæ•¸æ“šæš«æ™‚ç‚º0ï¼Œæœªä¾†å¯¦ç¾ï¼‰
            const totalBookings = allData.bookings.length;
            const completedBookings = allData.bookings.filter(b => b.stay_status === 'COMPLETED').length;
            const conversionRate = totalBookings > 0 ? ((completedBookings / totalBookings) * 100).toFixed(1) : '0.0';
            
            // è¨ˆç®—å¹³å‡ä½£é‡‘
            const totalCommission = allData.bookings
                .filter(b => b.stay_status === 'COMPLETED')
                .reduce((sum, b) => sum + (parseFloat(b.commission_amount) || 0), 0);
            const avgCommission = completedBookings > 0 ? Math.round(totalCommission / completedBookings) : 0;
            
            // æ‰¾å‡ºæœ€ä½³å¤§ä½¿
            const partnerStats = calculateAnalyticsPartnerStats();
            const topAmbassador = partnerStats.length > 0 ? partnerStats[0] : { conversionRate: 0, name: '-' };
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('totalConversionRate').textContent = conversionRate + '%';
            document.getElementById('avgCommissionPerBooking').textContent = '$' + avgCommission;
            document.getElementById('topAmbassadorConversion').textContent = topAmbassador.conversionRate.toFixed(1) + '%';
            document.getElementById('topAmbassadorName').textContent = topAmbassador.name || '-';
            document.getElementById('mostPopularGift').textContent = 'ğŸš§ é–‹ç™¼ä¸­';
        }

        // è¨ˆç®—å¤¥ä¼´çµ±è¨ˆ
        function calculateAnalyticsPartnerStats() {
            return allData.partners.map(partner => {
                const partnerBookings = allData.bookings.filter(b => b.partner_code === partner.partner_code);
                const completedBookings = partnerBookings.filter(b => b.stay_status === 'COMPLETED').length;
                
                return {
                    ...partner,
                    bookings: partnerBookings.length,
                    completed: completedBookings,
                    conversionRate: partnerBookings.length > 0 ? (completedBookings / partnerBookings.length) * 100 : 0,
                    avgOrderValue: completedBookings > 0 ? 
                        partnerBookings.filter(b => b.stay_status === 'COMPLETED')
                                     .reduce((sum, b) => sum + (parseFloat(b.room_price) || 0), 0) / completedBookings : 0
                };
            }).sort((a, b) => b.conversionRate - a.conversionRate);
        }

        // åˆå§‹åŒ–åœ–è¡¨
        function initializeAnalyticsCharts() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js æœªè¼‰å…¥ï¼Œè·³éåœ–è¡¨åˆå§‹åŒ–');
                return;
            }

            // éŠ·æ¯€ç¾æœ‰åœ–è¡¨ä»¥é¿å…é‡è¤‡å‰µå»º
            if (analyticsCharts.ambassadorPerformance) {
                analyticsCharts.ambassadorPerformance.destroy();
            }
            if (analyticsCharts.levelDistribution) {
                analyticsCharts.levelDistribution.destroy();
            }
            if (analyticsCharts.giftClick) {
                analyticsCharts.giftClick.destroy();
            }

            // å¤§ä½¿ç¸¾æ•ˆåœ–è¡¨
            const ctx1 = document.getElementById('ambassadorPerformanceChart');
            if (ctx1) {
                analyticsCharts.ambassadorPerformance = new Chart(ctx1, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: '#2E4B36' }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // ç­‰ç´šåˆ†ä½ˆåœ–è¡¨
            const ctx2 = document.getElementById('levelDistributionChart');
            if (ctx2) {
                analyticsCharts.levelDistribution = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['LV1 çŸ¥éŸ³å¤§ä½¿', 'LV2 æ£®æ—åš®å°', 'LV3 ç§˜å¢ƒå®ˆè­·è€…'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            // ç¦®ç‰©é»æ“Šåœ–è¡¨ï¼ˆæœªä¾†åŠŸèƒ½ï¼‰
            const ctx3 = document.getElementById('giftClickChart');
            if (ctx3) {
                analyticsCharts.giftClick = new Chart(ctx3, {
                    type: 'pie',
                    data: { 
                        labels: ['è²éŸ³çš„é¢¨æ™¯', 'æ–‡å­—çš„ç¾…ç›¤', 'æ£®æ—çš„æŒ‡å¼•', 'ç¨å®¶çš„æ•…äº‹'],
                        datasets: [{ 
                            data: [0, 0, 0, 0], 
                            backgroundColor: ['#2E4B36', '#4B7C4B', '#8B5CF6', '#F59E0B']
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': é–‹ç™¼ä¸­';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // æ›´æ–°æ‰€æœ‰åˆ†æåœ–è¡¨
        function updateAllAnalyticsCharts() {
            updateAnalyticsAmbassadorChart();
            updateAnalyticsLevelChart();
            updateAnalyticsFunnelAnalysis();
        }

        // æ›´æ–°å¤§ä½¿åœ–è¡¨
        function updateAnalyticsAmbassadorChart() {
            if (!analyticsCharts.ambassadorPerformance) return;
            
            const sortBy = document.getElementById('performanceSort')?.value || 'conversion';
            const partnerStats = calculateAnalyticsPartnerStats();
            
            let sortedStats;
            switch (sortBy) {
                case 'conversion':
                    sortedStats = partnerStats.sort((a, b) => b.conversionRate - a.conversionRate);
                    break;
                case 'clicks':
                    sortedStats = partnerStats.sort((a, b) => b.bookings - a.bookings);
                    break;
                case 'commission':
                    sortedStats = partnerStats.sort((a, b) => (parseFloat(b.total_commission_earned) || 0) - (parseFloat(a.total_commission_earned) || 0));
                    break;
                default:
                    sortedStats = partnerStats;
            }
            
            const top5 = sortedStats.slice(0, 5);
            
            analyticsCharts.ambassadorPerformance.data.labels = top5.map(p => p.partner_code);
            analyticsCharts.ambassadorPerformance.data.datasets[0].data = top5.map(p => {
                switch (sortBy) {
                    case 'conversion': return p.conversionRate;
                    case 'clicks': return p.bookings;
                    case 'commission': return parseFloat(p.total_commission_earned) || 0;
                    default: return p.conversionRate;
                }
            });
            analyticsCharts.ambassadorPerformance.update();
        }

        // æ›´æ–°ç­‰ç´šåˆ†ä½ˆåœ–è¡¨
        function updateAnalyticsLevelChart() {
            if (!analyticsCharts.levelDistribution) return;
            
            const levelCounts = {
                'LV1_INSIDER': allData.partners.filter(p => p.level === 'LV1_INSIDER').length,
                'LV2_GUIDE': allData.partners.filter(p => p.level === 'LV2_GUIDE').length,
                'LV3_GUARDIAN': allData.partners.filter(p => p.level === 'LV3_GUARDIAN').length
            };
            
            analyticsCharts.levelDistribution.data.datasets[0].data = [
                levelCounts.LV1_INSIDER,
                levelCounts.LV2_GUIDE,
                levelCounts.LV3_GUARDIAN
            ];
            analyticsCharts.levelDistribution.update();
            
            // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
            const lv1El = document.getElementById('lv1Count');
            const lv2El = document.getElementById('lv2Count');
            const lv3El = document.getElementById('lv3Count');
            
            if (lv1El) lv1El.textContent = levelCounts.LV1_INSIDER + ' äºº';
            if (lv2El) lv2El.textContent = levelCounts.LV2_GUIDE + ' äºº';
            if (lv3El) lv3El.textContent = levelCounts.LV3_GUARDIAN + ' äºº';
        }

        // æ›´æ–°æ¼æ–—åˆ†æ
        function updateAnalyticsFunnelAnalysis() {
            const totalBookings = allData.bookings.length;
            const checkedIn = allData.bookings.filter(b => b.stay_status === 'CHECKED_IN' || b.stay_status === 'COMPLETED').length;
            const completed = allData.bookings.filter(b => b.stay_status === 'COMPLETED').length;
            
            const funnelClicksEl = document.getElementById('funnelClicks');
            const funnelBookingsEl = document.getElementById('funnelBookings');
            const funnelCheckedInEl = document.getElementById('funnelCheckedIn');
            const funnelCompletedEl = document.getElementById('funnelCompleted');
            
            if (funnelClicksEl) funnelClicksEl.textContent = 'é–‹ç™¼ä¸­';
            if (funnelBookingsEl) funnelBookingsEl.textContent = totalBookings;
            if (funnelCheckedInEl) funnelCheckedInEl.textContent = checkedIn;
            if (funnelCompletedEl) funnelCompletedEl.textContent = completed;
            
            // è¨ˆç®—è½‰æ›ç‡
            const checkinRate = totalBookings > 0 ? ((checkedIn / totalBookings) * 100).toFixed(1) : '0.0';
            const completionRate = checkedIn > 0 ? ((completed / checkedIn) * 100).toFixed(1) : '0.0';
            
            const bookingRateEl = document.getElementById('bookingConversionRate');
            const checkinRateEl = document.getElementById('checkinConversionRate');
            const completionRateEl = document.getElementById('completionConversionRate');
            
            if (bookingRateEl) bookingRateEl.textContent = 'é–‹ç™¼ä¸­';
            if (checkinRateEl) checkinRateEl.textContent = checkinRate + '%';
            if (completionRateEl) completionRateEl.textContent = completionRate + '%';
        }

        // æ›´æ–°è©³ç´°æ•¸æ“šè¡¨æ ¼
        function updateAnalyticsDetailedTable() {
            const partnerStats = calculateAnalyticsPartnerStats();
            const table = document.getElementById('detailedAnalyticsTable');
            
            if (!table) return;
            
            if (partnerStats.length === 0) {
                table.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-stone-500">æš«ç„¡æ•¸æ“š</td></tr>';
                return;
            }
            
            table.innerHTML = partnerStats.map(partner => `
                <tr class="border-b hover:bg-stone-50">
                    <td class="py-3 px-4 font-medium">${partner.partner_code}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="px-2 py-1 rounded text-xs ${getLevelClass(partner.level)}">
                            ${getLevelText(partner.level)}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center text-stone-400">é–‹ç™¼ä¸­</td>
                    <td class="py-3 px-4 text-center">${partner.bookings}</td>
                    <td class="py-3 px-4 text-center font-semibold text-green-600">${partner.completed}</td>
                    <td class="py-3 px-4 text-center">${partner.conversionRate.toFixed(1)}%</td>
                    <td class="py-3 px-4 text-center">$${(parseFloat(partner.total_commission_earned) || 0).toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">$${Math.round(partner.avgOrderValue).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        // æ›´æ–°å¤§ä½¿åœ–è¡¨ï¼ˆç•¶ä¸‹æ‹‰é¸å–®æ”¹è®Šæ™‚ï¼‰
        function updateAmbassadorChart() {
            updateAnalyticsAmbassadorChart();
        }
        
        // åŒ¯å‡ºåˆ†æå ±è¡¨
        function exportAnalyticsReport() {
            const partnerStats = calculateAnalyticsPartnerStats();
            const reportData = partnerStats.map(p => ({
                'å¤§ä½¿ä»£ç¢¼': p.partner_code,
                'å§“å': p.name || '-',
                'ç­‰ç´š': getLevelText(p.level),
                'é»æ“Šæ•¸': 'é–‹ç™¼ä¸­',
                'è¨‚æˆ¿æ•¸': p.bookings,
                'å®Œæˆæ•¸': p.completed,
                'è½‰æ›ç‡': p.conversionRate.toFixed(1) + '%',
                'ç´¯ç©ä½£é‡‘': parseFloat(p.total_commission_earned) || 0,
                'å¹³å‡å®¢å–®åƒ¹': Math.round(p.avgOrderValue)
            }));
            
            downloadCSV(reportData, 'çŸ¥éŸ³è¨ˆç•«åˆ†æå ±è¡¨.csv');
        }
        
        function downloadCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½ï¼ˆä¿®å¾©ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ¨™ç±¤çš„æ•¸æ“šè¼‰å…¥ï¼‰
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤çš„ active ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤å…§å®¹
            const targetContent = document.getElementById(`content-${tabName}`);
            const targetButton = document.getElementById(`tab-${tabName}`);
            
            if (targetContent) targetContent.classList.remove('hidden');
            if (targetButton) targetButton.classList.add('active');
            
            // æ ¹æ“šæ¨™ç±¤è¼‰å…¥ç›¸æ‡‰æ•¸æ“š
            switch(tabName) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'bookings':
                    loadBookingsData();
                    break;
                case 'payouts':
                    loadPayoutsData();
                    // ä¸è‡ªå‹•åˆ·æ–°ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“šå³æ™‚æ›´æ–°
                    break;
                case 'analytics':
                    setTimeout(() => {
                        loadAnalyticsData();
                    }, 100);
                    break;
            }
        }
    </script>
    <!-- å¤–éƒ¨ JavaScript æ–‡ä»¶ï¼Œæ·»åŠ ç‰ˆæœ¬è™Ÿé˜²æ­¢å¿«å– -->
    <script src="payout-functions.js?v=20240816"></script>
    <script src="commission-management.js?v=20240816"></script>
</body>
</html>