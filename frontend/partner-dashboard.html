<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥éŸ³å¤§ä½¿ - å€‹äººå„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // æŠ‘åˆ¶ Tailwind CSS ç”Ÿç”¢ç’°å¢ƒè­¦å‘Š
        tailwind.config = {
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #F8FAF3 0%, #EEF3E5 100%);
            color: #5C544B;
        }
        h1, h2, h3, .font-serif {
            font-family: 'Noto Serif TC', serif;
        }
        .brand-accent {
            color: #2E4B36;
        }
        .brand-card {
            background-color: #FFFFFF;
            border: 1px solid #EAE6E1;
            border-radius: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #2E4B36 0%, #4B7C4B 100%);
        }
        .level-badge {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 8px;
            background-color: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
            transition: width 0.5s ease;
        }
        .commission-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="min-h-screen py-6 px-4">
    <!-- è¼‰å…¥è¦†è“‹å±¤ -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
            <div class="text-lg font-medium text-stone-700">è¼‰å…¥æ‚¨çš„æˆæœæ•¸æ“šä¸­...</div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- é ‚éƒ¨å°èˆª -->
        <header class="mb-8">
            <div class="brand-card p-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center">
                            <span class="text-white text-xl font-bold" id="userInitial">ğŸŒ²</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold brand-accent">æ­¡è¿å›ä¾†ï¼Œ<span id="partnerName">çŸ¥éŸ³å¤§ä½¿</span></h1>
                            <div class="flex items-center space-x-3 text-sm text-stone-600">
                                <span>ä»£ç¢¼ï¼š<span id="partnerCode" class="font-mono font-semibold">-</span></span>
                                <span class="level-badge text-white px-3 py-1 rounded-full text-xs font-semibold" id="partnerLevel">
                                    è¼‰å…¥ä¸­...
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            ğŸ”„ é‡æ–°è¼‰å…¥
                        </button>
                        <button onclick="logout()" class="bg-stone-600 text-white px-4 py-2 rounded-lg hover:bg-stone-700 transition-colors">
                            ğŸšª ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- æ ¸å¿ƒçµ±è¨ˆ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- æ¨è–¦æˆåŠŸæ•¸ -->
            <div class="brand-card p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-green-600" id="totalReferrals">-</div>
                        <div class="text-sm text-stone-600 mt-1">æ¨è–¦æˆåŠŸ</div>
                        <div class="text-xs text-stone-500">å®Œæˆå…¥ä½</div>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">ğŸ†</span>
                    </div>
                </div>
            </div>

            <!-- ç´¯ç©ä½£é‡‘ -->
            <div class="brand-card p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-blue-600" id="totalCommission">-</div>
                        <div class="text-sm text-stone-600 mt-1">ç´¯ç©ä½£é‡‘</div>
                        <div class="text-xs text-stone-500">ç¸½æ”¶ç›Š</div>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">ğŸ’°</span>
                    </div>
                </div>
            </div>

            <!-- å¯ç”¨ä½å®¿é‡‘ -->
            <div class="brand-card p-6 stat-card commission-badge">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-purple-600" id="availablePoints">-</div>
                        <div class="text-sm text-stone-600 mt-1">å¯ç”¨ä½å®¿é‡‘</div>
                        <div class="text-xs text-stone-500">é»æ•¸é¤˜é¡</div>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">ğŸ</span>
                    </div>
                </div>
            </div>

            <!-- ç­‰ç´šé€²åº¦ -->
            <div class="brand-card p-6 stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-3xl font-bold text-amber-600" id="levelProgress">-</div>
                        <div class="text-sm text-stone-600 mt-1">å‡ç´šé€²åº¦</div>
                        <div class="text-xs text-stone-500" id="nextLevelText">ä¸‹ä¸€ç­‰ç´š</div>
                    </div>
                    <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">â­</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- æ¨è–¦ç¸¾æ•ˆåœ–è¡¨ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-xl font-semibold brand-accent mb-6">ğŸ“ˆ æ¨è–¦ç¸¾æ•ˆè¶¨å‹¢</h2>
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div class="text-sm text-stone-600">
                        æœ€è¿‘ 6 å€‹æœˆæ¨è–¦æˆæœ
                    </div>
                </div>
            </div>

            <!-- ä½£é‡‘åˆ†ä½ˆ -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-xl font-semibold brand-accent mb-6">ğŸ’ ä½£é‡‘é¡å‹åˆ†ä½ˆ</h2>
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="commissionChart"></canvas>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-sm text-stone-600 mb-2">
                        <span class="flex items-center">
                            <span class="w-3 h-3 bg-green-500 rounded mr-2"></span>
                            ä½å®¿é‡‘
                        </span>
                        <span id="accommodationTotal">-</span>
                    </div>
                    <div class="flex justify-between text-sm text-stone-600">
                        <span class="flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded mr-2"></span>
                            ç¾é‡‘
                        </span>
                        <span id="cashTotal">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°è¨˜éŒ„ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- æœ€è¿‘æ¨è–¦è¨˜éŒ„ -->
            <div class="brand-card p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-serif text-xl font-semibold brand-accent">ğŸ¯ æœ€è¿‘æ¨è–¦è¨˜éŒ„</h2>
                    <button onclick="exportBookings()" class="text-sm bg-stone-200 text-stone-700 px-3 py-2 rounded-lg hover:bg-stone-300">
                        ğŸ“Š åŒ¯å‡ºè¨˜éŒ„
                    </button>
                </div>
                <div id="recentBookings" class="space-y-4">
                    <div class="text-center py-8 text-stone-500">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- å°ˆå±¬æ¨è–¦å·¥å…· -->
            <div class="brand-card p-8">
                <h2 class="font-serif text-xl font-semibold brand-accent mb-6">ğŸ”— æˆ‘çš„æ¨è–¦å·¥å…·</h2>
                
                <!-- æ¨è–¦é€£çµ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-stone-700 mb-2">å°ˆå±¬æ¨è–¦é€£çµ</label>
                    <div class="flex">
                        <input 
                            type="text" 
                            id="referralLink" 
                            class="flex-1 px-3 py-2 border border-stone-300 rounded-l-lg bg-stone-50 text-sm" 
                            readonly
                            value="è¼‰å…¥ä¸­..."
                        >
                        <button 
                            onclick="copyReferralLink()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 text-sm"
                        >
                            è¤‡è£½
                        </button>
                    </div>
                </div>

                <!-- æ¨è–¦æ–‡æ¡ˆ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-stone-700 mb-2">æ¨è–¦æ–‡æ¡ˆæ¨¡æ¿</label>
                    <div class="bg-stone-50 p-4 rounded-lg text-sm">
                        <div class="text-stone-700 leading-relaxed" id="referralTemplate">
                            ğŸŒ² ç™¼ç¾æ£®æ—ä¸­çš„ç§˜å¯†ä½å®¿é«”é©—ï¼<br>
                            âœ¨ é€éæˆ‘çš„å°ˆå±¬é€£çµé è¨‚ï¼Œäº«å—ç¨ç‰¹çš„æ£®æ—ç™‚ç™’ä¹‹æ—…<br>
                            ğŸ é‚„æœ‰æ©Ÿæœƒç²å¾—å°ˆå±¬æ£®æ—ç¦®ç‰©<br><br>
                            ç«‹å³é è¨‚ï¼š<span class="text-blue-600">[æ‚¨çš„å°ˆå±¬é€£çµ]</span>
                        </div>
                    </div>
                    <button onclick="copyTemplate()" class="mt-2 text-xs bg-stone-200 text-stone-700 px-3 py-1 rounded hover:bg-stone-300">
                        è¤‡è£½æ–‡æ¡ˆ
                    </button>
                </div>

                <!-- å¿«é€Ÿåˆ†äº« -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="shareToLine()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600">
                        ğŸ“± LINE åˆ†äº«
                    </button>
                    <button onclick="shareToFacebook()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-600">
                        ğŸ“˜ Facebook
                    </button>
                </div>
            </div>
        </div>

        <!-- ç­‰ç´šèªªæ˜ -->
        <div class="mt-8 brand-card p-8">
            <h2 class="font-serif text-xl font-semibold brand-accent mb-6">ğŸ† å¤§ä½¿ç­‰ç´šèªªæ˜</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">ğŸŒ±</span>
                    </div>
                    <h3 class="font-semibold text-green-700 mb-2">LV1 çŸ¥éŸ³å¤§ä½¿</h3>
                    <div class="text-sm text-stone-600 space-y-1">
                        <div>æ¯ç­†ï¼š1000ä½å®¿é‡‘ / 500ç¾é‡‘</div>
                        <div>è¦æ±‚ï¼š0-2 ç­†æˆåŠŸæ¨è–¦</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">ğŸŒ¿</span>
                    </div>
                    <h3 class="font-semibold text-blue-700 mb-2">LV2 æ£®æ—åš®å°</h3>
                    <div class="text-sm text-stone-600 space-y-1">
                        <div>æ¯ç­†ï¼š1200ä½å®¿é‡‘ / 600ç¾é‡‘</div>
                        <div>è¦æ±‚ï¼š3-9 ç­†æˆåŠŸæ¨è–¦</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">ğŸŒ³</span>
                    </div>
                    <h3 class="font-semibold text-purple-700 mb-2">LV3 ç§˜å¢ƒå®ˆè­·è€…</h3>
                    <div class="text-sm text-stone-600 space-y-1">
                        <div>æ¯ç­†ï¼š1500ä½å®¿é‡‘ / 800ç¾é‡‘</div>
                        <div>è¦æ±‚ï¼š10+ ç­†æˆåŠŸæ¨è–¦</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script API URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        
        let partnerData = null;
        let allBookings = [];
        let charts = {};
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function() {
            checkAuth();
            loadPartnerData();
        });
        
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkAuth() {
            const partnerCode = sessionStorage.getItem('partnerCode');
            if (!partnerCode) {
                // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é 
                window.location.href = 'partner-login.html';
                return;
            }
            
            // å˜—è©¦å¾ sessionStorage è¼‰å…¥å¿«å–æ•¸æ“š
            const cachedData = sessionStorage.getItem('partnerData');
            if (cachedData) {
                try {
                    partnerData = JSON.parse(cachedData);
                    displayBasicInfo();
                } catch (error) {
                    console.error('è§£æå¿«å–æ•¸æ“šå¤±æ•—:', error);
                }
            }
        }
        
        // è¼‰å…¥å¤¥ä¼´æ•¸æ“š
        async function loadPartnerData() {
            const partnerCode = sessionStorage.getItem('partnerCode');
            
            try {
                // è¼‰å…¥å¤¥ä¼´è©³ç´°æ•¸æ“š
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'get_partner_dashboard_data',
                        partner_code: partnerCode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    partnerData = result.partner;
                    allBookings = result.bookings || [];
                    
                    // æ›´æ–°å¿«å–
                    sessionStorage.setItem('partnerData', JSON.stringify(partnerData));
                    
                    // æ›´æ–°é¡¯ç¤º
                    displayAllData();
                    initializeCharts();
                    
                } else {
                    throw new Error(result.error || 'è¼‰å…¥æ•¸æ“šå¤±æ•—');
                }
                
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                showError('è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹é‡è©¦');
            } finally {
                hideLoading();
            }
        }
        
        // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        function displayBasicInfo() {
            if (!partnerData) return;
            
            document.getElementById('partnerName').textContent = partnerData.name || 'çŸ¥éŸ³å¤§ä½¿';
            document.getElementById('partnerCode').textContent = partnerData.partner_code || '-';
            document.getElementById('partnerLevel').textContent = getLevelText(partnerData.level);
            
            // è¨­å®šä½¿ç”¨è€…ç¸®å¯«
            const initial = partnerData.name ? partnerData.name.charAt(0) : 'ğŸŒ²';
            document.getElementById('userInitial').textContent = initial;
        }
        
        // é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š
        function displayAllData() {
            displayBasicInfo();
            updateStatistics();
            displayRecentBookings();
            generateReferralLink();
        }
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStatistics() {
            if (!partnerData) return;
            
            const completedBookings = allBookings.filter(b => b.stay_status === 'COMPLETED').length;
            const totalCommission = parseFloat(partnerData.total_commission_earned) || 0;
            const availablePoints = calculateAvailablePoints();
            const progress = calculateLevelProgress();
            
            document.getElementById('totalReferrals').textContent = completedBookings;
            document.getElementById('totalCommission').textContent = '$' + totalCommission.toLocaleString();
            document.getElementById('availablePoints').textContent = '$' + availablePoints.toLocaleString();
            document.getElementById('levelProgress').textContent = progress.current + '/' + progress.target;
            document.getElementById('nextLevelText').textContent = progress.nextLevel;
        }
        
        // è¨ˆç®—å¯ç”¨ä½å®¿é‡‘
        function calculateAvailablePoints() {
            if (!partnerData) return 0;
            
            const totalEarned = parseFloat(partnerData.total_commission_earned) || 0;
            const totalPaid = parseFloat(partnerData.total_commission_paid) || 0;
            
            return Math.max(0, totalEarned - totalPaid);
        }
        
        // è¨ˆç®—ç­‰ç´šé€²åº¦
        function calculateLevelProgress() {
            const completedCount = allBookings.filter(b => b.stay_status === 'COMPLETED').length;
            
            let current = completedCount;
            let target = 3;
            let nextLevel = 'LV2 æ£®æ—åš®å°';
            
            if (completedCount >= 10) {
                current = completedCount;
                target = 'âˆ';
                nextLevel = 'å·²é”æœ€é«˜ç­‰ç´š';
            } else if (completedCount >= 3) {
                current = completedCount;
                target = 10;
                nextLevel = 'LV3 ç§˜å¢ƒå®ˆè­·è€…';
            }
            
            return { current, target, nextLevel };
        }
        
        // é¡¯ç¤ºæœ€è¿‘è¨‚æˆ¿è¨˜éŒ„
        function displayRecentBookings() {
            const container = document.getElementById('recentBookings');
            
            if (allBookings.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-stone-500">æš«ç„¡æ¨è–¦è¨˜éŒ„</div>';
                return;
            }
            
            const recentBookings = allBookings.slice(0, 5);
            
            container.innerHTML = recentBookings.map(booking => {
                const statusClass = getStatusClass(booking.stay_status);
                const statusText = getStatusText(booking.stay_status);
                const commissionAmount = parseFloat(booking.commission_amount) || 0;
                
                return `
                    <div class="border border-stone-200 rounded-lg p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-medium text-stone-800">${booking.guest_name}</div>
                                <div class="text-sm text-stone-600">${formatDate(booking.checkin_date)} - ${formatDate(booking.checkout_date)}</div>
                            </div>
                            <span class="px-2 py-1 rounded text-xs ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-stone-600">
                                æˆ¿åƒ¹ï¼š$${(parseFloat(booking.room_price) || 0).toLocaleString()}
                            </div>
                            <div class="text-sm font-semibold ${commissionAmount > 0 ? 'text-green-600' : 'text-stone-400'}">
                                ${commissionAmount > 0 ? `ä½£é‡‘ï¼š$${commissionAmount.toLocaleString()}` : 'å¾…è¨ˆç®—'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ç”Ÿæˆæ¨è–¦é€£çµ
        function generateReferralLink() {
            if (!partnerData) return;
            
            const partnerCode = partnerData.partner_code;
            const baseUrl = 'https://didi1119.github.io/forest-gift-v1/invitation.html';
            const referralLink = `${baseUrl}?ref=${partnerCode}`;
            
            document.getElementById('referralLink').value = referralLink;
            
            // æ›´æ–°æ¨è–¦æ–‡æ¡ˆä¸­çš„é€£çµ
            const template = document.getElementById('referralTemplate');
            const templateText = template.innerHTML.replace('[æ‚¨çš„å°ˆå±¬é€£çµ]', referralLink);
            template.innerHTML = templateText;
        }
        
        // åˆå§‹åŒ–åœ–è¡¨
        function initializeCharts() {
            if (typeof Chart === 'undefined') {
                console.log('Chart.js æœªè¼‰å…¥');
                return;
            }
            
            initPerformanceChart();
            initCommissionChart();
        }
        
        // åˆå§‹åŒ–ç¸¾æ•ˆåœ–è¡¨
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;
            
            // ç”Ÿæˆéå»6å€‹æœˆçš„æ•¸æ“š
            const months = [];
            const bookingCounts = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(date.toLocaleDateString('zh-TW', { month: 'short' }));
                
                // è¨ˆç®—è©²æœˆçš„è¨‚æˆ¿æ•¸
                const monthBookings = allBookings.filter(booking => {
                    const bookingDate = new Date(booking.checkin_date);
                    return bookingDate.getMonth() === date.getMonth() && 
                           bookingDate.getFullYear() === date.getFullYear();
                }).length;
                
                bookingCounts.push(monthBookings);
            }
            
            charts.performance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'æ¨è–¦æ•¸',
                        data: bookingCounts,
                        borderColor: '#2E4B36',
                        backgroundColor: 'rgba(46, 75, 54, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–ä½£é‡‘åœ–è¡¨
        function initCommissionChart() {
            const ctx = document.getElementById('commissionChart');
            if (!ctx) return;
            
            // è¨ˆç®—ä½å®¿é‡‘å’Œç¾é‡‘ä½£é‡‘
            const accommodationCommission = allBookings
                .filter(b => b.commission_type === 'ACCOMMODATION' && b.stay_status === 'COMPLETED')
                .reduce((sum, b) => sum + (parseFloat(b.commission_amount) || 0), 0);
                
            const cashCommission = allBookings
                .filter(b => b.commission_type === 'CASH' && b.stay_status === 'COMPLETED')
                .reduce((sum, b) => sum + (parseFloat(b.commission_amount) || 0), 0);
            
            document.getElementById('accommodationTotal').textContent = '$' + accommodationCommission.toLocaleString();
            document.getElementById('cashTotal').textContent = '$' + cashCommission.toLocaleString();
            
            charts.commission = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ä½å®¿é‡‘', 'ç¾é‡‘'],
                    datasets: [{
                        data: [accommodationCommission, cashCommission],
                        backgroundColor: ['#10B981', '#3B82F6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // å·¥å…·å‡½æ•¸
        function getLevelText(level) {
            const levelMap = {
                'LV1_INSIDER': 'LV1 çŸ¥éŸ³å¤§ä½¿',
                'LV2_GUIDE': 'LV2 æ£®æ—åš®å°',
                'LV3_GUARDIAN': 'LV3 ç§˜å¢ƒå®ˆè­·è€…'
            };
            return levelMap[level] || level;
        }
        
        function getStatusClass(status) {
            const statusMap = {
                'PENDING': 'bg-yellow-100 text-yellow-800',
                'CONFIRMED': 'bg-blue-100 text-blue-800',
                'CHECKED_IN': 'bg-purple-100 text-purple-800',
                'COMPLETED': 'bg-green-100 text-green-800',
                'CANCELLED': 'bg-red-100 text-red-800'
            };
            return statusMap[status] || 'bg-gray-100 text-gray-800';
        }
        
        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'å¾…ç¢ºèª',
                'CONFIRMED': 'å·²ç¢ºèª',
                'CHECKED_IN': 'å·²å…¥ä½',
                'COMPLETED': 'å·²å®Œæˆ',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW');
        }
        
        // äº’å‹•åŠŸèƒ½
        function copyReferralLink() {
            const link = document.getElementById('referralLink');
            link.select();
            document.execCommand('copy');
            showSuccess('æ¨è–¦é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }
        
        function copyTemplate() {
            const template = document.getElementById('referralTemplate').textContent;
            navigator.clipboard.writeText(template).then(() => {
                showSuccess('æ¨è–¦æ–‡æ¡ˆå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            });
        }
        
        function shareToLine() {
            const link = document.getElementById('referralLink').value;
            const text = `ğŸŒ² ç™¼ç¾æ£®æ—ä¸­çš„ç§˜å¯†ä½å®¿é«”é©—ï¼å¿«ä¾†é€éæˆ‘çš„å°ˆå±¬é€£çµé è¨‚ï¼š${link}`;
            const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');
        }
        
        function shareToFacebook() {
            const link = document.getElementById('referralLink').value;
            const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`;
            window.open(fbUrl, '_blank');
        }
        
        function exportBookings() {
            if (allBookings.length === 0) {
                showError('æš«ç„¡è¨˜éŒ„å¯åŒ¯å‡º');
                return;
            }
            
            const csvData = allBookings.map(booking => ({
                'å…¥ä½æ—¥æœŸ': formatDate(booking.checkin_date),
                'é€€æˆ¿æ—¥æœŸ': formatDate(booking.checkout_date),
                'æˆ¿å®¢å§“å': booking.guest_name,
                'æˆ¿åƒ¹': parseFloat(booking.room_price) || 0,
                'ç‹€æ…‹': getStatusText(booking.stay_status),
                'ä½£é‡‘': parseFloat(booking.commission_amount) || 0,
                'ä½£é‡‘é¡å‹': booking.commission_type === 'ACCOMMODATION' ? 'ä½å®¿é‡‘' : 'ç¾é‡‘'
            }));
            
            downloadCSV(csvData, `æ¨è–¦è¨˜éŒ„_${partnerData.partner_code}.csv`);
        }
        
        function downloadCSV(data, filename) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
        
        function refreshData() {
            showLoading();
            loadPartnerData();
        }
        
        function logout() {
            sessionStorage.removeItem('partnerCode');
            sessionStorage.removeItem('partnerData');
            window.location.href = 'partner-login.html';
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showSuccess(message) {
            alert('âœ… ' + message);
        }
        
        function showError(message) {
            alert('âŒ ' + message);
        }
    </script>
</body>
</html>