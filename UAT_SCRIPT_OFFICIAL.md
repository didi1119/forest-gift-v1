# 靜謐森林知音計畫 - UAT 測試腳本

## 測試目標
根據 Project Board M6-Issue11 的規格，進行完整的用戶驗收測試，確保所有核心功能符合商業需求。

## 測試環境準備

### 必要設定項目：
- [ ] Google Sheets 已建立並設定完成（五表結構）
- [ ] Apps Script Web App 已部署並取得 URL
- [ ] GA4 Property 已設定並取得 Measurement ID
- [ ] 測試用夥伴帳號已建立（partner_code = "TEST_A"）
- [ ] LINE 優惠券深層連結已準備

### 測試資料準備：
```javascript
// 測試夥伴 A 資料
partner_code: "TEST_A"
name: "測試夥伴A"
email: "test-a@example.com"
coupon_code: "FOREST_A_2025"
```

---

## UAT 測試腳本

### 📋 測試案例 1：夥伴連結進站與點擊記錄

**目標**：驗證 subid 追蹤與點擊記錄功能

**前置條件**：
- 夥伴 A 的專屬連結已生成

**測試步驟**：
1. 開啟夥伴 A 的 `landing_link`（格式：`${APPS_SCRIPT_URL}?pid=TEST_A&dest=landing`）
2. 系統應自動跳轉到主頁面並附加 `subid=TEST_A` 參數
3. 檢查頁面是否顯示「由 @TEST_A 推薦」字樣
4. 檢查 localStorage 是否儲存了 `forest_subid = TEST_A`

**預期結果**：
- ✅ 成功跳轉到主頁面
- ✅ 頁面顯示推薦來源
- ✅ `Clicks Log` 新增一筆 `type = "click"` 的記錄
- ✅ localStorage 正確儲存 subid

**驗收條件**：
- [ ] `Clicks Log` 中出現對應記錄：`partner_code = "TEST_A"`, `type = "click"`
- [ ] 頁面重新整理後仍顯示「由 @TEST_A 推薦」

---

### 📋 測試案例 2：互動事件追蹤

**目標**：驗證 GA4 事件追蹤與 subid 傳遞

**測試步驟**：
1. 在主頁面進行以下操作：
   - 點擊「抽取神諭卡片」並選擇三張牌
   - 點擊「播放療癒音樂」
   - 進入內心地圖手冊，填寫第一日的週記（超過50字元）
2. 開啟 GA4 即時報表查看事件
3. 檢查每個事件是否包含 `subid=TEST_A` 參數

**預期結果**：
- ✅ `card_draw` 事件包含選中的卡片資訊
- ✅ `playlist_play` 事件記錄音樂播放
- ✅ `journal_submit` 事件記錄週記提交（day=1）
- ✅ 所有事件都包含正確的 subid

**驗收條件**：
- [ ] GA4 即時報表顯示至少 3 個事件
- [ ] 每個事件的自訂維度 `subid` 值為 "TEST_A"
- [ ] 週記內容成功儲存到 `Journals` 表格

---

### 📋 測試案例 3：優惠券連結與 LINE 導流

**目標**：驗證優惠券點擊記錄與 LINE 跳轉

**測試步驟**：
1. 在主頁面點擊「領取專屬優惠」按鈕
2. 系統應跳轉到 Apps Script 處理 coupon 請求
3. 再跳轉到 LINE 優惠券頁面
4. 檢查 `Clicks Log` 是否新增 coupon 類型記錄

**預期結果**：
- ✅ 成功跳轉到 LINE 優惠券頁面
- ✅ `Clicks Log` 新增 `type = "coupon"` 記錄
- ✅ 觸發 `line_click` GA4 事件

**驗收條件**：
- [ ] `Clicks Log` 中有 `partner_code = "TEST_A"`, `type = "coupon"` 記錄
- [ ] GA4 記錄到 `line_click` 事件且包含 subid

---

### 📋 測試案例 4：訂房管理與狀態追蹤

**目標**：驗證「完成入住」商業邏輯

**測試步驟**：
1. 進入管理後台 → 「訂單管理」頁面
2. 新增測試訂房：
   ```
   booking_id: "BK2025_001"
   partner_code: "TEST_A"
   guest_name: "王小明"
   booking_amount: 5000
   status: "pending"
   ```
3. 儲存後檢查「Overview」頁面的完成入住數（應為 0）
4. 將訂房狀態更新為 `paid`，檢查完成入住數（仍為 0）
5. 將訂房狀態更新為 `stayed_completed`，檢查完成入住數（應為 1）
6. 將訂房狀態改為 `canceled`，檢查完成入住數（應回到 0）
7. 再改回 `stayed_completed`，檢查完成入住數（應為 1）

**預期結果**：
- ✅ 只有 `stayed_completed` 狀態的訂房計入完成入住數
- ✅ 狀態變更即時反映在總覽儀表板
- ✅ 資料儲存到 `Bookings` 表格

**驗收條件**：
- [ ] 完成入住數與 `Bookings` 表中 `stayed_completed` 訂房數一致
- [ ] 純點擊不會影響完成入住數統計
- [ ] 重新整理後資料不遺失

---

### 📋 測試案例 5：結算管理與手動金額

**目標**：驗證手動結算流程與獎金計算

**測試步驟**：
1. 確保夥伴 A 有至少 1 筆 `stayed_completed` 訂房
2. 進入管理後台 → 「結算管理」頁面
3. 建立新結算單：
   ```
   partner_code: "TEST_A"
   period_start: "2025-01-01"
   period_end: "2025-01-31"
   amount_manual: 500
   ```
4. 查看該期間內的訂房清單（僅供參考顯示）
5. 手動輸入結算金額：500 元
6. 標記為 `paid` 狀態
7. 檢查夥伴 A 的 `payout_lifetime_accum` 是否增加 500

**預期結果**：
- ✅ 結算單成功建立並儲存到 `Payouts` 表
- ✅ 標記 `paid` 後累計獎金正確更新
- ✅ 不做任何自動計算，完全依賴手動輸入

**驗收條件**：
- [ ] `Payouts` 表有對應記錄
- [ ] `Affiliate Master` 中 `payout_lifetime_accum` 正確累加
- [ ] 獎金欄位完全由人工輸入並可覆寫

---

### 📋 測試案例 6：資料一致性檢查

**目標**：驗證各系統間資料同步正確性

**測試步驟**：
1. 完成上述所有測試案例
2. 執行夜間彙整程式（手動觸發 Apps Script aggregation）
3. 檢查各表格資料一致性：
   - `Clicks Log` 總點擊數 vs `Affiliate Master.clicks_total`
   - `Bookings` 各狀態統計 vs `Affiliate Master` 對應欄位
   - `eligible_conversions` 是否等於 `stays_completed`
4. 重新整理管理後台，確認數據正確顯示

**預期結果**：
- ✅ 所有統計數據一致
- ✅ `eligible_conversions` 嚴格等於 `stays_completed`
- ✅ 夜間彙整不會修改手動輸入的獎金欄位

**驗收條件**：
- [ ] 彙整後 `Affiliate Master` 中的統計欄位與實際資料一致
- [ ] 完成入住數與 Bookings 中 `stayed_completed` 總數匹配
- [ ] 重新整理後儀表與列表數據一致

---

## 🚨 關鍵驗收條件總結

### 商業邏輯驗證：
- [ ] **「實際入住才計獎」規則**：只有 `stayed_completed` 訂房計入 `eligible_conversions`
- [ ] **點擊不計獎**：純點擊增長不會改變完成入住數
- [ ] **手動金額管理**：所有獎金欄位由人工輸入，系統不做自動計算

### 技術功能驗證：
- [ ] **subid 追蹤完整性**：從進站到所有事件都正確傳遞 subid
- [ ] **資料持久性**：localStorage 和 Google Sheets 資料在重新整理後不遺失  
- [ ] **即時同步**：狀態變更立即反映在儀表板統計

### 使用者體驗驗證：
- [ ] **推薦來源顯示**：進站後能看到推薦來源標示
- [ ] **導流順暢性**：所有 CTA 連結都正常運作並帶入 subid
- [ ] **管理介面易用性**：新增、編輯、查看功能都能正常操作

---

## 📋 測試結果記錄表

| 測試案例 | 執行狀態 | 通過/失敗 | 問題描述 | 修復狀態 |
|---------|---------|----------|----------|----------|
| 案例 1：夥伴連結進站 | ⏳ 待執行 | - | - | - |
| 案例 2：互動事件追蹤 | ⏳ 待執行 | - | - | - |
| 案例 3：優惠券導流 | ⏳ 待執行 | - | - | - |
| 案例 4：訂房狀態管理 | ⏳ 待執行 | - | - | - |
| 案例 5：結算管理 | ⏳ 待執行 | - | - | - |
| 案例 6：資料一致性 | ⏳ 待執行 | - | - | - |

---

## 📝 測試完成檢查清單

### 執行前準備：
- [ ] 測試環境已搭建完成
- [ ] 測試資料已準備
- [ ] 所有相關人員已被告知測試時程

### 執行後驗證：
- [ ] 所有測試案例已執行完成
- [ ] 關鍵驗收條件全數通過
- [ ] 發現的問題已記錄並修復
- [ ] 測試結果已歸檔保存

### 移交準備：
- [ ] 系統文件已更新
- [ ] 生產環境配置清單已準備
- [ ] 維運人員已接受培訓

**測試完成簽核：**
- 測試執行人：_______________ 日期：___________
- 驗收負責人：_______________ 日期：___________

---

此測試腳本完全符合 Project Board M6-Issue11 的規格要求，確保系統在投入生產前所有核心功能都能正常運作。