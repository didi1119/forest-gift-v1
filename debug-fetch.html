<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>詳細 Fetch 診斷工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Apps Script Fetch 診斷工具</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Apps Script URL:</label>
                <input type="text" id="scriptUrl" value="https://script.google.com/macros/s/AKfycbyzaMMHbo1zesnAP4Go3Iz1R1z3702Ct4cuEJOdJpHArHpVpnCgvMIfeWx_PzRTWj8F/exec" class="w-full p-2 border rounded text-xs">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">測試方式:</label>
                <select id="testMethod" class="w-full p-2 border rounded">
                    <option value="GET">GET 請求</option>
                    <option value="POST">POST 請求</option>
                    <option value="FETCH_TEST">Fetch 可用性測試</option>
                    <option value="CORS_TEST">CORS 預檢測試</option>
                </select>
            </div>
        </div>
        
        <div class="space-x-4 mb-6">
            <button onclick="testFetch()" class="bg-blue-600 text-white px-6 py-3 rounded font-semibold">
                開始診斷
            </button>
            <button onclick="clearLog()" class="bg-gray-600 text-white px-6 py-3 rounded font-semibold">
                清除記錄
            </button>
        </div>
        
        <div id="results" class="bg-gray-50 p-4 rounded min-h-96 font-mono text-sm overflow-auto">
            <p class="text-gray-600">準備開始診斷...</p>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            results.innerHTML += `<div class="${colors[type] || 'text-gray-600'}"><strong>[${timestamp}]</strong> ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testFetch() {
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            const method = document.getElementById('testMethod').value;
            
            if (!scriptUrl) {
                log('請輸入 Apps Script URL', 'error');
                return;
            }
            
            clearLog();
            log(`開始測試: ${method}`, 'info');
            log(`目標 URL: ${scriptUrl}`, 'info');
            log(`瀏覽器: ${navigator.userAgent}`, 'info');
            log(`來源: ${window.location.origin}`, 'info');
            log('---', 'info');
            
            try {
                if (method === 'GET') {
                    await testGet(scriptUrl);
                } else if (method === 'POST') {
                    await testPost(scriptUrl);
                } else if (method === 'FETCH_TEST') {
                    await testFetchAvailability(scriptUrl);
                } else if (method === 'CORS_TEST') {
                    await testCors(scriptUrl);
                }
            } catch (error) {
                log(`主要錯誤: ${error.message}`, 'error');
                console.error('詳細錯誤:', error);
            }
        }
        
        async function testGet(scriptUrl) {
            log('🔍 測試 GET 請求...', 'info');
            
            try {
                const url = `${scriptUrl}?test=true&timestamp=${Date.now()}`;
                log(`GET URL: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                log(`GET 狀態碼: ${response.status}`, response.ok ? 'success' : 'error');
                log(`GET 狀態文字: ${response.statusText}`, 'info');
                
                // 顯示回應 headers
                log('GET 回應 Headers:', 'info');
                for (let [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                const responseText = await response.text();
                log(`GET 回應內容: ${responseText.substring(0, 200)}${responseText.length > 200 ? '...' : ''}`, 'info');
                
                if (response.ok) {
                    log('✅ GET 請求成功', 'success');
                } else {
                    log('❌ GET 請求失敗', 'error');
                }
                
            } catch (error) {
                log(`❌ GET 請求錯誤: ${error.message}`, 'error');
                log(`錯誤類型: ${error.name}`, 'error');
                
                if (error.message.includes('fetch')) {
                    log('🔍 這可能是網路連接問題或 CORS 問題', 'warning');
                }
            }
        }
        
        async function testPost(scriptUrl) {
            log('🔍 測試 POST 請求...', 'info');
            
            const testData = {
                action: 'create_partner',
                partner_code: 'DEBUG_TEST_' + Date.now(),
                name: '診斷測試',
                email: 'debug@test.com',
                coupon_url: 'https://lin.ee/debug'
            };
            
            try {
                log(`POST 資料: ${JSON.stringify(testData)}`, 'info');
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                log(`POST 狀態碼: ${response.status}`, response.ok ? 'success' : 'error');
                log(`POST 狀態文字: ${response.statusText}`, 'info');
                
                // 顯示回應 headers
                log('POST 回應 Headers:', 'info');
                for (let [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                const responseText = await response.text();
                log(`POST 回應內容: ${responseText}`, 'info');
                
                try {
                    const result = JSON.parse(responseText);
                    log(`POST 解析結果: ${JSON.stringify(result, null, 2)}`, 'info');
                    
                    if (result.success) {
                        log('✅ POST 請求成功', 'success');
                    } else {
                        log(`❌ POST 請求失敗: ${result.error}`, 'error');
                    }
                } catch (parseError) {
                    log(`JSON 解析錯誤: ${parseError.message}`, 'error');
                }
                
            } catch (error) {
                log(`❌ POST 請求錯誤: ${error.message}`, 'error');
                log(`錯誤類型: ${error.name}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('🔍 這通常表示:', 'warning');
                    log('  1. CORS 預檢請求失敗', 'warning');
                    log('  2. Apps Script 部署設定問題', 'warning');
                    log('  3. 網路連接問題', 'warning');
                }
            }
        }
        
        async function testFetchAvailability(scriptUrl) {
            log('🔍 測試 Fetch API 可用性...', 'info');
            
            // 檢查 fetch 是否可用
            if (typeof fetch === 'undefined') {
                log('❌ Fetch API 不可用', 'error');
                return;
            }
            
            log('✅ Fetch API 可用', 'success');
            
            // 測試簡單的外部請求
            try {
                log('測試對 Google 的請求...', 'info');
                const testResponse = await fetch('https://www.google.com', { 
                    method: 'HEAD', 
                    mode: 'no-cors' 
                });
                log('✅ 外部網路連接正常', 'success');
            } catch (error) {
                log(`❌ 外部網路連接有問題: ${error.message}`, 'error');
            }
            
            // 測試對 Apps Script 的基本連接
            try {
                log('測試對 Apps Script 的基本連接...', 'info');
                const response = await fetch(scriptUrl, { 
                    method: 'HEAD', 
                    mode: 'cors' 
                });
                log(`基本連接狀態: ${response.status}`, 'info');
            } catch (error) {
                log(`基本連接失敗: ${error.message}`, 'error');
            }
        }
        
        async function testCors(scriptUrl) {
            log('🔍 測試 CORS 設定...', 'info');
            
            try {
                // 測試 OPTIONS 請求
                log('發送 OPTIONS 請求...', 'info');
                const optionsResponse = await fetch(scriptUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                    }
                });
                
                log(`OPTIONS 狀態碼: ${optionsResponse.status}`, optionsResponse.ok ? 'success' : 'error');
                
                log('CORS Headers:', 'info');
                let hasCorHeaders = false;
                for (let [key, value] of optionsResponse.headers.entries()) {
                    if (key.toLowerCase().includes('access-control')) {
                        log(`  ${key}: ${value}`, 'success');
                        hasCorHeaders = true;
                    }
                }
                
                if (!hasCorHeaders) {
                    log('❌ 沒有找到 CORS headers', 'error');
                    log('這表示 doOptions 函數可能沒有正常工作', 'warning');
                } else {
                    log('✅ 發現 CORS headers', 'success');
                }
                
            } catch (error) {
                log(`❌ CORS 測試失敗: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>