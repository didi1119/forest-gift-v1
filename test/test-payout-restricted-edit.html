<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµç®—ä¿®æ”¹é™åˆ¶æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">ğŸ’° çµç®—ä¿®æ”¹é™åˆ¶æ¸¬è©¦</h1>
        
        <!-- æ¸¬è©¦èªªæ˜ -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>æ¸¬è©¦ç›®æ¨™ï¼š</strong>é©—è­‰çµç®—è¨˜éŒ„çš„è²¡å‹™æ¬„ä½ï¼ˆé‡‘é¡ã€é¡å‹ã€å¤§ä½¿ä»£ç¢¼ï¼‰ç„¡æ³•ä¿®æ”¹<br>
                        <strong>æ¸¬è©¦ç­–ç•¥ï¼š</strong>ç¢ºä¿åªæœ‰éè²¡å‹™æ¬„ä½å¯ä»¥æ›´æ–°
                    </p>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦æ­¥é©Ÿ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">æ¸¬è©¦æ­¥é©Ÿ</h2>
            
            <!-- æ­¥é©Ÿ 1: å‰µå»ºæ¸¬è©¦çµç®— -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">1ï¸âƒ£ å‰µå»ºæ¸¬è©¦çµç®—</h3>
                <button onclick="createTestPayout()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    å‰µå»ºæ¸¬è©¦çµç®—
                </button>
                <div id="step1Result" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- æ­¥é©Ÿ 2: å˜—è©¦ä¿®æ”¹è²¡å‹™æ¬„ä½ -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">2ï¸âƒ£ æ¸¬è©¦è²¡å‹™æ¬„ä½é™åˆ¶</h3>
                <button onclick="testFinancialFieldRestriction()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    å˜—è©¦ä¿®æ”¹é‡‘é¡å’Œé¡å‹
                </button>
                <div id="step2Result" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- æ­¥é©Ÿ 3: æ¸¬è©¦éè²¡å‹™æ¬„ä½ä¿®æ”¹ -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">3ï¸âƒ£ æ¸¬è©¦éè²¡å‹™æ¬„ä½</h3>
                <button onclick="testNonFinancialFieldEdit()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ä¿®æ”¹å‚™è¨»å’Œç‹€æ…‹
                </button>
                <div id="step3Result" class="mt-2 text-sm text-gray-600"></div>
            </div>

            <!-- æ­¥é©Ÿ 4: æ¸¬è©¦å–æ¶ˆä¸¦é‡å»ºæµç¨‹ -->
            <div class="mb-4">
                <h3 class="font-semibold mb-2">4ï¸âƒ£ å–æ¶ˆä¸¦é‡å»ºæµç¨‹</h3>
                <button onclick="testCancelAndRecreate()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    åŸ·è¡Œå–æ¶ˆä¸¦é‡å»º
                </button>
                <div id="step4Result" class="mt-2 text-sm text-gray-600"></div>
            </div>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-bold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="testResults" class="space-y-2"></div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWVmkMJUladdBVp56vcISxqCfebXaytT4_SX970OaD7Aq8wg74Kcf_9OxyNEaPA_4W/exec';
        let testPayoutId = null;

        // å‰µå»ºæ¸¬è©¦çµç®—
        async function createTestPayout() {
            try {
                const params = new URLSearchParams({
                    action: 'create_payout',
                    partner_code: 'TEST_RESTRICT_001',
                    payout_type: 'ACCOMMODATION',
                    amount: 3000,
                    payout_status: 'PENDING',
                    notes: 'æ¸¬è©¦é™åˆ¶ä¿®æ”¹'
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });

                const result = await response.json();
                if (result.success) {
                    testPayoutId = result.data.id || result.data.ID;
                    document.getElementById('step1Result').innerHTML = 
                        `âœ… å‰µå»ºæˆåŠŸï¼ŒID: ${testPayoutId}`;
                    addTestResult('å‰µå»ºæ¸¬è©¦çµç®—', true, `ID: ${testPayoutId}`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('step1Result').innerHTML = 
                    `âŒ å‰µå»ºå¤±æ•—: ${error.message}`;
                addTestResult('å‰µå»ºæ¸¬è©¦çµç®—', false, error.message);
            }
        }

        // æ¸¬è©¦è²¡å‹™æ¬„ä½é™åˆ¶
        async function testFinancialFieldRestriction() {
            if (!testPayoutId) {
                alert('è«‹å…ˆå‰µå»ºæ¸¬è©¦çµç®—');
                return;
            }

            try {
                // å˜—è©¦ä¿®æ”¹é‡‘é¡å’Œé¡å‹ï¼ˆæ‡‰è©²è¢«å¿½ç•¥ï¼‰
                const params = new URLSearchParams({
                    action: 'update_payout',
                    payout_id: testPayoutId,
                    amount: 5000,  // å˜—è©¦æ”¹è®Šé‡‘é¡
                    payout_type: 'CASH',  // å˜—è©¦æ”¹è®Šé¡å‹
                    notes: 'å˜—è©¦ä¿®æ”¹è²¡å‹™æ¬„ä½'
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });

                const result = await response.json();
                
                // æª¢æŸ¥æ•¸æ“šæ˜¯å¦çœŸçš„æ²’æœ‰æ”¹è®Š
                const checkResponse = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const checkData = await checkResponse.json();
                const payout = checkData.data.payouts.find(p => p.id == testPayoutId);
                
                const amountUnchanged = payout.amount == 3000;
                const typeUnchanged = payout.payout_type === 'ACCOMMODATION';
                
                if (amountUnchanged && typeUnchanged) {
                    document.getElementById('step2Result').innerHTML = 
                        `âœ… è²¡å‹™æ¬„ä½å·²è¢«ä¿è­·ï¼ˆé‡‘é¡ä»ç‚º3000ï¼Œé¡å‹ä»ç‚ºACCOMMODATIONï¼‰`;
                    addTestResult('è²¡å‹™æ¬„ä½é™åˆ¶', true, 'é‡‘é¡å’Œé¡å‹ç„¡æ³•ä¿®æ”¹');
                } else {
                    document.getElementById('step2Result').innerHTML = 
                        `âŒ è²¡å‹™æ¬„ä½æœªè¢«ä¿è­·ï¼`;
                    addTestResult('è²¡å‹™æ¬„ä½é™åˆ¶', false, 'é‡‘é¡æˆ–é¡å‹è¢«ä¿®æ”¹äº†');
                }
            } catch (error) {
                document.getElementById('step2Result').innerHTML = 
                    `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                addTestResult('è²¡å‹™æ¬„ä½é™åˆ¶', false, error.message);
            }
        }

        // æ¸¬è©¦éè²¡å‹™æ¬„ä½ä¿®æ”¹
        async function testNonFinancialFieldEdit() {
            if (!testPayoutId) {
                alert('è«‹å…ˆå‰µå»ºæ¸¬è©¦çµç®—');
                return;
            }

            try {
                const newNotes = 'æ¸¬è©¦å‚™è¨» - ' + new Date().toLocaleTimeString();
                const params = new URLSearchParams({
                    action: 'update_payout',
                    payout_id: testPayoutId,
                    payout_status: 'COMPLETED',
                    bank_transfer_reference: 'REF123456',
                    bank_transfer_date: new Date().toISOString().split('T')[0],
                    notes: newNotes
                });

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });

                const result = await response.json();
                
                // æª¢æŸ¥æ•¸æ“šæ˜¯å¦æ›´æ–°
                const checkResponse = await fetch(`${APPS_SCRIPT_URL}?action=get_all_data`);
                const checkData = await checkResponse.json();
                const payout = checkData.data.payouts.find(p => p.id == testPayoutId);
                
                const statusUpdated = payout.payout_status === 'COMPLETED';
                const notesUpdated = payout.notes === newNotes;
                const refUpdated = payout.bank_transfer_reference === 'REF123456';
                
                if (statusUpdated && notesUpdated && refUpdated) {
                    document.getElementById('step3Result').innerHTML = 
                        `âœ… éè²¡å‹™æ¬„ä½æˆåŠŸæ›´æ–°`;
                    addTestResult('éè²¡å‹™æ¬„ä½ä¿®æ”¹', true, 'ç‹€æ…‹ã€å‚™è¨»ã€åƒè€ƒè™ŸæˆåŠŸæ›´æ–°');
                } else {
                    document.getElementById('step3Result').innerHTML = 
                        `âš ï¸ éƒ¨åˆ†æ¬„ä½æœªæ›´æ–°`;
                    addTestResult('éè²¡å‹™æ¬„ä½ä¿®æ”¹', false, 'æŸäº›æ¬„ä½æœªæ­£ç¢ºæ›´æ–°');
                }
            } catch (error) {
                document.getElementById('step3Result').innerHTML = 
                    `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                addTestResult('éè²¡å‹™æ¬„ä½ä¿®æ”¹', false, error.message);
            }
        }

        // æ¸¬è©¦å–æ¶ˆä¸¦é‡å»ºæµç¨‹
        async function testCancelAndRecreate() {
            if (!testPayoutId) {
                alert('è«‹å…ˆå‰µå»ºæ¸¬è©¦çµç®—');
                return;
            }

            try {
                // æ­¥é©Ÿ1: å–æ¶ˆåŸçµç®—
                const cancelParams = new URLSearchParams({
                    action: 'cancel_payout',
                    payout_id: testPayoutId
                });

                const cancelResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: cancelParams.toString()
                });

                const cancelResult = await cancelResponse.json();
                if (!cancelResult.success) {
                    throw new Error('å–æ¶ˆå¤±æ•—: ' + cancelResult.error);
                }

                // æ­¥é©Ÿ2: å‰µå»ºæ–°çµç®—ï¼ˆä¸åŒé‡‘é¡å’Œé¡å‹ï¼‰
                const createParams = new URLSearchParams({
                    action: 'create_payout',
                    partner_code: 'TEST_RESTRICT_001',
                    payout_type: 'CASH',  // æ”¹ç‚ºç¾é‡‘
                    amount: 1500,  // æ”¹ç‚º1500
                    payout_status: 'PENDING',
                    notes: 'é‡æ–°å‰µå»ºçš„çµç®—ï¼ˆåŸç‚º3000é»ä½å®¿é‡‘ï¼‰'
                });

                const createResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: createParams.toString()
                });

                const createResult = await createResponse.json();
                if (createResult.success) {
                    const newPayoutId = createResult.data.id || createResult.data.ID;
                    document.getElementById('step4Result').innerHTML = 
                        `âœ… æˆåŠŸå–æ¶ˆä¸¦é‡å»º<br>åŸID: ${testPayoutId}ï¼ˆå·²å–æ¶ˆï¼‰<br>æ–°ID: ${newPayoutId}ï¼ˆç¾é‡‘ $1500ï¼‰`;
                    addTestResult('å–æ¶ˆä¸¦é‡å»ºæµç¨‹', true, `æ–°çµç®—ID: ${newPayoutId}`);
                    testPayoutId = newPayoutId;  // æ›´æ–°æ¸¬è©¦ID
                } else {
                    throw new Error('é‡å»ºå¤±æ•—: ' + createResult.error);
                }
            } catch (error) {
                document.getElementById('step4Result').innerHTML = 
                    `âŒ æµç¨‹å¤±æ•—: ${error.message}`;
                addTestResult('å–æ¶ˆä¸¦é‡å»ºæµç¨‹', false, error.message);
            }
        }

        // æ·»åŠ æ¸¬è©¦çµæœ
        function addTestResult(testName, success, detail) {
            const resultsDiv = document.getElementById('testResults');
            const resultItem = document.createElement('div');
            resultItem.className = success ? 
                'p-2 bg-green-50 border-l-4 border-green-400' : 
                'p-2 bg-red-50 border-l-4 border-red-400';
            resultItem.innerHTML = `
                <div class="flex items-center">
                    <span class="text-lg mr-2">${success ? 'âœ…' : 'âŒ'}</span>
                    <div>
                        <div class="font-semibold">${testName}</div>
                        <div class="text-sm text-gray-600">${detail}</div>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(resultItem);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('çµç®—ä¿®æ”¹é™åˆ¶æ¸¬è©¦å·¥å…·å°±ç·’');
        });
    </script>
</body>
</html>